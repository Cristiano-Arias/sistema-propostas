<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Envio de Propostas</title>
    
    <!-- Carregar sistema de autentica√ß√£o -->
    <script src="auth.js"></script>
    
    <!-- Configura√ß√£o da API -->
    <script>
        // Detecta automaticamente se est√° local ou em produ√ß√£o
        const API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:5000' 
            : window.location.origin;
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .processo-info {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .processo-info input {
            background: transparent;
            border: 1px solid white;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .processo-info input#objetoProcesso {
            width: 400px;
        }

        .progress-container {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .progress-bar {
            background: #ecf0f1;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(45deg, #3498db, #2980b9);
            height: 100%;
            transition: width 0.3s ease;
            width: 0%;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 140px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab.active { background: #3498db; color: white; }

        .form-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .form-section.active { display: block; }

        .section-title {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
            font-size: 14px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row.single { grid-template-columns: 1fr; }
        .form-row.triple { grid-template-columns: 1fr 1fr 1fr; }

        .form-group { margin-bottom: 15px; }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 13px;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        textarea { resize: vertical; min-height: 70px; }

        .required { color: #e74c3c; }

        .help-text {
            font-size: 11px;
            color: #7f8c8d;
            margin-top: 3px;
        }

        .dynamic-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            margin: 10px 0;
        }

        .dynamic-table th {
            background: #3498db;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
        }

        .dynamic-table td {
            padding: 8px;
            border-bottom: 1px solid #ecf0f1;
        }

        .dynamic-table input, .dynamic-table select {
            border: 1px solid #ddd;
            padding: 5px;
            font-size: 12px;
        }

        .add-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin: 8px 0;
        }

        .remove-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }

        .submit-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .submit-btn, .preview-btn {
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 0 8px;
            border: none;
        }

        .submit-btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }

        .preview-btn {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }

        .total-box {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 5px solid #27ae60;
        }

        .total-line {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-weight: bold;
        }

        .final-total {
            font-size: 18px;
            color: #2c3e50;
            border-top: 2px solid #27ae60;
            padding-top: 10px;
            margin-top: 10px;
        }

        .resumo-box {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .resumo-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #bae6fd;
        }

        .resumo-item:last-child {
            border-bottom: none;
            font-size: 18px;
            font-weight: 700;
            color: #0c4a6e;
        }

        /* Modal de Revis√£o */
        .modal-revisao {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            overflow-y: auto;
        }

        .modal-revisao-content {
            background-color: white;
            margin: 2% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 900px;
            box-shadow: 0 5px 30px rgba(0,0,0,0.3);
            max-height: 95vh;
            display: flex;
            flex-direction: column;
        }

        .modal-revisao-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-revisao-body {
            padding: 30px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-revisao-footer {
            padding: 20px 30px;
            background: #f8f9fa;
            border-top: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 0 0 15px 15px;
        }

        .revisao-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .revisao-section h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 18px;
        }

        .revisao-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #e9ecef;
        }

        .revisao-item:last-child {
            border-bottom: none;
        }

        .revisao-label {
            font-weight: 600;
            color: #6c757d;
            min-width: 150px;
        }

        .revisao-valor {
            flex: 1;
            text-align: right;
            color: #2c3e50;
        }

        .revisao-total {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            text-align: center;
        }

        .revisao-total h2 {
            color: #2c3e50;
            margin: 0;
        }

        .valor-total-revisao {
            font-size: 36px;
            color: #27ae60;
            font-weight: bold;
            margin: 10px 0;
        }

        .btn-confirmar-envio {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-voltar-revisao {
            background: #6c757d;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .alerta-revisao {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .cronograma-automatico-info {
            background: #e8f5e8;
            border: 1px solid #27ae60;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
            color: #2c3e50;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .form-row, .form-row.triple { grid-template-columns: 1fr; }
            .tabs { flex-direction: column; }
            .tab { min-width: auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ Portal de Envio de Propostas</h1>
            <p>Sistema Profissional de Propostas T√©cnicas e Comerciais</p>
        </div>

        <div class="processo-info">
            <h2>üìã Processo: <input type="text" id="numeroProcesso" value="LIC-2025-001"></h2>
            <p><strong>Objeto:</strong> <input type="text" id="objetoProcesso" value="Constru√ß√£o de Complexo Comercial - 5.000m¬≤"></p>
            <p><strong>Prazo para envio:</strong> <input type="text" id="prazoEnvio" value="30/08/2025 √†s 17:00h"></p>
        </div>

        <div class="progress-container">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span><strong>Progresso:</strong> <span id="progressText">0%</span></span>
                <span style="font-size: 12px; color: #27ae60;">üíæ Auto-save ativo</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dados', this)">1. Dados Cadastrais</button>
            <button class="tab" onclick="showTab('resumo', this)">2. Resumo Proposta</button>
            <button class="tab" onclick="showTab('tecnica', this)">3. Proposta T√©cnica</button>
            <button class="tab" onclick="showTab('comercial', this)">4. Proposta Comercial</button>
            <button class="tab" onclick="showTab('revisao', this)">5. Revis√£o</button>
        </div>

        <!-- SE√á√ÉO 1: DADOS CADASTRAIS -->
        <div class="form-section active" id="dados">
            <div class="section-title">üè¢ 1. Dados Cadastrais</div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="razaoSocial">Raz√£o Social <span class="required">*</span></label>
                    <input type="text" id="razaoSocial" required>
                </div>
                <div class="form-group">
                    <label for="cnpj">CNPJ <span class="required">*</span></label>
                    <input type="text" id="cnpj" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="endereco">Endere√ßo Completo</label>
                    <input type="text" id="endereco">
                </div>
                <div class="form-group">
                    <label for="cidade">Cidade/UF</label>
                    <input type="text" id="cidade">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="telefone">Telefone</label>
                    <input type="tel" id="telefone">
                </div>
                <div class="form-group">
                    <label for="email">E-mail <span class="required">*</span></label>
                    <input type="email" id="email" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="respTecnico">Respons√°vel T√©cnico</label>
                    <input type="text" id="respTecnico">
                </div>
                <div class="form-group">
                    <label for="crea">CREA/CAU</label>
                    <input type="text" id="crea">
                </div>
            </div>
        </div>

        <!-- SE√á√ÉO 2: RESUMO DA PROPOSTA -->
        <div class="form-section" id="resumo">
            <div class="section-title">üìä 2. Resumo da Proposta</div>
            
            <div class="resumo-box">
                <div class="resumo-item">
                    <span>üí∞ Pre√ßo Total:</span>
                    <span><strong>R$ <span id="precoTotalResumo">0,00</span></strong></span>
                </div>
                <div class="resumo-item">
                    <span>‚è∞ Prazo de Execu√ß√£o:</span>
                    <span><strong><span id="prazoResumo">-- dias</span></strong></span>
                </div>
                <div class="resumo-item">
                    <span>üí≥ Condi√ß√£o de Pagamento:</span>
                    <span><strong><span id="pagamentoResumo">A definir</span></strong></span>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="prazoExecucaoResumo">Prazo de Execu√ß√£o <span class="required">*</span></label>
                    <input type="text" id="prazoExecucaoResumo" placeholder="120 dias corridos" onchange="atualizarResumo()">
                </div>
                <div class="form-group">
                    <label for="formaPagamentoResumo">Condi√ß√£o de Pagamento</label>
                    <input type="text" id="formaPagamentoResumo" placeholder="30% entrada, 70% execu√ß√£o" onchange="atualizarResumo()">
                </div>
            </div>
        </div>

        <!-- SE√á√ÉO 3: PROPOSTA T√âCNICA -->
        <div class="form-section" id="tecnica">
            <div class="section-title">üìã 3. Proposta T√©cnica</div>

            <div class="section-title">3.1 Objeto da Concorr√™ncia</div>
            <div class="form-group">
                <label for="objetoConcorrencia">Descri√ß√£o do Objeto <span class="required">*</span></label>
                <textarea id="objetoConcorrencia" rows="3" required></textarea>
                <div class="help-text">Transcreva exatamente conforme edital</div>
            </div>

            <div class="section-title">3.2 Descri√ß√£o Detalhada do Escopo</div>
            <div class="form-group">
                <label for="escopoInclusos">Servi√ßos a Executar</label>
                <textarea id="escopoInclusos" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label for="escopoExclusos">Servi√ßos Ocultos</label>
                <textarea id="escopoExclusos" rows="3"></textarea>
            </div>

            <div class="section-title">3.3 Metodologia de Execu√ß√£o</div>
            <div class="form-group">
                <label for="metodologia">Detalhamento <span class="required">*</span></label>
                <textarea id="metodologia" rows="5" required></textarea>
            </div>
            <div class="form-group">
                <label for="sequenciaExecucao">Plano de Execu√ß√£o</label>
                <textarea id="sequenciaExecucao" rows="3"></textarea>
            </div>

            <div class="section-title">3.3.1 Tabela de Servi√ßos (sem valores)</div>
            <table class="dynamic-table" id="servicosTecnicaTable">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Descri√ß√£o</th>
                        <th>Unidade</th>
                        <th>Quantidade</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" value="1" readonly></td>
                        <td><input type="text" placeholder="Descri√ß√£o do servi√ßo"></td>
                        <td><input type="text" placeholder="m¬≤"></td>
                        <td><input type="number" placeholder="100"></td>
                        <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addServicoTecnicaRow()">+ Servi√ßo</button>

            <div class="section-title">3.4 M√£o de Obra Direta e Indireta</div>
            <table class="dynamic-table" id="equipeTable">
                <thead>
                    <tr>
                        <th>Fun√ß√£o</th>
                        <th>Quantidade</th>
                        <th>Tempo (meses)</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Engenheiro Civil"></td>
                        <td><input type="number" placeholder="1"></td>
                        <td><input type="number" placeholder="4" step="0.1"></td>
                        <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addEquipeRow()">+ Profissional</button>

            <div class="section-title">3.5 Lista de Materiais (Quantidades sem pre√ßos)</div>
            <table class="dynamic-table" id="materiaisTable">
                <thead>
                    <tr>
                        <th>Material</th>
                        <th>Especifica√ß√£o</th>
                        <th>Unidade</th>
                        <th>Quantidade</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Concreto"></td>
                        <td><input type="text" placeholder="FCK 25 MPa"></td>
                        <td><input type="text" placeholder="m¬≥"></td>
                        <td><input type="number" placeholder="450"></td>
                        <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addMaterialRow()">+ Adicionar Material</button>

            <div class="section-title">3.6 Lista de Equipamentos (Quantidades)</div>
            <table class="dynamic-table" id="equipamentosTable">
                <thead>
                    <tr>
                        <th>Equipamento</th>
                        <th>Especifica√ß√£o</th>
                        <th>Unidade</th>
                        <th>Quantidade</th>
                        <th>Tempo (meses)</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Betoneira"></td>
                        <td><input type="text" placeholder="400L"></td>
                        <td><input type="text" placeholder="und"></td>
                        <td><input type="number" placeholder="2"></td>
                        <td><input type="number" placeholder="4" step="0.1"></td>
                        <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addEquipamentoRow()">+ Adicionar Equipamento</button>

            <div class="section-title">3.9 Prazo de Execu√ß√£o</div>
            <div class="form-row single">
                <div class="form-group">
                    <label for="prazoExecucao">Prazo Total <span class="required">*</span></label>
                    <input type="text" id="prazoExecucao" placeholder="120 dias corridos" required>
                </div>
            </div>

            <div class="section-title">3.10 Prazo de Mobiliza√ß√£o</div>
            <div class="form-row single">
                <div class="form-group">
                    <label for="prazoMobilizacao">Mobiliza√ß√£o</label>
                    <input type="text" id="prazoMobilizacao" placeholder="15 dias">
                </div>
            </div>

            <div class="section-title">3.11 Cronograma de Execu√ß√£o Automatizado</div>
            <div class="cronograma-automatico-info">
                <strong>üí° Cronograma Inteligente:</strong> Insira apenas a atividade e a dura√ß√£o em dias. 
                As datas de in√≠cio e fim ser√£o calculadas automaticamente de forma sequencial.
            </div>
            <table class="dynamic-table" id="cronogramaTable">
                <thead>
                    <tr>
                        <th>Atividade</th>
                        <th>Dura√ß√£o (dias)</th>
                        <th>In√≠cio (Calculado)</th>
                        <th>Fim (Calculado)</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Mobiliza√ß√£o" value="Mobiliza√ß√£o"></td>
                        <td><input type="number" placeholder="15" min="1" value="15" onchange="calcularCronograma()"></td>
                        <td><input type="text" readonly value="Dia 1" style="background: #f8f9fa;"></td>
                        <td><input type="text" readonly value="Dia 15" style="background: #f8f9fa;"></td>
                        <td><button type="button" class="remove-btn" onclick="removeRowAndRecalculate(this)">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addCronogramaRow()">+ Atividade</button>
            <div style="text-align: right; margin-top: 10px; font-weight: bold; color: #2c3e50;">
                Prazo Total Calculado: <span id="prazoTotalCronograma">15</span> dias
            </div>

            <div class="section-title">3.12 Garantias Oferecidas</div>
            <div class="form-group">
                <label for="garantias">Garantias</label>
                <textarea id="garantias" rows="3" placeholder="5 anos para estrutura, 3 anos para acabamentos..."></textarea>
            </div>

            <div class="section-title">3.13 Necessidade de Canteiro</div>
            <div class="form-group">
                <label for="estruturaCanteiro">Estrutura do Canteiro</label>
                <textarea id="estruturaCanteiro" rows="3" placeholder="Escrit√≥rio, almoxarifado, vesti√°rios, refeit√≥rio"></textarea>
            </div>

            <div class="section-title">3.14 Obriga√ß√µes (Alimenta√ß√£o, Energia, etc.)</div>
            <div class="form-group">
                <label for="obrigacoesContratada">Responsabilidades da CONTRATADA</label>
                <textarea id="obrigacoesContratada" rows="3" placeholder="Alimenta√ß√£o, transporte, energia, etc."></textarea>
            </div>
            <div class="form-group">
                <label for="obrigacoesContratante">Responsabilidades da CONTRATANTE</label>
                <textarea id="obrigacoesContratante" rows="3"></textarea>
            </div>

            <div class="section-title">3.15 Experi√™ncia</div>
            <table class="dynamic-table" id="experienciaTable">
                <thead>
                    <tr>
                        <th>Obra</th>
                        <th>Cliente</th>
                        <th>Valor</th>
                        <th>Ano</th>
                        <th>Contato</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Nome da obra"></td>
                        <td><input type="text" placeholder="Cliente"></td>
                        <td><input type="text" placeholder="R$ 2.500.000"></td>
                        <td><input type="number" placeholder="2024"></td>
                        <td><input type="text" placeholder="(00) 0000-0000"></td>
                        <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addExperienciaRow()">+ Obra</button>

            <div class="section-title">3.16 Certifica√ß√µes/Qualifica√ß√µes</div>
            <table class="dynamic-table" id="certificacoesTable">
                <thead>
                    <tr>
                        <th>Certifica√ß√£o</th>
                        <th>√ìrg√£o</th>
                        <th>Validade</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="ISO 9001"></td>
                        <td><input type="text" placeholder="√ìrg√£o"></td>
                        <td><input type="date"></td>
                        <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addCertificacaoRow()">+ Certifica√ß√£o</button>
        </div>

        <!-- SE√á√ÉO 4: PROPOSTA COMERCIAL -->
        <div class="form-section" id="comercial">
            <div class="section-title">üí∞ 4. Proposta Comercial</div>

            <div class="section-title">4.1 Objeto da Concorr√™ncia</div>
            <div class="form-group">
                <label for="objetoComercial">Objeto (ser√° copiado da proposta t√©cnica)</label>
                <textarea id="objetoComercial" rows="2" readonly style="background: #f8f9fa;"></textarea>
            </div>

            <div class="section-title">4.2 Tabela de Servi√ßos por Item</div>
            <table class="dynamic-table" id="servicosTable">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Descri√ß√£o</th>
                        <th>Unid</th>
                        <th>Qtd</th>
                        <th>Pre√ßo Unit</th>
                        <th>Total</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="1"></td>
                        <td><input type="text" placeholder="Escava√ß√£o"></td>
                        <td><input type="text" placeholder="m¬≥"></td>
                        <td><input type="number" placeholder="100" onchange="calcTotal(this)"></td>
                        <td><input type="number" placeholder="25.50" step="0.01" onchange="calcTotal(this)"></td>
                        <td><input type="text" readonly></td>
                        <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addServicoRow()">+ Servi√ßo</button>
            
            <div style="text-align: right; margin: 10px 0; font-weight: bold;">
                <span>TOTAL SERVI√áOS: R$ <span id="totalServicos">0,00</span></span>
            </div>

            <div class="section-title">4.3 Pre√ßo Global</div>
            <div class="form-row">
                <div class="form-group">
                    <label for="valorTotal">Valor Total (Calculado Automaticamente)</label>
                    <input type="text" id="valorTotal" placeholder="R$ 0,00" readonly style="background: #f8f9fa; font-weight: bold; font-size: 16px;">
                </div>
                <div class="form-group">
                    <label for="validadeProposta">Validade da Proposta</label>
                    <input type="text" id="validadeProposta" placeholder="60 dias" value="60 dias">
                </div>
            </div>

            <div class="section-title">4.4 M√£o de Obra Direta e Indireta</div>
            <table class="dynamic-table" id="maoObraTable">
                <thead>
                    <tr>
                        <th>Fun√ß√£o</th>
                        <th>Quantidade</th>
                        <th>Tempo (meses)</th>
                        <th>Sal√°rio (R$)</th>
                        <th>Enc. Sociais (%)</th>
                        <th>Total Mensal (R$)</th>
                        <th>Total Geral (R$)</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Engenheiro Civil"></td>
                        <td><input type="number" placeholder="1" onchange="calcMaoObra(this)"></td>
                        <td><input type="number" placeholder="4" onchange="calcMaoObra(this)" step="0.1"></td>
                        <td><input type="number" placeholder="8500" onchange="calcMaoObra(this)" step="0.01"></td>
                        <td><input type="number" placeholder="80" value="80" onchange="calcMaoObra(this)" step="0.1"></td>
                        <td><input type="text" readonly></td>
                        <td><input type="text" readonly></td>
                        <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addMaoObraRow()">+ Adicionar Fun√ß√£o</button>
            
            <div style="text-align: right; margin: 10px 0; font-weight: bold;">
                <span>TOTAL M√ÉO DE OBRA: R$ <span id="totalMaoObra">0,00</span></span>
            </div>

            <div class="section-title">4.5 Lista de Materiais com Valores</div>
            <table class="dynamic-table" id="materiaisComercialTable">
                <thead>
                    <tr>
                        <th>Material</th>
                        <th>Especifica√ß√£o</th>
                        <th>Unidade</th>
                        <th>Quantidade</th>
                        <th>Pre√ßo Unit. (R$)</th>
                        <th>Total (R$)</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Concreto"></td>
                        <td><input type="text" placeholder="FCK 25 MPa"></td>
                        <td><input type="text" placeholder="m¬≥"></td>
                        <td><input type="number" placeholder="450" onchange="calcMaterial(this)"></td>
                        <td><input type="number" placeholder="320.50" step="0.01" onchange="calcMaterial(this)"></td>
                        <td><input type="text" readonly></td>
                        <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addMaterialComercialRow()">+ Adicionar Material</button>
            
            <div style="text-align: right; margin: 10px 0; font-weight: bold;">
                <span>TOTAL MATERIAIS: R$ <span id="totalMateriais">0,00</span></span>
            </div>

            <div class="section-title">4.6 Equipamentos com Pre√ßo Unit√°rio, Tempo e Quantidade</div>
            <table class="dynamic-table" id="equipamentosComercialTable">
                <thead>
                    <tr>
                        <th>Equipamento</th>
                        <th>Especifica√ß√£o</th>
                        <th>Quantidade</th>
                        <th>Tempo</th>
                        <th>Pre√ßo/m√™s (R$)</th>
                        <th>Total (R$)</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Betoneira"></td>
                        <td><input type="text" placeholder="400L"></td>
                        <td><input type="number" placeholder="2" onchange="calcEquipamento(this)"></td>
                        <td><input type="number" placeholder="4" step="0.1" onchange="calcEquipamento(this)"></td>
                        <td><input type="number" placeholder="1200" step="0.01" onchange="calcEquipamento(this)"></td>
                        <td><input type="text" readonly></td>
                        <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addEquipamentoComercialRow()">+ Adicionar Equipamento</button>
            
            <div style="text-align: right; margin: 10px 0; font-weight: bold;">
                <span>TOTAL EQUIPAMENTOS: R$ <span id="totalEquipamentos">0,00</span></span>
            </div>

            <div class="section-title">4.7 BDI Detalhado</div>
            <table class="dynamic-table" id="bdiTable">
                <thead>
                    <tr>
                        <th>Item do BDI</th>
                        <th>Percentual (%)</th>
                        <th>Valor (R$)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" value="Administra√ß√£o Central" readonly></td>
                        <td><input type="number" placeholder="8.0" step="0.1" onchange="calcBDI()"></td>
                        <td><input type="text" readonly></td>
                    </tr>
                    <tr>
                        <td><input type="text" value="Seguros e Garantias" readonly></td>
                        <td><input type="number" placeholder="1.5" step="0.1" onchange="calcBDI()"></td>
                        <td><input type="text" readonly></td>
                    </tr>
                    <tr>
                        <td><input type="text" value="Riscos" readonly></td>
                        <td><input type="number" placeholder="2.0" step="0.1" onchange="calcBDI()"></td>
                        <td><input type="text" readonly></td>
                    </tr>
                    <tr>
                        <td><input type="text" value="Despesas Financeiras" readonly></td>
                        <td><input type="number" placeholder="1.0" step="0.1" onchange="calcBDI()"></td>
                        <td><input type="text" readonly></td>
                    </tr>
                    <tr>
                        <td><input type="text" placeholder="Item adicional"></td>
                        <td><input type="number" placeholder="0.0" step="0.1" onchange="calcBDI()"></td>
                        <td><input type="text" readonly></td>
                    </tr>
                    <tr>
                        <td><input type="text" placeholder="Item adicional"></td>
                        <td><input type="number" placeholder="0.0" step="0.1" onchange="calcBDI()"></td>
                        <td><input type="text" readonly></td>
                    </tr>
                    <tr>
                        <td><input type="text" placeholder="Item adicional"></td>
                        <td><input type="number" placeholder="0.0" step="0.1" onchange="calcBDI()"></td>
                        <td><input type="text" readonly></td>
                    </tr>
                    <tr>
                        <td><input type="text" value="Lucro" readonly></td>
                        <td><input type="number" placeholder="8.0" step="0.1" onchange="calcBDI()"></td>
                        <td><input type="text" readonly></td>
                    </tr>
                    <tr>
                        <td><input type="text" value="Tributos (ISS, PIS, COFINS)" readonly></td>
                        <td><input type="number" placeholder="7.5" step="0.1" onchange="calcBDI()"></td>
                        <td><input type="text" readonly></td>
                    </tr>
                </tbody>
            </table>
            
            <div class="total-box">
                <div class="total-line">
                    <span>CUSTO DIRETO (MO + Mat + Equip):</span>
                    <span>R$ <span id="custoDirecto">0,00</span></span>
                </div>
                <div class="total-line" style="color: #27ae60;">
                    <span>BDI TOTAL:</span>
                    <span><span id="bdiPercentual">0.0</span>% = R$ <span id="bdiValor">0,00</span></span>
                </div>
                <div class="total-line final-total">
                    <span>VALOR TOTAL DA PROPOSTA:</span>
                    <span>R$ <span id="valorTotalCalculado">0,00</span></span>
                </div>
            </div>

            <div class="section-title">4.8 Condi√ß√µes</div>
            <div class="form-group">
                <label for="validadeDetalhada">Condi√ß√µes de Validade</label>
                <textarea id="validadeDetalhada" rows="3" placeholder="Proposta v√°lida por 60 dias. Pre√ßos sujeitos a reajuste ap√≥s este per√≠odo."></textarea>
            </div>
        </div>

        <!-- SE√á√ÉO 5: REVIS√ÉO -->
        <div class="form-section" id="revisao">
            <div class="section-title">üìã 5. Revis√£o Final</div>
            
            <div id="resumoProposta">
                <!-- Conte√∫do gerado automaticamente -->
            </div>
        </div>

        <div class="submit-section">
            <button type="button" class="preview-btn" onclick="gerarPreview()">üëÅÔ∏è Visualizar</button>
            <button type="button" class="submit-btn" onclick="enviarProposta()">üöÄ Enviar Proposta</button>
            
            <div id="mensagem"></div>
        </div>
    </div>

    <!-- Modal de Revis√£o -->
    <div id="modalRevisao" class="modal-revisao">
        <div class="modal-revisao-content">
            <div class="modal-revisao-header">
                <h2>üìã Revis√£o Final da Proposta</h2>
                <button onclick="fecharModalRevisao()" style="background: none; border: none; color: white; font-size: 28px; cursor: pointer;">&times;</button>
            </div>
            
            <div class="modal-revisao-body">
                <div class="alerta-revisao">
                    <span style="font-size: 24px;">‚ö†Ô∏è</span>
                    <div>
                        <strong>ATEN√á√ÉO:</strong> Revise cuidadosamente todos os dados antes de enviar.
                        Ap√≥s o envio, a proposta n√£o poder√° ser alterada.
                    </div>
                </div>
                
                <div id="conteudoRevisao">
                    <!-- Conte√∫do ser√° preenchido dinamicamente -->
                </div>
            </div>
            
            <div class="modal-revisao-footer">
                <button class="btn-voltar-revisao" onclick="fecharModalRevisao()">
                    ‚Üê Voltar e Editar
                </button>
                
                <div style="display: flex; align-items: center; gap: 15px;">
                    <label style="display: flex; align-items: center; gap: 5px; font-weight: 600;">
                        <input type="checkbox" id="confirmacaoFinal" onchange="habilitarBotaoEnvio()">
                        Confirmo que todos os dados est√£o corretos
                    </label>
                    
                    <button id="btnConfirmarEnvio" class="btn-confirmar-envio" onclick="confirmarEnvioFinal()" disabled style="opacity: 0.5;">
                        ‚úÖ Confirmar e Enviar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentTab = 'dados';
        let currentUser = null;
        
        // ===== INTEGRA√á√ÉO COM SISTEMA DE AUTENTICA√á√ÉO EXISTENTE =====
        document.addEventListener('DOMContentLoaded', async function() {
            // Usar o sistema de autentica√ß√£o existente
            currentUser = Auth.verificarAutenticacao(['fornecedor', 'admin']);
            
            if (!currentUser) {
                // A fun√ß√£o verificarAutenticacao j√° redireciona se n√£o autenticado
                return;
            }
            
            console.log('Usu√°rio autenticado:', currentUser);
            
            // Carregar dados do processo da URL
            const urlParams = new URLSearchParams(window.location.search);
            const numeroProcesso = urlParams.get('processo');
            
            if (numeroProcesso) {
                // Carregar processo do localStorage
                const processosData = JSON.parse(localStorage.getItem('processos') || '[]');
                const processo = processosData.find(p => p.numero === numeroProcesso);
                
                if (processo) {
                    // Verificar se o fornecedor foi convidado
                    if (processo.fornecedoresConvidados && 
                        processo.fornecedoresConvidados.includes(currentUser.usuarioId)) {
                        
                        document.getElementById('numeroProcesso').value = processo.numero;
                        document.getElementById('objetoProcesso').value = processo.objeto || '';
                        
                        if (processo.prazo) {
                            const prazoDate = new Date(processo.prazo);
                            document.getElementById('prazoEnvio').value = prazoDate.toLocaleString('pt-BR');
                        }
                        
                        // CORRE√á√ÉO: Usar fun√ß√£o do Auth.js para carregar dados da empresa
                        const empresaData = Auth.obterDadosEmpresa(currentUser.usuarioId);
                        
                        if (empresaData) {
                            console.log('Dados da empresa carregados:', empresaData);
                            
                            // Pr√©-preencher dados cadastrais
                            document.getElementById('razaoSocial').value = empresaData.razaoSocial || '';
                            document.getElementById('cnpj').value = empresaData.cnpj || '';
                            document.getElementById('endereco').value = empresaData.endereco || '';
                            document.getElementById('cidade').value = empresaData.cidade || '';
                            document.getElementById('telefone').value = empresaData.telefone || '';
                            document.getElementById('email').value = empresaData.email || '';
                            document.getElementById('respTecnico').value = empresaData.respTecnico || '';
                            document.getElementById('crea').value = empresaData.crea || '';
                        } else {
                            console.log('Dados da empresa n√£o encontrados');
                            // Se n√£o tiver dados da empresa, usar dados do usu√°rio
                            if (currentUser.email) {
                                document.getElementById('email').value = currentUser.email;
                            }
                        }
                    } else {
                        alert('Voc√™ n√£o tem permiss√£o para acessar este processo.');
                        window.location.href = 'dashboard-fornecedor.html';
                        return;
                    }
                } else {
                    alert('Processo n√£o encontrado.');
                    window.location.href = 'dashboard-fornecedor.html';
                    return;
                }
            } else {
                alert('Nenhum processo especificado.');
                window.location.href = 'dashboard-fornecedor.html';
                return;
            }
            
            // Verificar status da API
            try {
                const response = await fetch(`${API_URL}/api/status`);
                const status = await response.json();
                console.log('Status da API:', status);
            } catch (error) {
                console.error('Erro ao conectar com API:', error);
                mostrarMensagem('‚ö†Ô∏è Servidor offline. Dados ser√£o salvos localmente.', 'error');
            }
            
            // Inicializar cronograma e c√°lculos
            calcularCronograma();
            updateProgress();
            
            // CORRE√á√ÉO 3: Inicializar c√°lculos vazios
            setTimeout(() => {
                calcularTotais();
            }, 500);
            
            // Carregar dados salvos se existir
            const rascunhoKey = `proposta_rascunho_${currentUser.usuarioId}_${numeroProcesso}`;
            const dadosSalvos = localStorage.getItem(rascunhoKey);
            if (dadosSalvos) {
                if (confirm('H√° um rascunho salvo. Deseja recuper√°-lo?')) {
                    carregarRascunho(JSON.parse(dadosSalvos));
                }
            }
        });

        // ===== FUN√á√ïES DE INTEGRA√á√ÉO COM API =====
        async function enviarPropostaAPI(dados) {
            try {
                const response = await fetch(`${API_URL}/api/enviar-proposta`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(dados)
                });
                
                const result = await response.json();
                return result;
            } catch (error) {
                console.error('Erro ao enviar proposta:', error);
                return { success: false, erro: error.message };
            }
        }
        
        async function carregarProcessoAPI(numeroProcesso) {
            try {
                const response = await fetch(`${API_URL}/api/processos/${numeroProcesso}`);
                const processo = await response.json();
                return processo;
            } catch (error) {
                console.error('Erro ao carregar processo:', error);
                return null;
            }
        }

        // ===== CRONOGRAMA AUTOM√ÅTICO =====
        function addCronogramaRow() {
            const tbody = document.querySelector('#cronogramaTable tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" placeholder="Nova Atividade"></td>
                <td><input type="number" placeholder="10" min="1" onchange="calcularCronograma()"></td>
                <td><input type="text" readonly style="background: #f8f9fa;"></td>
                <td><input type="text" readonly style="background: #f8f9fa;"></td>
                <td><button type="button" class="remove-btn" onclick="removeRowAndRecalculate(this)">√ó</button></td>
            `;
            calcularCronograma();
        }

        function calcularCronograma() {
            const tbody = document.querySelector('#cronogramaTable tbody');
            let diaAtual = 1;
            let prazoTotal = 0;
            
            for (const row of tbody.rows) {
                const duracaoInput = row.cells[1].querySelector('input');
                const duracao = parseInt(duracaoInput.value) || 0;
                
                if (duracao > 0) {
                    const diaFim = diaAtual + duracao - 1;
                    row.cells[2].querySelector('input').value = `Dia ${diaAtual}`;
                    row.cells[3].querySelector('input').value = `Dia ${diaFim}`;
                    diaAtual = diaFim + 1;
                    prazoTotal += duracao;
                } else {
                    row.cells[2].querySelector('input').value = '';
                    row.cells[3].querySelector('input').value = '';
                }
            }
            
            document.getElementById('prazoTotalCronograma').textContent = prazoTotal;
            document.getElementById('prazoExecucao').value = `${prazoTotal} dias`;
            
            // Atualizar resumo
            const prazoResumo = document.getElementById('prazoExecucaoResumo');
            if (prazoResumo && !prazoResumo.value) {
                prazoResumo.value = `${prazoTotal} dias`;
                atualizarResumo();
            }
        }

        function removeRowAndRecalculate(button) {
            button.closest('tr').remove();
            calcularCronograma();
        }

        // Fun√ß√µes de formata√ß√£o de moeda
        function formatarMoeda(valor) {
            if (!valor && valor !== 0) return '';
            let numero = parseFloat(valor);
            if (isNaN(numero)) return '';
            return numero.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }
        
        function adicionarFormatacaoMoeda(input) {
            input.addEventListener('blur', function() {
                if (this.value) {
                    this.value = formatarMoeda(this.value);
                }
            });
            
            input.addEventListener('focus', function() {
                if (this.value) {
                    this.value = limparMoeda(this.value).toString().replace('.', ',');
                }
            });
        }
        
        function limparMoeda(valor) {
            if (!valor) return 0;
            let numero = valor.toString().replace(/[^\d,.-]/g, '');
            if (numero.includes('.') && numero.includes(',')) {
                numero = numero.replace(/\./g, '').replace(',', '.');
            } else if (numero.includes(',')) {
                numero = numero.replace(',', '.');
            }
            return parseFloat(numero) || 0;
        }

        async function enviarProposta() {
            // Valida√ß√µes b√°sicas
            const camposObrigatorios = ['razaoSocial', 'cnpj', 'email', 'objetoConcorrencia', 'metodologia', 'prazoExecucao'];
            let tudoPreenchido = true;
            
            for (const campo of camposObrigatorios) {
                const elemento = document.getElementById(campo);
                if (!elemento || !elemento.value.trim()) {
                    tudoPreenchido = false;
                    if (elemento) {
                        elemento.style.borderColor = '#e74c3c';
                    }
                }
            }
            
            if (!tudoPreenchido) {
                mostrarMensagem('Por favor, preencha todos os campos obrigat√≥rios (*)', 'error');
                return;
            }
            
            // Mostrar modal de revis√£o
            gerarRevisaoFinal();
            document.getElementById('modalRevisao').style.display = 'block';
        }

        function showTab(tabName, buttonElement) {
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            buttonElement.classList.add('active');
            
            currentTab = tabName;
            updateProgress();
            
            if (tabName === 'comercial') {
                copiarObjetoParaComercial();
                copiarDadosTecnicaParaComercial();
            }
            
            if (tabName === 'revisao') {
                gerarRevisao();
            }
        }

        function updateProgress() {
            const tabs = ['dados', 'resumo', 'tecnica', 'comercial', 'revisao'];
            const currentIndex = tabs.indexOf(currentTab);
            const progress = ((currentIndex + 1) / tabs.length) * 100;
            
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = Math.round(progress) + '%';
        }

        function atualizarResumo() {
            const prazo = document.getElementById('prazoExecucaoResumo').value;
            const pagamento = document.getElementById('formaPagamentoResumo').value;
            const valorTotal = document.getElementById('valorTotalCalculado').textContent;
            
            document.getElementById('prazoResumo').textContent = prazo || '-- dias';
            document.getElementById('pagamentoResumo').textContent = pagamento || 'A definir';
            document.getElementById('precoTotalResumo').textContent = valorTotal;
        }

        function copiarObjetoParaComercial() {
            const objetoTecnico = document.getElementById('objetoConcorrencia').value;
            document.getElementById('objetoComercial').value = objetoTecnico;
        }

        // Fun√ß√µes para adicionar linhas nas tabelas
        function addEquipeRow() {
            const tbody = document.querySelector('#equipeTable tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" placeholder="Fun√ß√£o"></td>
                <td><input type="number" placeholder="1"></td>
                <td><input type="number" placeholder="4" step="0.1"></td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
            `;
        }

        function addMaterialRow() {
            const tbody = document.querySelector('#materiaisTable tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" placeholder="Material"></td>
                <td><input type="text" placeholder="Especifica√ß√£o"></td>
                <td><input type="text" placeholder="Unidade"></td>
                <td><input type="number" placeholder="Quantidade"></td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
            `;
        }

        function addEquipamentoRow() {
            const tbody = document.querySelector('#equipamentosTable tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" placeholder="Equipamento"></td>
                <td><input type="text" placeholder="Especifica√ß√£o"></td>
                <td><input type="text" placeholder="Unidade"></td>
                <td><input type="number" placeholder="Quantidade"></td>
                <td><input type="number" placeholder="4" step="0.1"></td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
            `;
        }

        function addExperienciaRow() {
            const tbody = document.querySelector('#experienciaTable tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" placeholder="Nome da obra"></td>
                <td><input type="text" placeholder="Cliente"></td>
                <td><input type="text" placeholder="Valor"></td>
                <td><input type="number" placeholder="Ano"></td>
                <td><input type="text" placeholder="(00) 0000-0000"></td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
            `;
        }

        function addCertificacaoRow() {
            const tbody = document.querySelector('#certificacoesTable tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" placeholder="Certifica√ß√£o"></td>
                <td><input type="text" placeholder="√ìrg√£o"></td>
                <td><input type="date"></td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
            `;
        }

        function addServicoTecnicaRow() {
            const tbody = document.querySelector('#servicosTecnicaTable tbody');
            const nextItem = tbody.rows.length + 1;
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" value="${nextItem}" readonly></td>
                <td><input type="text" placeholder="Descri√ß√£o do servi√ßo"></td>
                <td><input type="text" placeholder="m¬≤"></td>
                <td><input type="number" placeholder="100"></td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
            `;
            renumerarTabela('servicosTecnicaTable');
        }

        function renumerarTabela(tableId) {
            const tbody = document.querySelector(`#${tableId} tbody`);
            const rows = tbody.rows;
            for (let i = 0; i < rows.length; i++) {
                const firstInput = rows[i].cells[0].querySelector('input');
                if (firstInput && firstInput.readOnly) {
                    firstInput.value = i + 1;
                }
            }
        }

        function copiarServicosTecnicaParaComercial() {
            const servicosTecnica = coletarTabela('servicosTecnicaTable');
            const tbody = document.querySelector('#servicosTable tbody');
            
            const valoresAtuais = {};
            document.querySelectorAll('#servicosTable tbody tr').forEach((row, index) => {
                const qtd = row.cells[3].querySelector('input')?.value;
                const preco = row.cells[4].querySelector('input')?.value;
                if (qtd || preco) {
                    valoresAtuais[index] = { qtd, preco };
                }
            });
            
            tbody.innerHTML = '';
            
            servicosTecnica.forEach((servico, index) => {
                const newRow = tbody.insertRow();
                const valores = valoresAtuais[index] || {};
                const quantidadeTecnica = servico[3] || '';
                const quantidadeComercial = valores.qtd || quantidadeTecnica;
                newRow.innerHTML = `
                    <td><input type="text" value="${index + 1}" readonly></td>
                    <td><input type="text" value="${servico[1]}" readonly style="background: #f8f9fa;"></td>
                    <td><input type="text" value="${servico[2]}" readonly style="background: #f8f9fa;"></td>
                    <td><input type="number" placeholder="100" value="${quantidadeComercial}" onchange="calcTotal(this)"></td>
                    <td><input type="number" placeholder="50.00" step="0.01" value="${valores.preco || ''}" onchange="calcTotal(this)"></td>
                    <td><input type="text" readonly></td>
                    <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                `;
                
                if (quantidadeComercial && valores.preco) {
                    calcTotal(newRow.cells[3].querySelector('input'));
                }
            });
        }

        function copiarDadosTecnicaParaComercial() {
            copiarServicosTecnicaParaComercial();
            
            const maoObraTecnica = coletarTabela('equipeTable');
            const tbodyMO = document.querySelector('#maoObraTable tbody');
            
            const salariosAtuais = {};
            document.querySelectorAll('#maoObraTable tbody tr').forEach((row, index) => {
                const salario = row.cells[3].querySelector('input')?.value;
                const encargos = row.cells[4].querySelector('input')?.value;
                if (salario) {
                    salariosAtuais[index] = { salario, encargos: encargos || '80' };
                }
            });
            
            tbodyMO.innerHTML = '';
            
            maoObraTecnica.forEach((item, index) => {
                const valores = salariosAtuais[index] || {};
                const newRow = tbodyMO.insertRow();
                newRow.innerHTML = `
                    <td><input type="text" value="${item[0]}" readonly style="background: #f8f9fa;"></td>
                    <td><input type="number" value="${item[1]}" readonly style="background: #f8f9fa;"></td>
                    <td><input type="number" value="${item[2]}" readonly style="background: #f8f9fa;" step="0.1"></td>
                    <td><input type="number" placeholder="3500" value="${valores.salario || ''}" onchange="calcMaoObra(this)" step="0.01"></td>
                    <td><input type="number" placeholder="80" value="${valores.encargos || '80'}" onchange="calcMaoObra(this)" step="0.1"></td>
                    <td><input type="text" readonly></td>
                    <td><input type="text" readonly></td>
                    <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                `;
                
                if (valores.salario) {
                    calcMaoObra(newRow.cells[3].querySelector('input'));
                }
            });
            
            const materiaisTecnica = coletarTabela('materiaisTable');
            const tbodyMat = document.querySelector('#materiaisComercialTable tbody');
            
            const precosMateriais = {};
            document.querySelectorAll('#materiaisComercialTable tbody tr').forEach((row, index) => {
                const preco = row.cells[4].querySelector('input')?.value;
                if (preco) {
                    precosMateriais[index] = preco;
                }
            });
            
            tbodyMat.innerHTML = '';
            
            materiaisTecnica.forEach((item, index) => {
                const preco = precosMateriais[index] || '';
                const newRow = tbodyMat.insertRow();
                newRow.innerHTML = `
                    <td><input type="text" value="${item[0]}" readonly style="background: #f8f9fa;"></td>
                    <td><input type="text" value="${item[1]}" readonly style="background: #f8f9fa;"></td>
                    <td><input type="text" value="${item[2]}" readonly style="background: #f8f9fa;"></td>
                    <td><input type="text" value="${item[3]}" readonly style="background: #f8f9fa;"></td>
                    <td><input type="number" placeholder="50.00" step="0.01" value="${preco}" onchange="calcMaterial(this)"></td>
                    <td><input type="text" readonly></td>
                    <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                `;
                
                if (preco) {
                    calcMaterial(newRow.cells[4].querySelector('input'));
                }
            });
            
            const equipamentosTecnica = coletarTabela('equipamentosTable');
            const tbodyEq = document.querySelector('#equipamentosComercialTable tbody');
            
            const precosEquipamentos = {};
            document.querySelectorAll('#equipamentosComercialTable tbody tr').forEach((row, index) => {
                const preco = row.cells[4].querySelector('input')?.value;
                if (preco) {
                    precosEquipamentos[index] = preco;
                }
            });
            
            tbodyEq.innerHTML = '';
            
            equipamentosTecnica.forEach((item, index) => {
                const preco = precosEquipamentos[index] || '';
                const newRow = tbodyEq.insertRow();
                newRow.innerHTML = `
                    <td><input type="text" value="${item[0]}" readonly style="background: #f8f9fa;"></td>
                    <td><input type="text" value="${item[1]}" readonly style="background: #f8f9fa;"></td>
                    <td><input type="text" value="${item[3]}" readonly style="background: #f8f9fa;"></td>
                    <td><input type="text" value="${item[4]}" readonly style="background: #f8f9fa;"></td>
                    <td><input type="number" placeholder="800" step="0.01" value="${preco}" onchange="calcEquipamento(this)"></td>
                    <td><input type="text" readonly></td>
                    <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                `;
                
                if (preco) {
                    calcEquipamento(newRow.cells[4].querySelector('input'));
                }
            });
        }

        function addServicoRow() {
            const tbody = document.querySelector('#servicosTable tbody');
            const nextItem = tbody.rows.length + 1;
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" value="${nextItem}" placeholder="${nextItem}"></td>
                <td><input type="text" placeholder="Descri√ß√£o"></td>
                <td><input type="text" placeholder="m¬≤"></td>
                <td><input type="number" placeholder="100" onchange="calcTotal(this)"></td>
                <td><input type="number" placeholder="50.00" step="0.01" onchange="calcTotal(this)"></td>
                <td><input type="text" readonly></td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
            `;

            const precoInput = newRow.cells[4].querySelector('input');
            adicionarFormatacaoMoeda(precoInput);
        }

        function addMaoObraRow() {
            const tbody = document.querySelector('#maoObraTable tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" placeholder="Ex: Pedreiro"></td>
                <td><input type="number" placeholder="5" onchange="calcMaoObra(this)"></td>
                <td><input type="number" placeholder="4" step="0.1" onchange="calcMaoObra(this)"></td>
                <td><input type="number" placeholder="3500" step="0.01" onchange="calcMaoObra(this)"></td>
                <td><input type="number" placeholder="80" value="80" step="0.1" onchange="calcMaoObra(this)"></td>
                <td><input type="text" readonly></td>
                <td><input type="text" readonly></td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
            `;

            const salarioInput = newRow.cells[3].querySelector('input');
            adicionarFormatacaoMoeda(salarioInput);
        }

        function addMaterialComercialRow() {
            const tbody = document.querySelector('#materiaisComercialTable tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" placeholder="Material"></td>
                <td><input type="text" placeholder="Especifica√ß√£o"></td>
                <td><input type="text" placeholder="Unidade"></td>
                <td><input type="number" placeholder="100" onchange="calcMaterial(this)"></td>
                <td><input type="number" placeholder="50.00" step="0.01" onchange="calcMaterial(this)"></td>
                <td><input type="text" readonly></td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
            `;

            const precoInput = newRow.cells[4].querySelector('input');
            adicionarFormatacaoMoeda(precoInput);
        }

        function addEquipamentoComercialRow() {
            const tbody = document.querySelector('#equipamentosComercialTable tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" placeholder="Equipamento"></td>
                <td><input type="text" placeholder="Especifica√ß√£o"></td>
                <td><input type="number" placeholder="1" onchange="calcEquipamento(this)"></td>
                <td><input type="number" placeholder="3" step="0.1" onchange="calcEquipamento(this)"></td>
                <td><input type="number" placeholder="800" step="0.01" onchange="calcEquipamento(this)"></td>
                <td><input type="text" readonly></td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
            `;

            const precoInput = newRow.cells[4].querySelector('input');
            adicionarFormatacaoMoeda(precoInput);
        }

        function removeRow(button) {
            const row = button.closest('tr');
            const table = row.closest('table');
            row.remove();
            
            if (table.id === 'servicosTecnicaTable') {
                renumerarTabela('servicosTecnicaTable');
            }
            
            calcularTotais();
        }

        // CORRE√á√ÉO 4: Fun√ß√µes de c√°lculo corrigidas
        function calcMaoObra(input) {
            const row = input.closest('tr');
            const cells = row.cells;
            const qtd = parseFloat(cells[1].querySelector('input').value) || 0;
            const tempo = parseFloat(cells[2].querySelector('input').value) || 0;
            const salario = limparMoeda(cells[3].querySelector('input').value) || 0;
            const encargos = parseFloat(cells[4].querySelector('input').value) || 0;
            
            if (qtd && tempo && salario) {
                const salarioComEncargos = salario * (1 + encargos/100);
                const totalMensal = qtd * salarioComEncargos;
                const totalGeral = totalMensal * tempo;
                
                cells[5].querySelector('input').value = formatarMoeda(totalMensal);
                cells[6].querySelector('input').value = formatarMoeda(totalGeral);
            }
            
            calcularTotalMaoObra();
            calcularTotais();
        }

        function calcTotal(input) {
            const row = input.closest('tr');
            const cells = row.cells;
            const qtdInput = cells[3].querySelector('input');
            const precoInput = cells[4].querySelector('input');
            const totalInput = cells[5].querySelector('input');
            
            const qtd = parseFloat(qtdInput.value) || 0;
            const preco = limparMoeda(precoInput.value) || 0;
            const total = qtd * preco;

            totalInput.value = formatarMoeda(total);
            
            calcularTotalServicos();
            calcularTotais();
        }

        function calcMaterial(input) {
            const row = input.closest('tr');
            const cells = row.cells;
            const qtd = parseFloat(cells[3].querySelector('input').value) || 0;
            const preco = limparMoeda(cells[4].querySelector('input').value) || 0;
            const total = qtd * preco;
            
            cells[5].querySelector('input').value = formatarMoeda(total);
            
            calcularTotalMateriais();
            calcularTotais();
        }

        function calcEquipamento(input) {
            const row = input.closest('tr');
            const cells = row.cells;
            const qtd = parseFloat(cells[2].querySelector('input').value) || 0;
            const tempo = parseFloat(cells[3].querySelector('input').value) || 0;
            const preco = limparMoeda(cells[4].querySelector('input').value) || 0;
            const total = qtd * tempo * preco;
            
            cells[5].querySelector('input').value = formatarMoeda(total);
            
            calcularTotalEquipamentos();
            calcularTotais();
        }

        function calcularTotalServicos() {
            let total = 0;
            document.querySelectorAll('#servicosTable tbody tr').forEach((row, index) => {
                const valorCell = row.cells[5].querySelector('input');
                if (valorCell && valorCell.value) {
                    const valor = limparMoeda(valorCell.value);
                    total += valor;
                }
            });
            document.getElementById('totalServicos').textContent = formatarMoeda(total);
            return total;
        }

        function calcularTotalMaoObra() {
            let total = 0;
            document.querySelectorAll('#maoObraTable tbody tr').forEach(row => {
                const valorCell = row.cells[6].querySelector('input');
                if (valorCell) {
                    total += limparMoeda(valorCell.value) || 0;
                }
            });
            document.getElementById('totalMaoObra').textContent = formatarMoeda(total);
            return total;
        }

        function calcularTotalMateriais() {
            let total = 0;
            document.querySelectorAll('#materiaisComercialTable tbody tr').forEach(row => {
                const valorCell = row.cells[5].querySelector('input');
                if (valorCell) {
                    total += limparMoeda(valorCell.value) || 0;
                }
            });
            document.getElementById('totalMateriais').textContent = formatarMoeda(total);
            return total;
        }

        function calcularTotalEquipamentos() {
            let total = 0;
            document.querySelectorAll('#equipamentosComercialTable tbody tr').forEach(row => {
                const valorCell = row.cells[5].querySelector('input');
                if (valorCell) {
                    total += limparMoeda(valorCell.value) || 0;
                }
            });
            document.getElementById('totalEquipamentos').textContent = formatarMoeda(total);
            return total;
        }

        function calcBDI() {
            const custoDirecto = calcularCustoDirecto();
            let totalBDI = 0;
            
            document.querySelectorAll('#bdiTable tbody tr').forEach(row => {
                const percentualInput = row.cells[1].querySelector('input');
                const valorInput = row.cells[2].querySelector('input');
                
                if (percentualInput && valorInput) {
                    const percentual = parseFloat(percentualInput.value) || 0;
                    const valor = custoDirecto * (percentual / 100);
                    valorInput.value = formatarMoeda(valor);
                    totalBDI += percentual;
                }
            });
            
            const valorBDI = custoDirecto * (totalBDI / 100);
            const valorTotal = custoDirecto + valorBDI;
            
            document.getElementById('bdiPercentual').textContent = totalBDI.toFixed(1);
            document.getElementById('bdiValor').textContent = formatarMoeda(valorBDI);
            document.getElementById('valorTotalCalculado').textContent = formatarMoeda(valorTotal);
            
            document.getElementById('valorTotal').value = 'R$ ' + formatarMoeda(valorTotal);
            
            atualizarResumo();
        }

        function calcularCustoDirecto() {
            const maoObra = calcularTotalMaoObra();
            const materiais = calcularTotalMateriais();
            const equipamentos = calcularTotalEquipamentos();
            const servicos = calcularTotalServicos();
            const total = maoObra + materiais + equipamentos + servicos;
            
            document.getElementById('custoDirecto').textContent = formatarMoeda(total);
            return total;
        }

        function calcularTotais() {
            calcularCustoDirecto();
            calcBDI();
        }

        function coletarTabela(tableId) {
            const dados = [];
            const rows = document.querySelectorAll(`#${tableId} tbody tr`);
            
            rows.forEach(row => {
                const rowData = [];
                row.querySelectorAll('input').forEach(input => {
                    rowData.push(input.value);
                });
                if (rowData.some(val => val !== '')) {
                    dados.push(rowData);
                }
            });
            
            return dados;
        }

        function gerarRevisao() {
            const valorTotal = document.getElementById('valorTotalCalculado').textContent;
            const prazo = document.getElementById('prazoExecucao').value || 'N√£o informado';
            const empresa = document.getElementById('razaoSocial').value || 'N√£o informado';
            
            const html = `
                <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                    <h3 style="color: #2c3e50; margin-bottom: 15px;">üìä Resumo da Proposta</h3>
                    <p><strong>Empresa:</strong> ${empresa}</p>
                    <p><strong>Processo:</strong> ${document.getElementById('numeroProcesso').value}</p>
                    <p><strong>Objeto:</strong> ${document.getElementById('objetoProcesso').value}</p>
                    <p><strong>Prazo de Execu√ß√£o:</strong> ${prazo}</p>
                    <p><strong>Valor Total:</strong> R$ ${valorTotal}</p>
                </div>
                
                <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; border-left: 5px solid #27ae60;">
                    <h4 style="color: #27ae60;">‚úÖ Checklist de Documentos</h4>
                    <ul style="list-style: none; padding-left: 0;">
                        <li>‚òëÔ∏è Dados cadastrais completos</li>
                        <li>‚òëÔ∏è Proposta t√©cnica detalhada</li>
                        <li>‚òëÔ∏è Proposta comercial com valores</li>
                        <li>‚òëÔ∏è BDI calculado</li>
                    </ul>
                </div>
            `;
            
            document.getElementById('resumoProposta').innerHTML = html;
        }

        function gerarPreview() {
            const dados = coletarDados();
            const protocolo = gerarProtocolo();
            
            const preview = window.open('', '_blank');
            preview.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Preview - Proposta ${protocolo}</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 40px; }
                        h1, h2, h3 { color: #2c3e50; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                        th { background: #3498db; color: white; }
                        .section { margin: 30px 0; }
                        .total { font-weight: bold; color: #27ae60; }
                    </style>
                </head>
                <body>
                    <h1>PROPOSTA T√âCNICA E COMERCIAL</h1>
                    <p><strong>Protocolo:</strong> ${protocolo}</p>
                    <p><strong>Data:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
                    
                    <div class="section">
                        <h2>1. DADOS DA EMPRESA</h2>
                        <p><strong>Raz√£o Social:</strong> ${dados.dados.razaoSocial}</p>
                        <p><strong>CNPJ:</strong> ${dados.dados.cnpj}</p>
                        <p><strong>E-mail:</strong> ${dados.dados.email}</p>
                    </div>
                    
                    <div class="section">
                        <h2>2. OBJETO</h2>
                        <p>${dados.tecnica.objetoConcorrencia}</p>
                    </div>
                    
                    <div class="section">
                        <h2>3. VALOR TOTAL</h2>
                        <p class="total">R$ ${dados.comercial.valorTotal}</p>
                    </div>
                    
                    <p style="text-align: center; margin-top: 50px;">
                        <button onclick="window.print()">üñ®Ô∏è Imprimir</button>
                        <button onclick="window.close()">‚ùå Fechar</button>
                    </p>
                </body>
                </html>
            `);
        }

        function coletarDados() {
            return {
                processo: document.getElementById('numeroProcesso').value,
                dados: {
                    razaoSocial: document.getElementById('razaoSocial').value,
                    cnpj: document.getElementById('cnpj').value,
                    endereco: document.getElementById('endereco').value,
                    cidade: document.getElementById('cidade').value,
                    telefone: document.getElementById('telefone').value,
                    email: document.getElementById('email').value,
                    respTecnico: document.getElementById('respTecnico').value,
                    crea: document.getElementById('crea').value
                },
                resumo: {
                    prazoExecucao: document.getElementById('prazoExecucaoResumo').value,
                    formaPagamento: document.getElementById('formaPagamentoResumo').value
                },
                tecnica: {
                    objetoConcorrencia: document.getElementById('objetoConcorrencia').value,
                    escopoInclusos: document.getElementById('escopoInclusos').value,
                    escopoExclusos: document.getElementById('escopoExclusos').value,
                    metodologia: document.getElementById('metodologia').value,
                    sequenciaExecucao: document.getElementById('sequenciaExecucao').value,
                    servicosTecnica: coletarTabela('servicosTecnicaTable'),
                    equipe: coletarTabela('equipeTable'),
                    materiais: coletarTabela('materiaisTable'),
                    equipamentos: coletarTabela('equipamentosTable'),
                    prazoExecucao: document.getElementById('prazoExecucao').value,
                    prazoMobilizacao: document.getElementById('prazoMobilizacao').value,
                    cronograma: coletarTabela('cronogramaTable'),
                    garantias: document.getElementById('garantias').value,
                    estruturaCanteiro: document.getElementById('estruturaCanteiro').value,
                    obrigacoesContratada: document.getElementById('obrigacoesContratada').value,
                    obrigacoesContratante: document.getElementById('obrigacoesContratante').value,
                    experiencia: coletarTabela('experienciaTable'),
                    certificacoes: coletarTabela('certificacoesTable')
                },
                comercial: {
                    objetoComercial: document.getElementById('objetoComercial').value,
                    servicos: coletarTabela('servicosTable'),
                    valorTotal: document.getElementById('valorTotalCalculado').textContent,
                    validadeProposta: document.getElementById('validadeProposta').value,
                    maoObra: coletarTabela('maoObraTable'),
                    materiaisComercial: coletarTabela('materiaisComercialTable'),
                    equipamentosComercial: coletarTabela('equipamentosComercialTable'),
                    bdi: coletarTabela('bdiTable'),
                    validadeDetalhada: document.getElementById('validadeDetalhada').value,
                    totalServicos: document.getElementById('totalServicos').textContent,
                    totalMaoObra: document.getElementById('totalMaoObra').textContent,
                    totalMateriais: document.getElementById('totalMateriais').textContent,
                    totalEquipamentos: document.getElementById('totalEquipamentos').textContent,
                    custoDirecto: document.getElementById('custoDirecto').textContent,
                    bdiPercentual: document.getElementById('bdiPercentual').textContent,
                    bdiValor: document.getElementById('bdiValor').textContent
                }
            };
        }

        function gerarProtocolo() {
            const data = new Date();
            const ano = data.getFullYear();
            const mes = String(data.getMonth() + 1).padStart(2, '0');
            const dia = String(data.getDate()).padStart(2, '0');
            const hora = String(data.getHours()).padStart(2, '0');
            const minuto = String(data.getMinutes()).padStart(2, '0');
            const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
            
            return `PROP-${ano}${mes}${dia}-${hora}${minuto}-${random}`;
        }

        function gerarRevisaoFinal() {
            const dados = coletarDados();
            
            const valorTotal = document.getElementById('valorTotalCalculado').textContent || '0,00';
            const totalMaoObra = document.getElementById('totalMaoObra').textContent || '0,00';
            const totalMateriais = document.getElementById('totalMateriais').textContent || '0,00';
            const totalEquipamentos = document.getElementById('totalEquipamentos').textContent || '0,00';
            const totalServicos = document.getElementById('totalServicos').textContent || '0,00';
            
            const html = `
                <div class="revisao-section">
                    <h3>üè¢ Dados da Empresa</h3>
                    <div class="revisao-item">
                        <span class="revisao-label">Raz√£o Social:</span>
                        <span class="revisao-valor">${dados.dados.razaoSocial || 'N√£o informado'}</span>
                    </div>
                    <div class="revisao-item">
                        <span class="revisao-label">CNPJ:</span>
                        <span class="revisao-valor">${dados.dados.cnpj || 'N√£o informado'}</span>
                    </div>
                    <div class="revisao-item">
                        <span class="revisao-label">E-mail:</span>
                        <span class="revisao-valor">${dados.dados.email || 'N√£o informado'}</span>
                    </div>
                    <div class="revisao-item">
                        <span class="revisao-label">Telefone:</span>
                        <span class="revisao-valor">${dados.dados.telefone || 'N√£o informado'}</span>
                    </div>
                    <div class="revisao-item">
                        <span class="revisao-label">Respons√°vel T√©cnico:</span>
                        <span class="revisao-valor">${dados.dados.respTecnico || 'N√£o informado'} - ${dados.dados.crea || ''}</span>
                    </div>
                </div>
                
                <div class="revisao-section">
                    <h3>üìã Dados do Processo</h3>
                    <div class="revisao-item">
                        <span class="revisao-label">Processo:</span>
                        <span class="revisao-valor">${document.getElementById('numeroProcesso').value}</span>
                    </div>
                    <div class="revisao-item">
                        <span class="revisao-label">Objeto:</span>
                        <span class="revisao-valor">${dados.tecnica.objetoConcorrencia || 'N√£o informado'}</span>
                    </div>
                    <div class="revisao-item">
                        <span class="revisao-label">Prazo de Execu√ß√£o:</span>
                        <span class="revisao-valor">${dados.tecnica.prazoExecucao || 'N√£o informado'}</span>
                    </div>
                    <div class="revisao-item">
                        <span class="revisao-label">Validade da Proposta:</span>
                        <span class="revisao-valor">${dados.comercial.validadeProposta || '60 dias'}</span>
                    </div>
                </div>
                
                <div class="revisao-section">
                    <h3>üí∞ Resumo Financeiro</h3>
                    <div class="revisao-item">
                        <span class="revisao-label">Servi√ßos:</span>
                        <span class="revisao-valor">R$ ${totalServicos}</span>
                    </div>
                    <div class="revisao-item">
                        <span class="revisao-label">M√£o de Obra:</span>
                        <span class="revisao-valor">R$ ${totalMaoObra}</span>
                    </div>
                    <div class="revisao-item">
                        <span class="revisao-label">Materiais:</span>
                        <span class="revisao-valor">R$ ${totalMateriais}</span>
                    </div>
                    <div class="revisao-item">
                        <span class="revisao-label">Equipamentos:</span>
                        <span class="revisao-valor">R$ ${totalEquipamentos}</span>
                    </div>
                    <div class="revisao-item">
                        <span class="revisao-label">BDI (${document.getElementById('bdiPercentual').textContent}%):</span>
                        <span class="revisao-valor">R$ ${document.getElementById('bdiValor').textContent}</span>
                    </div>
                </div>
                
                <div class="revisao-total">
                    <h2>Valor Total da Proposta</h2>
                    <div class="valor-total-revisao">R$ ${valorTotal}</div>
                </div>
            `;
            
            document.getElementById('conteudoRevisao').innerHTML = html;
        }

        function fecharModalRevisao() {
            document.getElementById('modalRevisao').style.display = 'none';
            document.getElementById('confirmacaoFinal').checked = false;
            document.getElementById('btnConfirmarEnvio').disabled = true;
            document.getElementById('btnConfirmarEnvio').style.opacity = '0.5';
        }

        function habilitarBotaoEnvio() {
            const checkbox = document.getElementById('confirmacaoFinal');
            const botao = document.getElementById('btnConfirmarEnvio');
            
            if (checkbox.checked) {
                botao.disabled = false;
                botao.style.opacity = '1';
            } else {
                botao.disabled = true;
                botao.style.opacity = '0.5';
            }
        }

        // CORRE√á√ÉO 5: Fun√ß√£o de envio corrigida
        async function confirmarEnvioFinal() {
            fecharModalRevisao();
            
            const dados = coletarDados();
            const protocolo = gerarProtocolo();
            
            if (!currentUser || !currentUser.usuarioId) {
                alert('Erro: Usu√°rio n√£o autenticado.');
                return;
            }
            
            const empresaData = Auth.obterDadosEmpresa(currentUser.usuarioId);
            
            mostrarMensagem('<span class="loading"></span> Enviando proposta...', 'info');
            
            // Criar objeto da proposta completo e estruturado
            const propostaCompleta = {
                protocolo: protocolo,
                processo: dados.processo,
                dataEnvio: new Date().toISOString(),
                data: new Date().toISOString(), // Manter compatibilidade
                status: 'enviada',
                
                // Dados da empresa
                empresa: empresaData?.nomeFantasia || empresaData?.razaoSocial || dados.dados.razaoSocial,
                cnpj: dados.dados.cnpj,
                fornecedorId: currentUser.usuarioId,
                
                // Valores principais para listagem
                valor: 'R$ ' + dados.comercial.valorTotal,
                prazo: parseInt(dados.tecnica.prazoExecucao) || 0,
                
                // Dados completos organizados
                dados: {
                    fornecedorId: currentUser.usuarioId,
                    fornecedorNome: currentUser.nome,
                    empresa: empresaData?.nomeFantasia || empresaData?.razaoSocial || dados.dados.razaoSocial,
                    cnpj: dados.dados.cnpj,
                    
                    // Dados cadastrais
                    cadastrais: dados.dados,
                    
                    // Resumo
                    resumo: dados.resumo,
                    
                    // Proposta t√©cnica
                    tecnica: {
                        ...dados.tecnica,
                        responsavelTecnico: dados.dados.respTecnico,
                        crea: dados.dados.crea
                    },
                    
                    // Proposta comercial
                    comercial: dados.comercial
                },
                
                // Compatibilidade com estrutura anterior
                comercial: dados.comercial,
                tecnica: dados.tecnica
            };
            
            console.log('Proposta a ser enviada:', propostaCompleta);
            
            // Enviar para API
            const resultado = await enviarPropostaAPI(propostaCompleta);
            
            if (resultado.success) {
                // Salvar tamb√©m no localStorage
                const propostas = JSON.parse(localStorage.getItem('propostas') || '[]');
                propostas.push(propostaCompleta);
                localStorage.setItem('propostas', JSON.stringify(propostas));
                
                // Notificar o comprador
                const processos = JSON.parse(localStorage.getItem('processos') || '[]');
                const processo = processos.find(p => p.numero === dados.processo);
                
                if (processo && processo.criadoPor) {
                    // Usar sistema de notifica√ß√µes do Auth.js
                    Auth.Notificacoes.criar({
                        tipo: 'nova_proposta',
                        titulo: 'üìÑ Nova Proposta Recebida',
                        mensagem: `${propostaCompleta.empresa} enviou proposta para ${processo.numero}`,
                        destinatario: processo.criadoPor,
                        remetente: currentUser.nome,
                        metadata: {
                            processoId: processo.numero,
                            propostaId: protocolo,
                            valor: dados.comercial.valorTotal
                        }
                    });
                }
                
                mostrarMensagem(`
                    <strong>‚úÖ Proposta enviada com sucesso!</strong><br>
                    <strong>Protocolo:</strong> ${protocolo}<br>
                    <strong>Data/Hora:</strong> ${new Date().toLocaleString('pt-BR')}<br>
                    ${resultado.email_enviado ? '<small>üìß E-mail de confirma√ß√£o enviado</small>' : ''}
                `, 'success');
                
                // Limpar rascunho
                const rascunhoKey = `proposta_rascunho_${currentUser.usuarioId}_${dados.processo}`;
                localStorage.removeItem(rascunhoKey);
                
                // Adicionar bot√µes de a√ß√£o
                setTimeout(() => {
                    const mensagemDiv = document.getElementById('mensagem');
                    mensagemDiv.innerHTML += `
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #27ae60;">
                            <button onclick="window.location.href='dashboard-fornecedor.html?page=propostas'" 
                                    style="background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin-right: 10px; font-weight: 600;">
                                üìÑ Ver Minhas Propostas
                            </button>
                            <button onclick="window.location.href='dashboard-fornecedor.html'" 
                                    style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-weight: 600;">
                                üè† Voltar ao Dashboard
                            </button>
                        </div>
                    `;
                }, 3000);
            } else {
                // Em caso de erro, salvar localmente
                salvarPropostaLocal(protocolo, propostaCompleta);
                
                mostrarMensagem(`
                    <strong>‚ö†Ô∏è Proposta salva localmente!</strong><br>
                    <strong>Protocolo:</strong> ${protocolo}<br>
                    <small>Houve um erro ao enviar. A proposta foi salva localmente.</small>
                `, 'error');
            }
        }

        function salvarPropostaLocal(protocolo, dados) {
            const propostas = JSON.parse(localStorage.getItem('propostas_locais') || '[]');
            propostas.push({
                protocolo: protocolo,
                data: new Date().toISOString(),
                dados: dados,
                enviada: false
            });
            localStorage.setItem('propostas_locais', JSON.stringify(propostas));
        }

        function carregarRascunho(dados) {
            // Implementar carregamento dos dados salvos
            console.log('Carregando rascunho...', dados);
            // TODO: Preencher todos os campos com os dados salvos
        }

        function mostrarMensagem(texto, tipo) {
            const mensagemDiv = document.getElementById('mensagem');
            mensagemDiv.className = tipo === 'error' ? 'error-message' : tipo === 'success' ? 'success-message' : '';
            mensagemDiv.innerHTML = texto;
            mensagemDiv.style.display = 'block';
            
            if (tipo !== 'info') {
                setTimeout(() => {
                    mensagemDiv.style.display = 'none';
                }, 10000);
            }
        }

        // Auto-save corrigido
        setInterval(() => {
            if (currentUser && currentUser.usuarioId) {
                const urlParams = new URLSearchParams(window.location.search);
                const numeroProcesso = urlParams.get('processo');
                
                if (numeroProcesso) {
                    const dados = coletarDados();
                    const rascunhoKey = `proposta_rascunho_${currentUser.usuarioId}_${numeroProcesso}`;
                    localStorage.setItem(rascunhoKey, JSON.stringify(dados));
                    console.log('Rascunho salvo automaticamente');
                }
            }
        }, 30000);
        
        // Aplicar formata√ß√£o aos campos de moeda ao carregar
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar formata√ß√£o de moeda
            document.querySelectorAll('#servicosTable input[onchange*="calcTotal"]').forEach(input => {
                if (input.closest('td').cellIndex === 4) {
                    adicionarFormatacaoMoeda(input);
                }
            });
            
            document.querySelectorAll('#maoObraTable input[onchange*="calcMaoObra"]').forEach(input => {
                if (input.closest('td').cellIndex === 3) {
                    adicionarFormatacaoMoeda(input);
                }
            });
            
            document.querySelectorAll('#materiaisComercialTable input[onchange*="calcMaterial"]').forEach(input => {
                if (input.closest('td').cellIndex === 4) {
                    adicionarFormatacaoMoeda(input);
                }
            });
            
            document.querySelectorAll('#equipamentosComercialTable input[onchange*="calcEquipamento"]').forEach(input => {
                if (input.closest('td').cellIndex === 4) {
                    adicionarFormatacaoMoeda(input);
                }
            });
        });
    </script>
</body>
</html>
