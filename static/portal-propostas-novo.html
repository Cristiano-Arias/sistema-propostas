<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de Envio de Propostas</title>
    
    <!-- Configura√ß√£o da API -->
    <script>
        // Detecta automaticamente se est√° local ou em produ√ß√£o
        const API_URL = window.location.hostname === 'localhost' 
            ? 'http://localhost:5000' 
            : window.location.origin;
    </script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .processo-info {
            background: linear-gradient(45deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .processo-info input {
            background: transparent;
            border: 1px solid white;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
        }
        
        .processo-info input#objetoProcesso {
            width: 400px;
        }

        .progress-container {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .progress-bar {
            background: #ecf0f1;
            height: 6px;
            border-radius: 3px;
            overflow: hidden;
        }

        .progress-fill {
            background: linear-gradient(45deg, #3498db, #2980b9);
            height: 100%;
            transition: width 0.3s ease;
            width: 0%;
        }

        .tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            margin-bottom: 20px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 140px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            background: #f8f9fa;
            border: none;
            font-size: 12px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .tab.active { background: #3498db; color: white; }

        .form-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .form-section.active { display: block; }

        .section-title {
            background: linear-gradient(45deg, #9b59b6, #8e44ad);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 600;
            font-size: 14px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .form-row.single { grid-template-columns: 1fr; }
        .form-row.triple { grid-template-columns: 1fr 1fr 1fr; }

        .form-group { margin-bottom: 15px; }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
            font-size: 13px;
        }

        input, textarea, select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 13px;
            transition: all 0.3s ease;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        textarea { resize: vertical; min-height: 70px; }

        .required { color: #e74c3c; }

        .help-text {
            font-size: 11px;
            color: #7f8c8d;
            margin-top: 3px;
        }

        .dynamic-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            margin: 10px 0;
        }

        .dynamic-table th {
            background: #3498db;
            color: white;
            padding: 10px;
            text-align: left;
            font-weight: 600;
            font-size: 12px;
        }

        .dynamic-table td {
            padding: 8px;
            border-bottom: 1px solid #ecf0f1;
        }

        .dynamic-table input, .dynamic-table select {
            border: 1px solid #ddd;
            padding: 5px;
            font-size: 12px;
        }

        .add-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
            margin: 8px 0;
        }

        .remove-btn {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 3px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 10px;
        }

        .submit-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .submit-btn, .preview-btn {
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            margin: 0 8px;
            border: none;
        }

        .submit-btn {
            background: linear-gradient(45deg, #27ae60, #2ecc71);
            color: white;
        }

        .preview-btn {
            background: linear-gradient(45deg, #f39c12, #e67e22);
            color: white;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
        }

        .total-box {
            background: #e8f5e8;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 5px solid #27ae60;
        }

        .total-line {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
            font-weight: bold;
        }

        .final-total {
            font-size: 18px;
            color: #2c3e50;
            border-top: 2px solid #27ae60;
            padding-top: 10px;
            margin-top: 10px;
        }

        .resumo-box {
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .resumo-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #bae6fd;
        }

        .btn-voltar {
            background: #6c757d;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 14px;
            transition: background-color 0.3s;
        }

        .btn-voltar:hover {
            background: #5a6268;
        }

        .resumo-item:last-child {
            border-bottom: none;
            font-size: 18px;
            font-weight: 700;
            color: #0c4a6e;
        }

        .cronograma-automatico-info {
            background: #e8f5e8;
            border: 1px solid #27ae60;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-size: 14px;
            color: #2c3e50;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container { padding: 10px; }
            .form-row, .form-row.triple { grid-template-columns: 1fr; }
            .tabs { flex-direction: column; }
            .tab { min-width: auto; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¢ Portal de Envio de Propostas</h1>
            <p>Sistema Profissional de Propostas T√©cnicas e Comerciais</p>
            <span style="position: absolute; top: 20px; right: 20px; background: #27ae60; color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px;">Sistema Funcional</span>
        </div>

        <div class="processo-info">
            <h2>üìã Processo: <input type="text" id="numeroProcesso" value="1600003456-150"></h2>
            <p><strong>Objeto:</strong> <input type="text" id="objetoProcesso" value="Exemplo de Processo"></p>
            <p><strong>Prazo para envio:</strong> <input type="text" id="prazoEnvio" value="31/12/2024"></p>
        </div>

        <div class="progress-container">
            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                <span><strong>Progresso:</strong> <span id="progressText">25%</span></span>
                <span style="font-size: 12px; color: #27ae60;">üíæ Auto-save ativo</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill" style="width: 25%;"></div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="showTab('dados', this)">üè¢ 1. Dados Cadastrais</button>
            <button class="tab" onclick="showTab('tecnica', this)">üìã 2. Proposta T√©cnica</button>
            <button class="tab" onclick="showTab('comercial', this)">üí∞ 3. Proposta Comercial</button>
            <button class="tab" onclick="showTab('resumo', this)">üìä 4. Resumo Proposta</button>
            <button class="tab" onclick="showTab('revisao', this)">üìã 5. Revis√£o</button>
        </div>

        <!-- SE√á√ÉO 1: DADOS CADASTRAIS -->
        <div class="form-section active" id="dados">
            <div class="section-title">üè¢ 1. Dados Cadastrais</div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="razaoSocial">Raz√£o Social <span class="required">*</span></label>
                    <input type="text" id="razaoSocial" required>
                </div>
                <div class="form-group">
                    <label for="cnpj">CNPJ <span class="required">*</span></label>
                    <input type="text" id="cnpj" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="endereco">Endere√ßo Completo</label>
                    <input type="text" id="endereco">
                </div>
                <div class="form-group">
                    <label for="cidade">Cidade/UF</label>
                    <input type="text" id="cidade">
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="telefone">Telefone</label>
                    <input type="tel" id="telefone">
                </div>
                <div class="form-group">
                    <label for="email">E-mail <span class="required">*</span></label>
                    <input type="email" id="email" required>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="respTecnico">Respons√°vel T√©cnico</label>
                    <input type="text" id="respTecnico">
                </div>
                <div class="form-group">
                    <label for="crea">CREA/CAU</label>
                    <input type="text" id="crea">
                </div>
            </div>
        </div>

        <!-- SE√á√ÉO 2: PROPOSTA T√âCNICA -->
        <div class="form-section" id="tecnica">
            <div class="section-title">üìã 2. Proposta T√©cnica</div>

            <div class="section-title">2.1 Objeto da Concorr√™ncia</div>
            <div class="form-group">
                <label for="objetoConcorrencia">Descri√ß√£o do Objeto <span class="required">*</span></label>
                <textarea id="objetoConcorrencia" rows="3" required></textarea>
                <div class="help-text">Transcreva exatamente conforme edital</div>
            </div>

            <div class="section-title">2.2 Descri√ß√£o Detalhada do Escopo</div>
            <div class="form-group">
                <label for="escopoInclusos">Servi√ßos a Executar</label>
                <textarea id="escopoInclusos" rows="4"></textarea>
            </div>
            <div class="form-group">
                <label for="escopoExclusos">Servi√ßos Ocultos</label>
                <textarea id="escopoExclusos" rows="3"></textarea>
            </div>

            <div class="section-title">2.3 Metodologia de Execu√ß√£o</div>
            <div class="form-group">
                <label for="metodologia">Detalhamento <span class="required">*</span></label>
                <textarea id="metodologia" rows="5" required></textarea>
            </div>
            <div class="form-group">
                <label for="sequenciaExecucao">Plano de Execu√ß√£o</label>
                <textarea id="sequenciaExecucao" rows="3"></textarea>
            </div>

            <div class="section-title">2.3.1 Tabela de Servi√ßos (sem valores)</div>
            <table class="dynamic-table" id="servicosTecnicaTable">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Descri√ß√£o</th>
                        <th>Unidade</th>
                        <th>Quantidade</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" value="1" readonly></td>
                        <td><input type="text" placeholder="Descri√ß√£o do servi√ßo"></td>
                        <td><input type="text" placeholder="m¬≤"></td>
                        <td><input type="number" placeholder="100"></td>
                        <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addServicoTecnicaRow()">+ Adicionar Servi√ßo</button>

            <div class="section-title">2.4 M√£o de Obra Direta e Indireta</div>
            <table class="dynamic-table" id="equipeTable">
                <thead>
                    <tr>
                        <th>Fun√ß√£o</th>
                        <th>Quantidade</th>
                        <th>Tempo (meses)</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Engenheiro Civil"></td>
                        <td><input type="number" placeholder="1"></td>
                        <td><input type="number" placeholder="4" step="0.1"></td>
                        <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addEquipeRow()">+ Adicionar Profissional</button>

            <div class="section-title">2.5 Lista de Materiais (Quantidades sem pre√ßos)</div>
            <table class="dynamic-table" id="materiaisTable">
                <thead>
                    <tr>
                        <th>Material</th>
                        <th>Especifica√ß√£o</th>
                        <th>Unidade</th>
                        <th>Quantidade</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Concreto"></td>
                        <td><input type="text" placeholder="FCK 25 MPa"></td>
                        <td><input type="text" placeholder="m¬≥"></td>
                        <td><input type="number" placeholder="450"></td>
                        <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addMaterialRow()">+ Adicionar Material</button>

            <div class="section-title">2.6 Lista de Equipamentos (Quantidades)</div>
            <table class="dynamic-table" id="equipamentosTable">
                <thead>
                    <tr>
                        <th>Equipamento</th>
                        <th>Especifica√ß√£o</th>
                        <th>Unidade</th>
                        <th>Quantidade</th>
                        <th>Tempo (meses)</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Betoneira"></td>
                        <td><input type="text" placeholder="400L"></td>
                        <td><input type="text" placeholder="und"></td>
                        <td><input type="number" placeholder="2"></td>
                        <td><input type="number" placeholder="4" step="0.1"></td>
                        <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addEquipamentoRow()">+ Adicionar Equipamento</button>

            <div class="section-title">2.9 Prazo de Execu√ß√£o</div>
            <div class="form-row single">
                <div class="form-group">
                    <label for="prazoExecucao">Prazo Total <span class="required">*</span></label>
                    <input type="text" id="prazoExecucao" placeholder="120 dias corridos" required readonly style="background: #f8f9fa;">
                </div>
            </div>

            <div class="section-title">2.10 Prazo de Mobiliza√ß√£o</div>
            <div class="form-row single">
                <div class="form-group">
                    <label for="prazoMobilizacao">Mobiliza√ß√£o</label>
                    <input type="text" id="prazoMobilizacao" placeholder="15 dias">
                </div>
            </div>

            <div class="section-title">2.11 Cronograma de Execu√ß√£o Automatizado</div>
            <div class="cronograma-automatico-info">
                <strong>üí° Cronograma Inteligente:</strong> Insira apenas a atividade e a dura√ß√£o em dias. 
                As datas de in√≠cio e fim ser√£o calculadas automaticamente de forma sequencial.
            </div>
            <table class="dynamic-table" id="cronogramaTable">
                <thead>
                    <tr>
                        <th>Atividade</th>
                        <th>Dura√ß√£o (dias)</th>
                        <th>In√≠cio (Calculado)</th>
                        <th>Fim (Calculado)</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Mobiliza√ß√£o" value="Mobiliza√ß√£o"></td>
                        <td><input type="number" placeholder="15" min="1" value="15" onchange="calcularCronograma()"></td>
                        <td><input type="text" readonly value="Dia 1" style="background: #f8f9fa;"></td>
                        <td><input type="text" readonly value="Dia 15" style="background: #f8f9fa;"></td>
                        <td><button type="button" class="remove-btn" onclick="removeRowAndRecalculate(this)">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addCronogramaRow()">+ Adicionar Atividade</button>
            <div style="text-align: right; margin-top: 10px; font-weight: bold; color: #2c3e50;">
                Prazo Total Calculado: <span id="prazoTotalCronograma">15</span> dias
            </div>

            <div class="section-title">2.12 Garantias Oferecidas</div>
            <div class="form-group">
                <label for="garantias">Garantias</label>
                <textarea id="garantias" rows="3" placeholder="5 anos para estrutura, 3 anos para acabamentos..."></textarea>
            </div>

            <div class="section-title">2.13 Necessidade de Canteiro</div>
            <div class="form-group">
                <label for="estruturaCanteiro">Estrutura do Canteiro</label>
                <textarea id="estruturaCanteiro" rows="3" placeholder="Escrit√≥rio, almoxarifado, vesti√°rios, refeit√≥rio"></textarea>
            </div>

            <div class="section-title">2.14 Obriga√ß√µes (Alimenta√ß√£o, Energia, etc.)</div>
            <div class="form-group">
                <label for="obrigacoesContratada">Responsabilidades da CONTRATADA</label>
                <textarea id="obrigacoesContratada" rows="3" placeholder="Alimenta√ß√£o, transporte, energia, etc."></textarea>
            </div>
            <div class="form-group">
                <label for="obrigacoesContratante">Responsabilidades da CONTRATANTE</label>
                <textarea id="obrigacoesContratante" rows="3"></textarea>
            </div>

            <div class="section-title">2.15 Experi√™ncia</div>
            <table class="dynamic-table" id="experienciaTable">
                <thead>
                    <tr>
                        <th>Obra</th>
                        <th>Cliente</th>
                        <th>Valor</th>
                        <th>Ano</th>
                        <th>Contato</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Nome da obra"></td>
                        <td><input type="text" placeholder="Cliente"></td>
                        <td><input type="text" placeholder="R$ 2.500.000"></td>
                        <td><input type="number" placeholder="2024"></td>
                        <td><input type="text" placeholder="(00) 0000-0000"></td>
                        <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addExperienciaRow()">+ Adicionar Obra</button>

            <div class="section-title">2.16 Certifica√ß√µes/Qualifica√ß√µes</div>
            <table class="dynamic-table" id="certificacoesTable">
                <thead>
                    <tr>
                        <th>Certifica√ß√£o</th>
                        <th>√ìrg√£o</th>
                        <th>Validade</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="ISO 9001"></td>
                        <td><input type="text" placeholder="√ìrg√£o"></td>
                        <td><input type="date"></td>
                        <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addCertificacaoRow()">+ Adicionar Certifica√ß√£o</button>
        </div>

        <!-- SE√á√ÉO 3: PROPOSTA COMERCIAL -->
        <div class="form-section" id="comercial">
            <div class="section-title">üí∞ 3. Proposta Comercial</div>

            <div class="section-title">3.1 Objeto da Concorr√™ncia</div>
            <div class="form-group">
                <label for="objetoComercial">Objeto (ser√° copiado da proposta t√©cnica)</label>
                <textarea id="objetoComercial" rows="2" readonly style="background: #f8f9fa;"></textarea>
            </div>

            <div class="section-title">3.2 Tabela de Servi√ßos por Item</div>
            <table class="dynamic-table" id="servicosTable">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th>Descri√ß√£o</th>
                        <th>Unid</th>
                        <th>Qtd</th>
                        <th>Pre√ßo Unit</th>
                        <th>Total</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="1"></td>
                        <td><input type="text" placeholder="Descri√ß√£o do servi√ßo"></td>
                        <td><input type="text" placeholder="m¬≥"></td>
                        <td><input type="number" placeholder="100" onchange="calcTotal(this)"></td>
                        <td><input type="number" placeholder="25.50" step="0.01" onchange="calcTotal(this)"></td>
                        <td><input type="text" readonly></td>
                        <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addServicoRow()">+ Adicionar Servi√ßo</button>
            
            <div style="text-align: right; margin: 10px 0; font-weight: bold;">
                <span>TOTAL SERVI√áOS: R$ <span id="totalServicos">0,00</span></span>
            </div>

            <div class="section-title">3.3 Pre√ßo Global</div>
            <div class="form-row">
                <div class="form-group">
                    <label for="valorTotal">Valor Total (Calculado Automaticamente)</label>
                    <input type="text" id="valorTotal" placeholder="R$ 0,00" readonly style="background: #f8f9fa; font-weight: bold; font-size: 16px;">
                </div>
                <div class="form-group">
                    <label for="validadeProposta">Validade da Proposta</label>
                    <input type="text" id="validadeProposta" placeholder="60 dias" value="60 dias">
                </div>
            </div>

            <div class="section-title">3.4 M√£o de Obra Direta e Indireta</div>
            <table class="dynamic-table" id="maoObraTable">
                <thead>
                    <tr>
                        <th>Fun√ß√£o</th>
                        <th>Quantidade</th>
                        <th>Tempo (meses)</th>
                        <th>Sal√°rio (R$)</th>
                        <th>Enc. Sociais (%)</th>
                        <th>Total Mensal (R$)</th>
                        <th>Total Geral (R$)</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Engenheiro Civil"></td>
                        <td><input type="number" placeholder="1" onchange="calcMaoObra(this)"></td>
                        <td><input type="number" placeholder="4" onchange="calcMaoObra(this)" step="0.1"></td>
                        <td><input type="number" placeholder="8500" onchange="calcMaoObra(this)" step="0.01"></td>
                        <td><input type="number" placeholder="80" value="80" onchange="calcMaoObra(this)" step="0.1"></td>
                        <td><input type="text" readonly></td>
                        <td><input type="text" readonly></td>
                        <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addMaoObraRow()">+ Adicionar Fun√ß√£o</button>
            
            <div style="text-align: right; margin: 10px 0; font-weight: bold;">
                <span>TOTAL M√ÉO DE OBRA: R$ <span id="totalMaoObra">0,00</span></span>
            </div>

            <div class="section-title">3.5 Lista de Materiais com Valores</div>
            <table class="dynamic-table" id="materiaisComercialTable">
                <thead>
                    <tr>
                        <th>Material</th>
                        <th>Especifica√ß√£o</th>
                        <th>Unidade</th>
                        <th>Quantidade</th>
                        <th>Pre√ßo Unit. (R$)</th>
                        <th>Total (R$)</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Concreto"></td>
                        <td><input type="text" placeholder="FCK 25 MPa"></td>
                        <td><input type="text" placeholder="m¬≥"></td>
                        <td><input type="number" placeholder="450" onchange="calcMaterial(this)"></td>
                        <td><input type="number" placeholder="320.50" step="0.01" onchange="calcMaterial(this)"></td>
                        <td><input type="text" readonly></td>
                        <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addMaterialComercialRow()">+ Adicionar Material</button>
            
            <div style="text-align: right; margin: 10px 0; font-weight: bold;">
                <span>TOTAL MATERIAIS: R$ <span id="totalMateriais">0,00</span></span>
            </div>

            <div class="section-title">3.6 Equipamentos com Pre√ßo Unit√°rio, Tempo e Quantidade</div>
            <table class="dynamic-table" id="equipamentosComercialTable">
                <thead>
                    <tr>
                        <th>Equipamento</th>
                        <th>Especifica√ß√£o</th>
                        <th>Quantidade</th>
                        <th>Tempo</th>
                        <th>Pre√ßo/m√™s (R$)</th>
                        <th>Total (R$)</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" placeholder="Betoneira"></td>
                        <td><input type="text" placeholder="400L"></td>
                        <td><input type="number" placeholder="2" onchange="calcEquipamento(this)"></td>
                        <td><input type="number" placeholder="4" step="0.1" onchange="calcEquipamento(this)"></td>
                        <td><input type="number" placeholder="1200" step="0.01" onchange="calcEquipamento(this)"></td>
                        <td><input type="text" readonly></td>
                        <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                    </tr>
                </tbody>
            </table>
            <button type="button" class="add-btn" onclick="addEquipamentoComercialRow()">+ Adicionar Equipamento</button>
            
            <div style="text-align: right; margin: 10px 0; font-weight: bold;">
                <span>TOTAL EQUIPAMENTOS: R$ <span id="totalEquipamentos">0,00</span></span>
            </div>

            <div class="section-title">3.7 BDI Detalhado</div>
            <table class="dynamic-table" id="bdiTable">
                <thead>
                    <tr>
                        <th>Item do BDI</th>
                        <th>Percentual (%)</th>
                        <th>Valor (R$)</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td><input type="text" value="Administra√ß√£o Central" readonly></td>
                        <td><input type="number" placeholder="8.0" step="0.1" onchange="calcBDI()"></td>
                        <td><input type="text" readonly></td>
                    </tr>
                    <tr>
                        <td><input type="text" value="Seguros e Garantias" readonly></td>
                        <td><input type="number" placeholder="1.5" step="0.1" onchange="calcBDI()"></td>
                        <td><input type="text" readonly></td>
                    </tr>
                    <tr>
                        <td><input type="text" value="Riscos" readonly></td>
                        <td><input type="number" placeholder="2.0" step="0.1" onchange="calcBDI()"></td>
                        <td><input type="text" readonly></td>
                    </tr>
                    <tr>
                        <td><input type="text" value="Despesas Financeiras" readonly></td>
                        <td><input type="number" placeholder="1.0" step="0.1" onchange="calcBDI()"></td>
                        <td><input type="text" readonly></td>
                    </tr>
                    <tr>
                        <td><input type="text" value="Lucro" readonly></td>
                        <td><input type="number" placeholder="8.0" step="0.1" onchange="calcBDI()"></td>
                        <td><input type="text" readonly></td>
                    </tr>
                    <tr>
                        <td><input type="text" value="Tributos (ISS, PIS, COFINS)" readonly></td>
                        <td><input type="number" placeholder="7.5" step="0.1" onchange="calcBDI()"></td>
                        <td><input type="text" readonly></td>
                    </tr>
                </tbody>
            </table>
            
            <div class="total-box">
                <div class="total-line">
                    <span>CUSTO DIRETO (MO + Mat + Equip):</span>
                    <span>R$ <span id="custoDirecto">0,00</span></span>
                </div>
                <div class="total-line" style="color: #27ae60;">
                    <span>BDI TOTAL:</span>
                    <span><span id="bdiPercentual">0.0</span>% = R$ <span id="bdiValor">0,00</span></span>
                </div>
                <div class="total-line final-total">
                    <span>VALOR TOTAL DA PROPOSTA:</span>
                    <span>R$ <span id="valorTotalCalculado">0,00</span></span>
                </div>
            </div>

            <div class="section-title">3.8 Condi√ß√µes</div>
            <div class="form-group">
                <label for="validadeDetalhada">Condi√ß√µes de Validade</label>
                <textarea id="validadeDetalhada" rows="3" placeholder="Proposta v√°lida por 60 dias. Pre√ßos sujeitos a reajuste ap√≥s este per√≠odo."></textarea>
            </div>
        </div>

        <!-- SE√á√ÉO 4: RESUMO DA PROPOSTA -->
        <div class="form-section" id="resumo">
            <div class="section-title">üìä 4. Resumo da Proposta</div>
            
            <div class="resumo-box">
                <div class="resumo-item">
                    <span>üí∞ Pre√ßo Total:</span>
                    <span><strong>R$ <span id="precoTotalResumo">0,00</span></strong></span>
                </div>
                <div class="resumo-item">
                    <span>‚è∞ Prazo de Execu√ß√£o:</span>
                    <span><strong><span id="prazoResumo">-- dias</span></strong></span>
                </div>
                <div class="resumo-item">
                    <span>üí≥ Condi√ß√£o de Pagamento:</span>
                    <span><strong><span id="pagamentoResumo">A definir</span></strong></span>
                </div>
            </div>

            <div class="form-row">
                <div class="form-group">
                    <label for="prazoExecucaoResumo">Prazo de Execu√ß√£o <span class="required">*</span></label>
                    <input type="text" id="prazoExecucaoResumo" placeholder="120 dias corridos" onchange="atualizarResumo()">
                </div>
                <div class="form-group">
                    <label for="formaPagamentoResumo">Condi√ß√£o de Pagamento</label>
                    <input type="text" id="formaPagamentoResumo" placeholder="30% entrada, 70% execu√ß√£o" onchange="atualizarResumo()">
                </div>
            </div>
        </div>

        <!-- SE√á√ÉO 5: REVIS√ÉO -->
        <div class="form-section" id="revisao">
            <div class="section-title">üìã 5. Revis√£o Final</div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <h3 style="color: #2c3e50; margin-bottom: 15px;">üìä Resumo da Proposta</h3>
                <p><strong>Empresa:</strong> <span id="empresaRevisao">N√£o informado</span></p>
                <p><strong>Processo:</strong> <span id="processoRevisao">1600003456-150</span></p>
                <p><strong>Objeto:</strong> <span id="objetoRevisao">Exemplo de Processo</span></p>
                <p><strong>Prazo de Execu√ß√£o:</strong> <span id="prazoRevisaoFinal">N√£o informado</span></p>
                <p><strong>Valor Total:</strong> R$ <span id="valorRevisaoFinal">0,00</span></p>
            </div>
            
            <div style="background: #e8f5e9; padding: 15px; border-radius: 10px; border-left: 5px solid #27ae60;">
                <h4 style="color: #27ae60;">‚úÖ Checklist de Documentos</h4>
                <ul style="list-style: none; padding-left: 0;">
                    <li>‚òëÔ∏è Dados cadastrais completos</li>
                    <li>‚òëÔ∏è Proposta t√©cnica detalhada</li>
                    <li>‚òëÔ∏è Proposta comercial com valores</li>
                    <li>‚òëÔ∏è BDI calculado</li>
                </ul>
            </div>
        </div>

        <div class="submit-section">
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <button type="button" class="btn-voltar" onclick="voltarDashboard()">
                    <i class="fas fa-arrow-left"></i> Voltar ao Dashboard
                </button>
                
                <button type="button" id="btnSalvarRascunho" class="submit-btn" style="background: #6c757d;" onclick="salvarRascunho()">
                    <i class="fas fa-save"></i> Salvar Rascunho
                </button>
                
                <button type="button" class="preview-btn" onclick="visualizarProposta()">
                    <i class="fas fa-eye"></i> Visualizar Proposta
                </button>
                
                <button type="button" class="submit-btn" style="background: linear-gradient(45deg, #27ae60, #2ecc71);" onclick="confirmarEnvio()">
                    <i class="fas fa-paper-plane"></i> Enviar Proposta Final
                </button>
            </div>
        
            <div id="mensagem" style="margin-top: 20px;"></div>
        </div>

    <script>
        let currentTab = 'dados';
        let enviandoProposta = false; // NOVA VARI√ÅVEL PARA CONTROLAR ENVIO

        // ===== INICIALIZA√á√ÉO COM DADOS DO DASHBOARD =====
        window.addEventListener('DOMContentLoaded', function() {
            // Verificar se veio do dashboard do fornecedor
            const dadosPortal = sessionStorage.getItem('dados_processo_portal');
            
            if (dadosPortal) {
                const dados = JSON.parse(dadosPortal);
                
                // Preencher automaticamente os dados do processo
                if (dados.processo) {
                    document.getElementById('numeroProcesso').value = dados.processo.numeroProcesso;
                    document.getElementById('objetoProcesso').value = dados.processo.objeto || dados.tr?.titulo || '';
                    document.getElementById('prazoEnvio').value = new Date(dados.processo.dataLimite).toLocaleDateString('pt-BR');
                    
                    // Desabilitar edi√ß√£o dos campos do processo
                    document.getElementById('numeroProcesso').readOnly = true;
                    document.getElementById('objetoProcesso').readOnly = true;
                    document.getElementById('prazoEnvio').readOnly = true;
                    
                    // Adicionar aviso visual
                    document.querySelector('.processo-info').style.background = 'linear-gradient(45deg, #2e7d32, #388e3c)';
                }
                
                // Preencher dados do fornecedor se dispon√≠vel
                if (dados.fornecedor) {
                    // Armazenar no window para uso posterior
                    window.fornecedorLogado = dados.fornecedor;
                    window.dadosOrigemDashboard = dados;
                    
                    // Se existir se√ß√£o de dados cadastrais, preencher
                    setTimeout(() => {
                        if (document.getElementById('razaoSocial')) {
                            document.getElementById('razaoSocial').value = dados.fornecedor.razaoSocial || '';
                            document.getElementById('cnpj').value = dados.fornecedor.cnpj || '';
                            document.getElementById('email').value = dados.fornecedor.email || '';
                            document.getElementById('telefone').value = dados.fornecedor.telefone || '';
                        }
                    }, 500);
                }
                
                // Armazenar TR completo para refer√™ncia
                if (dados.tr) {
                    window.trProcesso = dados.tr;
                }
                
                // Carregar dados da proposta existente
                if (dados.propostaExistente && dados.propostaExistente.dadosCompletos) {
                    carregarDadosPropostaExistente(dados.propostaExistente.dadosCompletos);
                }
                
                // NOVO: Carregar dados espec√≠ficos das tabelas
                const dadosTabelas = sessionStorage.getItem('dados_tabelas_proposta');
                if (dadosTabelas) {
                    try {
                        const tabelas = JSON.parse(dadosTabelas);
                        carregarDadosTabelas(tabelas);
                    } catch (error) {
                        console.error('Erro ao carregar dados das tabelas:', error);
                    }
                }
                
                // Limpar sessionStorage
                sessionStorage.removeItem('dados_processo_portal');
            }
            
            // Verificar modo visualiza√ß√£o
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('modo') === 'visualizacao') {
                const dadosVisualizacao = sessionStorage.getItem('visualizar_proposta_portal');
                if (dadosVisualizacao) {
                    carregarModoVisualizacao(JSON.parse(dadosVisualizacao));
                    sessionStorage.removeItem('visualizar_proposta_portal');
                }
            }
        });
    
        // ===== FUN√á√ïES DE NAVEGA√á√ÉO =====
        function showTab(tabName, buttonElement) {
            // Esconder todas as se√ß√µes
            document.querySelectorAll('.form-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remover classe active de todas as abas
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostrar se√ß√£o selecionada
            document.getElementById(tabName).classList.add('active');
            buttonElement.classList.add('active');
            
            currentTab = tabName;
            updateProgress();
            
            // A√ß√µes espec√≠ficas por aba
            if (tabName === 'comercial') {
                copiarObjetoParaComercial();
                copiarDadosTecnicaParaComercial();
            }
            
            if (tabName === 'resumo') {
                atualizarResumo();
            }
            
            if (tabName === 'revisao') {
                gerarRevisao();
            }
        }

        function updateProgress() {
            const tabs = ['dados', 'tecnica', 'comercial', 'resumo', 'revisao'];
            const currentIndex = tabs.indexOf(currentTab);
            const progress = ((currentIndex + 1) / tabs.length) * 100;
            
            document.getElementById('progressFill').style.width = progress + '%';
            document.getElementById('progressText').textContent = Math.round(progress) + '%';
        }

        // ===== FUN√á√ïES DE ATUALIZA√á√ÉO =====
        function atualizarResumo() {
            const prazo = document.getElementById('prazoExecucaoResumo').value;
            const pagamento = document.getElementById('formaPagamentoResumo').value;
            const valorTotal = document.getElementById('valorTotalCalculado').textContent;
            
            document.getElementById('prazoResumo').textContent = prazo || '-- dias';
            document.getElementById('pagamentoResumo').textContent = pagamento || 'A definir';
            document.getElementById('precoTotalResumo').textContent = valorTotal;
        }

        function copiarObjetoParaComercial() {
            const objetoTecnico = document.getElementById('objetoConcorrencia').value;
            document.getElementById('objetoComercial').value = objetoTecnico;
        }

        // ===== FUN√á√ÉO CORRIGIDA PARA COPIAR DADOS DA T√âCNICA PARA COMERCIAL =====
        function copiarDadosTecnicaParaComercial() {
            // Copiar servi√ßos t√©cnicos para comerciais
            copiarServicosTecnicaParaComercial();
            
            // Copiar m√£o de obra t√©cnica para comercial
            copiarMaoObraTecnicaParaComercial();
            
            // Copiar materiais t√©cnicos para comerciais
            copiarMateriaisTecnicaParaComercial();
            
            // Copiar equipamentos t√©cnicos para comerciais
            copiarEquipamentosTecnicaParaComercial();
        }

        function copiarServicosTecnicaParaComercial() {
            const servicosTecnica = coletarTabela('servicosTecnicaTable');
            const tbody = document.querySelector('#servicosTable tbody');
            
            // Preservar valores comerciais existentes
            const valoresAtuais = {};
            document.querySelectorAll('#servicosTable tbody tr').forEach((row, index) => {
                const qtd = row.cells[3].querySelector('input')?.value;
                const preco = row.cells[4].querySelector('input')?.value;
                if (qtd || preco) {
                    valoresAtuais[index] = { qtd, preco };
                }
            });
            
            tbody.innerHTML = '';
            
            servicosTecnica.forEach((servico, index) => {
                const valores = valoresAtuais[index] || {};
                const quantidadeTecnica = servico[3] || '';
                const quantidadeComercial = valores.qtd || quantidadeTecnica;
                
                const newRow = tbody.insertRow();
                newRow.innerHTML = `
                    <td><input type="text" value="${index + 1}" readonly></td>
                    <td><input type="text" value="${servico[1] || ''}" readonly style="background: #f8f9fa;"></td>
                    <td><input type="text" value="${servico[2] || ''}" readonly style="background: #f8f9fa;"></td>
                    <td><input type="number" placeholder="100" value="${quantidadeComercial}" onchange="calcTotal(this)"></td>
                    <td><input type="number" placeholder="50.00" step="0.01" value="${valores.preco || ''}" onchange="calcTotal(this)"></td>
                    <td><input type="text" readonly></td>
                    <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                `;
                
                if (quantidadeComercial && valores.preco) {
                    calcTotal(newRow.cells[3].querySelector('input'));
                }
            });
        }

        function copiarMaoObraTecnicaParaComercial() {
            const maoObraTecnica = coletarTabela('equipeTable');
            const tbody = document.querySelector('#maoObraTable tbody');
            
            // Preservar sal√°rios existentes
            const salariosAtuais = {};
            document.querySelectorAll('#maoObraTable tbody tr').forEach((row, index) => {
                const salario = row.cells[3].querySelector('input')?.value;
                const encargos = row.cells[4].querySelector('input')?.value;
                if (salario) {
                    salariosAtuais[index] = { salario, encargos: encargos || '80' };
                }
            });
            
            tbody.innerHTML = '';
            
            maoObraTecnica.forEach((item, index) => {
                const valores = salariosAtuais[index] || {};
                const newRow = tbody.insertRow();
                newRow.innerHTML = `
                    <td><input type="text" value="${item[0] || ''}" readonly style="background: #f8f9fa;"></td>
                    <td><input type="number" value="${item[1] || ''}" readonly style="background: #f8f9fa;"></td>
                    <td><input type="number" value="${item[2] || ''}" readonly style="background: #f8f9fa;" step="0.1"></td>
                    <td><input type="number" placeholder="3500" value="${valores.salario || ''}" onchange="calcMaoObra(this)" step="0.01"></td>
                    <td><input type="number" placeholder="80" value="${valores.encargos || '80'}" onchange="calcMaoObra(this)" step="0.1"></td>
                    <td><input type="text" readonly></td>
                    <td><input type="text" readonly></td>
                    <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                `;
                
                if (valores.salario) {
                    calcMaoObra(newRow.cells[3].querySelector('input'));
                }
            });
        }

        function copiarMateriaisTecnicaParaComercial() {
            const materiaisTecnica = coletarTabela('materiaisTable');
            const tbody = document.querySelector('#materiaisComercialTable tbody');
            
            // Preservar pre√ßos existentes
            const precosMateriais = {};
            document.querySelectorAll('#materiaisComercialTable tbody tr').forEach((row, index) => {
                const preco = row.cells[4].querySelector('input')?.value;
                if (preco) {
                    precosMateriais[index] = preco;
                }
            });
            
            tbody.innerHTML = '';
            
            materiaisTecnica.forEach((item, index) => {
                const preco = precosMateriais[index] || '';
                const newRow = tbody.insertRow();
                newRow.innerHTML = `
                    <td><input type="text" value="${item[0] || ''}" readonly style="background: #f8f9fa;"></td>
                    <td><input type="text" value="${item[1] || ''}" readonly style="background: #f8f9fa;"></td>
                    <td><input type="text" value="${item[2] || ''}" readonly style="background: #f8f9fa;"></td>
                    <td><input type="number" value="${item[3] || ''}" readonly style="background: #f8f9fa;"></td>
                    <td><input type="number" placeholder="50.00" step="0.01" value="${preco}" onchange="calcMaterial(this)"></td>
                    <td><input type="text" readonly></td>
                    <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                `;
                
                if (preco) {
                    calcMaterial(newRow.cells[4].querySelector('input'));
                }
            });
        }

        function copiarEquipamentosTecnicaParaComercial() {
            const equipamentosTecnica = coletarTabela('equipamentosTable');
            const tbody = document.querySelector('#equipamentosComercialTable tbody');
            
            // Preservar pre√ßos existentes
            const precosEquipamentos = {};
            document.querySelectorAll('#equipamentosComercialTable tbody tr').forEach((row, index) => {
                const preco = row.cells[4].querySelector('input')?.value;
                if (preco) {
                    precosEquipamentos[index] = preco;
                }
            });
            
            tbody.innerHTML = '';
            
            equipamentosTecnica.forEach((item, index) => {
                const preco = precosEquipamentos[index] || '';
                const newRow = tbody.insertRow();
                newRow.innerHTML = `
                    <td><input type="text" value="${item[0] || ''}" readonly style="background: #f8f9fa;"></td>
                    <td><input type="text" value="${item[1] || ''}" readonly style="background: #f8f9fa;"></td>
                    <td><input type="number" value="${item[3] || ''}" readonly style="background: #f8f9fa;"></td>
                    <td><input type="number" value="${item[4] || ''}" readonly style="background: #f8f9fa;" step="0.1"></td>
                    <td><input type="number" placeholder="800" step="0.01" value="${preco}" onchange="calcEquipamento(this)"></td>
                    <td><input type="text" readonly></td>
                    <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                `;
                
                if (preco) {
                    calcEquipamento(newRow.cells[4].querySelector('input'));
                }
            });
        }

        function coletarTabela(tableId) {
            const dados = [];
            const rows = document.querySelectorAll(`#${tableId} tbody tr`);
            
            rows.forEach(row => {
                const rowData = [];
                row.querySelectorAll('input').forEach(input => {
                    rowData.push(input.value);
                });
                if (rowData.some(val => val !== '')) {
                    dados.push(rowData);
                }
            });
            
            return dados;
        }

        // ===== CRONOGRAMA AUTOM√ÅTICO =====
        function addCronogramaRow() {
            const tbody = document.querySelector('#cronogramaTable tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" placeholder="Nova Atividade"></td>
                <td><input type="number" placeholder="10" min="1" onchange="calcularCronograma()"></td>
                <td><input type="text" readonly style="background: #f8f9fa;"></td>
                <td><input type="text" readonly style="background: #f8f9fa;"></td>
                <td><button type="button" class="remove-btn" onclick="removeRowAndRecalculate(this)">√ó</button></td>
            `;
            calcularCronograma();
        }

        function calcularCronograma() {
            const tbody = document.querySelector('#cronogramaTable tbody');
            let diaAtual = 1;
            let prazoTotal = 0;
            
            for (const row of tbody.rows) {
                const duracaoInput = row.cells[1].querySelector('input');
                const duracao = parseInt(duracaoInput.value) || 0;
                
                if (duracao > 0) {
                    const diaFim = diaAtual + duracao - 1;
                    row.cells[2].querySelector('input').value = `Dia ${diaAtual}`;
                    row.cells[3].querySelector('input').value = `Dia ${diaFim}`;
                    diaAtual = diaFim + 1;
                    prazoTotal += duracao;
                } else {
                    row.cells[2].querySelector('input').value = '';
                    row.cells[3].querySelector('input').value = '';
                }
            }
            
            document.getElementById('prazoTotalCronograma').textContent = prazoTotal;
            document.getElementById('prazoExecucao').value = `${prazoTotal} dias`;
        }

        function removeRowAndRecalculate(button) {
            button.closest('tr').remove();
            calcularCronograma();
        }

        // ===== FUN√á√ïES PARA ADICIONAR LINHAS =====
        function addServicoTecnicaRow() {
            const tbody = document.querySelector('#servicosTecnicaTable tbody');
            const nextItem = tbody.rows.length + 1;
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" value="${nextItem}" readonly></td>
                <td><input type="text" placeholder="Descri√ß√£o do servi√ßo"></td>
                <td><input type="text" placeholder="m¬≤"></td>
                <td><input type="number" placeholder="100"></td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
            `;
        }

        function addEquipeRow() {
            const tbody = document.querySelector('#equipeTable tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" placeholder="Fun√ß√£o"></td>
                <td><input type="number" placeholder="1"></td>
                <td><input type="number" placeholder="4" step="0.1"></td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
            `;
        }

        function addMaterialRow() {
            const tbody = document.querySelector('#materiaisTable tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" placeholder="Material"></td>
                <td><input type="text" placeholder="Especifica√ß√£o"></td>
                <td><input type="text" placeholder="Unidade"></td>
                <td><input type="number" placeholder="Quantidade"></td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
            `;
        }

        function addEquipamentoRow() {
            const tbody = document.querySelector('#equipamentosTable tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" placeholder="Equipamento"></td>
                <td><input type="text" placeholder="Especifica√ß√£o"></td>
                <td><input type="text" placeholder="Unidade"></td>
                <td><input type="number" placeholder="Quantidade"></td>
                <td><input type="number" placeholder="4" step="0.1"></td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
            `;
        }

        function addExperienciaRow() {
            const tbody = document.querySelector('#experienciaTable tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" placeholder="Nome da obra"></td>
                <td><input type="text" placeholder="Cliente"></td>
                <td><input type="text" placeholder="R$ 2.500.000"></td>
                <td><input type="number" placeholder="2024"></td>
                <td><input type="text" placeholder="(00) 0000-0000"></td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
            `;
        }

        function addCertificacaoRow() {
            const tbody = document.querySelector('#certificacoesTable tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" placeholder="ISO 9001"></td>
                <td><input type="text" placeholder="√ìrg√£o"></td>
                <td><input type="date"></td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
            `;
        }

        function addServicoRow() {
            const tbody = document.querySelector('#servicosTable tbody');
            const nextItem = tbody.rows.length + 1;
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" value="${nextItem}" placeholder="${nextItem}"></td>
                <td><input type="text" placeholder="Descri√ß√£o"></td>
                <td><input type="text" placeholder="m¬≤"></td>
                <td><input type="number" placeholder="100" onchange="calcTotal(this)"></td>
                <td><input type="number" placeholder="50.00" step="0.01" onchange="calcTotal(this)"></td>
                <td><input type="text" readonly></td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
            `;
        }

        function addMaoObraRow() {
            const tbody = document.querySelector('#maoObraTable tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" placeholder="Ex: Pedreiro"></td>
                <td><input type="number" placeholder="5" onchange="calcMaoObra(this)"></td>
                <td><input type="number" placeholder="4" step="0.1" onchange="calcMaoObra(this)"></td>
                <td><input type="number" placeholder="3500" step="0.01" onchange="calcMaoObra(this)"></td>
                <td><input type="number" placeholder="80" value="80" step="0.1" onchange="calcMaoObra(this)"></td>
                <td><input type="text" readonly></td>
                <td><input type="text" readonly></td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
            `;
        }

        function addMaterialComercialRow() {
            const tbody = document.querySelector('#materiaisComercialTable tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" placeholder="Material"></td>
                <td><input type="text" placeholder="Especifica√ß√£o"></td>
                <td><input type="text" placeholder="Unidade"></td>
                <td><input type="number" placeholder="100" onchange="calcMaterial(this)"></td>
                <td><input type="number" placeholder="50.00" step="0.01" onchange="calcMaterial(this)"></td>
                <td><input type="text" readonly></td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
            `;
        }

        function addEquipamentoComercialRow() {
            const tbody = document.querySelector('#equipamentosComercialTable tbody');
            const newRow = tbody.insertRow();
            newRow.innerHTML = `
                <td><input type="text" placeholder="Equipamento"></td>
                <td><input type="text" placeholder="Especifica√ß√£o"></td>
                <td><input type="number" placeholder="1" onchange="calcEquipamento(this)"></td>
                <td><input type="number" placeholder="3" step="0.1" onchange="calcEquipamento(this)"></td>
                <td><input type="number" placeholder="800" step="0.01" onchange="calcEquipamento(this)"></td>
                <td><input type="text" readonly></td>
                <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
            `;
        }

        function removeRow(button) {
            const row = button.closest('tr');
            row.remove();
            calcularTotais();
        }

        // ===== C√ÅLCULOS FINANCEIROS CORRIGIDOS =====
        function formatarMoeda(valor) {
            if (!valor && valor !== 0) return '0,00';
            let numero = parseFloat(valor);
            if (isNaN(numero)) return '0,00';
            return numero.toLocaleString('pt-BR', {
                minimumFractionDigits: 2,
                maximumFractionDigits: 2
            });
        }

        function limparMoeda(valor) {
            if (!valor) return 0;
            // Remove tudo exceto n√∫meros, v√≠rgulas e pontos
            let numero = valor.toString().replace(/[^\d,.-]/g, '');
            // Se tem v√≠rgula e ponto, assume que v√≠rgula √© separador de milhares
            if (numero.includes('.') && numero.includes(',')) {
                numero = numero.replace(/\./g, '').replace(',', '.');
            } else if (numero.includes(',')) {
                // Se s√≥ tem v√≠rgula, assume que √© separador decimal
                numero = numero.replace(',', '.');
            }
            return parseFloat(numero) || 0;
        }

        function calcTotal(input) {
            const row = input.closest('tr');
            const cells = row.cells;
            const qtdInput = cells[3].querySelector('input');
            const precoInput = cells[4].querySelector('input');
            const totalInput = cells[5].querySelector('input');
            
            const qtd = parseFloat(qtdInput.value) || 0;
            const preco = limparMoeda(precoInput.value) || 0;
            const total = qtd * preco;

            totalInput.value = formatarMoeda(total);
            
            calcularTotalServicos();
            calcularTotais();
        }

        function calcMaoObra(input) {
            const row = input.closest('tr');
            const cells = row.cells;
            const qtd = parseFloat(cells[1].querySelector('input').value) || 0;
            const tempo = parseFloat(cells[2].querySelector('input').value) || 0;
            const salario = limparMoeda(cells[3].querySelector('input').value) || 0;
            const encargos = parseFloat(cells[4].querySelector('input').value) || 0;
            
            if (qtd && tempo && salario) {
                const salarioComEncargos = salario * (1 + encargos/100);
                const totalMensal = qtd * salarioComEncargos;
                const totalGeral = totalMensal * tempo;
                
                cells[5].querySelector('input').value = formatarMoeda(totalMensal);
                cells[6].querySelector('input').value = formatarMoeda(totalGeral);
            }
            
            calcularTotalMaoObra();
            calcularTotais();
        }

        function calcMaterial(input) {
            const row = input.closest('tr');
            const cells = row.cells;
            const qtd = parseFloat(cells[3].querySelector('input').value) || 0;
            const preco = limparMoeda(cells[4].querySelector('input').value) || 0;
            const total = qtd * preco;
            
            cells[5].querySelector('input').value = formatarMoeda(total);
            
            calcularTotalMateriais();
            calcularTotais();
        }

        function calcEquipamento(input) {
            const row = input.closest('tr');
            const cells = row.cells;
            const qtd = parseFloat(cells[2].querySelector('input').value) || 0;
            const tempo = parseFloat(cells[3].querySelector('input').value) || 0;
            const preco = limparMoeda(cells[4].querySelector('input').value) || 0;
            const total = qtd * tempo * preco;
            
            cells[5].querySelector('input').value = formatarMoeda(total);
            
            calcularTotalEquipamentos();
            calcularTotais();
        }

        function calcularTotalServicos() {
            let total = 0;
            document.querySelectorAll('#servicosTable tbody tr').forEach(row => {
                const valorCell = row.cells[5].querySelector('input');
                if (valorCell && valorCell.value) {
                    const valor = limparMoeda(valorCell.value);
                    total += valor;
                }
            });
            document.getElementById('totalServicos').textContent = formatarMoeda(total);
            return total;
        }

        function calcularTotalMaoObra() {
            let total = 0;
            document.querySelectorAll('#maoObraTable tbody tr').forEach(row => {
                const valorCell = row.cells[6].querySelector('input');
                if (valorCell) {
                    const valor = limparMoeda(valorCell.value);
                    total += valor;
                }
            });
            document.getElementById('totalMaoObra').textContent = formatarMoeda(total);
            return total;
        }

        function calcularTotalMateriais() {
            let total = 0;
            document.querySelectorAll('#materiaisComercialTable tbody tr').forEach(row => {
                const valorCell = row.cells[5].querySelector('input');
                if (valorCell) {
                    const valor = limparMoeda(valorCell.value);
                    total += valor;
                }
            });
            document.getElementById('totalMateriais').textContent = formatarMoeda(total);
            return total;
        }

        function calcularTotalEquipamentos() {
            let total = 0;
            document.querySelectorAll('#equipamentosComercialTable tbody tr').forEach(row => {
                const valorCell = row.cells[5].querySelector('input');
                if (valorCell) {
                    const valor = limparMoeda(valorCell.value);
                    total += valor;
                }
            });
            document.getElementById('totalEquipamentos').textContent = formatarMoeda(total);
            return total;
        }

        function calcBDI() {
            const custoDirecto = calcularCustoDirecto();
            let totalBDI = 0;
            
            document.querySelectorAll('#bdiTable tbody tr').forEach(row => {
                const percentualInput = row.cells[1].querySelector('input');
                const valorInput = row.cells[2].querySelector('input');
                
                if (percentualInput && valorInput) {
                    const percentual = parseFloat(percentualInput.value) || 0;
                    const valor = custoDirecto * (percentual / 100);
                    valorInput.value = formatarMoeda(valor);
                    totalBDI += percentual;
                }
            });
            
            const valorBDI = custoDirecto * (totalBDI / 100);
            const valorTotal = custoDirecto + valorBDI;
            
            document.getElementById('bdiPercentual').textContent = totalBDI.toFixed(1);
            document.getElementById('bdiValor').textContent = formatarMoeda(valorBDI);
            document.getElementById('valorTotalCalculado').textContent = formatarMoeda(valorTotal);
            
            document.getElementById('valorTotal').value = 'R$ ' + formatarMoeda(valorTotal);
            
            atualizarResumo();
        }

        function calcularCustoDirecto() {
            const maoObra = calcularTotalMaoObra();
            const materiais = calcularTotalMateriais();
            const equipamentos = calcularTotalEquipamentos();
            const total = maoObra + materiais + equipamentos;
            
            document.getElementById('custoDirecto').textContent = formatarMoeda(total);
            return total;
        }

        function calcularTotais() {
            calcularCustoDirecto();
            calcBDI();
        }

        // ===== FUN√á√ïES DE REVIS√ÉO E ENVIO =====
        function gerarRevisao() {
            const valorTotal = document.getElementById('valorTotalCalculado').textContent || '0,00';
            const prazo = document.getElementById('prazoExecucao').value || 'N√£o informado';
            const empresa = document.getElementById('razaoSocial').value || 'N√£o informado';
            
            document.getElementById('empresaRevisao').textContent = empresa;
            document.getElementById('processoRevisao').textContent = document.getElementById('numeroProcesso').value;
            document.getElementById('objetoRevisao').textContent = document.getElementById('objetoProcesso').value;
            document.getElementById('prazoRevisaoFinal').textContent = prazo;
            document.getElementById('valorRevisaoFinal').textContent = valorTotal;
        }

        function visualizarProposta() {
            const protocolo = 'PREV-' + Date.now();
            
            // Coletar todos os dados
            const dados = coletarDadosCompletos();
            
            const preview = window.open('', '_blank');
            preview.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Preview - Proposta ${protocolo}</title>
                    <style>
                        body { 
                            font-family: Arial, sans-serif; 
                            margin: 40px; 
                            color: #333;
                            line-height: 1.6;
                        }
                        h1, h2, h3 { color: #2c3e50; }
                        table { 
                            width: 100%; 
                            border-collapse: collapse; 
                            margin: 20px 0; 
                        }
                        th, td { 
                            border: 1px solid #ddd; 
                            padding: 8px; 
                            text-align: left; 
                        }
                        th { 
                            background: #f0f0f0; 
                        }
                        .section { 
                            margin: 30px 0; 
                            padding: 20px;
                            background: #f8f9fa;
                            border-radius: 8px;
                        }
                        .total { 
                            font-weight: bold; 
                            color: #27ae60; 
                            font-size: 24px;
                        }
                        .header {
                            text-align: center;
                            border-bottom: 2px solid #3498db;
                            padding-bottom: 20px;
                            margin-bottom: 30px;
                        }
                        @media print {
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>PROPOSTA T√âCNICA E COMERCIAL</h1>
                        <p><strong>Protocolo:</strong> ${protocolo}</p>
                        <p><strong>Data:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>
                        <p><strong>Processo:</strong> ${dados.processo.numero}</p>
                    </div>
                    
                    <div class="section">
                        <h2>1. DADOS DA EMPRESA</h2>
                        <p><strong>Raz√£o Social:</strong> ${dados.dadosCadastrais.razaoSocial}</p>
                        <p><strong>CNPJ:</strong> ${dados.dadosCadastrais.cnpj}</p>
                        <p><strong>E-mail:</strong> ${dados.dadosCadastrais.email}</p>
                        <p><strong>Telefone:</strong> ${dados.dadosCadastrais.telefone}</p>
                        <p><strong>Endere√ßo:</strong> ${dados.dadosCadastrais.endereco}, ${dados.dadosCadastrais.cidade}</p>
                        <p><strong>Respons√°vel T√©cnico:</strong> ${dados.dadosCadastrais.respTecnico} - ${dados.dadosCadastrais.crea}</p>
                    </div>
                    
                    <div class="section">
                        <h2>2. OBJETO</h2>
                        <p>${dados.propostaTecnica.objetoConcorrencia}</p>
                    </div>
                    
                    <div class="section">
                        <h2>3. PROPOSTA COMERCIAL</h2>
                        <p class="total">VALOR TOTAL: R$ ${dados.propostaComercial.valorTotal}</p>
                        <p><strong>Validade da Proposta:</strong> ${dados.propostaComercial.validadeProposta}</p>
                        <p><strong>Prazo de Execu√ß√£o:</strong> ${dados.propostaTecnica.prazoExecucao}</p>
                        <p><strong>Condi√ß√µes de Pagamento:</strong> ${dados.resumo.formaPagamento}</p>
                    </div>
                    
                    <p class="no-print" style="text-align: center; margin-top: 50px;">
                        <button onclick="window.print()" style="padding: 10px 20px; margin: 5px;">üñ®Ô∏è Imprimir</button>
                        <button onclick="window.close()" style="padding: 10px 20px; margin: 5px;">‚ùå Fechar</button>
                    </p>
                </body>
                </html>
            `);
        }

        // Fun√ß√£o para confirmar envio - CORRIGIDA
        function confirmarEnvio() {
            // Verificar se j√° est√° enviando
            if (enviandoProposta) {
                mostrarMensagem('‚è≥ Aguarde, proposta sendo enviada...', 'warning');
                return;
            }
            
            // Validar campos obrigat√≥rios primeiro
            const camposObrigatorios = ['razaoSocial', 'cnpj', 'email', 'objetoConcorrencia'];
            let tudoPreenchido = true;
            
            for (const campo of camposObrigatorios) {
                const elemento = document.getElementById(campo);
                if (!elemento || !elemento.value.trim()) {
                    tudoPreenchido = false;
                    if (elemento) {
                        elemento.style.borderColor = '#e74c3c';
                    }
                }
            }
            
            if (!tudoPreenchido) {
                mostrarMensagem('‚ö†Ô∏è Por favor, preencha todos os campos obrigat√≥rios (*) antes de enviar', 'error');
                return;
            }
            
            // Mostrar confirma√ß√£o detalhada
            const valorTotal = document.getElementById('valorTotalCalculado').textContent;
            const prazo = document.getElementById('prazoExecucao').value;
            
            const confirmacao = confirm(`
üöÄ CONFIRMAR ENVIO DA PROPOSTA FINAL

Valor Total: R$ ${valorTotal}
Prazo de Execu√ß√£o: ${prazo}

‚ö†Ô∏è ATEN√á√ÉO:
- Ap√≥s o envio, a proposta N√ÉO poder√° ser alterada
- Voc√™ receber√° um protocolo de confirma√ß√£o
- A proposta ser√° enviada ao setor de compras

Deseja realmente enviar a proposta?
            `);
            
            if (confirmacao) {
                enviarProposta();
            }
        }
        
// Fun√ß√£o enviarProposta - CORRIGIDA
async function enviarProposta() {
    // Verificar se j√° est√° enviando
    if (typeof enviandoProposta !== 'undefined' && enviandoProposta) {
        return;
    }
    
    window.enviandoProposta = true;
    
    // Valida√ß√µes b√°sicas
    const camposObrigatorios = ['razaoSocial', 'cnpj', 'email', 'objetoConcorrencia'];
    let tudoPreenchido = true;
    
    for (const campo of camposObrigatorios) {
        const elemento = document.getElementById(campo);
        if (!elemento || !elemento.value.trim()) {
            tudoPreenchido = false;
            if (elemento) {
                elemento.style.borderColor = '#e74c3c';
            }
        }
    }
    
    if (!tudoPreenchido) {
        mostrarMensagem('Por favor, preencha todos os campos obrigat√≥rios (*)', 'error');
        window.enviandoProposta = false;
        return;
    }
    
    // Mostrar loading
    const submitBtn = document.querySelector('.submit-btn[onclick="confirmarEnvio()"]');
    if (!submitBtn) {
        window.enviandoProposta = false;
        return;
    }
    
    const originalText = submitBtn.innerHTML;
    submitBtn.innerHTML = '<span class="loading"></span> Enviando...';
    submitBtn.disabled = true;
    
    try {
        // Simular envio
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Gerar protocolo √∫nico
        const protocolo = 'PROP-' + Date.now();
        
        // CORRE√á√ÉO: Coletar TODOS os dados completos
        const dadosCompletos = coletarDadosCompletos();
        
        // Preparar dados para salvar
        const propostaParaSalvar = {
            id: Date.now().toString(36) + Math.random().toString(36).substr(2),
            protocolo: protocolo,
            numeroProcesso: document.getElementById('numeroProcesso').value,
            fornecedorCNPJ: document.getElementById('cnpj').value,
            fornecedorRazaoSocial: document.getElementById('razaoSocial').value,
            fornecedorEmail: document.getElementById('email').value,
            valor: parseFloat(String(dadosCompletos.propostaComercial.valorTotal || '0').replace(/[^\d.,]/g, '').replace(',', '.')) || 0,
            prazoExecucao: dadosCompletos.propostaTecnica.prazoExecucao,
            condicoesPagamento: dadosCompletos.resumo.formaPagamento,
            validadeProposta: dadosCompletos.propostaComercial.validadeProposta,
            garantia: dadosCompletos.propostaTecnica.garantias,
            metodologia: dadosCompletos.propostaTecnica.metodologia,
            descricao_tecnica: dadosCompletos.propostaTecnica.metodologia,
            experiencia: dadosCompletos.propostaTecnica.experiencia ? 'Sim' : 'N√£o informado',
            equipeTecnica: dadosCompletos.propostaTecnica.equipe ? 'Conforme detalhado' : 'N√£o informado',
            telefone: dadosCompletos.dadosCadastrais.telefone,
            endereco: dadosCompletos.dadosCadastrais.endereco,
            cidade: dadosCompletos.dadosCadastrais.cidade,
            responsavel: dadosCompletos.dadosCadastrais.respTecnico,
            crea: dadosCompletos.dadosCadastrais.crea,
            objeto: dadosCompletos.propostaTecnica.objetoConcorrencia,
            escopo: dadosCompletos.propostaTecnica.escopoInclusos,
            cronograma: dadosCompletos.propostaTecnica.cronograma ? 'Conforme detalhado' : 'A definir',
            status: 'ENVIADA',
            dataEnvio: new Date().toISOString(),
            dadosCompletos: dadosCompletos // IMPORTANTE: Salvar dados completos
        };
        
        // Salvar em propostas_fornecedores
        if (window.fornecedorLogado && window.dadosOrigemDashboard) {
            const propostasFornecedores = JSON.parse(localStorage.getItem('propostas_fornecedores') || '[]');
            
            // Remover rascunhos anteriores
            const propostasFiltradas = propostasFornecedores.filter(p => 
                !(p.processoId === window.dadosOrigemDashboard.processo.processoId && 
                  p.fornecedorId === window.fornecedorLogado.id)
            );
            
            // Adicionar proposta com processId correto
            propostaParaSalvar.processoId = window.dadosOrigemDashboard.processo.processoId;
            propostaParaSalvar.fornecedorId = window.fornecedorLogado.id;
            
            propostasFiltradas.push(propostaParaSalvar);
            localStorage.setItem('propostas_fornecedores', JSON.stringify(propostasFiltradas));
        }
        
        // Salvar tamb√©m em propostas_comparativo
        const propostasComparativo = JSON.parse(localStorage.getItem('propostas_comparativo') || '[]');
        const propostasComparativoFiltradas = propostasComparativo.filter(p => 
            !(p.numeroProcesso === propostaParaSalvar.numeroProcesso && 
              p.fornecedorCNPJ === propostaParaSalvar.fornecedorCNPJ)
        );
        propostasComparativoFiltradas.push(propostaParaSalvar);
        localStorage.setItem('propostas_comparativo', JSON.stringify(propostasComparativoFiltradas));
        
        // Sucesso
        mostrarMensagem(`
            <strong>‚úÖ Proposta enviada com sucesso!</strong><br>
            <strong>Protocolo:</strong> ${protocolo}<br>
            <strong>Data/Hora:</strong> ${new Date().toLocaleString('pt-BR')}<br>
            <small>üìß E-mail de confirma√ß√£o enviado</small>
        `, 'success');
        
        // Desabilitar edi√ß√£o
        document.querySelectorAll('input, textarea, select').forEach(el => {
            el.disabled = true;
        });
        
    } catch (error) {
        console.error('Erro ao enviar proposta:', error);
        mostrarMensagem(`
            <strong>‚ùå Erro ao enviar proposta</strong><br>
            ${error.message}<br>
            <small>Tente novamente em alguns instantes</small>
        `, 'error');
    } finally {
        if (submitBtn) {
            submitBtn.innerHTML = originalText;
            submitBtn.disabled = false;
        }
        window.enviandoProposta = false;
    }
}    

// ===== FUN√á√ÉO AUXILIAR PARA COLETAR DADOS EXTRAS (SEGURA) =====
function coletarDadosCompletosSeguro() {
    const dados = {
        dadosCadastrais: {},
        propostaTecnica: {},
        propostaComercial: {
            servicos: [],
            maoObra: [],
            materiaisComercial: [],
            equipamentosComercial: [],
            bdi: [],
            totais: {}
        },
        resumo: {},
        metadata: {
            dataEnvio: new Date().toISOString(),
            versaoSistema: '2.0',
            navegador: navigator.userAgent
        }
    };
    
    // Coletar dados cadastrais (com verifica√ß√£o)
    const camposCadastrais = ['razaoSocial', 'cnpj', 'endereco', 'cidade', 'telefone', 'email', 'respTecnico', 'crea'];
    camposCadastrais.forEach(campo => {
        const elemento = document.getElementById(campo);
        if (elemento) {
            dados.dadosCadastrais[campo] = elemento.value || '';
        }
    });
    
    // Coletar dados da proposta t√©cnica (com verifica√ß√£o)
    const camposTecnicos = [
        'objetoConcorrencia', 'escopoInclusos', 'escopoExclusos', 'metodologia',
        'sequenciaExecucao', 'prazoExecucao', 'prazoMobilizacao', 'garantias',
        'estruturaCanteiro', 'obrigacoesContratada', 'obrigacoesContratante'
    ];
    camposTecnicos.forEach(campo => {
        const elemento = document.getElementById(campo);
        if (elemento) {
            dados.propostaTecnica[campo] = elemento.value || '';
        }
    });
    
    // Coletar tabelas (com verifica√ß√£o)
    const tabelas = [
        'servicosTable', 'maoObraTable', 'materiaisComercialTable', 
        'equipamentosComercialTable', 'bdiTable'
    ];
    
    tabelas.forEach(tabelaId => {
        try {
            const dadosTabela = coletarTabelaSegura(tabelaId);
            if (dadosTabela && dadosTabela.length > 0) {
                switch(tabelaId) {
                    case 'servicosTable':
                        dados.propostaComercial.servicos = dadosTabela;
                        break;
                    case 'maoObraTable':
                        dados.propostaComercial.maoObra = dadosTabela;
                        break;
                    case 'materiaisComercialTable':
                        dados.propostaComercial.materiaisComercial = dadosTabela;
                        break;
                    case 'equipamentosComercialTable':
                        dados.propostaComercial.equipamentosComercial = dadosTabela;
                        break;
                    case 'bdiTable':
                        dados.propostaComercial.bdi = dadosTabela;
                        break;
                }
            }
        } catch (error) {
            console.warn(`Erro ao coletar tabela ${tabelaId}:`, error);
        }
    });
    
    // Coletar totais (com verifica√ß√£o)
    const elementosTotais = [
        'totalServicos', 'totalMaoObra', 'totalMateriais', 'totalEquipamentos',
        'custoDirecto', 'bdiPercentual', 'bdiValor', 'valorTotalCalculado'
    ];
    
    elementosTotais.forEach(elementoId => {
        const elemento = document.getElementById(elementoId);
        if (elemento) {
            dados.propostaComercial.totais[elementoId] = elemento.textContent || '0,00';
        }
    });
    
    // Coletar resumo (com verifica√ß√£o)
    const resumoElementos = ['prazoExecucaoResumo', 'formaPagamentoResumo'];
    resumoElementos.forEach(campo => {
        const elemento = document.getElementById(campo);
        if (elemento) {
            dados.resumo[campo.replace('Resumo', '')] = elemento.value || '';
        }
    });
    
    return dados;
}

// ===== FUN√á√ÉO AUXILIAR PARA COLETAR TABELA (SEGURA) =====
function coletarTabelaSegura(tabelaId) {
    try {
        const tabela = document.getElementById(tabelaId);
        if (!tabela) return [];
        
        const tbody = tabela.querySelector('tbody');
        if (!tbody) return [];
        
        const linhas = tbody.querySelectorAll('tr');
        const dados = [];
        
        linhas.forEach(linha => {
            const inputs = linha.querySelectorAll('input, select, textarea');
            if (inputs.length > 0) {
                const linhaDados = {};
                inputs.forEach((input, index) => {
                    if (input.type !== 'button' && !input.classList.contains('remove-btn')) {
                        // Mapear os √≠ndices para nomes de campo baseado na tabela
                        const nomeCampo = obterNomeCampo(tabelaId, index);
                        linhaDados[nomeCampo] = input.value || '';
                    }
                });
                if (Object.values(linhaDados).some(valor => valor.trim() !== '')) {
                    dados.push(linhaDados);
                }
            }
        });
        
        return dados;
    } catch (error) {
        console.warn(`Erro ao coletar tabela ${tabelaId}:`, error);
        return [];
    }
}

// Nova fun√ß√£o auxiliar para mapear campos
function obterNomeCampo(tabelaId, index) {
    const mapeamento = {
        'servicosTecnicaTable': ['item', 'descricao', 'unidade', 'quantidade'],
        'equipeTable': ['funcao', 'quantidade', 'tempo'],
        'materiaisTable': ['material', 'especificacao', 'unidade', 'quantidade'],
        'equipamentosTable': ['equipamento', 'especificacao', 'unidade', 'quantidade', 'tempo'],
        'cronogramaTable': ['atividade', 'duracao', 'inicio', 'fim'],
        'experienciaTable': ['obra', 'cliente', 'valor', 'ano', 'contato'],
        'certificacoesTable': ['certificacao', 'orgao', 'validade'],
        'servicosTable': ['item', 'descricao', 'unidade', 'quantidade', 'precoUnitario', 'total'],
        'maoObraTable': ['funcao', 'quantidade', 'tempo', 'salario', 'encargos', 'totalMensal', 'totalGeral'],
        'materiaisComercialTable': ['material', 'especificacao', 'unidade', 'quantidade', 'precoUnitario', 'total'],
        'equipamentosComercialTable': ['equipamento', 'especificacao', 'quantidade', 'tempo', 'precoMensal', 'total'],
        'bdiTable': ['item', 'percentual', 'valor']
    };
    
    return mapeamento[tabelaId]?.[index] || `campo${index}`;
}
        
// ===== FUN√á√ÉO PARA SALVAR PROPOSTA PARA COMPARATIVO =====
function salvarPropostaParaComparativo(dadosBasicos, dadosExtras, protocolo) {
    try {
        // Verificar se tem dados m√≠nimos
        if (!dadosBasicos.numeroProcesso || !dadosBasicos.cnpj) {
            return;
        }
        
        // Criar proposta para o comparativo
        const propostaComparativo = {
            id: Date.now().toString(36) + Math.random().toString(36).substr(2),
            protocolo: protocolo,
            numeroProcesso: dadosBasicos.numeroProcesso,
            fornecedorCNPJ: dadosBasicos.cnpj,
            fornecedorRazaoSocial: dadosBasicos.razaoSocial,
            valor: parseFloat(String(dadosBasicos.valorTotal || '0').replace(/[^\d.,]/g, '').replace(',', '.')) || 0,
            prazoExecucao: dadosBasicos.prazoExecucao,
            status: 'ENVIADA',
            dataEnvio: new Date().toISOString(),
            dadosBasicos: dadosBasicos,
            dadosCompletos: dadosExtras
        };
        
        // Salvar no localStorage para o comparativo
        const propostas = JSON.parse(localStorage.getItem('propostas_comparativo') || '[]');
        
        // Remover proposta anterior do mesmo fornecedor/processo se existir
        const propostasFiltradas = propostas.filter(p => 
            !(p.numeroProcesso === dadosBasicos.numeroProcesso && 
              p.fornecedorCNPJ === dadosBasicos.cnpj)
        );
        
        propostasFiltradas.push(propostaComparativo);
        localStorage.setItem('propostas_comparativo', JSON.stringify(propostasFiltradas));
        
        console.log('Proposta salva para comparativo:', protocolo);
        
        // NOVO C√ìDIGO - IN√çCIO
        // IMPORTANTE: Atualizar tamb√©m em propostas_fornecedores para o dashboard
        if (window.fornecedorLogado && window.dadosOrigemDashboard) {
            const propostasFornecedores = JSON.parse(localStorage.getItem('propostas_fornecedores') || '[]');
            
            // Criar ou atualizar proposta
            const propostaFornecedor = {
                id: propostaComparativo.id,
                processoId: window.dadosOrigemDashboard.processo.processoId,
                numeroProcesso: dadosBasicos.numeroProcesso,
                fornecedorId: window.fornecedorLogado.id,
                fornecedorEmail: window.fornecedorLogado.email,
                fornecedorCNPJ: window.fornecedorLogado.cnpj,
                fornecedorRazaoSocial: window.fornecedorLogado.razaoSocial,
                valor: dadosBasicos.valorTotal,
                prazoExecucao: dadosBasicos.prazoExecucao,
                condicoesPagamento: dadosExtras?.resumo?.formaPagamento || '',
                status: 'ENVIADA', // IMPORTANTE: Status ENVIADA
                dataEnvio: new Date().toISOString(),
                protocolo: protocolo,
                dadosCompletos: dadosExtras
            };
            
            // Remover rascunhos anteriores do mesmo processo
            const propostasFiltradas = propostasFornecedores.filter(p => 
                !(p.processoId === window.dadosOrigemDashboard.processo.processoId && 
                  p.fornecedorId === window.fornecedorLogado.id)
            );
            
            // Adicionar nova proposta com status ENVIADA
            propostasFiltradas.push(propostaFornecedor);
            localStorage.setItem('propostas_fornecedores', JSON.stringify(propostasFiltradas));
            
            console.log('Proposta atualizada no dashboard do fornecedor');
        }
        // NOVO C√ìDIGO - FIM
        
    } catch (error) {
        console.warn('Erro ao salvar proposta para comparativo:', error);
    }
}
// ===== FUN√á√ÉO MOSTRAR MENSAGEM (MANTIDA SE N√ÉO EXISTIR) =====
if (typeof mostrarMensagem === 'undefined') {
    function mostrarMensagem(texto, tipo) {
        // Criar ou usar div de mensagem existente
        let mensagemDiv = document.getElementById('mensagem');
        if (!mensagemDiv) {
            mensagemDiv = document.createElement('div');
            mensagemDiv.id = 'mensagem';
            mensagemDiv.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 9999;
                max-width: 400px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            document.body.appendChild(mensagemDiv);
        }
        
        mensagemDiv.className = tipo === 'error' ? 'error-message' : 'success-message';
        mensagemDiv.style.backgroundColor = tipo === 'error' ? '#e74c3c' : '#27ae60';
        mensagemDiv.innerHTML = texto;
        mensagemDiv.style.display = 'block';
        
        setTimeout(() => {
            mensagemDiv.style.display = 'none';
        }, 8000);
    }
}
  
        function coletarDadosCompletos() {
            const dadosColetados = {
                // Dados cadastrais
                dadosCadastrais: {
                    razaoSocial: document.getElementById('razaoSocial').value,
                    cnpj: document.getElementById('cnpj').value,
                    endereco: document.getElementById('endereco').value,
                    cidade: document.getElementById('cidade').value,
                    telefone: document.getElementById('telefone').value,
                    email: document.getElementById('email').value,
                    respTecnico: document.getElementById('respTecnico').value,
                    crea: document.getElementById('crea').value
                },
                
                // Dados do processo
                processo: {
                    numero: document.getElementById('numeroProcesso').value,
                    objeto: document.getElementById('objetoProcesso').value,
                    prazoEnvio: document.getElementById('prazoEnvio').value
                },
                
                // Proposta t√©cnica
                propostaTecnica: {
                    objetoConcorrencia: document.getElementById('objetoConcorrencia').value,
                    escopoInclusos: document.getElementById('escopoInclusos').value,
                    escopoExclusos: document.getElementById('escopoExclusos').value,
                    metodologia: document.getElementById('metodologia').value,
                    sequenciaExecucao: document.getElementById('sequenciaExecucao').value,
                    prazoExecucao: document.getElementById('prazoExecucao').value,
                    prazoMobilizacao: document.getElementById('prazoMobilizacao').value,
                    garantias: document.getElementById('garantias').value,
                    estruturaCanteiro: document.getElementById('estruturaCanteiro').value,
                    obrigacoesContratada: document.getElementById('obrigacoesContratada').value,
                    obrigacoesContratante: document.getElementById('obrigacoesContratante').value,
                    servicosTecnica: coletarTabela('servicosTecnicaTable'),
                    equipe: coletarTabela('equipeTable'),
                    materiais: coletarTabela('materiaisTable'),
                    equipamentos: coletarTabela('equipamentosTable'),
                    cronograma: coletarTabela('cronogramaTable'),
                    experiencia: coletarTabela('experienciaTable'),
                    certificacoes: coletarTabela('certificacoesTable')
                },
                
                // Proposta comercial
                propostaComercial: {
                    servicos: coletarTabela('servicosTable'),
                    maoObra: coletarTabela('maoObraTable'),
                    materiaisComercial: coletarTabela('materiaisComercialTable'),
                    equipamentosComercial: coletarTabela('equipamentosComercialTable'),
                    bdi: coletarTabela('bdiTable'),
                    valorTotal: document.getElementById('valorTotalCalculado').textContent,
                    validadeProposta: document.getElementById('validadeProposta').value,
                    validadeDetalhada: document.getElementById('validadeDetalhada').value,
                    totais: {
                        servicos: document.getElementById('totalServicos').textContent,
                        maoObra: document.getElementById('totalMaoObra').textContent,
                        materiais: document.getElementById('totalMateriais').textContent,
                        equipamentos: document.getElementById('totalEquipamentos').textContent,
                        custoDirecto: document.getElementById('custoDirecto').textContent,
                        bdiPercentual: document.getElementById('bdiPercentual').textContent,
                        bdiValor: document.getElementById('bdiValor').textContent
                    }
                },
                
                // Resumo
                resumo: {
                    prazoExecucao: document.getElementById('prazoExecucaoResumo').value,
                    formaPagamento: document.getElementById('formaPagamentoResumo').value
                },
                
                // Metadados
                metadata: {
                    dataEnvio: new Date().toISOString(),
                    versaoSistema: '2.0',
                    navegador: navigator.userAgent
                }
            };
            
            // Garantir que propriedades essenciais existam
            if (!dadosColetados.propostaComercial) {
                dadosColetados.propostaComercial = { servicos: [], totais: {} };
            }
            if (!dadosColetados.propostaTecnica) {
                dadosColetados.propostaTecnica = { cronograma: [], experiencia: [], certificacoes: [] };
            }
            
            return dadosColetados;
        }

        function mostrarMensagem(texto, tipo) {
            const mensagemDiv = document.getElementById('mensagem');
            mensagemDiv.className = tipo === 'error' ? 'error-message' : 'success-message';
            mensagemDiv.innerHTML = texto;
            mensagemDiv.style.display = 'block';
            
            setTimeout(() => {
                mensagemDiv.style.display = 'none';
            }, 10000);
        }

        // Fun√ß√£o para voltar ao dashboard
        function voltarDashboard() {
            if (window.fornecedorLogado) {
                if (confirm('Deseja salvar o rascunho antes de sair?')) {
                    salvarRascunho();
                }
                window.close();
            } else {
                history.back();
            }
        }
        
        // ===== INICIALIZA√á√ÉO =====
        document.addEventListener('DOMContentLoaded', function() {
            calcularCronograma();
            updateProgress();
            
            // Inicializar funcionalidades adicionais
            setTimeout(function() {
                adicionarBotaoRascunho();
                carregarRascunho();
                verificarPropostaExistente();
            }, 1000);
        });

        // ===== FUNCIONALIDADES ADICIONAIS =====
        
        // Adicionar bot√£o Salvar Rascunho
        function adicionarBotaoRascunho() {
            const botaoEnviar = document.querySelector('.submit-btn');
            if (botaoEnviar && !document.getElementById('btnSalvarRascunho')) {
                const botaoRascunho = document.createElement('button');
                botaoRascunho.id = 'btnSalvarRascunho';
                botaoRascunho.type = 'button';
                botaoRascunho.className = 'submit-btn';
                botaoRascunho.style.backgroundColor = '#6c757d';
                botaoRascunho.style.marginRight = '10px';
                botaoRascunho.innerHTML = 'üíæ Salvar Rascunho';
                botaoRascunho.onclick = salvarRascunho;
                botaoEnviar.parentNode.insertBefore(botaoRascunho, botaoEnviar);
            }
        }

        // Salvar rascunho
        function salvarRascunho() {
            try {
                const numeroProcesso = document.getElementById('numeroProcesso') ? document.getElementById('numeroProcesso').value : '';
                let cnpjFornecedor = '';
                
                if (document.getElementById('cnpj') && document.getElementById('cnpj').value) {
                    cnpjFornecedor = document.getElementById('cnpj').value;
                } else if (window.currentUser && window.currentUser.cnpj) {
                    cnpjFornecedor = window.currentUser.cnpj;
                } else if (window.fornecedorLogado && window.fornecedorLogado.cnpj) {
                    cnpjFornecedor = window.fornecedorLogado.cnpj;
                }
                
                if (!numeroProcesso || !cnpjFornecedor) {
                    mostrarMensagem('‚ö†Ô∏è Dados insuficientes para salvar rascunho', 'error');
                    return;
                }
                
                const dadosRascunho = coletarDadosCompletos();
                dadosRascunho.isRascunho = true;
                dadosRascunho.dataRascunho = new Date().toISOString();
                dadosRascunho.cnpjFornecedor = cnpjFornecedor;
                dadosRascunho.numeroProcesso = numeroProcesso;
                
                const cnpjLimpo = cnpjFornecedor.replace(/[^0-9]/g, '');
                const chaveRascunho = 'rascunho_' + cnpjLimpo + '_' + numeroProcesso;
                localStorage.setItem(chaveRascunho, JSON.stringify(dadosRascunho));

                // Sincronizar com o sistema principal se veio do dashboard
                if (window.fornecedorLogado && window.dadosOrigemDashboard) {
                    const propostas = JSON.parse(localStorage.getItem('propostas_fornecedores') || '[]');
                    
                    // Procurar se j√° existe um rascunho
                    const propostaIndex = propostas.findIndex(p => 
                        p.numeroProcesso === numeroProcesso && 
                        p.fornecedorCNPJ === cnpjFornecedor &&
                        p.status === 'RASCUNHO'
                    );
                    
                    const propostaSistema = {
                        id: dadosRascunho.id || Date.now().toString(36) + Math.random().toString(36).substr(2),
                        processoId: window.dadosOrigemDashboard.processo.processoId,
                        numeroProcesso: numeroProcesso,
                        fornecedorId: window.fornecedorLogado.id,
                        fornecedorEmail: window.fornecedorLogado.email,
                        fornecedorCNPJ: window.fornecedorLogado.cnpj,
                        fornecedorRazaoSocial: window.fornecedorLogado.razaoSocial,
                        valor: dadosRascunho.propostaComercial?.valorTotal || '0',
                        prazoExecucao: dadosRascunho.resumo?.prazoExecucao || '',
                        condicoesPagamento: dadosRascunho.resumo?.formaPagamento || '',
                        status: 'RASCUNHO',
                        dataCriacao: propostaIndex >= 0 ? propostas[propostaIndex].dataCriacao : new Date().toISOString(),
                        dataAtualizacao: new Date().toISOString(),
                        dadosCompletos: dadosRascunho // Armazena todos os dados do portal
                    };
                    
                    if (propostaIndex >= 0) {
                        propostas[propostaIndex] = propostaSistema;
                    } else {
                        propostas.push(propostaSistema);
                    }
                    
                    localStorage.setItem('propostas_fornecedores', JSON.stringify(propostas));
                }
                mostrarMensagem('üíæ Rascunho salvo com sucesso!', 'success');
            } catch (error) {
                mostrarMensagem('‚ùå Erro ao salvar rascunho', 'error');
            }
        }

        // Carregar rascunho
        function carregarRascunho() {
            try {
                const numeroProcesso = document.getElementById('numeroProcesso') ? document.getElementById('numeroProcesso').value : '';
                let cnpjFornecedor = '';
                
                if (document.getElementById('cnpj') && document.getElementById('cnpj').value) {
                    cnpjFornecedor = document.getElementById('cnpj').value;
                } else if (window.currentUser && window.currentUser.cnpj) {
                    cnpjFornecedor = window.currentUser.cnpj;
                }
                
                if (!numeroProcesso || !cnpjFornecedor) return;
                
                const cnpjLimpo = cnpjFornecedor.replace(/[^0-9]/g, '');
                const chaveRascunho = 'rascunho_' + cnpjLimpo + '_' + numeroProcesso;
                const rascunhoSalvo = localStorage.getItem(chaveRascunho);
                
                if (rascunhoSalvo) {
                    const dados = JSON.parse(rascunhoSalvo);
                    preencherFormularioRascunho(dados);
                    mostrarMensagem('üìÑ Rascunho carregado', 'info');
                }
            } catch (error) {
                console.error('Erro ao carregar rascunho:', error);
            }
        }

        // Preencher formul√°rio com rascunho
        function preencherFormularioRascunho(dados) {
            if (!dados) return;
            
            if (dados.dadosCadastrais) {
                Object.keys(dados.dadosCadastrais).forEach(function(campo) {
                    const elemento = document.getElementById(campo);
                    if (elemento && dados.dadosCadastrais[campo]) {
                        elemento.value = dados.dadosCadastrais[campo];
                    }
                });
            }
            
            if (dados.propostaTecnica) {
                Object.keys(dados.propostaTecnica).forEach(function(campo) {
                    const elemento = document.getElementById(campo);
                    if (elemento && dados.propostaTecnica[campo]) {
                        elemento.value = dados.propostaTecnica[campo];
                    }
                });
            }
            
            if (dados.propostaComercial) {
                Object.keys(dados.propostaComercial).forEach(function(campo) {
                    const elemento = document.getElementById(campo);
                    if (elemento && dados.propostaComercial[campo]) {
                        elemento.value = dados.propostaComercial[campo];
                    }
                });
            }
        }

        // Verificar se j√° enviou proposta
        async function verificarPropostaExistente() {
            try {
                const numeroProcesso = document.getElementById('numeroProcesso') ? document.getElementById('numeroProcesso').value : '';
                let cnpjFornecedor = '';
                
                if (document.getElementById('cnpj') && document.getElementById('cnpj').value) {
                    cnpjFornecedor = document.getElementById('cnpj').value;
                } else if (window.currentUser && window.currentUser.cnpj) {
                    cnpjFornecedor = window.currentUser.cnpj;
                }
                
                if (!numeroProcesso || !cnpjFornecedor) return false;
                
                const url = API_URL + '/api/propostas?processo=' + encodeURIComponent(numeroProcesso) + '&cnpj=' + encodeURIComponent(cnpjFornecedor);
                const response = await fetch(url);
                
                if (response.ok) {
                    const resultado = await response.json();
                    const propostas = resultado.propostas || [];
                    
                    if (propostas.length > 0) {
                        bloquearEnvio(propostas[0]);
                        return true;
                    }
                }
                
                return false;
            } catch (error) {
                console.error('Erro ao verificar proposta:', error);
                return false;
            }
        }

        // Bloquear envio
        function bloquearEnvio(proposta) {
            const botaoEnviar = document.querySelector('.submit-btn:not(#btnSalvarRascunho)');
            if (botaoEnviar) {
                botaoEnviar.disabled = true;
                botaoEnviar.style.backgroundColor = '#dc3545';
                botaoEnviar.innerHTML = 'üö´ J√° Enviada';
                botaoEnviar.title = 'Proposta j√° enviada em ' + new Date(proposta.data).toLocaleString('pt-BR');
            }
            
            if (!document.getElementById('avisoJaEnviada')) {
                const aviso = document.createElement('div');
                aviso.id = 'avisoJaEnviada';
                aviso.style.cssText = 'background: #f8d7da; color: #721c24; padding: 15px; border-radius: 8px; margin: 20px 0; border: 1px solid #f5c6cb; text-align: center;';
                aviso.innerHTML = '<strong>‚ö†Ô∏è PROPOSTA J√Å ENVIADA</strong><br>Protocolo: ' + proposta.protocolo + '<br>Data: ' + new Date(proposta.data).toLocaleString('pt-BR');
                
                const container = document.querySelector('.container');
                if (container) {
                    container.insertBefore(aviso, container.firstChild);
                }
            }
        }

        // Sobrescrever enviarProposta
        const enviarPropostaOriginal = window.enviarProposta;
        window.enviarProposta = async function() {
            const jaEnviou = await verificarPropostaExistente();
            if (jaEnviou) {
                mostrarMensagem('‚ö†Ô∏è Voc√™ j√° enviou uma proposta para este processo', 'error');
                return false;
            }
            
            if (enviarPropostaOriginal) {
                const resultado = await enviarPropostaOriginal();
                
                if (resultado !== false) {
                    const numeroProcesso = document.getElementById('numeroProcesso') ? document.getElementById('numeroProcesso').value : '';
                    let cnpjFornecedor = '';
                    if (window.currentUser && window.currentUser.cnpj) {
                        cnpjFornecedor = window.currentUser.cnpj;
                    }
                    
                    if (numeroProcesso && cnpjFornecedor) {
                        const cnpjLimpo = cnpjFornecedor.replace(/[^0-9]/g, '');
                        const chaveRascunho = 'rascunho_' + cnpjLimpo + '_' + numeroProcesso;
                        localStorage.removeItem(chaveRascunho);
                    }
                }
                
                return resultado;
            }
        };

        // Auto-save a cada 2 minutos
        setInterval(function() {
            const numeroProcesso = document.getElementById('numeroProcesso') ? document.getElementById('numeroProcesso').value : '';
            if (numeroProcesso) {
                salvarRascunho();
            }
        }, 120000);

        // ===== FUN√á√ïES AUXILIARES PARA INTEGRA√á√ÉO =====

        // Carregar dados de proposta existente do dashboard
        function carregarDadosPropostaExistente(dadosProposta) {
            if (!dadosProposta) return;
            
            // Usar a fun√ß√£o existente
            preencherFormularioRascunho(dadosProposta);
        }
        
        // Modo visualiza√ß√£o (somente leitura)
        function carregarModoVisualizacao(dadosProposta) {
            // Carregar dados completos usando a nova fun√ß√£o
            carregarDadosCompletosVisualizacao(dadosProposta);
            
            // Desabilitar todos os campos
            document.querySelectorAll('input, textarea, select').forEach(el => {
                if (el.type !== 'hidden') {
                    el.disabled = true;
                    el.style.backgroundColor = '#f0f0f0';
                }
            });
            
            // Esconder bot√µes de a√ß√£o
            const submitSection = document.querySelector('.submit-section');
            if (submitSection) {
                submitSection.style.display = 'none';
            }
            
            // Adicionar aviso de modo visualiza√ß√£o
            const header = document.querySelector('.header');
            if (header) {
                const aviso = document.createElement('div');
                aviso.style.cssText = 'background: #2196f3; color: white; padding: 15px; border-radius: 10px; margin-top: 20px; text-align: center; font-weight: bold;';
                aviso.innerHTML = '<i class="fas fa-eye"></i> MODO VISUALIZA√á√ÉO - Esta proposta √© somente leitura';
                header.appendChild(aviso);
            }
            
            // Adicionar bot√£o para fechar janela
            const container = document.querySelector('.container');
            if (container) {
                const botaoFechar = document.createElement('div');
                botaoFechar.style.cssText = 'text-align: center; margin: 30px 0;';
                botaoFechar.innerHTML = `
                    <button onclick="window.close()" class="btn btn-secondary" style="padding: 15px 30px; font-size: 16px;">
                        <i class="fas fa-times"></i> Fechar Visualiza√ß√£o
                    </button>
                `;
                container.appendChild(botaoFechar);
            }
        }

        // Fun√ß√£o para carregar dados completos no modo visualiza√ß√£o
        function carregarDadosCompletosVisualizacao(dados) {
            if (!dados) return;
            
            // 1. Carregar dados cadastrais
            if (dados.dadosCadastrais) {
                Object.keys(dados.dadosCadastrais).forEach(campo => {
                    const elemento = document.getElementById(campo);
                    if (elemento) {
                        elemento.value = dados.dadosCadastrais[campo] || '';
                    }
                });
            }
            
            // 2. Carregar dados da proposta t√©cnica
            if (dados.propostaTecnica) {
                // Campos simples
                Object.keys(dados.propostaTecnica).forEach(campo => {
                    const elemento = document.getElementById(campo);
                    if (elemento && typeof dados.propostaTecnica[campo] === 'string') {
                        elemento.value = dados.propostaTecnica[campo];
                    }
                });
                
                // Tabela de servi√ßos t√©cnicos
                if (dados.propostaTecnica.servicosTecnica && dados.propostaTecnica.servicosTecnica.length > 0) {
                    const tbody = document.querySelector('#servicosTecnicaTable tbody');
                    tbody.innerHTML = '';
                    dados.propostaTecnica.servicosTecnica.forEach((servico, index) => {
                        const newRow = tbody.insertRow();
                        newRow.innerHTML = `
                            <td><input type="text" value="${index + 1}" readonly></td>
                            <td><input type="text" value="${servico[1] || ''}" placeholder="Descri√ß√£o do servi√ßo"></td>
                            <td><input type="text" value="${servico[2] || ''}" placeholder="m¬≤"></td>
                            <td><input type="number" value="${servico[3] || ''}" placeholder="100"></td>
                            <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                        `;
                    });
                }
                
                // Tabela de equipe
                if (dados.propostaTecnica.equipe && dados.propostaTecnica.equipe.length > 0) {
                    const tbody = document.querySelector('#equipeTable tbody');
                    tbody.innerHTML = '';
                    dados.propostaTecnica.equipe.forEach(item => {
                        const newRow = tbody.insertRow();
                        newRow.innerHTML = `
                            <td><input type="text" value="${item[0] || ''}" placeholder="Engenheiro Civil"></td>
                            <td><input type="number" value="${item[1] || ''}" placeholder="1"></td>
                            <td><input type="number" value="${item[2] || ''}" placeholder="4" step="0.1"></td>
                            <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                        `;
                    });
                }
                
                // Tabela de materiais
                if (dados.propostaTecnica.materiais && dados.propostaTecnica.materiais.length > 0) {
                    const tbody = document.querySelector('#materiaisTable tbody');
                    tbody.innerHTML = '';
                    dados.propostaTecnica.materiais.forEach(item => {
                        const newRow = tbody.insertRow();
                        newRow.innerHTML = `
                            <td><input type="text" value="${item[0] || ''}" placeholder="Concreto"></td>
                            <td><input type="text" value="${item[1] || ''}" placeholder="FCK 25 MPa"></td>
                            <td><input type="text" value="${item[2] || ''}" placeholder="m¬≥"></td>
                            <td><input type="number" value="${item[3] || ''}" placeholder="450"></td>
                            <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                        `;
                    });
                }
                
                // Tabela de equipamentos
                if (dados.propostaTecnica.equipamentos && dados.propostaTecnica.equipamentos.length > 0) {
                    const tbody = document.querySelector('#equipamentosTable tbody');
                    tbody.innerHTML = '';
                    dados.propostaTecnica.equipamentos.forEach(item => {
                        const newRow = tbody.insertRow();
                        newRow.innerHTML = `
                            <td><input type="text" value="${item[0] || ''}" placeholder="Betoneira"></td>
                            <td><input type="text" value="${item[1] || ''}" placeholder="400L"></td>
                            <td><input type="text" value="${item[2] || ''}" placeholder="und"></td>
                            <td><input type="number" value="${item[3] || ''}" placeholder="2"></td>
                            <td><input type="number" value="${item[4] || ''}" placeholder="4" step="0.1"></td>
                            <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                        `;
                    });
                }
                
                // Tabela de cronograma
                if (dados.propostaTecnica.cronograma && dados.propostaTecnica.cronograma.length > 0) {
                    const tbody = document.querySelector('#cronogramaTable tbody');
                    tbody.innerHTML = '';
                    dados.propostaTecnica.cronograma.forEach(item => {
                        const newRow = tbody.insertRow();
                        newRow.innerHTML = `
                            <td><input type="text" value="${item[0] || ''}" placeholder="Nova Atividade"></td>
                            <td><input type="number" value="${item[1] || ''}" placeholder="10" min="1" onchange="calcularCronograma()"></td>
                            <td><input type="text" value="${item[2] || ''}" readonly style="background: #f8f9fa;"></td>
                            <td><input type="text" value="${item[3] || ''}" readonly style="background: #f8f9fa;"></td>
                            <td><button type="button" class="remove-btn" onclick="removeRowAndRecalculate(this)">√ó</button></td>
                        `;
                    });
                }
                
                // Tabela de experi√™ncia
                if (dados.propostaTecnica.experiencia && dados.propostaTecnica.experiencia.length > 0) {
                    const tbody = document.querySelector('#experienciaTable tbody');
                    tbody.innerHTML = '';
                    dados.propostaTecnica.experiencia.forEach(item => {
                        const newRow = tbody.insertRow();
                        newRow.innerHTML = `
                            <td><input type="text" value="${item[0] || ''}" placeholder="Nome da obra"></td>
                            <td><input type="text" value="${item[1] || ''}" placeholder="Cliente"></td>
                            <td><input type="text" value="${item[2] || ''}" placeholder="R$ 2.500.000"></td>
                            <td><input type="number" value="${item[3] || ''}" placeholder="2024"></td>
                            <td><input type="text" value="${item[4] || ''}" placeholder="(00) 0000-0000"></td>
                            <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                        `;
                    });
                }
                
                // Tabela de certifica√ß√µes
                if (dados.propostaTecnica.certificacoes && dados.propostaTecnica.certificacoes.length > 0) {
                    const tbody = document.querySelector('#certificacoesTable tbody');
                    tbody.innerHTML = '';
                    dados.propostaTecnica.certificacoes.forEach(item => {
                        const newRow = tbody.insertRow();
                        newRow.innerHTML = `
                            <td><input type="text" value="${item[0] || ''}" placeholder="ISO 9001"></td>
                            <td><input type="text" value="${item[1] || ''}" placeholder="√ìrg√£o"></td>
                            <td><input type="date" value="${item[2] || ''}"></td>
                            <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                        `;
                    });
                }
            }
            
            // 3. Carregar dados da proposta comercial
            if (dados.propostaComercial) {
                // Campos simples
                document.getElementById('objetoComercial').value = dados.propostaComercial.objetoComercial || dados.propostaTecnica?.objetoConcorrencia || '';
                document.getElementById('valorTotal').value = dados.propostaComercial.valorTotal ? `R$ ${dados.propostaComercial.valorTotal}` : '';
                document.getElementById('validadeProposta').value = dados.propostaComercial.validadeProposta || '';
                document.getElementById('validadeDetalhada').value = dados.propostaComercial.validadeDetalhada || '';
                
                // Tabela de servi√ßos comerciais
                if (dados.propostaComercial.servicos && dados.propostaComercial.servicos.length > 0) {
                    const tbody = document.querySelector('#servicosTable tbody');
                    tbody.innerHTML = '';
                    dados.propostaComercial.servicos.forEach(servico => {
                        const newRow = tbody.insertRow();
                        newRow.innerHTML = `
                            <td><input type="text" value="${servico[0] || ''}" placeholder="1"></td>
                            <td><input type="text" value="${servico[1] || ''}" placeholder="Descri√ß√£o"></td>
                            <td><input type="text" value="${servico[2] || ''}" placeholder="m¬≥"></td>
                            <td><input type="number" value="${servico[3] || ''}" placeholder="100" onchange="calcTotal(this)"></td>
                            <td><input type="number" value="${servico[4] || ''}" placeholder="25.50" step="0.01" onchange="calcTotal(this)"></td>
                            <td><input type="text" value="${servico[5] || ''}" readonly></td>
                            <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                        `;
                    });
                }
                
                // Tabela de m√£o de obra
                if (dados.propostaComercial.maoObra && dados.propostaComercial.maoObra.length > 0) {
                    const tbody = document.querySelector('#maoObraTable tbody');
                    tbody.innerHTML = '';
                    dados.propostaComercial.maoObra.forEach(item => {
                        const newRow = tbody.insertRow();
                        newRow.innerHTML = `
                            <td><input type="text" value="${item[0] || ''}" placeholder="Engenheiro Civil"></td>
                            <td><input type="number" value="${item[1] || ''}" placeholder="1" onchange="calcMaoObra(this)"></td>
                            <td><input type="number" value="${item[2] || ''}" placeholder="4" onchange="calcMaoObra(this)" step="0.1"></td>
                            <td><input type="number" value="${item[3] || ''}" placeholder="8500" onchange="calcMaoObra(this)" step="0.01"></td>
                            <td><input type="number" value="${item[4] || ''}" placeholder="80" onchange="calcMaoObra(this)" step="0.1"></td>
                            <td><input type="text" value="${item[5] || ''}" readonly></td>
                            <td><input type="text" value="${item[6] || ''}" readonly></td>
                            <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                        `;
                    });
                }
                
                // Tabela de materiais comerciais
                if (dados.propostaComercial.materiaisComercial && dados.propostaComercial.materiaisComercial.length > 0) {
                    const tbody = document.querySelector('#materiaisComercialTable tbody');
                    tbody.innerHTML = '';
                    dados.propostaComercial.materiaisComercial.forEach(item => {
                        const newRow = tbody.insertRow();
                        newRow.innerHTML = `
                            <td><input type="text" value="${item[0] || ''}" placeholder="Concreto"></td>
                            <td><input type="text" value="${item[1] || ''}" placeholder="FCK 25 MPa"></td>
                            <td><input type="text" value="${item[2] || ''}" placeholder="m¬≥"></td>
                            <td><input type="number" value="${item[3] || ''}" placeholder="450" onchange="calcMaterial(this)"></td>
                            <td><input type="number" value="${item[4] || ''}" placeholder="320.50" step="0.01" onchange="calcMaterial(this)"></td>
                            <td><input type="text" value="${item[5] || ''}" readonly></td>
                            <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                        `;
                    });
                }
                
                // Tabela de equipamentos comerciais
                if (dados.propostaComercial.equipamentosComercial && dados.propostaComercial.equipamentosComercial.length > 0) {
                    const tbody = document.querySelector('#equipamentosComercialTable tbody');
                    tbody.innerHTML = '';
                    dados.propostaComercial.equipamentosComercial.forEach(item => {
                        const newRow = tbody.insertRow();
                        newRow.innerHTML = `
                            <td><input type="text" value="${item[0] || ''}" placeholder="Betoneira"></td>
                            <td><input type="text" value="${item[1] || ''}" placeholder="400L"></td>
                            <td><input type="number" value="${item[2] || ''}" placeholder="2" onchange="calcEquipamento(this)"></td>
                            <td><input type="number" value="${item[3] || ''}" placeholder="4" step="0.1" onchange="calcEquipamento(this)"></td>
                            <td><input type="number" value="${item[4] || ''}" placeholder="1200" step="0.01" onchange="calcEquipamento(this)"></td>
                            <td><input type="text" value="${item[5] || ''}" readonly></td>
                            <td><button type="button" class="remove-btn" onclick="removeRow(this)">√ó</button></td>
                        `;
                    });
                }
                
                // Tabela de BDI
                if (dados.propostaComercial.bdi && dados.propostaComercial.bdi.length > 0) {
                    const tbody = document.querySelector('#bdiTable tbody');
                    if (tbody) {
                        const rows = tbody.querySelectorAll('tr');
                        dados.propostaComercial.bdi.forEach((item, index) => {
                            if (rows[index]) {
                                const inputs = rows[index].querySelectorAll('input');
                                if (inputs[1]) inputs[1].value = item[1] || '';
                                if (inputs[2]) inputs[2].value = item[2] || '';
                            }
                        });
                    }
                }
                
                // Atualizar totais
                if (dados.propostaComercial.totais) {
                    document.getElementById('totalServicos').textContent = dados.propostaComercial.totais.servicos || '0,00';
                    document.getElementById('totalMaoObra').textContent = dados.propostaComercial.totais.maoObra || '0,00';
                    document.getElementById('totalMateriais').textContent = dados.propostaComercial.totais.materiais || '0,00';
                    document.getElementById('totalEquipamentos').textContent = dados.propostaComercial.totais.equipamentos || '0,00';
                    document.getElementById('custoDirecto').textContent = dados.propostaComercial.totais.custoDirecto || '0,00';
                    document.getElementById('bdiPercentual').textContent = dados.propostaComercial.totais.bdiPercentual || '0,00';
                    document.getElementById('bdiValor').textContent = dados.propostaComercial.totais.bdiValor || '0,00';
                    document.getElementById('valorTotalCalculado').textContent = dados.propostaComercial.valorTotal || '0,00';
                }
            }
            
            // 4. Carregar dados do resumo
            if (dados.resumo) {
                document.getElementById('prazoExecucaoResumo').value = dados.resumo.prazoExecucao || '';
                document.getElementById('formaPagamentoResumo').value = dados.resumo.formaPagamento || '';
                document.getElementById('precoTotalResumo').textContent = dados.propostaComercial?.valorTotal || '0,00';
                document.getElementById('prazoResumo').textContent = dados.resumo.prazoExecucao || '-- dias';
                document.getElementById('pagamentoResumo').textContent = dados.resumo.formaPagamento || 'A definir';
            }
            
            // 5. Atualizar informa√ß√µes do processo
            if (dados.processo) {
                document.getElementById('numeroProcesso').value = dados.processo.numero || '';
                document.getElementById('objetoProcesso').value = dados.processo.objeto || '';
                document.getElementById('prazoEnvio').value = dados.processo.prazoEnvio || '';
            }
            
            // Recalcular totais
            setTimeout(() => {
                calcularTotais();
            }, 500);
        }
        
        // Modificar fun√ß√£o carregarRascunho para suportar fornecedor do dashboard
        const carregarRascunhoOriginal = carregarRascunho;
        carregarRascunho = function() {
            try {
                const numeroProcesso = document.getElementById('numeroProcesso') ? document.getElementById('numeroProcesso').value : '';
                let cnpjFornecedor = '';
                
                if (document.getElementById('cnpj') && document.getElementById('cnpj').value) {
                    cnpjFornecedor = document.getElementById('cnpj').value;
                } else if (window.currentUser && window.currentUser.cnpj) {
                    cnpjFornecedor = window.currentUser.cnpj;
                } else if (window.fornecedorLogado && window.fornecedorLogado.cnpj) {
                    // NOVO: Suporte para fornecedor do dashboard
                    cnpjFornecedor = window.fornecedorLogado.cnpj;
                }
                
                if (!numeroProcesso || !cnpjFornecedor) return;
                
                const cnpjLimpo = cnpjFornecedor.replace(/[^0-9]/g, '');
                const chaveRascunho = 'rascunho_' + cnpjLimpo + '_' + numeroProcesso;
                const rascunhoSalvo = localStorage.getItem(chaveRascunho);
                
                if (rascunhoSalvo) {
                    const dados = JSON.parse(rascunhoSalvo);
                    preencherFormularioRascunho(dados);
                    mostrarMensagem('üìÑ Rascunho carregado', 'info');
                }
            } catch (error) {
                console.error('Erro ao carregar rascunho:', error);
            }
        };
        
        // Adicionar bot√£o de voltar ao dashboard se veio de l√°
        document.addEventListener('DOMContentLoaded', function() {
            if (window.fornecedorLogado) {
                const btnVoltar = document.querySelector('.btn-voltar');
                if (btnVoltar) {
                    btnVoltar.addEventListener('click', function(e) {
                        e.preventDefault();
                        if (confirm('Deseja fechar esta janela e voltar ao dashboard?')) {
                            window.close();
                        }
                    });
                }
            }
        });

        function carregarDadosTabelas(dadosTabelas) {
            // Carregar tabelas da proposta t√©cnica
            if (dadosTabelas.propostaTecnica) {
                if (dadosTabelas.propostaTecnica.servicosTecnica) {
                    carregarDadosNaTabela('servicosTecnicaTable', dadosTabelas.propostaTecnica.servicosTecnica);
                }
                if (dadosTabelas.propostaTecnica.equipe) {
                    carregarDadosNaTabela('equipeTable', dadosTabelas.propostaTecnica.equipe);
                }
                if (dadosTabelas.propostaTecnica.materiais) {
                    carregarDadosNaTabela('materiaisTable', dadosTabelas.propostaTecnica.materiais);
                }
                if (dadosTabelas.propostaTecnica.equipamentos) {
                    carregarDadosNaTabela('equipamentosTable', dadosTabelas.propostaTecnica.equipamentos);
                }
                if (dadosTabelas.propostaTecnica.cronograma) {
                    carregarDadosNaTabela('cronogramaTable', dadosTabelas.propostaTecnica.cronograma);
                }
                if (dadosTabelas.propostaTecnica.experiencia) {
                    carregarDadosNaTabela('experienciaTable', dadosTabelas.propostaTecnica.experiencia);
                }
                if (dadosTabelas.propostaTecnica.certificacoes) {
                    carregarDadosNaTabela('certificacoesTable', dadosTabelas.propostaTecnica.certificacoes);
                }
            }
            
            // Carregar tabelas da proposta comercial
            if (dadosTabelas.propostaComercial) {
                if (dadosTabelas.propostaComercial.servicos) {
                    carregarDadosNaTabela('servicosTable', dadosTabelas.propostaComercial.servicos);
                }
                if (dadosTabelas.propostaComercial.maoObra) {
                    carregarDadosNaTabela('maoObraTable', dadosTabelas.propostaComercial.maoObra);
                }
                if (dadosTabelas.propostaComercial.materiaisComercial) {
                    carregarDadosNaTabela('materiaisComercialTable', dadosTabelas.propostaComercial.materiaisComercial);
                }
                if (dadosTabelas.propostaComercial.equipamentosComercial) {
                    carregarDadosNaTabela('equipamentosComercialTable', dadosTabelas.propostaComercial.equipamentosComercial);
                }
                if (dadosTabelas.propostaComercial.bdi) {
                    carregarDadosNaTabela('bdiTable', dadosTabelas.propostaComercial.bdi);
                }
            }
            
            // Recalcular totais ap√≥s carregar os dados
            setTimeout(() => {
                calcularTotais();
            }, 500);
        }
        
        function carregarDadosNaTabela(tabelaId, dados) {
            if (!dados || !Array.isArray(dados) || dados.length === 0) {
                return;
            }
            
            const tabela = document.getElementById(tabelaId);
            if (!tabela) {
                console.warn(`Tabela ${tabelaId} n√£o encontrada`);
                return;
            }
            
            const tbody = tabela.querySelector('tbody');
            if (!tbody) {
                console.warn(`Tbody da tabela ${tabelaId} n√£o encontrado`);
                return;
            }
            
            // Limpar tabela existente (exceto primeira linha se for template)
            const rows = tbody.querySelectorAll('tr');
            rows.forEach((row, index) => {
                if (index > 0) { // Manter primeira linha como template
                    row.remove();
                }
            });
            
            // Adicionar dados
            dados.forEach((item, index) => {
                if (index === 0 && rows.length > 0) {
                    // Preencher primeira linha existente
                    const primeiraLinha = rows[0];
                    const inputs = primeiraLinha.querySelectorAll('input, select, textarea');
                    Object.keys(item).forEach((key, keyIndex) => {
                        if (inputs[keyIndex]) {
                            inputs[keyIndex].value = item[key] || '';
                        }
                    });
                } else {
                    // Adicionar nova linha
                    adicionarLinhaTabela(tabelaId, item);
                }
            });
        }
    </script>

    <script type="module" src="/static/firebase.js"></script>
    <script type="module" src="/static/auth.js"></script>

</body>
</html>
