<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatório Analítico de Propostas</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
        }

        /* Container Principal */
        .relatorio-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: white;
            min-height: 100vh;
        }

        /* Cabeçalho do Relatório */
        .relatorio-header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .relatorio-header h1 {
            font-size: 28px;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .relatorio-header .info-processo {
            font-size: 16px;
            opacity: 0.9;
        }

        /* Controles */
        .controles-relatorio {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .btn-relatorio {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-imprimir {
            background: #27ae60;
            color: white;
        }

        .btn-imprimir:hover {
            background: #229954;
        }

        .btn-exportar {
            background: #3498db;
            color: white;
        }

        .btn-exportar:hover {
            background: #2980b9;
        }

        .btn-voltar {
            background: #95a5a6;
            color: white;
        }

        .btn-voltar:hover {
            background: #7f8c8d;
        }

        /* Seções do Relatório */
        .secao-relatorio {
            margin-bottom: 40px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .secao-header {
            background: linear-gradient(135deg, #34495e, #2c3e50);
            color: white;
            padding: 20px;
            font-size: 20px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .secao-content {
            padding: 20px;
            background: white;
        }

        /* Tabelas Comparativas */
        .tabela-comparativa {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .tabela-comparativa th {
            background: #ecf0f1;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border: 1px solid #bdc3c7;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .tabela-comparativa th:first-child {
            background: #34495e;
            color: white;
            width: 200px;
            min-width: 200px;
        }

        .tabela-comparativa td {
            padding: 10px;
            border: 1px solid #e0e0e0;
            vertical-align: top;
        }

        .tabela-comparativa tbody tr:hover {
            background: #f8f9fa;
        }

        /* Destaques de Valores */
        .menor-valor {
            background: #d4edda;
            color: #155724;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .maior-valor {
            background: #f8d7da;
            color: #721c24;
            font-weight: 700;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .valor-ausente {
            background: #fff3cd;
            color: #856404;
            font-style: italic;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .divergencia-alta {
            background: #ffe6e6;
            border-left: 4px solid #e74c3c !important;
        }

        /* Box de Análise IA */
        .analise-ia {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            border-left: 4px solid #3498db;
        }

        .analise-ia-header {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
            margin-bottom: 15px;
        }

        .analise-ia-content {
            display: grid;
            gap: 15px;
        }

        .insight-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .insight-tipo {
            font-weight: 600;
            color: #3498db;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .insight-texto {
            color: #555;
            line-height: 1.6;
        }

        /* Indicadores de Diferença */
        .indicador-diferenca {
            display: inline-block;
            font-size: 12px;
            padding: 2px 8px;
            border-radius: 12px;
            margin-left: 8px;
            font-weight: 600;
        }

        .dif-pequena {
            background: #e8f8f5;
            color: #27ae60;
        }

        .dif-media {
            background: #fef9e7;
            color: #f39c12;
        }

        .dif-grande {
            background: #fadbd8;
            color: #e74c3c;
        }

        /* Resumo Executivo */
        .resumo-executivo {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 25px;
            border-radius: 10px;
            margin-bottom: 30px;
        }

        .resumo-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .resumo-card {
            background: rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .resumo-valor {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .resumo-label {
            font-size: 14px;
            opacity: 0.9;
        }

        /* Gráfico de Barras Simples */
        .grafico-barras {
            margin: 20px 0;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
        }

        .barra-container {
            margin-bottom: 15px;
        }

        .barra-label {
            font-weight: 600;
            margin-bottom: 5px;
            display: flex;
            justify-content: space-between;
        }

        .barra {
            height: 30px;
            background: linear-gradient(to right, #3498db, #2980b9);
            border-radius: 4px;
            position: relative;
            transition: width 0.5s ease;
        }

        .barra-valor {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        /* Abas de navegação */
        .abas-relatorio {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
        }

        .aba-btn {
            padding: 12px 24px;
            border: none;
            background: #e9ecef;
            color: #495057;
            font-weight: 600;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .aba-btn:hover {
            background: #dee2e6;
        }

        .aba-btn.ativa {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
        }

        .conteudo-aba {
            display: none;
        }

        .conteudo-aba.ativa {
            display: block;
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .relatorio-container {
                padding: 10px;
            }

            .tabela-comparativa {
                font-size: 12px;
            }

            .tabela-comparativa th:first-child {
                width: 120px;
                min-width: 120px;
            }

            .resumo-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        @media print {
            .controles-relatorio,
            .btn-voltar {
                display: none !important;
            }

            .relatorio-container {
                max-width: 100%;
                padding: 0;
            }

            .secao-relatorio {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    <div class="relatorio-container">
        <!-- Cabeçalho do Relatório -->
        <div class="relatorio-header">
            <h1>
                <i class="fas fa-file-alt"></i>
                Relatório Analítico de Propostas
            </h1>
            <div class="info-processo">
                <p><strong>Processo:</strong> <span id="processo-numero">-</span></p>
                <p><strong>Data de Geração:</strong> <span id="data-geracao">-</span></p>
                <p><strong>TR Vinculado:</strong> <span id="tr-vinculado">-</span></p>
            </div>
        </div>

        <!-- Controles -->
        <div class="controles-relatorio">
            <button class="btn-relatorio btn-voltar" onclick="voltarComparativo()">
                <i class="fas fa-arrow-left"></i> Voltar ao Comparativo
            </button>
            <div>
                <button class="btn-relatorio btn-imprimir" onclick="imprimirRelatorio()">
                    <i class="fas fa-print"></i> Imprimir
                </button>
                <button class="btn-relatorio btn-exportar" onclick="exportarPDF()">
                    <i class="fas fa-file-pdf"></i> Exportar PDF
                </button>
            </div>
        </div>

        <!-- Resumo Executivo -->
        <div class="resumo-executivo">
            <h2><i class="fas fa-chart-pie"></i> Resumo Executivo</h2>
            <div class="resumo-grid">
                <div class="resumo-card">
                    <div class="resumo-valor" id="total-propostas">0</div>
                    <div class="resumo-label">Propostas Analisadas</div>
                </div>
                <div class="resumo-card">
                    <div class="resumo-valor" id="variacao-preco">0%</div>
                    <div class="resumo-label">Variação de Preços</div>
                </div>
                <div class="resumo-card">
                    <div class="resumo-valor" id="melhor-valor">R$ 0,00</div>
                    <div class="resumo-label">Menor Valor Global</div>
                </div>
                <div class="resumo-card">
                    <div class="resumo-valor" id="divergencias">0</div>
                    <div class="resumo-label">Divergências Identificadas</div>
                </div>
            </div>
        </div>

        <!-- Abas de Navegação -->
        <div class="abas-relatorio">
            <button class="aba-btn ativa" onclick="mudarAba(event, 'tecnica')">
                <i class="fas fa-cogs"></i> Análise Técnica
            </button>
            <button class="aba-btn" onclick="mudarAba(event, 'comercial')">
                <i class="fas fa-dollar-sign"></i> Análise Comercial
            </button>
            <button class="aba-btn" onclick="mudarAba(event, 'consolidada')">
                <i class="fas fa-chart-bar"></i> Análise Consolidada
            </button>
        </div>

        <!-- Conteúdo das Abas -->
        <div id="conteudo-relatorio">
            <!-- Aba Análise Técnica -->
            <div id="aba-tecnica" class="conteudo-aba ativa">
                <!-- Conteúdo será gerado dinamicamente -->
            </div>
            
            <!-- Aba Análise Comercial -->
            <div id="aba-comercial" class="conteudo-aba">
                <!-- Conteúdo será gerado dinamicamente -->
            </div>
            
            <!-- Aba Análise Consolidada -->
            <div id="aba-consolidada" class="conteudo-aba">
                <!-- Conteúdo será gerado dinamicamente -->
            </div>
        </div>
    </div>

    <script>
        // Classe para gerar o relatório analítico
        class RelatorioAnalitico {
            constructor() {
                this.propostas = [];
                this.processo = null;
                this.divergencias = 0;
                this.init();
            }

            init() {
                // Carregar dados do processo selecionado
                this.carregarDados();
                this.gerarRelatorio();
            }

            carregarDados() {
                // Buscar processo ID da URL ou sessionStorage
                const urlParams = new URLSearchParams(window.location.search);
                const processoId = urlParams.get('processo') || sessionStorage.getItem('processoRelatorio');
                
                if (!processoId) {
                    alert('Nenhum processo selecionado!');
                    return;
                }

                // Buscar dados do localStorage
                const processos = JSON.parse(localStorage.getItem('processos_licitatorios') || '[]');
                this.processo = processos.find(p => p.id === processoId);

                if (!this.processo) {
                    alert('Processo não encontrado!');
                    return;
                }

                // Buscar propostas
                this.propostas = this.buscarPropostasCompletas(processoId);

                // Atualizar informações do cabeçalho
                document.getElementById('processo-numero').textContent = this.processo.numeroProcesso;
                document.getElementById('data-geracao').textContent = new Date().toLocaleString('pt-BR');
                document.getElementById('tr-vinculado').textContent = this.processo.trVinculado?.titulo || 'Não informado';
            }

            buscarPropostasCompletas(processoId) {
                const propostas = [];
                const propostasMap = new Map();
                
                // Buscar em todas as fontes de propostas
                const propostasCompletas = JSON.parse(localStorage.getItem('propostas_completas') || '[]');
                const propostasFornecedores = JSON.parse(localStorage.getItem('propostas_fornecedores') || '[]');
                const propostasComparativo = JSON.parse(localStorage.getItem('propostas_comparativo') || '[]');
                
                // Primeiro, adicionar propostas_fornecedores (prioridade)
                propostasFornecedores.forEach(p => {
                    if (p.processoId === processoId && p.status === 'ENVIADA') {
                        const chave = p.fornecedorCNPJ || p.cnpj;
                        if (chave && !propostasMap.has(chave)) {
                            propostasMap.set(chave, this.formatarProposta(p));
                        }
                    }
                });
                
                // Depois, adicionar propostas_comparativo
                propostasComparativo.forEach(p => {
                    if (p.numeroProcesso === processoId || p.processoId === processoId) {
                        const chave = p.fornecedorCNPJ || p.cnpj;
                        if (chave && !propostasMap.has(chave)) {
                            propostasMap.set(chave, this.formatarProposta(p));
                        }
                    }
                });
                
                // Por último, propostas_completas
                propostasCompletas.forEach(p => {
                    if (p.processoId === processoId) {
                        const chave = p.dadosCadastrais?.cnpj || p.cnpj;
                        if (chave && !propostasMap.has(chave)) {
                            propostasMap.set(chave, this.formatarProposta(p));
                        }
                    }
                });
                
                // Converter Map para array
                return Array.from(propostasMap.values());
            }

            formatarProposta(proposta) {
                // Formatar dados para estrutura padrão
                const dadosCompletos = proposta.dadosCompletos || {};
                
                // Verificar se é array e converter
                const converterArray = (dados) => {
                    if (!dados) return [];
                    if (Array.isArray(dados)) return dados;
                    return [];
                };
                
                return {
                    id: proposta.id,
                    dadosCadastrais: {
                        razaoSocial: proposta.fornecedorRazaoSocial || dadosCompletos.dadosCadastrais?.razaoSocial || proposta.razaoSocial || 'Não informado',
                        cnpj: proposta.fornecedorCNPJ || proposta.cnpj || dadosCompletos.dadosCadastrais?.cnpj || 'Não informado',
                        email: proposta.fornecedorEmail || proposta.email || dadosCompletos.dadosCadastrais?.email || 'Não informado',
                        telefone: proposta.telefone || dadosCompletos.dadosCadastrais?.telefone || 'Não informado',
                        endereco: proposta.endereco || dadosCompletos.dadosCadastrais?.endereco || 'Não informado',
                        respTecnico: proposta.responsavel || dadosCompletos.dadosCadastrais?.respTecnico || 'Não informado',
                        crea: proposta.crea || dadosCompletos.dadosCadastrais?.crea || 'Não informado'
                    },
                    propostaTecnica: dadosCompletos.propostaTecnica || {
                        prazoExecucao: proposta.prazoExecucao || 'Não informado',
                        metodologia: proposta.descricao_tecnica || 'Não informado',
                        garantias: proposta.garantia || 'Não informado',
                        prazoMobilizacao: '15 dias',
                        estruturaCanteiro: 'Conforme necessário'
                    },
                    propostaComercial: dadosCompletos.propostaComercial || {
                        valorTotal: proposta.valor || 0
                    },
                    servicosTecnica: converterArray(dadosCompletos.propostaTecnica?.servicosTecnica),
                    servicosComercial: converterArray(dadosCompletos.propostaComercial?.servicos),
                    maoObraTecnica: converterArray(dadosCompletos.propostaTecnica?.equipe),
                    maoObraComercial: converterArray(dadosCompletos.propostaComercial?.maoObra),
                    materiaisTecnica: converterArray(dadosCompletos.propostaTecnica?.materiais),
                    materiaisComercial: converterArray(dadosCompletos.propostaComercial?.materiaisComercial),
                    equipamentosTecnica: converterArray(dadosCompletos.propostaTecnica?.equipamentos),
                    equipamentosComercial: converterArray(dadosCompletos.propostaComercial?.equipamentosComercial),
                    bdi: converterArray(dadosCompletos.propostaComercial?.bdi),
                    resumoFinanceiro: this.calcularResumoFinanceiro(dadosCompletos.propostaComercial, proposta.valor)
                };
            }

            calcularResumoFinanceiro(comercial, valorTotal) {
                if (!comercial || !comercial.totais) {
                    return {
                        valorTotal: parseFloat(valorTotal || 0),
                        bdiPercentual: 25,
                        custoDireto: parseFloat(valorTotal || 0) * 0.75
                    };
                }
                
                return {
                    totalServicos: this.converterParaNumero(comercial.totais.servicos),
                    totalMaoObra: this.converterParaNumero(comercial.totais.maoObra),
                    totalMateriais: this.converterParaNumero(comercial.totais.materiais),
                    totalEquipamentos: this.converterParaNumero(comercial.totais.equipamentos),
                    custoDireto: this.converterParaNumero(comercial.totais.custoDirecto),
                    bdiPercentual: parseFloat(comercial.totais.bdiPercentual || 25),
                    bdiValor: this.converterParaNumero(comercial.totais.bdiValor),
                    valorTotal: this.converterParaNumero(comercial.valorTotal || valorTotal)
                };
            }

            converterParaNumero(valor) {
                if (!valor) return 0;
                if (typeof valor === 'number') return valor;
                
                const numero = valor.toString()
                    .replace(/R\$/g, '')
                    .replace(/\./g, '')
                    .replace(',', '.')
                    .trim();
                
                return parseFloat(numero) || 0;
            }

            gerarRelatorio() {
                console.log('Propostas encontradas:', this.propostas.length);
                
                if (this.propostas.length === 0) {
                    document.getElementById('conteudo-relatorio').innerHTML = `
                        <div style="text-align: center; padding: 50px; color: #666;">
                            <i class="fas fa-exclamation-circle" style="font-size: 64px; margin-bottom: 20px;"></i>
                            <h3>Nenhuma proposta encontrada</h3>
                            <p>Não há propostas para análise neste processo.</p>
                        </div>
                    `;
                    return;
                }

                // Atualizar resumo executivo
                this.atualizarResumo();

                // Gerar conteúdo para cada aba
                this.gerarConteudoTecnico();
                this.gerarConteudoComercial();
                this.gerarConteudoConsolidado();
            }

            gerarConteudoTecnico() {
                const container = document.getElementById('aba-tecnica');
                container.innerHTML = '';
                container.appendChild(this.gerarSecaoTecnica());
            }

            gerarConteudoComercial() {
                const container = document.getElementById('aba-comercial');
                container.innerHTML = '';
                container.appendChild(this.gerarSecaoComercial());
            }

            gerarConteudoConsolidado() {
                const container = document.getElementById('aba-consolidada');
                container.innerHTML = '';
                container.appendChild(this.gerarSecaoConsolidada());
            }

            atualizarResumo() {
                // Total de propostas
                document.getElementById('total-propostas').textContent = this.propostas.length;

                // Calcular variação de preços
                const valores = this.propostas.map(p => p.resumoFinanceiro?.valorTotal || 0).filter(v => v > 0);
                const menorValor = Math.min(...valores);
                const maiorValor = Math.max(...valores);
                const variacao = valores.length > 0 ? ((maiorValor - menorValor) / menorValor * 100).toFixed(1) : 0;
                
                document.getElementById('variacao-preco').textContent = `${variacao}%`;
                document.getElementById('melhor-valor').textContent = this.formatarMoeda(menorValor);
                document.getElementById('divergencias').textContent = this.divergencias;
            }

            gerarSecaoTecnica() {
                const secao = document.createElement('div');
                secao.className = 'secao-relatorio';
                
                secao.innerHTML = `
                    <div class="secao-header">
                        <i class="fas fa-cogs"></i>
                        ANÁLISE TÉCNICA COMPARATIVA
                    </div>
                    <div class="secao-content">
                        ${this.gerarTabelaDadosCadastrais()}
                        ${this.gerarTabelaPropostaTecnica()}
                        ${this.gerarTabelaServicosTecnicos()}
                        ${this.gerarTabelaMaoObraTecnica()}
                        ${this.gerarTabelaMateriaisTecnica()}
                        ${this.gerarTabelaEquipamentosTecnica()}
                        ${this.gerarAnaliseTecnicaIA()}
                    </div>
                `;
                
                return secao;
            }

            gerarSecaoComercial() {
                const secao = document.createElement('div');
                secao.className = 'secao-relatorio';
                
                secao.innerHTML = `
                    <div class="secao-header">
                        <i class="fas fa-dollar-sign"></i>
                        ANÁLISE COMERCIAL COMPARATIVA
                    </div>
                    <div class="secao-content">
                        ${this.gerarTabelaResumoFinanceiro()}
                        ${this.gerarTabelaServicosComerciais()}
                        ${this.gerarTabelaMaoObraComercial()}
                        ${this.gerarTabelaMateriaisComercial()}
                        ${this.gerarTabelaEquipamentosComercial()}
                        ${this.gerarTabelaBDI()}
                        ${this.gerarAnaliseComercialIA()}
                    </div>
                `;
                
                return secao;
            }

            gerarSecaoConsolidada() {
                const secao = document.createElement('div');
                secao.className = 'secao-relatorio';
                
                secao.innerHTML = `
                    <div class="secao-header">
                        <i class="fas fa-chart-bar"></i>
                        ANÁLISE CONSOLIDADA
                    </div>
                    <div class="secao-content">
                        ${this.gerarGraficoComparativo()}
                        ${this.gerarAnaliseConsolidadaIA()}
                    </div>
                `;
                
                return secao;
            }

            // TABELAS TÉCNICAS
            gerarTabelaDadosCadastrais() {
                let html = '<h3 style="margin-bottom: 15px;">1.1 Dados Cadastrais</h3>';
                html += '<table class="tabela-comparativa">';
                html += '<thead><tr><th>Informação</th>';
                
                // Headers com nomes das empresas
                this.propostas.forEach(p => {
                    html += `<th>${p.dadosCadastrais.razaoSocial}</th>`;
                });
                html += '</tr></thead><tbody>';

                // Linhas de dados
                const campos = [
                    { label: 'CNPJ', key: 'cnpj' },
                    { label: 'E-mail', key: 'email' },
                    { label: 'Telefone', key: 'telefone' },
                    { label: 'Endereço', key: 'endereco' },
                    { label: 'Responsável Técnico', key: 'respTecnico' },
                    { label: 'CREA/CAU', key: 'crea' }
                ];

                campos.forEach(campo => {
                    html += `<tr><td><strong>${campo.label}</strong></td>`;
                    
                    this.propostas.forEach(p => {
                        const valor = p.dadosCadastrais[campo.key];
                        html += `<td>${valor || '<span class="valor-ausente">Não informado</span>'}</td>`;
                    });
                    
                    html += '</tr>';
                });

                html += '</tbody></table>';
                return html;
            }

            gerarTabelaPropostaTecnica() {
                let html = '<h3 style="margin-top: 30px; margin-bottom: 15px;">1.2 Proposta Técnica</h3>';
                html += '<table class="tabela-comparativa">';
                html += '<thead><tr><th>Aspecto Técnico</th>';
                
                this.propostas.forEach(p => {
                    html += `<th>${p.dadosCadastrais.razaoSocial}</th>`;
                });
                html += '</tr></thead><tbody>';

                // Campos técnicos
                const campos = [
                    { label: 'Prazo de Execução', key: 'prazoExecucao' },
                    { label: 'Metodologia', key: 'metodologia' },
                    { label: 'Garantias', key: 'garantias' },
                    { label: 'Prazo de Mobilização', key: 'prazoMobilizacao' },
                    { label: 'Estrutura do Canteiro', key: 'estruturaCanteiro' }
                ];

                campos.forEach(campo => {
                    html += `<tr><td><strong>${campo.label}</strong></td>`;
                    
                    const valores = this.propostas.map(p => p.propostaTecnica[campo.key] || '');
                    const divergente = this.verificarDivergencia(valores);
                    
                    this.propostas.forEach(p => {
                        const valor = p.propostaTecnica[campo.key];
                        const classe = divergente && valor ? 'divergencia-alta' : '';
                        html += `<td class="${classe}">${valor || '<span class="valor-ausente">Não informado</span>'}</td>`;
                    });
                    
                    html += '</tr>';
                });

                html += '</tbody></table>';
                return html;
            }

            gerarTabelaServicosTecnicos() {
                let html = '<h3 style="margin-top: 30px; margin-bottom: 15px;">1.3 Serviços - Quantidades</h3>';
                
                // Coletar todos os serviços únicos
                const servicosUnicos = this.coletarItensUnicos('servicosTecnica', 1); // índice 1 = descrição
                
                if (servicosUnicos.length === 0) {
                    return html + '<p style="color: #666; padding: 20px;">Nenhum serviço técnico detalhado nas propostas.</p>';
                }

                html += '<table class="tabela-comparativa">';
                html += '<thead><tr><th>Serviço</th>';
                
                this.propostas.forEach(p => {
                    html += `<th>${p.dadosCadastrais.razaoSocial}<br><small>Qtd | Unid</small></th>`;
                });
                html += '</tr></thead><tbody>';

                servicosUnicos.forEach(servico => {
                    html += `<tr><td><strong>${servico}</strong></td>`;
                    
                    const quantidades = [];
                    this.propostas.forEach(p => {
                        const servicoProposta = p.servicosTecnica?.find(s => s[1] === servico);
                        if (servicoProposta) {
                            const qtd = servicoProposta[3] || '-';
                            const unid = servicoProposta[2] || '-';
                            quantidades.push(qtd);
                            html += `<td>${qtd} ${unid}</td>`;
                        } else {
                            html += '<td><span class="valor-ausente">Não cotado</span></td>';
                        }
                    });
                    
                    // Verificar divergências nas quantidades
                    if (this.verificarDivergenciaQuantidades(quantidades)) {
                        this.divergencias++;
                    }
                    
                    html += '</tr>';
                });

                html += '</tbody></table>';
                return html;
            }

            gerarTabelaMaoObraTecnica() {
                let html = '<h3 style="margin-top: 30px; margin-bottom: 15px;">1.4 Mão de Obra - Equipe Técnica</h3>';
                
                const funcoesUnicas = this.coletarItensUnicos('maoObraTecnica', 0); // índice 0 = função
                
                if (funcoesUnicas.length === 0) {
                    return html + '<p style="color: #666; padding: 20px;">Nenhuma equipe técnica detalhada nas propostas.</p>';
                }

                html += '<table class="tabela-comparativa">';
                html += '<thead><tr><th>Função</th>';
                
                this.propostas.forEach(p => {
                    html += `<th>${p.dadosCadastrais.razaoSocial}<br><small>Qtd | Meses</small></th>`;
                });
                html += '</tr></thead><tbody>';

                funcoesUnicas.forEach(funcao => {
                    html += `<tr><td><strong>${funcao}</strong></td>`;
                    
                    this.propostas.forEach(p => {
                        const funcaoProposta = p.maoObraTecnica?.find(f => f[0] === funcao);
                        if (funcaoProposta) {
                            const qtd = funcaoProposta[1] || '-';
                            const meses = funcaoProposta[2] || '-';
                            html += `<td>${qtd} profissionais | ${meses} meses</td>`;
                        } else {
                            html += '<td><span class="valor-ausente">Não informado</span></td>';
                        }
                    });
                    
                    html += '</tr>';
                });

                html += '</tbody></table>';
                return html;
            }

            gerarTabelaMateriaisTecnica() {
                let html = '<h3 style="margin-top: 30px; margin-bottom: 15px;">1.5 Materiais - Quantidades</h3>';
                
                const materiaisUnicos = this.coletarItensUnicos('materiaisTecnica', 0); // índice 0 = material
                
                if (materiaisUnicos.length === 0) {
                    return html + '<p style="color: #666; padding: 20px;">Nenhum material técnico detalhado nas propostas.</p>';
                }

                html += '<table class="tabela-comparativa">';
                html += '<thead><tr><th>Material</th>';
                
                this.propostas.forEach(p => {
                    html += `<th>${p.dadosCadastrais.razaoSocial}<br><small>Qtd | Unid</small></th>`;
                });
                html += '</tr></thead><tbody>';

                materiaisUnicos.forEach(material => {
                    html += `<tr><td><strong>${material}</strong></td>`;
                    
                    this.propostas.forEach(p => {
                        const materialProposta = p.materiaisTecnica?.find(m => m[0] === material);
                        if (materialProposta) {
                            const qtd = materialProposta[3] || '-';
                            const unid = materialProposta[2] || '-';
                            html += `<td>${qtd} ${unid}</td>`;
                        } else {
                            html += '<td><span class="valor-ausente">Não informado</span></td>';
                        }
                    });
                    
                    html += '</tr>';
                });

                html += '</tbody></table>';
                return html;
            }

            gerarTabelaEquipamentosTecnica() {
                let html = '<h3 style="margin-top: 30px; margin-bottom: 15px;">1.6 Equipamentos - Quantidades</h3>';
                
                const equipamentosUnicos = this.coletarItensUnicos('equipamentosTecnica', 0); // índice 0 = equipamento
                
                if (equipamentosUnicos.length === 0) {
                    return html + '<p style="color: #666; padding: 20px;">Nenhum equipamento técnico detalhado nas propostas.</p>';
                }

                html += '<table class="tabela-comparativa">';
                html += '<thead><tr><th>Equipamento</th>';
                
                this.propostas.forEach(p => {
                    html += `<th>${p.dadosCadastrais.razaoSocial}<br><small>Qtd | Tempo</small></th>`;
                });
                html += '</tr></thead><tbody>';

                equipamentosUnicos.forEach(equipamento => {
                    html += `<tr><td><strong>${equipamento}</strong></td>`;
                    
                    this.propostas.forEach(p => {
                        const equipamentoProposta = p.equipamentosTecnica?.find(e => e[0] === equipamento);
                        if (equipamentoProposta) {
                            const qtd = equipamentoProposta[3] || '-';
                            const tempo = equipamentoProposta[4] || '-';
                            html += `<td>${qtd} unid. | ${tempo} meses</td>`;
                        } else {
                            html += '<td><span class="valor-ausente">Não informado</span></td>';
                        }
                    });
                    
                    html += '</tr>';
                });

                html += '</tbody></table>';
                return html;
            }

            // TABELAS COMERCIAIS
            gerarTabelaResumoFinanceiro() {
                let html = '<h3 style="margin-bottom: 15px;">2.1 Resumo Financeiro</h3>';
                html += '<table class="tabela-comparativa">';
                html += '<thead><tr><th>Componente</th>';
                
                this.propostas.forEach(p => {
                    html += `<th>${p.dadosCadastrais.razaoSocial}</th>`;
                });
                html += '</tr></thead><tbody>';

                // Componentes do resumo
                const componentes = [
                    { label: 'Total Serviços', key: 'totalServicos' },
                    { label: 'Total Mão de Obra', key: 'totalMaoObra' },
                    { label: 'Total Materiais', key: 'totalMateriais' },
                    { label: 'Total Equipamentos', key: 'totalEquipamentos' },
                    { label: 'Custo Direto', key: 'custoDireto' },
                    { label: 'BDI (%)', key: 'bdiPercentual', tipo: 'percentual' },
                    { label: 'BDI (R$)', key: 'bdiValor' },
                    { label: 'VALOR TOTAL', key: 'valorTotal', destaque: true }
                ];

                componentes.forEach(comp => {
                    const estilo = comp.destaque ? 'background: #34495e; color: white;' : '';
                    html += `<tr><td style="${estilo}"><strong>${comp.label}</strong></td>`;
                    
                    const valores = [];
                    this.propostas.forEach(p => {
                        const valor = p.resumoFinanceiro?.[comp.key] || 0;
                        if (comp.tipo !== 'percentual') {
                            valores.push(valor);
                        }
                        
                        if (comp.tipo === 'percentual') {
                            html += `<td style="${estilo}">${valor}%</td>`;
                        } else {
                            const classeValor = comp.destaque ? this.getClasseValor(valor, valores) : '';
                            html += `<td class="${classeValor}" style="${estilo}">
                                ${comp.destaque ? '<strong>' : ''}
                                R$ ${this.formatarMoeda(valor)}
                                ${comp.destaque ? '</strong>' : ''}
                            </td>`;
                        }
                    });
                    
                    html += '</tr>';
                });

                html += '</tbody></table>';
                return html;
            }

            gerarTabelaServicosComerciais() {
                let html = '<h3 style="margin-top: 30px; margin-bottom: 15px;">2.2 Serviços - Valores</h3>';
                
                const servicosUnicos = this.coletarItensUnicos('servicosComercial', 1); // índice 1 = descrição
                
                if (servicosUnicos.length === 0) {
                    return html + '<p style="color: #666; padding: 20px;">Nenhum serviço comercial detalhado nas propostas.</p>';
                }

                html += '<table class="tabela-comparativa">';
                html += '<thead><tr><th>Serviço</th>';
                
                this.propostas.forEach(p => {
                    html += `<th>${p.dadosCadastrais.razaoSocial}<br><small>Qtd | Un | Preço Unit. | Total</small></th>`;
                });
                html += '</tr></thead><tbody>';

                servicosUnicos.forEach(servico => {
                    html += `<tr><td><strong>${servico}</strong></td>`;
                    
                    const precos = [];
                    this.propostas.forEach(p => {
                        const servicoProposta = p.servicosComercial?.find(s => s[1] === servico);
                        if (servicoProposta) {
                            const qtd = servicoProposta[3] || '-';
                            const unid = servicoProposta[2] || '-';
                            const precoUnit = this.converterParaNumero(servicoProposta[4]);
                            const total = this.converterParaNumero(servicoProposta[5]);
                            precos.push(precoUnit);
                            
                            const classePrecio = this.getClasseValor(precoUnit, precos);
                            html += `<td class="${classePrecio}">
                                ${qtd} ${unid}<br>
                                R$ ${servicoProposta[4] || '0,00'}<br>
                                <strong>R$ ${servicoProposta[5] || '0,00'}</strong>
                            </td>`;
                        } else {
                            html += '<td><span class="valor-ausente">Não cotado</span></td>';
                        }
                    });
                    
                    html += '</tr>';
                });

                html += '</tbody></table>';
                return html;
            }

            gerarTabelaMaoObraComercial() {
                let html = '<h3 style="margin-top: 30px; margin-bottom: 15px;">2.3 Mão de Obra - Custos</h3>';
                
                const funcoesUnicas = this.coletarItensUnicos('maoObraComercial', 0);
                
                if (funcoesUnicas.length === 0) {
                    return html + '<p style="color: #666; padding: 20px;">Nenhum custo de mão de obra detalhado nas propostas.</p>';
                }

                html += '<table class="tabela-comparativa">';
                html += '<thead><tr><th>Função</th>';
                
                this.propostas.forEach(p => {
                    html += `<th>${p.dadosCadastrais.razaoSocial}<br><small>Qtd | Meses | Salário | Enc. | Total</small></th>`;
                });
                html += '</tr></thead><tbody>';

                funcoesUnicas.forEach(funcao => {
                    html += `<tr><td><strong>${funcao}</strong></td>`;
                    
                    const salarios = [];
                    this.propostas.forEach(p => {
                        const funcaoProposta = p.maoObraComercial?.find(f => f[0] === funcao);
                        if (funcaoProposta) {
                            const qtd = funcaoProposta[1] || '-';
                            const meses = funcaoProposta[2] || '-';
                            const salario = this.converterParaNumero(funcaoProposta[3]);
                            salarios.push(salario);
                            
                            const classeSalario = this.getClasseValor(salario, salarios);
                            html += `<td class="${classeSalario}">
                                ${qtd} prof. | ${meses} meses<br>
                                R$ ${funcaoProposta[3] || '0,00'}<br>
                                ${funcaoProposta[4] || '0'}%<br>
                                <strong>R$ ${funcaoProposta[6] || '0,00'}</strong>
                            </td>`;
                        } else {
                            html += '<td><span class="valor-ausente">Não informado</span></td>';
                        }
                    });
                    
                    html += '</tr>';
                });

                html += '</tbody></table>';
                return html;
            }

            gerarTabelaMateriaisComercial() {
                let html = '<h3 style="margin-top: 30px; margin-bottom: 15px;">2.4 Materiais - Custos</h3>';
                
                const materiaisUnicos = this.coletarItensUnicos('materiaisComercial', 0);
                
                if (materiaisUnicos.length === 0) {
                    return html + '<p style="color: #666; padding: 20px;">Nenhum material detalhado nas propostas.</p>';
                }

                html += '<table class="tabela-comparativa">';
                html += '<thead><tr><th>Material</th>';
                
                this.propostas.forEach(p => {
                    html += `<th>${p.dadosCadastrais.razaoSocial}<br><small>Qtd | Un | Preço Unit. | Total</small></th>`;
                });
                html += '</tr></thead><tbody>';

                materiaisUnicos.forEach(material => {
                    html += `<tr><td><strong>${material}</strong></td>`;
                    
                    const precos = [];
                    this.propostas.forEach(p => {
                        const materialProposta = p.materiaisComercial?.find(m => m[0] === material);
                        if (materialProposta) {
                            const qtd = materialProposta[3] || '-';
                            const unid = materialProposta[2] || '-';
                            const precoUnit = this.converterParaNumero(materialProposta[4]);
                            precos.push(precoUnit);
                            
                            const classePreco = this.getClasseValor(precoUnit, precos);
                            html += `<td class="${classePreco}">
                                ${qtd} ${unid}<br>
                                R$ ${materialProposta[4] || '0,00'}<br>
                                <strong>R$ ${materialProposta[5] || '0,00'}</strong>
                            </td>`;
                        } else {
                            html += '<td><span class="valor-ausente">Não cotado</span></td>';
                        }
                    });
                    
                    html += '</tr>';
                });

                html += '</tbody></table>';
                return html;
            }

            gerarTabelaEquipamentosComercial() {
                let html = '<h3 style="margin-top: 30px; margin-bottom: 15px;">2.5 Equipamentos - Custos</h3>';
                
                const equipamentosUnicos = this.coletarItensUnicos('equipamentosComercial', 0);
                
                if (equipamentosUnicos.length === 0) {
                    return html + '<p style="color: #666; padding: 20px;">Nenhum equipamento detalhado nas propostas.</p>';
                }

                html += '<table class="tabela-comparativa">';
                html += '<thead><tr><th>Equipamento</th>';
                
                this.propostas.forEach(p => {
                    html += `<th>${p.dadosCadastrais.razaoSocial}<br><small>Qtd | Meses | P./Mês | Total</small></th>`;
                });
                html += '</tr></thead><tbody>';

                equipamentosUnicos.forEach(equipamento => {
                    html += `<tr><td><strong>${equipamento}</strong></td>`;
                    
                    const precos = [];
                    this.propostas.forEach(p => {
                        const equipamentoProposta = p.equipamentosComercial?.find(e => e[0] === equipamento);
                        if (equipamentoProposta) {
                            const qtd = equipamentoProposta[2] || '-';
                            const meses = equipamentoProposta[3] || '-';
                            const precoMes = this.converterParaNumero(equipamentoProposta[4]);
                            precos.push(precoMes);
                            
                            const classePreco = this.getClasseValor(precoMes, precos);
                            html += `<td class="${classePreco}">
                                ${qtd} unid. | ${meses} meses<br>
                                R$ ${equipamentoProposta[4] || '0,00'}<br>
                                <strong>R$ ${equipamentoProposta[5] || '0,00'}</strong>
                            </td>`;
                        } else {
                            html += '<td><span class="valor-ausente">Não cotado</span></td>';
                        }
                    });
                    
                    html += '</tr>';
                });

                html += '</tbody></table>';
                return html;
            }

            gerarTabelaBDI() {
                let html = '<h3 style="margin-top: 30px; margin-bottom: 15px;">2.6 BDI Detalhado</h3>';
                
                const itensBDI = this.coletarItensUnicos('bdi', 0);
                
                if (itensBDI.length === 0) {
                    return html + '<p style="color: #666; padding: 20px;">Nenhum BDI detalhado nas propostas.</p>';
                }

                html += '<table class="tabela-comparativa">';
                html += '<thead><tr><th>Item do BDI</th>';
                
                this.propostas.forEach(p => {
                    html += `<th>${p.dadosCadastrais.razaoSocial}<br><small>% | Valor</small></th>`;
                });
                html += '</tr></thead><tbody>';

                itensBDI.forEach(item => {
                    html += `<tr><td><strong>${item}</strong></td>`;
                    
                    this.propostas.forEach(p => {
                        const itemBDI = p.bdi?.find(b => b[0] === item);
                        if (itemBDI) {
                            const percentual = parseFloat(itemBDI[1]) || 0;
                            const indicador = this.getIndicadorDiferenca(percentual, 0, 5);
                            html += `<td>
                                ${percentual.toFixed(1)}% ${indicador}<br>
                                <small>R$ ${this.formatarMoeda(this.converterParaNumero(itemBDI[2]))}</small>
                            </td>`;
                        } else {
                            html += '<td><span class="valor-ausente">Não informado</span></td>';
                        }
                    });
                    
                    html += '</tr>';
                });

                // Linha de total
                html += '<tr style="background: #f8f9fa; font-weight: bold;">';
                html += '<td>BDI TOTAL</td>';
                
                this.propostas.forEach(p => {
                    const totalBDI = p.resumoFinanceiro?.bdiPercentual || 0;
                    const valorBDI = p.resumoFinanceiro?.bdiValor || 0;
                    html += `<td>
                        <span style="color: #e74c3c;">${totalBDI}%</span><br>
                        <span style="color: #27ae60;">R$ ${this.formatarMoeda(valorBDI)}</span>
                    </td>`;
                });
                
                html += '</tr></tbody></table>';
                return html;
            }

            gerarGraficoComparativo() {
                let html = '<h3 style="margin-bottom: 20px;">Comparativo de Valores Totais</h3>';
                html += '<div class="grafico-barras">';
                
                const valores = this.propostas.map(p => ({
                    empresa: p.dadosCadastrais.razaoSocial,
                    valor: p.resumoFinanceiro?.valorTotal || 0
                })).sort((a, b) => a.valor - b.valor);
                
                const maiorValor = Math.max(...valores.map(v => v.valor));
                
                valores.forEach((item, index) => {
                    const percentual = (item.valor / maiorValor * 100).toFixed(0);
                    const cor = index === 0 ? 'linear-gradient(to right, #27ae60, #2ecc71)' : 
                               index === valores.length - 1 ? 'linear-gradient(to right, #e74c3c, #c0392b)' : 
                               'linear-gradient(to right, #3498db, #2980b9)';
                    
                    html += `
                        <div class="barra-container">
                            <div class="barra-label">
                                <span>${item.empresa}</span>
                                <span>${this.formatarMoeda(item.valor)}</span>
                            </div>
                            <div class="barra" style="width: ${percentual}%; background: ${cor};">
                                <span class="barra-valor">${percentual}%</span>
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                return html;
            }

            // ANÁLISES IA
            gerarAnaliseTecnicaIA() {
                let html = '<div class="analise-ia">';
                html += '<div class="analise-ia-header">';
                html += '<i class="fas fa-brain"></i> Análise Inteligente - Aspectos Técnicos';
                html += '</div>';
                html += '<div class="analise-ia-content">';
                
                const insights = this.analisarAspectosTecnicos();
                
                insights.forEach(insight => {
                    html += `
                        <div class="insight-item">
                            <div class="insight-tipo">
                                <i class="${insight.icone}"></i>
                                ${insight.tipo}
                            </div>
                            <div class="insight-texto">${insight.texto}</div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                return html;
            }

            gerarAnaliseComercialIA() {
                let html = '<div class="analise-ia">';
                html += '<div class="analise-ia-header">';
                html += '<i class="fas fa-brain"></i> Análise Inteligente - Aspectos Comerciais';
                html += '</div>';
                html += '<div class="analise-ia-content">';
                
                const insights = this.analisarAspectosComerciais();
                
                insights.forEach(insight => {
                    html += `
                        <div class="insight-item">
                            <div class="insight-tipo">
                                <i class="${insight.icone}"></i>
                                ${insight.tipo}
                            </div>
                            <div class="insight-texto">${insight.texto}</div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                return html;
            }

            gerarAnaliseConsolidadaIA() {
                let html = '<div class="analise-ia">';
                html += '<div class="analise-ia-header">';
                html += '<i class="fas fa-brain"></i> Recomendações Finais';
                html += '</div>';
                html += '<div class="analise-ia-content">';
                
                const insights = this.gerarRecomendacoes();
                
                insights.forEach(insight => {
                    html += `
                        <div class="insight-item">
                            <div class="insight-tipo">
                                <i class="${insight.icone}"></i>
                                ${insight.tipo}
                            </div>
                            <div class="insight-texto">${insight.texto}</div>
                        </div>
                    `;
                });
                
                html += '</div></div>';
                return html;
            }

            // Métodos de análise
            analisarAspectosTecnicos() {
                const insights = [];
                
                // 1. Análise detalhada de prazos
                const prazos = this.propostas.map(p => ({
                    empresa: p.dadosCadastrais.razaoSocial,
                    prazo: parseInt(p.propostaTecnica?.prazoExecucao) || 0
                })).filter(p => p.prazo > 0);
                
                if (prazos.length > 0) {
                    const menorPrazo = Math.min(...prazos.map(p => p.prazo));
                    const maiorPrazo = Math.max(...prazos.map(p => p.prazo));
                    const mediaPrazo = prazos.reduce((sum, p) => sum + p.prazo, 0) / prazos.length;
                    
                    if (maiorPrazo - menorPrazo > 30) {
                        const empresaMenorPrazo = prazos.find(p => p.prazo === menorPrazo).empresa;
                        const empresaMaiorPrazo = prazos.find(p => p.prazo === maiorPrazo).empresa;
                        
                        insights.push({
                            tipo: 'Análise Crítica de Prazos',
                            icone: 'fas fa-clock',
                            texto: `<strong>Divergência significativa identificada:</strong><br>
                                    • Menor prazo: ${menorPrazo} dias (${empresaMenorPrazo})<br>
                                    • Maior prazo: ${maiorPrazo} dias (${empresaMaiorPrazo})<br>
                                    • Diferença: ${maiorPrazo - menorPrazo} dias (${((maiorPrazo - menorPrazo) / menorPrazo * 100).toFixed(0)}%)<br>
                                    • Média: ${mediaPrazo.toFixed(0)} dias<br><br>
                                    <strong>Recomendação:</strong> Solicitar cronograma físico-financeiro detalhado da empresa com menor prazo 
                                    para verificar exequibilidade e avaliar riscos de atrasos.`
                        });
                    }
                }
                
                // 2. Análise de equipe técnica
                const equipes = this.propostas.map(p => ({
                    empresa: p.dadosCadastrais.razaoSocial,
                    totalProfissionais: p.maoObraTecnica?.reduce((sum, f) => sum + (parseInt(f[1]) || 0), 0) || 0,
                    funcoes: p.maoObraTecnica?.length || 0
                }));
                
                if (equipes.some(e => e.totalProfissionais > 0)) {
                    const maiorEquipe = Math.max(...equipes.map(e => e.totalProfissionais));
                    const menorEquipe = Math.min(...equipes.filter(e => e.totalProfissionais > 0).map(e => e.totalProfissionais));
                    
                    insights.push({
                        tipo: 'Dimensionamento de Equipe',
                        icone: 'fas fa-users',
                        texto: `<strong>Análise de recursos humanos:</strong><br>
                                ${equipes.map(e => `• ${e.empresa}: ${e.totalProfissionais} profissionais em ${e.funcoes} funções`).join('<br>')}<br><br>
                                <strong>Observação:</strong> Equipes variam de ${menorEquipe} a ${maiorEquipe} profissionais.<br>
                                ${maiorEquipe / menorEquipe > 2 ? '<strong>⚠️ Alerta:</strong> Diferença superior a 100% pode indicar interpretações divergentes do escopo.' : ''}
                                <br><strong>Recomendação:</strong> Verificar se o dimensionamento proposto é adequado ao prazo e escopo dos serviços.`
                    });
                }
                
                // 3. Análise de metodologia e qualidade técnica
                const metodologias = this.propostas.map(p => ({
                    empresa: p.dadosCadastrais.razaoSocial,
                    temMetodologia: p.propostaTecnica?.metodologia && p.propostaTecnica.metodologia !== 'Não informado',
                    temGarantia: p.propostaTecnica?.garantias && p.propostaTecnica.garantias !== 'Não informado',
                    completude: this.calcularCompletude(p)
                }));
                
                const bemDocumentadas = metodologias.filter(m => m.temMetodologia && m.temGarantia).length;
                const malDocumentadas = metodologias.filter(m => !m.temMetodologia || !m.temGarantia);
                
                if (malDocumentadas.length > 0) {
                    insights.push({
                        tipo: 'Qualidade da Documentação Técnica',
                        icone: 'fas fa-file-alt',
                        texto: `<strong>Avaliação da documentação:</strong><br>
                                • Propostas bem documentadas: ${bemDocumentadas} de ${this.propostas.length}<br>
                                • Média de completude: ${(metodologias.reduce((sum, m) => sum + m.completude, 0) / metodologias.length).toFixed(0)}%<br><br>
                                <strong>Propostas com documentação insuficiente:</strong><br>
                                ${malDocumentadas.map(m => `• ${m.empresa}: ${!m.temMetodologia ? 'Metodologia ausente' : ''} ${!m.temGarantia ? 'Garantia não especificada' : ''}`).join('<br>')}<br><br>
                                <strong>Recomendação:</strong> Solicitar complementação de informações técnicas antes da adjudicação.`
                    });
                }
                
                // 4. Análise de materiais e equipamentos
                const recursos = this.propostas.map(p => ({
                    empresa: p.dadosCadastrais.razaoSocial,
                    qtdMateriais: p.materiaisTecnica?.length || 0,
                    qtdEquipamentos: p.equipamentosTecnica?.length || 0
                }));
                
                const variacaoRecursos = recursos.some(r => r.qtdMateriais > 0 || r.qtdEquipamentos > 0);
                if (variacaoRecursos) {
                    insights.push({
                        tipo: 'Recursos Materiais e Equipamentos',
                        icone: 'fas fa-tools',
                        texto: `<strong>Comparativo de recursos propostos:</strong><br>
                                ${recursos.map(r => `• ${r.empresa}: ${r.qtdMateriais} tipos de materiais, ${r.qtdEquipamentos} tipos de equipamentos`).join('<br>')}<br><br>
                                <strong>Análise:</strong> ${recursos.some(r => r.qtdMateriais === 0 && r.qtdEquipamentos === 0) ? 
                                'Algumas empresas não detalharam recursos, o que pode indicar:<br>• Inclusão no BDI<br>• Subcontratação prevista<br>• Omissão de informações' : 
                                'Todas as empresas especificaram recursos necessários.'}<br><br>
                                <strong>Recomendação:</strong> Confirmar disponibilidade de recursos críticos para execução.`
                    });
                }
                
                // 5. Análise de riscos técnicos
                const riscos = [];
                
                // Risco de prazo
                if (prazos.length > 0) {
                    const mediaPrazo = prazos.reduce((sum, p) => sum + p.prazo, 0) / prazos.length;
                    const cvPrazo = (Math.max(...prazos.map(p => p.prazo)) - Math.min(...prazos.map(p => p.prazo))) / mediaPrazo;
                    if (cvPrazo > 0.3) riscos.push('Alta variação nos prazos propostos (risco de cronograma)');
                }
                
                // Risco de equipe
                if (equipes.some(e => e.totalProfissionais < 5)) {
                    riscos.push('Equipes reduzidas propostas (risco de capacidade produtiva)');
                }
                
                // Risco de documentação
                if (metodologias.filter(m => m.completude < 70).length > 0) {
                    riscos.push('Propostas com baixa completude técnica (risco de indefinições)');
                }
                
                if (riscos.length > 0) {
                    insights.push({
                        tipo: 'Matriz de Riscos Técnicos',
                        icone: 'fas fa-exclamation-triangle',
                        texto: `<strong>Riscos identificados na análise técnica:</strong><br>
                                ${riscos.map((r, i) => `${i + 1}. ${r}`).join('<br>')}<br><br>
                                <strong>Mitigação sugerida:</strong><br>
                                • Realizar reunião de alinhamento técnico pré-contratual<br>
                                • Estabelecer marcos de verificação no cronograma<br>
                                • Definir penalidades contratuais para atrasos<br>
                                • Exigir seguro-garantia de execução`
                    });
                }
                
                return insights;
            }

            analisarAspectosComerciais() {
                const insights = [];
                
                // 1. Análise detalhada de valores
                const valores = this.propostas.map(p => ({
                    empresa: p.dadosCadastrais.razaoSocial,
                    valor: p.resumoFinanceiro?.valorTotal || 0,
                    bdi: p.resumoFinanceiro?.bdiPercentual || 0,
                    custoDireto: p.resumoFinanceiro?.custoDireto || 0
                })).filter(v => v.valor > 0);
                
                if (valores.length > 0) {
                    const menorValor = Math.min(...valores.map(v => v.valor));
                    const maiorValor = Math.max(...valores.map(v => v.valor));
                    const mediaValor = valores.reduce((sum, v) => sum + v.valor, 0) / valores.length;
                    const variacao = ((maiorValor - menorValor) / menorValor * 100).toFixed(1);
                    
                    // Encontrar empresas
                    const empresaMenor = valores.find(v => v.valor === menorValor);
                    const empresaMaior = valores.find(v => v.valor === maiorValor);
                    
                    insights.push({
                        tipo: 'Análise Detalhada de Preços',
                        icone: 'fas fa-chart-line',
                        texto: `<strong>Resumo da análise de valores:</strong><br>
                                • Menor valor: ${this.formatarMoeda(menorValor)} (${empresaMenor.empresa})<br>
                                • Maior valor: ${this.formatarMoeda(maiorValor)} (${empresaMaior.empresa})<br>
                                • Valor médio: ${this.formatarMoeda(mediaValor)}<br>
                                • Variação: ${variacao}% entre menor e maior<br><br>
                                <strong>Análise estatística:</strong><br>
                                • Desvio do menor valor em relação à média: ${(((menorValor - mediaValor) / mediaValor) * 100).toFixed(1)}%<br>
                                • ${variacao > 20 ? '⚠️ <strong>Alerta:</strong> Variação superior a 20% indica possível divergência na interpretação do escopo' : '✓ Variação dentro de parâmetros aceitáveis'}<br><br>
                                <strong>Recomendação:</strong> ${variacao > 20 ? 'Realizar diligência para confirmar escopo com todos os licitantes' : 'Valores apresentam consistência adequada'}`
                    });
                }
                
                // 2. Análise de composição de custos
                const composicoes = valores.map(v => {
                    const servicos = this.propostas.find(p => p.dadosCadastrais.razaoSocial === v.empresa)?.resumoFinanceiro?.totalServicos || 0;
                    const maoObra = this.propostas.find(p => p.dadosCadastrais.razaoSocial === v.empresa)?.resumoFinanceiro?.totalMaoObra || 0;
                    const materiais = this.propostas.find(p => p.dadosCadastrais.razaoSocial === v.empresa)?.resumoFinanceiro?.totalMateriais || 0;
                    const equipamentos = this.propostas.find(p => p.dadosCadastrais.razaoSocial === v.empresa)?.resumoFinanceiro?.totalEquipamentos || 0;
                    
                    return {
                        empresa: v.empresa,
                        servicos: servicos,
                        maoObra: maoObra,
                        materiais: materiais,
                        equipamentos: equipamentos,
                        total: servicos + maoObra + materiais + equipamentos
                    };
                });
                
                if (composicoes.some(c => c.total > 0)) {
                    const analiseComposicao = composicoes.map(c => {
                        const percServicos = c.total > 0 ? (c.servicos / c.total * 100).toFixed(1) : 0;
                        const percMaoObra = c.total > 0 ? (c.maoObra / c.total * 100).toFixed(1) : 0;
                        const percMateriais = c.total > 0 ? (c.materiais / c.total * 100).toFixed(1) : 0;
                        const percEquipamentos = c.total > 0 ? (c.equipamentos / c.total * 100).toFixed(1) : 0;
                        
                        return `• ${c.empresa}:<br>
                                &nbsp;&nbsp;- Serviços: ${percServicos}% | Mão de obra: ${percMaoObra}%<br>
                                &nbsp;&nbsp;- Materiais: ${percMateriais}% | Equipamentos: ${percEquipamentos}%`;
                    }).join('<br>');
                    
                    insights.push({
                        tipo: 'Composição de Custos Diretos',
                        icone: 'fas fa-calculator',
                        texto: `<strong>Distribuição percentual dos custos:</strong><br>
                                ${analiseComposicao}<br><br>
                                <strong>Análise:</strong> Variações significativas na composição podem indicar:<br>
                                • Diferentes estratégias de execução<br>
                                • Interpretações divergentes do escopo<br>
                                • Diferentes níveis de verticalização<br><br>
                                <strong>Recomendação:</strong> Avaliar se as composições são compatíveis com a natureza dos serviços.`
                    });
                }
                
                // 3. Análise de BDI
                const bdis = valores.filter(v => v.bdi > 0);
                if (bdis.length > 0) {
                    const menorBDI = Math.min(...bdis.map(b => b.bdi));
                    const maiorBDI = Math.max(...bdis.map(b => b.bdi));
                    const mediaBDI = bdis.reduce((sum, b) => sum + b.bdi, 0) / bdis.length;
                    
                    // Análise de componentes do BDI
                    const componentesBDI = this.propostas.map(p => ({
                        empresa: p.dadosCadastrais.razaoSocial,
                        itens: p.bdi || []
                    })).filter(c => c.itens.length > 0);
                    
                    insights.push({
                        tipo: 'Análise Detalhada do BDI',
                        icone: 'fas fa-percentage',
                        texto: `<strong>Análise comparativa do BDI:</strong><br>
                                • BDI mínimo: ${menorBDI.toFixed(1)}%<br>
                                • BDI máximo: ${maiorBDI.toFixed(1)}%<br>
                                • BDI médio: ${mediaBDI.toFixed(1)}%<br>
                                • Variação: ${(maiorBDI - menorBDI).toFixed(1)} pontos percentuais<br><br>
                                <strong>Referências (Acórdão TCU 2622/2013):</strong><br>
                                • Construção civil: 20,34% a 25,00%<br>
                                • Reformas: 24,23% a 28,82%<br><br>
                                ${mediaBDI > 28.82 ? '⚠️ <strong>Alerta:</strong> BDI médio acima dos parâmetros do TCU' : '✓ BDI dentro dos parâmetros referenciais'}<br><br>
                                <strong>Recomendação:</strong> ${maiorBDI > 28.82 ? 'Solicitar detalhamento e justificativa para BDI acima do referencial' : 'BDI apresentado está adequado'}`
                    });
                }
                
                // 4. Análise de preços unitários críticos
                const servicosComuns = this.coletarItensUnicos('servicosComercial', 1);
                if (servicosComuns.length > 0) {
                    // Analisar os 5 serviços mais relevantes
                    const servicosRelevantes = servicosComuns.slice(0, 5).map(servico => {
                        const precos = this.propostas.map(p => {
                            const item = p.servicosComercial?.find(s => s[1] === servico);
                            return {
                                empresa: p.dadosCadastrais.razaoSocial,
                                precoUnit: item ? this.converterParaNumero(item[4]) : 0,
                                quantidade: item ? parseFloat(item[3]) || 0 : 0
                            };
                        }).filter(p => p.precoUnit > 0);
                        
                        if (precos.length > 0) {
                            const menorPreco = Math.min(...precos.map(p => p.precoUnit));
                            const maiorPreco = Math.max(...precos.map(p => p.precoUnit));
                            const variacaoPreco = ((maiorPreco - menorPreco) / menorPreco * 100).toFixed(0);
                            
                            return {
                                servico: servico.substring(0, 50) + (servico.length > 50 ? '...' : ''),
                                variacao: variacaoPreco,
                                critico: variacaoPreco > 30
                            };
                        }
                        return null;
                    }).filter(s => s !== null);
                    
                    const servicosCriticos = servicosRelevantes.filter(s => s.critico);
                    
                    if (servicosRelevantes.length > 0) {
                        insights.push({
                            tipo: 'Análise de Preços Unitários',
                            icone: 'fas fa-search-dollar',
                            texto: `<strong>Variação nos principais serviços:</strong><br>
                                    ${servicosRelevantes.map(s => `• ${s.servico}: ${s.variacao}% ${s.critico ? '⚠️' : '✓'}`).join('<br>')}<br><br>
                                    ${servicosCriticos.length > 0 ? 
                                    `<strong>⚠️ Serviços com variação crítica (>30%):</strong> ${servicosCriticos.length}<br>
                                    <strong>Recomendação:</strong> Solicitar memória de cálculo para itens com alta variação` : 
                                    '<strong>✓ Preços unitários apresentam consistência adequada</strong>'}`
                        });
                    }
                }
                
                // 5. Análise de exequibilidade
                const menorValorGlobal = Math.min(...valores.map(v => v.valor));
                const valorEstimado = this.processo?.valorEstimado || 0;
                
                if (valorEstimado > 0) {
                    const percentualMenor = ((menorValorGlobal / valorEstimado) * 100).toFixed(1);
                    
                    insights.push({
                        tipo: 'Análise de Exequibilidade',
                        icone: 'fas fa-balance-scale',
                        texto: `<strong>Comparação com valor estimado:</strong><br>
                                • Valor estimado: ${this.formatarMoeda(valorEstimado)}<br>
                                • Menor proposta: ${this.formatarMoeda(menorValorGlobal)} (${percentualMenor}% do estimado)<br>
                                • Economia potencial: ${this.formatarMoeda(valorEstimado - menorValorGlobal)}<br><br>
                                ${percentualMenor < 70 ? 
                                '⚠️ <strong>Alerta de inexequibilidade:</strong> Proposta inferior a 70% do valor estimado<br><strong>Ação necessária:</strong> Solicitar demonstração de exequibilidade conforme art. 48 da Lei 8.666/93' : 
                                percentualMenor < 85 ? 
                                '⚠️ <strong>Atenção:</strong> Desconto significativo - verificar composição de custos' :
                                '✓ Valor dentro de parâmetros normais de mercado'}`
                    });
                }
                
                return insights;
            }

            gerarRecomendacoes() {
                const insights = [];
                
                // 1. Análise multicritério para escolha da proposta
                const analiseMulticriterio = this.propostas.map(p => {
                    const valor = p.resumoFinanceiro?.valorTotal || 0;
                    const prazo = parseInt(p.propostaTecnica?.prazoExecucao) || 999;
                    const completude = this.calcularCompletude(p);
                    const equipe = p.maoObraTecnica?.reduce((sum, f) => sum + (parseInt(f[1]) || 0), 0) || 0;
                    const bdi = p.resumoFinanceiro?.bdiPercentual || 0;
                    
                    // Pontuação (quanto menor melhor para valor e prazo)
                    const menorValor = Math.min(...this.propostas.map(prop => prop.resumoFinanceiro?.valorTotal || Infinity));
                    const menorPrazo = Math.min(...this.propostas.map(prop => parseInt(prop.propostaTecnica?.prazoExecucao) || Infinity));
                    
                    const scoreValor = valor > 0 ? (menorValor / valor) * 40 : 0; // 40% peso
                    const scorePrazo = prazo < 999 ? (menorPrazo / prazo) * 20 : 0; // 20% peso
                    const scoreCompletude = (completude / 100) * 20; // 20% peso
                    const scoreEquipe = equipe > 0 ? Math.min(equipe / 10, 1) * 10 : 0; // 10% peso
                    const scoreBDI = bdi > 0 && bdi <= 28.82 ? 10 : 5; // 10% peso
                    
                    const scoreTotal = scoreValor + scorePrazo + scoreCompletude + scoreEquipe + scoreBDI;
                    
                    return {
                        empresa: p.dadosCadastrais.razaoSocial,
                        valor: valor,
                        prazo: prazo,
                        completude: completude,
                        equipe: equipe,
                        bdi: bdi,
                        scoreTotal: scoreTotal,
                        scores: {
                            valor: scoreValor.toFixed(1),
                            prazo: scorePrazo.toFixed(1),
                            completude: scoreCompletude.toFixed(1),
                            equipe: scoreEquipe.toFixed(1),
                            bdi: scoreBDI.toFixed(1)
                        }
                    };
                }).sort((a, b) => b.scoreTotal - a.scoreTotal);
                
                insights.push({
                    tipo: 'Análise Multicritério - Ranking Final',
                    icone: 'fas fa-trophy',
                    texto: `<strong>Classificação geral das propostas (análise ponderada):</strong><br><br>
                            ${analiseMulticriterio.map((a, index) => 
                                `<strong>${index + 1}º lugar: ${a.empresa}</strong><br>
                                • Pontuação total: ${a.scoreTotal.toFixed(1)}/100<br>
                                • Valor: ${this.formatarMoeda(a.valor)} (score: ${a.scores.valor})<br>
                                • Prazo: ${a.prazo} dias (score: ${a.scores.prazo})<br>
                                • Documentação: ${a.completude}% completa (score: ${a.scores.completude})<br>
                                • Equipe: ${a.equipe} profissionais (score: ${a.scores.equipe})<br>
                                • BDI: ${a.bdi}% (score: ${a.scores.bdi})<br>`
                            ).join('<br>')}<br>
                            <strong>Metodologia:</strong> Valor (40%), Prazo (20%), Documentação (20%), Equipe (10%), BDI (10%)`
                });
                
                // 2. Análise de conformidade e riscos
                const empresaRecomendada = analiseMulticriterio[0];
                const riscos = [];
                const conformidades = [];
                
                // Verificar riscos
                if (empresaRecomendada.bdi > 28.82) {
                    riscos.push({
                        tipo: 'BDI acima do referencial TCU',
                        acao: 'Solicitar justificativa detalhada e composição do BDI'
                    });
                }
                
                if (empresaRecomendada.completude < 80) {
                    riscos.push({
                        tipo: 'Documentação incompleta',
                        acao: 'Solicitar complementação antes da contratação'
                    });
                }
                
                const menorValor = Math.min(...this.propostas.map(p => p.resumoFinanceiro?.valorTotal || Infinity));
                if (empresaRecomendada.valor > menorValor * 1.1) {
                    riscos.push({
                        tipo: 'Não é a proposta de menor valor',
                        acao: 'Justificar escolha baseada em critérios técnicos se não for menor preço'
                    });
                }
                
                // Verificar conformidades
                if (empresaRecomendada.prazo <= 180) {
                    conformidades.push('Prazo de execução adequado');
                }
                
                if (empresaRecomendada.equipe >= 10) {
                    conformidades.push('Equipe técnica robusta');
                }
                
                if (empresaRecomendada.bdi <= 28.82) {
                    conformidades.push('BDI dentro dos parâmetros TCU');
                }
                
                insights.push({
                    tipo: 'Análise de Conformidade e Riscos',
                    icone: 'fas fa-clipboard-check',
                    texto: `<strong>Empresa melhor classificada: ${empresaRecomendada.empresa}</strong><br><br>
                            <strong>✓ Pontos positivos:</strong><br>
                            ${conformidades.map(c => `• ${c}`).join('<br>')}<br><br>
                            ${riscos.length > 0 ? 
                            `<strong>⚠️ Pontos de atenção:</strong><br>
                            ${riscos.map(r => `• ${r.tipo}<br>&nbsp;&nbsp;<em>Ação: ${r.acao}</em>`).join('<br>')}<br><br>` : 
                            '<strong>✓ Nenhum risco significativo identificado</strong><br><br>'}
                            <strong>Recomendação:</strong> ${riscos.length === 0 ? 
                            'Prosseguir com a contratação após verificação de documentos de habilitação' : 
                            'Realizar diligências para esclarecer pontos de atenção antes da adjudicação'}`
                });
                
                // 3. Checklist de próximos passos
                const checklistItems = [
                    {
                        etapa: 'Análise de documentação',
                        itens: [
                            'Verificar autenticidade dos documentos de habilitação',
                            'Confirmar regularidade fiscal e trabalhista',
                            'Validar atestados de capacidade técnica',
                            'Verificar capital social mínimo e índices contábeis'
                        ]
                    },
                    {
                        etapa: 'Diligências técnicas',
                        itens: [
                            'Solicitar cronograma físico-financeiro detalhado',
                            'Requerer ART/RRT do responsável técnico',
                            'Confirmar disponibilidade de equipamentos críticos',
                            'Validar composições de custos unitários'
                        ]
                    },
                    {
                        etapa: 'Negociação e contratação',
                        itens: [
                            'Negociar redução de preço com o primeiro colocado',
                            'Ajustar cronograma conforme necessidades do órgão',
                            'Definir marcos de medição e pagamento',
                            'Estabelecer matriz de riscos contratuais'
                        ]
                    }
                ];
                
                insights.push({
                    tipo: 'Roteiro de Ações - Próximos Passos',
                    icone: 'fas fa-tasks',
                    texto: `<strong>Checklist para conclusão do processo:</strong><br><br>
                            ${checklistItems.map(item => 
                                `<strong>${item.etapa}:</strong><br>
                                ${item.itens.map(i => `☐ ${i}`).join('<br>')}`
                            ).join('<br><br>')}<br><br>
                            <strong>Prazo estimado:</strong> 10-15 dias úteis para conclusão de todas as etapas<br>
                            <strong>Responsável sugerido:</strong> Comissão de Licitação com apoio da área técnica`
                });
                
                // 4. Resumo executivo para decisão
                const economia = this.processo?.valorEstimado ? 
                    ((this.processo.valorEstimado - empresaRecomendada.valor) / this.processo.valorEstimado * 100).toFixed(1) : 0;
                
                insights.push({
                    tipo: 'Resumo Executivo para Decisão',
                    icone: 'fas fa-file-signature',
                    texto: `<strong>PARECER TÉCNICO CONCLUSIVO</strong><br><br>
                            <strong>Processo:</strong> ${this.processo?.numeroProcesso || 'N/A'}<br>
                            <strong>Objeto:</strong> ${this.processo?.objeto || 'Conforme TR'}<br>
                            <strong>Propostas analisadas:</strong> ${this.propostas.length}<br><br>
                            <strong>Recomendação:</strong> ${empresaRecomendada.empresa}<br>
                            <strong>Valor:</strong> ${this.formatarMoeda(empresaRecomendada.valor)}<br>
                            <strong>Economia:</strong> ${economia}% em relação ao valor estimado<br>
                            <strong>Prazo:</strong> ${empresaRecomendada.prazo} dias<br><br>
                            <strong>Fundamentação:</strong><br>
                            1. Melhor pontuação na análise multicritério (${empresaRecomendada.scoreTotal.toFixed(1)}/100)<br>
                            2. Atende aos requisitos técnicos do TR<br>
                            3. Preço compatível com o mercado<br>
                            4. ${riscos.length === 0 ? 'Não foram identificados riscos significativos' : 'Riscos identificados são mitigáveis'}<br><br>
                            <strong>Conclusão:</strong> Recomenda-se a adjudicação à empresa ${empresaRecomendada.empresa}, 
                            condicionada ao atendimento dos requisitos de habilitação e esclarecimentos pendentes.`
                });
                
                return insights;
            }

            // Métodos auxiliares
            coletarItensUnicos(campo, indice) {
                const itens = new Set();
                
                this.propostas.forEach(p => {
                    if (p[campo] && Array.isArray(p[campo])) {
                        p[campo].forEach(item => {
                            if (item[indice]) {
                                itens.add(item[indice]);
                            }
                        });
                    }
                });
                
                return Array.from(itens).sort();
            }

            verificarDivergencia(valores) {
                const valoresUnicos = [...new Set(valores.filter(v => v))];
                return valoresUnicos.length > 1;
            }

            verificarDivergenciaQuantidades(quantidades) {
                const numeros = quantidades.map(q => parseFloat(q)).filter(n => !isNaN(n));
                if (numeros.length < 2) return false;
                
                const min = Math.min(...numeros);
                const max = Math.max(...numeros);
                
                return (max - min) / min > 0.2; // Diferença maior que 20%
            }

            getClasseValor(valor, todosValores) {
                const valoresValidos = todosValores.filter(v => v > 0);
                if (valoresValidos.length === 0) return '';
                
                const min = Math.min(...valoresValidos);
                const max = Math.max(...valoresValidos);
                
                if (valor === min && valoresValidos.length > 1) return 'menor-valor';
                if (valor === max && valoresValidos.length > 1) return 'maior-valor';
                return '';
            }

            getIndicadorDiferenca(valor, min, max) {
                const diferenca = max - min;
                const posicao = ((valor - min) / diferenca) * 100;
                
                if (posicao < 33) return '<span class="indicador-diferenca dif-pequena">Baixo</span>';
                if (posicao < 66) return '<span class="indicador-diferenca dif-media">Médio</span>';
                return '<span class="indicador-diferenca dif-grande">Alto</span>';
            }

            calcularCompletude(proposta) {
                let camposPreenchidos = 0;
                let totalCampos = 0;
                
                // Verificar campos obrigatórios
                const verificar = (obj, campos) => {
                    campos.forEach(campo => {
                        totalCampos++;
                        if (obj && obj[campo] && obj[campo] !== 'Não informado') {
                            camposPreenchidos++;
                        }
                    });
                };
                
                verificar(proposta.dadosCadastrais, ['cnpj', 'email', 'telefone', 'respTecnico']);
                verificar(proposta.propostaTecnica, ['prazoExecucao', 'metodologia', 'garantias']);
                
                // Verificar arrays
                if (proposta.servicosComercial && proposta.servicosComercial.length > 0) camposPreenchidos++;
                if (proposta.maoObraComercial && proposta.maoObraComercial.length > 0) camposPreenchidos++;
                if (proposta.bdi && proposta.bdi.length > 0) camposPreenchidos++;
                totalCampos += 3;
                
                return Math.round((camposPreenchidos / totalCampos) * 100);
            }

            formatarMoeda(valor) {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(valor || 0);
            }
        }

        // Funções globais
        function voltarComparativo() {
            window.history.back();
        }

        function imprimirRelatorio() {
            window.print();
        }

        function exportarPDF() {
            alert('Funcionalidade de exportação PDF será implementada em breve.\n\nPor enquanto, use Ctrl+P e selecione "Salvar como PDF".');
        }

        function mudarAba(event, aba) {
            // Prevenir comportamento padrão
            if (event) event.preventDefault();
            
            // Remover classe ativa de todas as abas
            document.querySelectorAll('.aba-btn').forEach(btn => {
                btn.classList.remove('ativa');
            });
            
            // Remover classe ativa de todos os conteúdos
            document.querySelectorAll('.conteudo-aba').forEach(conteudo => {
                conteudo.classList.remove('ativa');
            });
            
            // Adicionar classe ativa à aba clicada
            if (event && event.target) {
                const botao = event.target.closest('.aba-btn');
                if (botao) {
                    botao.classList.add('ativa');
                }
            }
            
            // Mostrar conteúdo da aba selecionada
            const conteudoAba = document.getElementById(`aba-${aba}`);
            if (conteudoAba) {
                conteudoAba.classList.add('ativa');
            }
        }

        // Inicializar relatório quando carregar a página
        document.addEventListener('DOMContentLoaded', function() {
            const relatorio = new RelatorioAnalitico();
            
            // Debug: verificar dados carregados
            console.log('Processo:', relatorio.processo);
            console.log('Total de propostas:', relatorio.propostas.length);
            
            // Mostrar empresas encontradas
            if (relatorio.propostas.length > 0) {
                console.log('Empresas encontradas:');
                relatorio.propostas.forEach(p => {
                    console.log('- ' + p.dadosCadastrais.razaoSocial);
                });
            }
        });
    </script>
</body>
</html>
