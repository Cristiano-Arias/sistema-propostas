<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M√≥dulo de Comparativo Avan√ßado com IA</title>
    <style>
        /* Estilos principais */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* Tabelas comparativas universais */
        .tabela-comparativa-lado-a-lado {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 11px;
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tabela-comparativa-lado-a-lado thead {
            background: #2c3e50;
            color: white;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .tabela-comparativa-lado-a-lado th {
            padding: 8px 6px;
            text-align: center;
            border: 1px solid #34495e;
            font-weight: 600;
            white-space: nowrap;
        }

        .coluna-item {
            min-width: 250px;
            text-align: left !important;
            background: #1a252f;
            position: sticky;
            left: 0;
            z-index: 101;
        }

        .coluna-unidade {
            min-width: 50px;
            background: #1a252f;
            position: sticky;
            left: 250px;
            z-index: 101;
        }

        .header-empresa {
            background: #34495e;
            border-bottom: 2px solid #2c3e50;
        }

        .subheader {
            background: #465a65;
            font-size: 10px;
            min-width: 70px;
        }

        .tabela-comparativa-lado-a-lado tbody tr {
            border-bottom: 1px solid #ecf0f1;
        }

        .tabela-comparativa-lado-a-lado tbody tr:hover {
            background: #f8f9fa;
        }

        .tabela-comparativa-lado-a-lado tbody td {
            padding: 6px 4px;
            text-align: center;
            border-left: 1px solid #ecf0f1;
            font-size: 11px;
        }

        .td-item {
            text-align: left !important;
            font-weight: 500;
            background: #f8f9fa;
            border-left: 3px solid #3498db;
            position: sticky;
            left: 0;
            z-index: 10;
        }

        .td-unidade {
            background: #f8f9fa;
            font-weight: 500;
            position: sticky;
            left: 250px;
            z-index: 10;
        }

        .menor-valor {
            background: #d4edda !important;
            color: #155724;
            font-weight: bold;
        }

        .maior-valor {
            background: #f8d7da !important;
            color: #721c24;
        }

        .valor-ausente {
            background: #f5f5f5;
            color: #999;
            font-style: italic;
        }

        .linha-subtotal {
            background: #2c3e50 !important;
            color: white;
            font-weight: bold;
            font-size: 12px;
        }

        .linha-subtotal td {
            padding: 10px !important;
            border: 1px solid #34495e;
        }

        /* Indicador de varia√ß√£o */
        .indicador-variacao {
            display: inline-block;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 10px;
            margin-left: 10px;
            font-weight: bold;
        }

        .variacao-alta { background: #ff6b6b; color: white; }
        .variacao-media { background: #ffd43b; color: #333; }
        .variacao-baixa { background: #51cf66; color: white; }

        /* Cards de an√°lise */
        .card-analise {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin: 20px 0;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
        }

        .card-analise h3 {
            font-size: 20px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .insight-box {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #ffeaa7;
        }

        /* Resumo visual */
        .resumo-visual {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }

        .card-empresa {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            transition: transform 0.3s;
            border: 2px solid transparent;
        }

        .card-empresa:hover {
            transform: translateY(-5px);
            border-color: #3498db;
        }

        .card-empresa.melhor {
            background: linear-gradient(135deg, #d4edda, #c3e6cb);
            border-color: #28a745;
        }

        .empresa-nome {
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .empresa-valor {
            font-size: 24px;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .empresa-score {
            font-size: 14px;
            color: #7f8c8d;
        }

        /* Gr√°fico de barras */
        .grafico-comparativo {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 300px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            margin: 20px 0;
        }

        .barra-grupo {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0 10px;
        }

        .barra-container {
            width: 100%;
            height: 250px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 5px;
        }

        .barra {
            width: 30px;
            background: linear-gradient(to top, #3498db, #2980b9);
            border-radius: 5px 5px 0 0;
            position: relative;
            transition: all 0.3s;
        }

        .barra:hover {
            transform: scale(1.05);
        }

        .barra-valor {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: bold;
            white-space: nowrap;
        }

        .barra-label {
            margin-top: 10px;
            font-size: 12px;
            text-align: center;
            font-weight: bold;
        }

        /* An√°lise de riscos */
        .matriz-riscos {
            background: #ffe5e5;
            border: 2px solid #ff6b6b;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .risco-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 5px;
        }

        .risco-nivel {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
        }

        .risco-alto { background: #e74c3c; color: white; }
        .risco-medio { background: #f39c12; color: white; }
        .risco-baixo { background: #27ae60; color: white; }

        /* Recomenda√ß√µes */
        .recomendacoes-box {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
        }

        .recomendacao-item {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid #ffeaa7;
        }

        /* √Årea de scroll horizontal */
        .tabela-scroll {
            overflow-x: auto;
            margin: 20px 0;
        }

        /* Impress√£o */
        @media print {
            body { background: white; }
            .container { box-shadow: none; }
            .tabela-comparativa-lado-a-lado { font-size: 9px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center; color: #2c3e50; margin-bottom: 30px;">
            ü§ñ M√≥dulo de Comparativo Avan√ßado com An√°lise IA
        </h1>

        <!-- Resumo Visual das Empresas -->
        <div class="resumo-visual" id="resumoEmpresas"></div>

        <!-- Gr√°fico Comparativo -->
        <h2 style="color: #2c3e50; margin-top: 40px;">üìä Comparativo Visual de Valores</h2>
        <div class="grafico-comparativo" id="graficoValores"></div>

        <!-- Tabela Comparativa de Servi√ßos -->
        <h2 style="color: #2c3e50; margin-top: 40px;">üìã COMPARATIVO DE SERVI√áOS - LADO A LADO</h2>
        <div class="tabela-scroll">
            <table class="tabela-comparativa-lado-a-lado" id="tabelaServicos"></table>
        </div>

        <!-- An√°lise IA de Servi√ßos -->
        <div class="card-analise">
            <h3>ü§ñ An√°lise Inteligente - Servi√ßos</h3>
            <div id="analiseServicosIA"></div>
        </div>

        <!-- Tabela Comparativa de M√£o de Obra -->
        <h2 style="color: #2c3e50; margin-top: 40px;">üë∑ COMPARATIVO DE M√ÉO DE OBRA - LADO A LADO</h2>
        <div class="tabela-scroll">
            <table class="tabela-comparativa-lado-a-lado" id="tabelaMaoObra"></table>
        </div>

        <!-- Tabela Comparativa de Materiais -->
        <h2 style="color: #2c3e50; margin-top: 40px;">üîß COMPARATIVO DE MATERIAIS - LADO A LADO</h2>
        <div class="tabela-scroll">
            <table class="tabela-comparativa-lado-a-lado" id="tabelaMateriais"></table>
        </div>

        <!-- Tabela Comparativa de Equipamentos -->
        <h2 style="color: #2c3e50; margin-top: 40px;">üöú COMPARATIVO DE EQUIPAMENTOS - LADO A LADO</h2>
        <div class="tabela-scroll">
            <table class="tabela-comparativa-lado-a-lado" id="tabelaEquipamentos"></table>
        </div>

        <!-- Tabela Comparativa de BDI -->
        <h2 style="color: #2c3e50; margin-top: 40px;">üìä COMPARATIVO DE BDI - LADO A LADO</h2>
        <div class="tabela-scroll">
            <table class="tabela-comparativa-lado-a-lado" id="tabelaBDI"></table>
        </div>

        <!-- Matriz de Riscos -->
        <div class="matriz-riscos">
            <h3>‚ö†Ô∏è Matriz de Riscos Identificados pela IA</h3>
            <div id="matrizRiscos"></div>
        </div>

        <!-- Recomenda√ß√µes Finais -->
        <div class="recomendacoes-box">
            <h3>üí° Recomenda√ß√µes Finais da IA</h3>
            <div id="recomendacoesFinais"></div>
        </div>
    </div>

    <script>
        // Classe principal do m√≥dulo comparativo
        class ComparativoAvancadoIA {
            constructor() {
                this.propostasProcesso = [];
                this.analiseCompleta = {};
                this.scores = {};
            }

            // Carregar dados das propostas
            carregarPropostas(processoId) {
                const propostas = JSON.parse(localStorage.getItem('propostas') || '[]');
                this.propostasProcesso = propostas.filter(p => p.processo === processoId);
                
                // Ordenar por valor
                this.propostasProcesso.sort((a, b) => {
                    const valorA = this.extrairValorNumerico(a.dados?.comercial?.valorTotal);
                    const valorB = this.extrairValorNumerico(b.dados?.comercial?.valorTotal);
                    return valorA - valorB;
                });
            }

            // Extrair valor num√©rico de string
            extrairValorNumerico(valor) {
                if (!valor) return 0;
                return parseFloat(valor.toString().replace(/[^\d,.-]/g, '').replace('.', '').replace(',', '.')) || 0;
            }

            // Montar tabela comparativa gen√©rica
            montarTabelaComparativa(tipo, elementId) {
                const tabela = document.getElementById(elementId);
                if (!tabela) return;

                // Limpar tabela
                tabela.innerHTML = '';

                // Criar cabe√ßalho
                const thead = this.criarCabecalhoComparativo(tipo);
                tabela.appendChild(thead);

                // Criar corpo
                const tbody = this.criarCorpoComparativo(tipo);
                tabela.appendChild(tbody);
            }

            // Criar cabe√ßalho da tabela
            criarCabecalhoComparativo(tipo) {
                const thead = document.createElement('thead');
                
                // Determinar colunas baseado no tipo
                let colunasExtras = [];
                switch(tipo) {
                    case 'servicos':
                    case 'materiais':
                        colunasExtras = ['Qtd', 'P.Unit', 'Total'];
                        break;
                    case 'maoobra':
                        colunasExtras = ['Qtd', 'Meses', 'Sal√°rio', 'Total'];
                        break;
                    case 'equipamentos':
                        colunasExtras = ['Qtd', 'Meses', '$/m√™s', 'Total'];
                        break;
                    case 'bdi':
                        colunasExtras = ['%', 'Valor'];
                        break;
                }

                // Linha principal
                const tr1 = document.createElement('tr');
                tr1.innerHTML = `
                    <th rowspan="2" class="coluna-item">${this.getTituloItem(tipo)}</th>
                    ${tipo !== 'bdi' ? '<th rowspan="2" class="coluna-unidade">Unid.</th>' : ''}
                    ${this.propostasProcesso.map(p => `
                        <th colspan="${colunasExtras.length}" class="header-empresa">${p.empresa}</th>
                    `).join('')}
                `;
                
                // Linha de subcabe√ßalhos
                const tr2 = document.createElement('tr');
                this.propostasProcesso.forEach(() => {
                    colunasExtras.forEach(col => {
                        tr2.innerHTML += `<th class="subheader">${col}</th>`;
                    });
                });

                thead.appendChild(tr1);
                thead.appendChild(tr2);
                return thead;
            }

            // Criar corpo da tabela
            criarCorpoComparativo(tipo) {
                const tbody = document.createElement('tbody');
                
                // Coletar todos os itens √∫nicos
                const itensMap = this.coletarItensPorTipo(tipo);
                
                // Criar linha para cada item
                itensMap.forEach((empresasDados, itemKey) => {
                    const tr = document.createElement('tr');
                    
                    // Coluna do item
                    const tdItem = document.createElement('td');
                    tdItem.className = 'td-item';
                    tdItem.textContent = itemKey;
                    tr.appendChild(tdItem);
                    
                    // Coluna unidade (se aplic√°vel)
                    if (tipo !== 'bdi') {
                        const tdUnidade = document.createElement('td');
                        tdUnidade.className = 'td-unidade';
                        tdUnidade.textContent = this.obterUnidade(empresasDados);
                        tr.appendChild(tdUnidade);
                    }
                    
                    // An√°lise de varia√ß√£o
                    const variacao = this.calcularVariacao(empresasDados, tipo);
                    if (variacao.percentual > 0) {
                        const badge = document.createElement('span');
                        badge.className = 'indicador-variacao';
                        badge.className += variacao.percentual > 25 ? ' variacao-alta' : 
                                         variacao.percentual > 15 ? ' variacao-media' : ' variacao-baixa';
                        badge.textContent = `${variacao.percentual.toFixed(1)}%`;
                        tdItem.appendChild(badge);
                    }
                    
                    // Colunas das empresas
                    this.propostasProcesso.forEach(proposta => {
                        const dados = empresasDados.get(proposta.empresa);
                        this.adicionarCelulasEmpresa(tr, dados, tipo, variacao);
                    });
                    
                    tbody.appendChild(tr);
                });
                
                // Adicionar linha de subtotal
                this.adicionarSubtotal(tbody, tipo);
                
                return tbody;
            }

            // Coletar itens por tipo
            coletarItensPorTipo(tipo) {
                const itensMap = new Map();
                
                this.propostasProcesso.forEach(proposta => {
                    let items = [];
                    
                    switch(tipo) {
                        case 'servicos':
                            items = proposta.dados?.comercial?.servicos || [];
                            items.forEach(item => {
                                const key = item[1]; // Descri√ß√£o
                                if (!itensMap.has(key)) itensMap.set(key, new Map());
                                itensMap.get(key).set(proposta.empresa, {
                                    unidade: item[2],
                                    quantidade: parseFloat(item[3]) || 0,
                                    precoUnit: this.extrairValorNumerico(item[4]),
                                    total: this.extrairValorNumerico(item[5])
                                });
                            });
                            break;
                            
                        case 'materiais':
                            items = proposta.dados?.comercial?.materiaisComercial || [];
                            items.forEach(item => {
                                const key = `${item[0]} - ${item[1]}`; // Nome + Especifica√ß√£o
                                if (!itensMap.has(key)) itensMap.set(key, new Map());
                                itensMap.get(key).set(proposta.empresa, {
                                    unidade: item[2],
                                    quantidade: parseFloat(item[3]) || 0,
                                    precoUnit: this.extrairValorNumerico(item[4]),
                                    total: this.extrairValorNumerico(item[5])
                                });
                            });
                            break;
                            
                        case 'maoobra':
                            items = proposta.dados?.comercial?.maoObra || [];
                            items.forEach(item => {
                                const key = item[0]; // Fun√ß√£o
                                if (!itensMap.has(key)) itensMap.set(key, new Map());
                                itensMap.get(key).set(proposta.empresa, {
                                    quantidade: parseFloat(item[1]) || 0,
                                    meses: parseFloat(item[2]) || 0,
                                    salario: parseFloat(item[3]) || 0,
                                    total: this.extrairValorNumerico(item[6])
                                });
                            });
                            break;
                            
                        case 'equipamentos':
                            items = proposta.dados?.comercial?.equipamentosComercial || [];
                            items.forEach(item => {
                                const key = `${item[0]} - ${item[1]}`; // Nome + Especifica√ß√£o
                                if (!itensMap.has(key)) itensMap.set(key, new Map());
                                itensMap.get(key).set(proposta.empresa, {
                                    quantidade: parseFloat(item[2]) || 0,
                                    meses: parseFloat(item[3]) || 0,
                                    precoMes: parseFloat(item[4]) || 0,
                                    total: this.extrairValorNumerico(item[5])
                                });
                            });
                            break;
                            
                        case 'bdi':
                            items = proposta.dados?.comercial?.bdi || [];
                            items.forEach(item => {
                                const key = item[0]; // Componente
                                if (!itensMap.has(key)) itensMap.set(key, new Map());
                                itensMap.get(key).set(proposta.empresa, {
                                    percentual: parseFloat(item[1]) || 0,
                                    valor: this.extrairValorNumerico(item[2] || 0)
                                });
                            });
                            // Adicionar total
                            if (!itensMap.has('TOTAL BDI')) itensMap.set('TOTAL BDI', new Map());
                            itensMap.get('TOTAL BDI').set(proposta.empresa, {
                                percentual: parseFloat(proposta.dados?.comercial?.bdiPercentual) || 0,
                                valor: this.extrairValorNumerico(proposta.dados?.comercial?.bdiValor)
                            });
                            break;
                    }
                });
                
                return itensMap;
            }

            // Calcular varia√ß√£o
            calcularVariacao(empresasDados, tipo) {
                const valores = [];
                let campo = 'precoUnit';
                
                switch(tipo) {
                    case 'maoobra': campo = 'salario'; break;
                    case 'equipamentos': campo = 'precoMes'; break;
                    case 'bdi': campo = 'percentual'; break;
                }
                
                empresasDados.forEach(dados => {
                    if (dados && dados[campo] > 0) {
                        valores.push(dados[campo]);
                    }
                });
                
                if (valores.length < 2) return { percentual: 0, menor: 0, maior: 0 };
                
                const menor = Math.min(...valores);
                const maior = Math.max(...valores);
                const percentual = ((maior - menor) / menor * 100);
                
                return { percentual, menor, maior };
            }

            // Adicionar c√©lulas da empresa
            adicionarCelulasEmpresa(tr, dados, tipo, variacao) {
                if (!dados) {
                    // Item ausente
                    const qtdColunas = this.getQtdColunasPorTipo(tipo);
                    for (let i = 0; i < qtdColunas; i++) {
                        const td = document.createElement('td');
                        td.className = 'valor-ausente';
                        td.textContent = '-';
                        tr.appendChild(td);
                    }
                    return;
                }

                switch(tipo) {
                    case 'servicos':
                    case 'materiais':
                        this.adicionarCelula(tr, dados.quantidade);
                        this.adicionarCelula(tr, `R$ ${dados.precoUnit.toFixed(2)}`, 
                            dados.precoUnit === variacao.menor ? 'menor-valor' : 
                            dados.precoUnit === variacao.maior ? 'maior-valor' : '');
                        this.adicionarCelula(tr, `R$ ${dados.total.toFixed(2)}`, 'td-total');
                        break;
                        
                    case 'maoobra':
                        this.adicionarCelula(tr, dados.quantidade);
                        this.adicionarCelula(tr, dados.meses);
                        this.adicionarCelula(tr, `R$ ${dados.salario.toFixed(2)}`,
                            dados.salario === variacao.menor ? 'menor-valor' : 
                            dados.salario === variacao.maior ? 'maior-valor' : '');
                        this.adicionarCelula(tr, `R$ ${dados.total.toFixed(2)}`, 'td-total');
                        break;
                        
                    case 'equipamentos':
                        this.adicionarCelula(tr, dados.quantidade);
                        this.adicionarCelula(tr, dados.meses);
                        this.adicionarCelula(tr, `R$ ${dados.precoMes.toFixed(2)}`,
                            dados.precoMes === variacao.menor ? 'menor-valor' : 
                            dados.precoMes === variacao.maior ? 'maior-valor' : '');
                        this.adicionarCelula(tr, `R$ ${dados.total.toFixed(2)}`, 'td-total');
                        break;
                        
                    case 'bdi':
                        this.adicionarCelula(tr, `${dados.percentual.toFixed(2)}%`);
                        this.adicionarCelula(tr, dados.valor ? `R$ ${dados.valor.toFixed(2)}` : '-');
                        break;
                }
            }

            // Adicionar c√©lula individual
            adicionarCelula(tr, conteudo, classe = '') {
                const td = document.createElement('td');
                if (classe) td.className = classe;
                td.textContent = conteudo;
                tr.appendChild(td);
            }

            // Adicionar linha de subtotal
            adicionarSubtotal(tbody, tipo) {
                const tr = document.createElement('tr');
                tr.className = 'linha-subtotal';
                
                const tdLabel = document.createElement('td');
                tdLabel.textContent = `SUBTOTAL ${tipo.toUpperCase()}`;
                if (tipo !== 'bdi') tdLabel.colSpan = 2;
                tr.appendChild(tdLabel);
                
                this.propostasProcesso.forEach(proposta => {
                    const total = this.calcularSubtotal(proposta, tipo);
                    const td = document.createElement('td');
                    td.colSpan = this.getQtdColunasPorTipo(tipo);
                    td.textContent = `R$ ${total.toFixed(2)}`;
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            }

            // Calcular subtotal por tipo
            calcularSubtotal(proposta, tipo) {
                let total = 0;
                
                switch(tipo) {
                    case 'servicos':
                        total = this.extrairValorNumerico(proposta.dados?.comercial?.totalServicos) || 0;
                        break;
                    case 'materiais':
                        total = this.extrairValorNumerico(proposta.dados?.comercial?.totalMateriais) || 0;
                        break;
                    case 'maoobra':
                        total = this.extrairValorNumerico(proposta.dados?.comercial?.totalMaoObra) || 0;
                        break;
                    case 'equipamentos':
                        total = this.extrairValorNumerico(proposta.dados?.comercial?.totalEquipamentos) || 0;
                        break;
                    case 'bdi':
                        total = this.extrairValorNumerico(proposta.dados?.comercial?.bdiValor) || 0;
                        break;
                }
                
                return total;
            }

            // Criar resumo visual
            criarResumoVisual() {
                const container = document.getElementById('resumoEmpresas');
                if (!container) return;
                
                container.innerHTML = this.propostasProcesso.map((proposta, index) => {
                    const valor = this.extrairValorNumerico(proposta.dados?.comercial?.valorTotal);
                    const score = this.calcularScore(proposta);
                    const isMelhor = index === 0;
                    
                    return `
                        <div class="card-empresa ${isMelhor ? 'melhor' : ''}">
                            <div class="empresa-nome">${proposta.empresa}</div>
                            <div class="empresa-valor">R$ ${(valor/1000).toFixed(0)}k</div>
                            <div class="empresa-score">Score IA: ${score}/100</div>
                            ${isMelhor ? '<div style="margin-top: 10px;">üèÜ Menor Valor</div>' : ''}
                        </div>
                    `;
                }).join('');
            }

            // Criar gr√°fico de valores
            criarGraficoValores() {
                const container = document.getElementById('graficoValores');
                if (!container) return;
                
                const valores = this.propostasProcesso.map(p => 
                    this.extrairValorNumerico(p.dados?.comercial?.valorTotal)
                );
                const maxValor = Math.max(...valores);
                
                container.innerHTML = this.propostasProcesso.map((proposta, index) => {
                    const valor = valores[index];
                    const altura = (valor / maxValor * 100) + '%';
                    
                    // Breakdown de custos
                    const servicos = this.extrairValorNumerico(proposta.dados?.comercial?.totalServicos) || 0;
                    const maoObra = this.extrairValorNumerico(proposta.dados?.comercial?.totalMaoObra) || 0;
                    const materiais = this.extrairValorNumerico(proposta.dados?.comercial?.totalMateriais) || 0;
                    const equipamentos = this.extrairValorNumerico(proposta.dados?.comercial?.totalEquipamentos) || 0;
                    
                    const alturaServicos = (servicos / valor * 250) + 'px';
                    const alturaMaoObra = (maoObra / valor * 250) + 'px';
                    const alturaMateriais = (materiais / valor * 250) + 'px';
                    const alturaEquipamentos = (equipamentos / valor * 250) + 'px';
                    
                    return `
                        <div class="barra-grupo">
                            <div class="barra-container">
                                <div class="barra" style="height: ${alturaServicos}; background: #3498db;" title="Servi√ßos: R$ ${(servicos/1000).toFixed(0)}k"></div>
                                <div class="barra" style="height: ${alturaMaoObra}; background: #2ecc71;" title="M√£o de Obra: R$ ${(maoObra/1000).toFixed(0)}k"></div>
                                <div class="barra" style="height: ${alturaMateriais}; background: #f39c12;" title="Materiais: R$ ${(materiais/1000).toFixed(0)}k"></div>
                                <div class="barra" style="height: ${alturaEquipamentos}; background: #e74c3c;" title="Equipamentos: R$ ${(equipamentos/1000).toFixed(0)}k">
                                    <div class="barra-valor">R$ ${(valor/1000).toFixed(0)}k</div>
                                </div>
                            </div>
                            <div class="barra-label">${proposta.empresa}</div>
                        </div>
                    `;
                }).join('');
            }

            // An√°lise IA de servi√ßos
            analisarServicosIA() {
                const container = document.getElementById('analiseServicosIA');
                if (!container) return;
                
                // An√°lise de varia√ß√µes
                const servicosMap = this.coletarItensPorTipo('servicos');
                const variacoes = [];
                
                servicosMap.forEach((empresas, servico) => {
                    const variacao = this.calcularVariacao(empresas, 'servicos');
                    if (variacao.percentual > 20) {
                        variacoes.push({
                            servico,
                            variacao: variacao.percentual,
                            menor: variacao.menor,
                            maior: variacao.maior
                        });
                    }
                });
                
                container.innerHTML = `
                    <div class="insight-box">
                        <h4>üìä An√°lise de Varia√ß√µes</h4>
                        ${variacoes.length > 0 ? `
                            <p>${variacoes.length} servi√ßos com varia√ß√£o superior a 20%:</p>
                            <ul>
                                ${variacoes.slice(0, 5).map(v => `
                                    <li><strong>${v.servico}</strong>: ${v.variacao.toFixed(1)}% 
                                        (R$ ${v.menor.toFixed(2)} - R$ ${v.maior.toFixed(2)})
                                    </li>
                                `).join('')}
                            </ul>
                        ` : '<p>‚úÖ Pre√ßos consistentes entre as propostas</p>'}
                    </div>
                    
                    <div class="insight-box">
                        <h4>üí° Recomenda√ß√µes</h4>
                        <ul>
                            <li>Verificar especifica√ß√µes t√©cnicas dos itens com alta varia√ß√£o</li>
                            <li>Solicitar composi√ß√£o de pre√ßos unit√°rios</li>
                            <li>Realizar equaliza√ß√£o t√©cnica antes da decis√£o</li>
                            ${variacoes.length > 3 ? '<li>‚ö†Ô∏è Muitas varia√ß√µes indicam poss√≠vel diverg√™ncia de escopo</li>' : ''}
                        </ul>
                    </div>
                `;
            }

            // Criar matriz de riscos
            criarMatrizRiscos() {
                const container = document.getElementById('matrizRiscos');
                if (!container) return;
                
                const riscos = [];
                
                this.propostasProcesso.forEach(proposta => {
                    const valor = this.extrairValorNumerico(proposta.dados?.comercial?.valorTotal);
                    const media = this.calcularMediaValores();
                    
                    // An√°lise de riscos
                    if (valor < media * 0.85) {
                        riscos.push({
                            empresa: proposta.empresa,
                            tipo: 'Pre√ßo muito baixo',
                            nivel: 'alto',
                            descricao: `${((1 - valor/media) * 100).toFixed(0)}% abaixo da m√©dia`
                        });
                    }
                    
                    const prazo = parseInt(proposta.dados?.tecnica?.prazoExecucao) || 0;
                    if (prazo > 0 && prazo < 90) {
                        riscos.push({
                            empresa: proposta.empresa,
                            tipo: 'Prazo muito curto',
                            nivel: 'medio',
                            descricao: `${prazo} dias pode comprometer qualidade`
                        });
                    }
                    
                    const bdi = parseFloat(proposta.dados?.comercial?.bdiPercentual) || 0;
                    if (bdi > 28) {
                        riscos.push({
                            empresa: proposta.empresa,
                            tipo: 'BDI elevado',
                            nivel: 'medio',
                            descricao: `${bdi.toFixed(1)}% de BDI`
                        });
                    }
                });
                
                container.innerHTML = riscos.map(risco => `
                    <div class="risco-item">
                        <span class="risco-nivel risco-${risco.nivel}">
                            ${risco.nivel.toUpperCase()}
                        </span>
                        <div>
                            <strong>${risco.empresa}</strong> - ${risco.tipo}<br>
                            <small>${risco.descricao}</small>
                        </div>
                    </div>
                `).join('') || '<p style="color: #27ae60;">‚úÖ Nenhum risco significativo identificado</p>';
            }

            // Criar recomenda√ß√µes finais
            criarRecomendacoesFinais() {
                const container = document.getElementById('recomendacoesFinais');
                if (!container) return;
                
                // Calcular scores e ordenar
                const empresasComScore = this.propostasProcesso.map(p => ({
                    empresa: p.empresa,
                    score: this.calcularScore(p),
                    valor: this.extrairValorNumerico(p.dados?.comercial?.valorTotal),
                    prazo: parseInt(p.dados?.tecnica?.prazoExecucao) || 0
                })).sort((a, b) => b.score - a.score);
                
                const economia = empresasComScore[empresasComScore.length - 1].valor - empresasComScore[0].valor;
                
                container.innerHTML = `
                    <div class="recomendacao-item">
                        <h4>ü•á Melhor Proposta Global</h4>
                        <p><strong>${empresasComScore[0].empresa}</strong></p>
                        <p>Score: ${empresasComScore[0].score}/100</p>
                        <p>Melhor equil√≠brio entre pre√ßo, prazo e qualidade t√©cnica</p>
                    </div>
                    
                    <div class="recomendacao-item">
                        <h4>üí∞ Economia Potencial</h4>
                        <p>Escolhendo ${empresasComScore[0].empresa}: <strong>R$ ${economia.toFixed(2)}</strong></p>
                        <p>Economia de ${((economia / empresasComScore[empresasComScore.length - 1].valor) * 100).toFixed(1)}%</p>
                    </div>
                    
                    <div class="recomendacao-item">
                        <h4>üìã Pr√≥ximos Passos</h4>
                        <ol>
                            <li>Solicitar documenta√ß√£o de habilita√ß√£o</li>
                            <li>Verificar composi√ß√µes de pre√ßos dos principais itens</li>
                            <li>Realizar dilig√™ncia t√©cnica</li>
                            <li>Negociar com as 3 melhores classificadas</li>
                        </ol>
                    </div>
                `;
            }

            // Calcular score da proposta
            calcularScore(proposta) {
                let score = 0;
                
                // Valor (40%)
                const valores = this.propostasProcesso.map(p => 
                    this.extrairValorNumerico(p.dados?.comercial?.valorTotal)
                );
                const menorValor = Math.min(...valores);
                const valorProposta = this.extrairValorNumerico(proposta.dados?.comercial?.valorTotal);
                
                if (valorProposta === menorValor) {
                    score += 40;
                } else {
                    score += 40 * (1 - (valorProposta - menorValor) / menorValor);
                }
                
                // Prazo (20%)
                const prazo = parseInt(proposta.dados?.tecnica?.prazoExecucao) || 999;
                if (prazo <= 90) score += 20;
                else if (prazo <= 120) score += 15;
                else if (prazo <= 150) score += 10;
                
                // Experi√™ncia (20%)
                const experiencia = proposta.dados?.tecnica?.experiencia?.length || 0;
                score += Math.min(experiencia * 4, 20);
                
                // Qualidade t√©cnica (20%)
                if (proposta.dados?.tecnica?.metodologia) score += 10;
                if (proposta.dados?.tecnica?.certificacoes?.length > 0) score += 10;
                
                return Math.round(score);
            }

            // Calcular m√©dia de valores
            calcularMediaValores() {
                const valores = this.propostasProcesso.map(p => 
                    this.extrairValorNumerico(p.dados?.comercial?.valorTotal)
                );
                return valores.reduce((a, b) => a + b, 0) / valores.length;
            }

            // M√©todos auxiliares
            getTituloItem(tipo) {
                const titulos = {
                    servicos: 'Item / Descri√ß√£o do Servi√ßo',
                    materiais: 'Material / Especifica√ß√£o',
                    maoobra: 'Fun√ß√£o',
                    equipamentos: 'Equipamento / Especifica√ß√£o',
                    bdi: 'Componente BDI'
                };
                return titulos[tipo] || 'Item';
            }

            getQtdColunasPorTipo(tipo) {
                const qtds = {
                    servicos: 3,
                    materiais: 3,
                    maoobra: 4,
                    equipamentos: 4,
                    bdi: 2
                };
                return qtds[tipo] || 3;
            }

            obterUnidade(empresasDados) {
                for (let dados of empresasDados.values()) {
                    if (dados && dados.unidade) return dados.unidade;
                }
                return '-';
            }

            // Gerar relat√≥rio completo
            gerarRelatorioCompleto() {
                // Criar resumo visual
                this.criarResumoVisual();
                
                // Criar gr√°fico
                this.criarGraficoValores();
                
                // Montar todas as tabelas
                this.montarTabelaComparativa('servicos', 'tabelaServicos');
                this.montarTabelaComparativa('maoobra', 'tabelaMaoObra');
                this.montarTabelaComparativa('materiais', 'tabelaMateriais');
                this.montarTabelaComparativa('equipamentos', 'tabelaEquipamentos');
                this.montarTabelaComparativa('bdi', 'tabelaBDI');
                
                // An√°lises IA
                this.analisarServicosIA();
                this.criarMatrizRiscos();
                this.criarRecomendacoesFinais();
            }
        }

        // Inicializa√ß√£o para demonstra√ß√£o
        window.addEventListener('DOMContentLoaded', function() {
            // Verificar se h√° processo especificado
            const urlParams = new URLSearchParams(window.location.search);
            const processoId = urlParams.get('processo');
            
            if (processoId) {
                const comparativo = new ComparativoAvancadoIA();
                comparativo.carregarPropostas(processoId);
                
                if (comparativo.propostasProcesso.length > 0) {
                    comparativo.gerarRelatorioCompleto();
                } else {
                    document.querySelector('.container').innerHTML += 
                        '<p style="text-align: center; color: #e74c3c; margin-top: 50px;">Nenhuma proposta encontrada para este processo.</p>';
                }
            } else {
                // Modo demonstra√ß√£o
                console.log('M√≥dulo de comparativo carregado. Use com par√¢metro ?processo=NUMERO_PROCESSO');
            }
        });

        // Exportar classe para uso global
        window.ComparativoAvancadoIA = ComparativoAvancadoIA;
    </script>
</body>
</html>