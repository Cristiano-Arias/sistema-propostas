<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador de Termo de Refer√™ncia - V2.0</title>
    
    <style>
        /* Estilos base mantidos */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        
        /* NOVO: Wizard com etapas */
        .wizard-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .wizard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px 10px 0 0;
            text-align: center;
        }
        
        .wizard-steps {
            background: white;
            padding: 0;
            display: flex;
            border-bottom: 3px solid #e0e0e0;
        }
        
        .wizard-step {
            flex: 1;
            padding: 20px;
            text-align: center;
            position: relative;
            background: #f8f9fa;
            cursor: not-allowed;
            transition: all 0.3s;
        }
        
        .wizard-step.completed {
            background: #d4edda;
            cursor: pointer;
        }
        
        .wizard-step.active {
            background: white;
            cursor: default;
            border-bottom: 3px solid #667eea;
            margin-bottom: -3px;
        }
        
        .wizard-step.locked {
            opacity: 0.5;
        }
        
        .step-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            line-height: 30px;
            border-radius: 50%;
            background: #6c757d;
            color: white;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .wizard-step.completed .step-number {
            background: #28a745;
        }
        
        .wizard-step.active .step-number {
            background: #667eea;
        }
        
        .step-title {
            font-size: 14px;
            font-weight: 600;
            color: #333;
        }
        
        .wizard-content {
            background: white;
            padding: 30px;
            min-height: 500px;
        }
        
        .step-content {
            display: none;
        }
        
        .step-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .form-section {
            margin-bottom: 30px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
        }
        
        .form-section h3 {
            color: #333;
            margin: 0 0 15px 0;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
            font-size: 1.2rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        .form-group input,
        .form-group textarea,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .required {
            color: #dc3545;
        }
        
        .help-text {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        /* TABELA PADRONIZADA - Id√™ntica ao Portal */
        .tabela-servicos-padrao {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .tabela-servicos-padrao th {
            background: #667eea;
            color: white;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
        }
        
        .tabela-servicos-padrao td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .tabela-servicos-padrao input,
        .tabela-servicos-padrao select {
            width: 100%;
            padding: 6px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }
        
        .btn-add-row {
            background: #28a745;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
        }
        
        .btn-remove-row {
            background: #dc3545;
            color: white;
            padding: 4px 8px;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 12px;
        }
        
        /* Matriz de Responsabilidades */
        .matriz-responsabilidades {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .responsabilidade-coluna {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border: 2px solid #e0e0e0;
        }
        
        .responsabilidade-coluna h4 {
            color: #333;
            margin-bottom: 15px;
            font-size: 16px;
        }
        
        .responsabilidade-coluna.contratada {
            border-color: #667eea;
        }
        
        .responsabilidade-coluna.contratante {
            border-color: #28a745;
        }
        
        .responsabilidade-item {
            background: white;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .responsabilidade-item input {
            flex: 1;
        }
        
        /* Bot√µes de navega√ß√£o */
        .wizard-navigation {
            background: white;
            padding: 20px 30px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .btn-nav {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-prev {
            background: #6c757d;
            color: white;
        }
        
        .btn-next {
            background: #667eea;
            color: white;
        }
        
        .btn-next:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-save {
            background: #ffc107;
            color: #212529;
        }
        
        .btn-finish {
            background: #28a745;
            color: white;
        }
        
        /* Valida√ß√£o visual */
        .form-group.error input,
        .form-group.error textarea {
            border-color: #dc3545;
        }
        
        .error-message {
            color: #dc3545;
            font-size: 12px;
            margin-top: 5px;
        }
        
        .validation-summary {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .validation-summary.show {
            display: block;
        }
        
        /* Loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }
        
        .loading-overlay.show {
            display: flex;
        }
        
        .loading-content {
            background: white;
            padding: 30px;
            border-radius: 10px;
            text-align: center;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Responsivo */
        @media (max-width: 768px) {
            .wizard-steps {
                flex-direction: column;
            }
            
            .matriz-responsabilidades {
                grid-template-columns: 1fr;
            }
            
            .wizard-navigation {
                flex-direction: column;
                gap: 10px;
            }
            
            .btn-nav {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="wizard-container">
        <!-- Header -->
        <div class="wizard-header">
            <h1>üìù Gerador de Termo de Refer√™ncia - V2.0</h1>
            <p>Sistema com ordem obrigat√≥ria e tabela padronizada</p>
        </div>
        
        <!-- Steps -->
        <div class="wizard-steps">
            <div class="wizard-step active" data-step="1">
                <span class="step-number">1</span>
                <div class="step-title">T√≠tulo e Objetivo</div>
            </div>
            <div class="wizard-step locked" data-step="2">
                <span class="step-number">2</span>
                <div class="step-title">Situa√ß√£o e Problemas</div>
            </div>
            <div class="wizard-step locked" data-step="3">
                <span class="step-number">3</span>
                <div class="step-title">Especifica√ß√µes</div>
            </div>
            <div class="wizard-step locked" data-step="4">
                <span class="step-number">4</span>
                <div class="step-title">Tabela de Servi√ßos</div>
            </div>
            <div class="wizard-step locked" data-step="5">
                <span class="step-number">5</span>
                <div class="step-title">Prazos e Garantias</div>
            </div>
            <div class="wizard-step locked" data-step="6">
                <span class="step-number">6</span>
                <div class="step-title">Responsabilidades</div>
            </div>
        </div>
        
        <!-- Content -->
        <div class="wizard-content">
            <!-- Validation Summary -->
            <div class="validation-summary" id="validationSummary">
                <strong>‚ö†Ô∏è Aten√ß√£o:</strong> Por favor, preencha todos os campos obrigat√≥rios antes de prosseguir.
            </div>
            
            <!-- Step 1: T√≠tulo e Objetivo -->
            <div class="step-content active" data-step-content="1">
                <div class="form-section">
                    <h3>üìã 1. T√≠tulo e Objetivo</h3>
                    
                    <div class="form-group">
                        <label for="titulo">T√≠tulo do Projeto <span class="required">*</span></label>
                        <input type="text" id="titulo" name="titulo" required 
                               placeholder="Ex: Reforma do Centro de Sa√∫de Municipal">
                        <div class="help-text">Seja claro e espec√≠fico sobre o objeto da contrata√ß√£o</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="objetivo">Objetivo da Contrata√ß√£o <span class="required">*</span></label>
                        <textarea id="objetivo" name="objetivo" required rows="6"
                                  placeholder="Descreva detalhadamente o objetivo principal da contrata√ß√£o, incluindo os resultados esperados..."></textarea>
                        <div class="help-text">M√≠nimo 100 caracteres. Seja detalhado sobre o que se espera alcan√ßar.</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="justificativa">Justificativa <span class="required">*</span></label>
                        <textarea id="justificativa" name="justificativa" required rows="4"
                                  placeholder="Explique por que esta contrata√ß√£o √© necess√°ria..."></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Step 2: Situa√ß√£o Atual e Problemas -->
            <div class="step-content" data-step-content="2">
                <div class="form-section">
                    <h3>üìä 2. Situa√ß√£o Atual e Problemas</h3>
                    
                    <div class="form-group">
                        <label for="situacao_atual">Diagn√≥stico da Situa√ß√£o Atual <span class="required">*</span></label>
                        <textarea id="situacao_atual" name="situacao_atual" required rows="6"
                                  placeholder="Descreva detalhadamente a situa√ß√£o atual que justifica a contrata√ß√£o. Inclua dados, n√∫meros e fatos concretos..."></textarea>
                        <div class="help-text">Seja espec√≠fico: inclua dados quantitativos, fotos se poss√≠vel, e descri√ß√£o detalhada do estado atual</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="problemas">Problemas Identificados <span class="required">*</span></label>
                        <textarea id="problemas" name="problemas" required rows="5"
                                  placeholder="Liste os principais problemas identificados:&#10;‚Ä¢ Problema 1: ...&#10;‚Ä¢ Problema 2: ...&#10;‚Ä¢ Problema 3: ..."></textarea>
                        <div class="help-text">Use bullets para listar cada problema de forma clara</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="impactos">Impactos dos Problemas</label>
                        <textarea id="impactos" name="impactos" rows="4"
                                  placeholder="Descreva os impactos negativos causados pelos problemas identificados..."></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Step 3: Especifica√ß√µes T√©cnicas -->
            <div class="step-content" data-step-content="3">
                <div class="form-section">
                    <h3>üîß 3. Especifica√ß√µes T√©cnicas</h3>
                    
                    <div class="form-group">
                        <label for="especificacoes">Especifica√ß√µes Detalhadas <span class="required">*</span></label>
                        <textarea id="especificacoes" name="especificacoes" required rows="8"
                                  placeholder="Detalhe todas as especifica√ß√µes t√©cnicas necess√°rias:&#10;‚Ä¢ Materiais a serem utilizados&#10;‚Ä¢ Normas t√©cnicas aplic√°veis&#10;‚Ä¢ Padr√µes de qualidade exigidos&#10;‚Ä¢ Requisitos t√©cnicos espec√≠ficos"></textarea>
                        <div class="help-text">Inclua todas as normas t√©cnicas (NBR, ABNT, etc.) que devem ser seguidas</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="normas">Normas e Regulamenta√ß√µes <span class="required">*</span></label>
                        <textarea id="normas" name="normas" required rows="4"
                                  placeholder="Ex: NBR 9050 - Acessibilidade&#10;NBR 5410 - Instala√ß√µes el√©tricas&#10;NR 18 - Seguran√ßa do trabalho"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="qualificacao_tecnica">Qualifica√ß√£o T√©cnica Exigida</label>
                        <textarea id="qualificacao_tecnica" name="qualificacao_tecnica" rows="4"
                                  placeholder="Descreva as qualifica√ß√µes t√©cnicas m√≠nimas exigidas da contratada..."></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Step 4: Tabela de Servi√ßos (PADRONIZADA) -->
            <div class="step-content" data-step-content="4">
                <div class="form-section">
                    <h3>üìã 4. Tabela de Servi√ßos (Padr√£o Portal)</h3>
                    <p style="color: #856404; background: #fff3cd; padding: 10px; border-radius: 5px; margin-bottom: 15px;">
                        ‚ö†Ô∏è <strong>Importante:</strong> Esta tabela tem o mesmo formato do Portal de Propostas. 
                        Preencha apenas as quantidades, sem valores.
                    </p>
                    
                    <table class="tabela-servicos-padrao" id="tabelaServicos">
                        <thead>
                            <tr>
                                <th width="60">Item</th>
                                <th width="40%">Descri√ß√£o do Servi√ßo</th>
                                <th width="100">Unidade</th>
                                <th width="120">Quantidade</th>
                                <th width="80">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td><input type="text" value="1" readonly style="background: #f8f9fa; text-align: center;"></td>
                                <td><input type="text" placeholder="Ex: Demoli√ß√£o de paredes internas" required></td>
                                <td>
                                    <select required>
                                        <option value="">Selecione</option>
                                        <option value="m¬≤">m¬≤</option>
                                        <option value="m¬≥">m¬≥</option>
                                        <option value="m">m</option>
                                        <option value="un">un</option>
                                        <option value="kg">kg</option>
                                        <option value="h">h</option>
                                        <option value="vb">vb</option>
                                        <option value="cj">cj</option>
                                        <option value="p√ß">p√ß</option>
                                    </select>
                                </td>
                                <td><input type="number" placeholder="Ex: 150" step="0.01" required></td>
                                <td><button type="button" class="btn-remove-row" onclick="removerLinha(this)">Remover</button></td>
                            </tr>
                        </tbody>
                    </table>
                    <button type="button" class="btn-add-row" onclick="adicionarLinhaServico()">+ Adicionar Servi√ßo</button>
                    
                    <div class="help-text" style="margin-top: 15px;">
                        üí° Dica: Seja espec√≠fico na descri√ß√£o dos servi√ßos. Isso facilitar√° a an√°lise das propostas.
                    </div>
                </div>
            </div>
            
            <!-- Step 5: Prazos e Garantias -->
            <div class="step-content" data-step-content="5">
                <div class="form-section">
                    <h3>‚è∞ 5. Prazos e Garantias</h3>
                    
                    <div class="form-group">
                        <label for="prazo_execucao">Prazo de Execu√ß√£o <span class="required">*</span></label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="prazo_execucao" name="prazo_execucao" required 
                                   placeholder="120" style="width: 150px;">
                            <select id="prazo_unidade" style="width: 150px;">
                                <option value="dias">Dias corridos</option>
                                <option value="dias_uteis">Dias √∫teis</option>
                                <option value="meses">Meses</option>
                            </select>
                        </div>
                        <div class="help-text">Considere um prazo realista para a complexidade do servi√ßo</div>
                    </div>
                    
                    <div class="form-group">
                        <label for="prazo_garantia">Prazo de Garantia <span class="required">*</span></label>
                        <div style="display: flex; gap: 10px;">
                            <input type="number" id="prazo_garantia" name="prazo_garantia" required 
                                   placeholder="12" style="width: 150px;">
                            <select id="garantia_unidade" style="width: 150px;">
                                <option value="meses">Meses</option>
                                <option value="anos">Anos</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="condicoes_garantia">Condi√ß√µes de Garantia <span class="required">*</span></label>
                        <textarea id="condicoes_garantia" name="condicoes_garantia" required rows="4"
                                  placeholder="Descreva as condi√ß√µes espec√≠ficas da garantia, incluindo o que est√° coberto e o que n√£o est√°..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="cronograma_basico">Cronograma B√°sico de Execu√ß√£o</label>
                        <textarea id="cronograma_basico" name="cronograma_basico" rows="4"
                                  placeholder="Etapa 1 (30 dias): Mobiliza√ß√£o e prepara√ß√£o&#10;Etapa 2 (60 dias): Execu√ß√£o principal&#10;Etapa 3 (30 dias): Acabamentos e entrega"></textarea>
                    </div>
                </div>
            </div>
            
            <!-- Step 6: Matriz de Responsabilidades -->
            <div class="step-content" data-step-content="6">
                <div class="form-section">
                    <h3>üìä 6. Matriz de Responsabilidades</h3>
                    <p style="color: #004085; background: #cce5ff; padding: 10px; border-radius: 5px; margin-bottom: 20px;">
                        ‚ÑπÔ∏è Defina claramente as responsabilidades de cada parte para evitar conflitos durante a execu√ß√£o.
                    </p>
                    
                    <div class="matriz-responsabilidades">
                        <div class="responsabilidade-coluna contratada">
                            <h4>üè¢ Responsabilidades da CONTRATADA</h4>
                            <div id="responsabilidadesContratada">
                                <div class="responsabilidade-item">
                                    <span>‚Ä¢</span>
                                    <input type="text" placeholder="Fornecimento de todos os materiais" value="Fornecimento de todos os materiais">
                                </div>
                                <div class="responsabilidade-item">
                                    <span>‚Ä¢</span>
                                    <input type="text" placeholder="M√£o de obra especializada" value="M√£o de obra especializada">
                                </div>
                                <div class="responsabilidade-item">
                                    <span>‚Ä¢</span>
                                    <input type="text" placeholder="Equipamentos e ferramentas" value="Equipamentos e ferramentas">
                                </div>
                                <div class="responsabilidade-item">
                                    <span>‚Ä¢</span>
                                    <input type="text" placeholder="EPIs e seguran√ßa do trabalho" value="EPIs e seguran√ßa do trabalho">
                                </div>
                                <div class="responsabilidade-item">
                                    <span>‚Ä¢</span>
                                    <input type="text" placeholder="Limpeza di√°ria da obra" value="Limpeza di√°ria da obra">
                                </div>
                            </div>
                            <button type="button" class="btn-add-row" onclick="adicionarResponsabilidade('contratada')">
                                + Adicionar Responsabilidade
                            </button>
                        </div>
                        
                        <div class="responsabilidade-coluna contratante">
                            <h4>üèõÔ∏è Responsabilidades da CONTRATANTE</h4>
                            <div id="responsabilidadesContratante">
                                <div class="responsabilidade-item">
                                    <span>‚Ä¢</span>
                                    <input type="text" placeholder="Acesso ao local da obra" value="Acesso ao local da obra">
                                </div>
                                <div class="responsabilidade-item">
                                    <span>‚Ä¢</span>
                                    <input type="text" placeholder="Ponto de energia el√©trica" value="Ponto de energia el√©trica">
                                </div>
                                <div class="responsabilidade-item">
                                    <span>‚Ä¢</span>
                                    <input type="text" placeholder="Ponto de √°gua" value="Ponto de √°gua">
                                </div>
                                <div class="responsabilidade-item">
                                    <span>‚Ä¢</span>
                                    <input type="text" placeholder="Local para armazenamento" value="Local para armazenamento de materiais">
                                </div>
                                <div class="responsabilidade-item">
                                    <span>‚Ä¢</span>
                                    <input type="text" placeholder="Fiscaliza√ß√£o da obra" value="Fiscaliza√ß√£o e acompanhamento">
                                </div>
                            </div>
                            <button type="button" class="btn-add-row" onclick="adicionarResponsabilidade('contratante')">
                                + Adicionar Responsabilidade
                            </button>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label for="observacoes_gerais">Observa√ß√µes Gerais</label>
                        <textarea id="observacoes_gerais" name="observacoes_gerais" rows="3"
                                  placeholder="Adicione observa√ß√µes importantes sobre as responsabilidades..."></textarea>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Navigation -->
        <div class="wizard-navigation">
            <button type="button" class="btn-nav btn-prev" id="btnPrev" onclick="navegarEtapa(-1)" style="display: none;">
                ‚Üê Anterior
            </button>
            
            <button type="button" class="btn-nav btn-save" onclick="salvarRascunho()">
                üíæ Salvar Rascunho
            </button>
            
            <button type="button" class="btn-nav btn-next" id="btnNext" onclick="navegarEtapa(1)">
                Pr√≥ximo ‚Üí
            </button>
            
            <button type="button" class="btn-nav btn-finish" id="btnFinish" onclick="finalizarTR()" style="display: none;">
                ‚úÖ Finalizar TR
            </button>
        </div>
    </div>
    
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <p>Processando...</p>
        </div>
    </div>
    
    <script>
        // Estado do wizard
        let etapaAtual = 1;
        const totalEtapas = 6;
        let dadosTR = {
            etapa1: {},
            etapa2: {},
            etapa3: {},
            etapa4: { servicos: [] },
            etapa5: {},
            etapa6: { contratada: [], contratante: [] }
        };
        
        // Valida√ß√µes por etapa
        const validacoesEtapa = {
            1: ['titulo', 'objetivo', 'justificativa'],
            2: ['situacao_atual', 'problemas'],
            3: ['especificacoes', 'normas'],
            4: () => validarTabelaServicos(),
            5: ['prazo_execucao', 'prazo_garantia', 'condicoes_garantia'],
            6: () => validarMatrizResponsabilidades()
        };
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            // Carregar rascunho se existir
            carregarRascunho();
            
            // Adicionar listeners de valida√ß√£o em tempo real
            adicionarListenersValidacao();
            
            // Verificar autentica√ß√£o
            verificarAutenticacao();
        });
        
        // Verificar autentica√ß√£o
        function verificarAutenticacao() {
            const sessao = sessionStorage.getItem('sessao_ativa');
            if (!sessao) {
                window.location.href = 'index.html';
                return;
            }
            
            const usuario = JSON.parse(sessao);
            if (usuario.tipo !== 'requisitante' && usuario.tipo !== 'admin') {
                alert('Acesso negado. Apenas requisitantes podem criar TRs.');
                window.location.href = 'index.html';
            }
        }
        
        // Navega√ß√£o entre etapas
        function navegarEtapa(direcao) {
            // Salvar dados da etapa atual
            salvarDadosEtapa();
            
            // Validar antes de avan√ßar
            if (direcao > 0 && !validarEtapa()) {
                mostrarErrosValidacao();
                return;
            }
            
            // Mudar etapa
            etapaAtual += direcao;
            
            // Limitar navega√ß√£o
            if (etapaAtual < 1) etapaAtual = 1;
            if (etapaAtual > totalEtapas) etapaAtual = totalEtapas;
            
            // Atualizar interface
            atualizarInterface();
        }
        
        // Validar etapa atual
        function validarEtapa() {
            const validacoes = validacoesEtapa[etapaAtual];
            
            if (typeof validacoes === 'function') {
                return validacoes();
            }
            
            let valido = true;
            validacoes.forEach(campo => {
                const elemento = document.getElementById(campo);
                if (!elemento || !elemento.value.trim()) {
                    valido = false;
                    if (elemento) {
                        elemento.parentElement.classList.add('error');
                    }
                } else {
                    elemento.parentElement.classList.remove('error');
                }
            });
            
            return valido;
        }
        
        // Validar tabela de servi√ßos
        function validarTabelaServicos() {
            const linhas = document.querySelectorAll('#tabelaServicos tbody tr');
            let valido = true;
            
            if (linhas.length === 0) {
                valido = false;
            }
            
            linhas.forEach(linha => {
                const inputs = linha.querySelectorAll('input[required], select[required]');
                inputs.forEach(input => {
                    if (!input.value.trim()) {
                        valido = false;
                        input.style.borderColor = '#dc3545';
                    } else {
                        input.style.borderColor = '#ced4da';
                    }
                });
            });
            
            return valido;
        }
        
        // Validar matriz de responsabilidades
        function validarMatrizResponsabilidades() {
            const contratada = document.querySelectorAll('#responsabilidadesContratada input');
            const contratante = document.querySelectorAll('#responsabilidadesContratante input');
            
            let validoContratada = false;
            let validoContratante = false;
            
            contratada.forEach(input => {
                if (input.value.trim()) validoContratada = true;
            });
            
            contratante.forEach(input => {
                if (input.value.trim()) validoContratante = true;
            });
            
            return validoContratada && validoContratante;
        }
        
        // Mostrar erros de valida√ß√£o
        function mostrarErrosValidacao() {
            const summary = document.getElementById('validationSummary');
            summary.classList.add('show');
            
            setTimeout(() => {
                summary.classList.remove('show');
            }, 5000);
        }
        
        // Salvar dados da etapa atual
        function salvarDadosEtapa() {
            switch(etapaAtual) {
                case 1:
                    dadosTR.etapa1 = {
                        titulo: document.getElementById('titulo').value,
                        objetivo: document.getElementById('objetivo').value,
                        justificativa: document.getElementById('justificativa').value
                    };
                    break;
                    
                case 2:
                    dadosTR.etapa2 = {
                        situacao_atual: document.getElementById('situacao_atual').value,
                        problemas: document.getElementById('problemas').value,
                        impactos: document.getElementById('impactos').value
                    };
                    break;
                    
                case 3:
                    dadosTR.etapa3 = {
                        especificacoes: document.getElementById('especificacoes').value,
                        normas: document.getElementById('normas').value,
                        qualificacao_tecnica: document.getElementById('qualificacao_tecnica').value
                    };
                    break;
                    
                case 4:
                    dadosTR.etapa4.servicos = coletarTabelaServicos();
                    break;
                    
                case 5:
                    dadosTR.etapa5 = {
                        prazo_execucao: document.getElementById('prazo_execucao').value,
                        prazo_unidade: document.getElementById('prazo_unidade').value,
                        prazo_garantia: document.getElementById('prazo_garantia').value,
                        garantia_unidade: document.getElementById('garantia_unidade').value,
                        condicoes_garantia: document.getElementById('condicoes_garantia').value,
                        cronograma_basico: document.getElementById('cronograma_basico').value
                    };
                    break;
                    
                case 6:
                    dadosTR.etapa6 = {
                        contratada: coletarResponsabilidades('contratada'),
                        contratante: coletarResponsabilidades('contratante'),
                        observacoes_gerais: document.getElementById('observacoes_gerais').value
                    };
                    break;
            }
            
            // Salvar no localStorage
            localStorage.setItem('tr_rascunho', JSON.stringify(dadosTR));
        }
        
        // Atualizar interface
        function atualizarInterface() {
            // Ocultar todos os conte√∫dos
            document.querySelectorAll('.step-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Mostrar conte√∫do atual
            document.querySelector(`[data-step-content="${etapaAtual}"]`).classList.add('active');
            
            // Atualizar steps
            document.querySelectorAll('.wizard-step').forEach((step, index) => {
                const stepNum = index + 1;
                
                step.classList.remove('active', 'completed', 'locked');
                
                if (stepNum < etapaAtual) {
                    step.classList.add('completed');
                } else if (stepNum === etapaAtual) {
                    step.classList.add('active');
                } else {
                    step.classList.add('locked');
                }
            });
            
            // Atualizar bot√µes
            document.getElementById('btnPrev').style.display = etapaAtual > 1 ? 'block' : 'none';
            document.getElementById('btnNext').style.display = etapaAtual < totalEtapas ? 'block' : 'none';
            document.getElementById('btnFinish').style.display = etapaAtual === totalEtapas ? 'block' : 'none';
            
            // Scroll to top
            window.scrollTo(0, 0);
        }
        
        // Adicionar linha de servi√ßo
        function adicionarLinhaServico() {
            const tbody = document.querySelector('#tabelaServicos tbody');
            const numeroLinhas = tbody.rows.length;
            const novaLinha = tbody.insertRow();
            
            novaLinha.innerHTML = `
                <td><input type="text" value="${numeroLinhas + 1}" readonly style="background: #f8f9fa; text-align: center;"></td>
                <td><input type="text" placeholder="Descri√ß√£o do servi√ßo" required></td>
                <td>
                    <select required>
                        <option value="">Selecione</option>
                        <option value="m¬≤">m¬≤</option>
                        <option value="m¬≥">m¬≥</option>
                        <option value="m">m</option>
                        <option value="un">un</option>
                        <option value="kg">kg</option>
                        <option value="h">h</option>
                        <option value="vb">vb</option>
                        <option value="cj">cj</option>
                        <option value="p√ß">p√ß</option>
                    </select>
                </td>
                <td><input type="number" placeholder="Quantidade" step="0.01" required></td>
                <td><button type="button" class="btn-remove-row" onclick="removerLinha(this)">Remover</button></td>
            `;
        }
        
        // Remover linha
        function removerLinha(button) {
            const linha = button.closest('tr');
            linha.remove();
            
            // Renumerar itens
            const linhas = document.querySelectorAll('#tabelaServicos tbody tr');
            linhas.forEach((linha, index) => {
                linha.cells[0].querySelector('input').value = index + 1;
            });
        }
        
        // Adicionar responsabilidade
        function adicionarResponsabilidade(tipo) {
            const container = document.getElementById(`responsabilidades${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
            const div = document.createElement('div');
            div.className = 'responsabilidade-item';
            div.innerHTML = `
                <span>‚Ä¢</span>
                <input type="text" placeholder="Nova responsabilidade">
                <button type="button" class="btn-remove-row" onclick="this.parentElement.remove()">√ó</button>
            `;
            container.appendChild(div);
        }
        
        // Coletar tabela de servi√ßos
        function coletarTabelaServicos() {
            const servicos = [];
            const linhas = document.querySelectorAll('#tabelaServicos tbody tr');
            
            linhas.forEach(linha => {
                const item = linha.cells[0].querySelector('input').value;
                const descricao = linha.cells[1].querySelector('input').value;
                const unidade = linha.cells[2].querySelector('select').value;
                const quantidade = linha.cells[3].querySelector('input').value;
                
                if (descricao && unidade && quantidade) {
                    servicos.push({ item, descricao, unidade, quantidade });
                }
            });
            
            return servicos;
        }
        
        // Coletar responsabilidades
        function coletarResponsabilidades(tipo) {
            const responsabilidades = [];
            const container = document.getElementById(`responsabilidades${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
            const inputs = container.querySelectorAll('input');
            
            inputs.forEach(input => {
                if (input.value.trim()) {
                    responsabilidades.push(input.value.trim());
                }
            });
            
            return responsabilidades;
        }
        
        // Salvar rascunho
        function salvarRascunho() {
            salvarDadosEtapa();
            
            // Mostrar loading
            document.getElementById('loadingOverlay').classList.add('show');
            
            // Simular salvamento
            setTimeout(() => {
                document.getElementById('loadingOverlay').classList.remove('show');
                alert('‚úÖ Rascunho salvo com sucesso!');
            }, 1000);
        }
        
        // Carregar rascunho
        function carregarRascunho() {
            const rascunho = localStorage.getItem('tr_rascunho');
            if (rascunho) {
                dadosTR = JSON.parse(rascunho);
                
                // Preencher campos da etapa 1
                if (dadosTR.etapa1) {
                    document.getElementById('titulo').value = dadosTR.etapa1.titulo || '';
                    document.getElementById('objetivo').value = dadosTR.etapa1.objetivo || '';
                    document.getElementById('justificativa').value = dadosTR.etapa1.justificativa || '';
                }
                
                // Verificar quais etapas est√£o completas
                for (let i = 1; i <= totalEtapas; i++) {
                    if (dadosTR[`etapa${i}`] && Object.keys(dadosTR[`etapa${i}`]).length > 0) {
                        // Marcar etapa como completa se tem dados
                        const step = document.querySelector(`[data-step="${i}"]`);
                        if (i < etapaAtual) {
                            step.classList.add('completed');
                        }
                    }
                }
            }
        }
        
        // Finalizar TR
        async function finalizarTR() {
            // Validar √∫ltima etapa
            if (!validarEtapa()) {
                mostrarErrosValidacao();
                return;
            }
            
            // Salvar dados finais
            salvarDadosEtapa();
            
            // Mostrar loading
            document.getElementById('loadingOverlay').classList.add('show');
            
            try {
                // Preparar dados para envio
                const trCompleto = {
                    titulo: dadosTR.etapa1.titulo,
                    objetivo: dadosTR.etapa1.objetivo,
                    justificativa: dadosTR.etapa1.justificativa,
                    situacao_atual: dadosTR.etapa2.situacao_atual,
                    problemas: dadosTR.etapa2.problemas,
                    impactos: dadosTR.etapa2.impactos,
                    especificacoes: dadosTR.etapa3.especificacoes,
                    normas: dadosTR.etapa3.normas,
                    qualificacao_tecnica: dadosTR.etapa3.qualificacao_tecnica,
                    servicos: dadosTR.etapa4.servicos,
                    prazo_execucao: `${dadosTR.etapa5.prazo_execucao} ${dadosTR.etapa5.prazo_unidade}`,
                    prazo_garantia: `${dadosTR.etapa5.prazo_garantia} ${dadosTR.etapa5.garantia_unidade}`,
                    condicoes_garantia: dadosTR.etapa5.condicoes_garantia,
                    cronograma_basico: dadosTR.etapa5.cronograma_basico,
                    matriz_responsabilidades: {
                        contratada: dadosTR.etapa6.contratada,
                        contratante: dadosTR.etapa6.contratante
                    },
                    observacoes_gerais: dadosTR.etapa6.observacoes_gerais,
                    status: 'finalizado',
                    criado_por: JSON.parse(sessionStorage.getItem('sessao_ativa')).usuarioId,
                    criado_em: new Date().toISOString()
                };
                
                // Simular envio para API
                const response = await enviarTRParaAPI(trCompleto);
                
                if (response.success) {
                    // Limpar rascunho
                    localStorage.removeItem('tr_rascunho');
                    
                    // Mostrar sucesso
                    alert('‚úÖ TR finalizado e enviado com sucesso!');
                    
                    // Redirecionar
                    setTimeout(() => {
                        window.location.href = 'dashboard-requisitante.html';
                    }, 1500);
                }
                
            } catch (error) {
                console.error('Erro ao finalizar TR:', error);
                alert('‚ùå Erro ao finalizar TR. Por favor, tente novamente.');
            } finally {
                document.getElementById('loadingOverlay').classList.remove('show');
            }
        }
        
        // Simular envio para API
        async function enviarTRParaAPI(dados) {
            // Simular delay de rede
            return new Promise((resolve) => {
                setTimeout(() => {
                    resolve({ success: true, id: 'TR-' + Date.now() });
                }, 2000);
            });
        }
        
        // Adicionar listeners de valida√ß√£o
        function adicionarListenersValidacao() {
            // Etapa 1
            const camposEtapa1 = ['titulo', 'objetivo', 'justificativa'];
            camposEtapa1.forEach(campo => {
                const elemento = document.getElementById(campo);
                if (elemento) {
                    elemento.addEventListener('blur', function() {
                        if (this.value.trim()) {
                            this.parentElement.classList.remove('error');
                        }
                    });
                }
            });
            
            // Valida√ß√£o especial para objetivo (m√≠nimo 100 caracteres)
            const objetivo = document.getElementById('objetivo');
            if (objetivo) {
                objetivo.addEventListener('input', function() {
                    const length = this.value.length;
                    const helpText = this.nextElementSibling;
                    if (length < 100) {
                        helpText.style.color = '#dc3545';
                        helpText.textContent = `M√≠nimo 100 caracteres. Atual: ${length}`;
                    } else {
                        helpText.style.color = '#6c757d';
                        helpText.textContent = 'M√≠nimo 100 caracteres. Seja detalhado sobre o que se espera alcan√ßar.';
                    }
                });
            }
        }
        
        // Permitir navega√ß√£o em etapas completas
        document.querySelectorAll('.wizard-step').forEach(step => {
            step.addEventListener('click', function() {
                const stepNumber = parseInt(this.dataset.step);
                
                // S√≥ permite navegar se for etapa anterior j√° completa
                if (this.classList.contains('completed') || stepNumber === etapaAtual) {
                    // Salvar dados atuais
                    salvarDadosEtapa();
                    
                    // Navegar para etapa clicada
                    etapaAtual = stepNumber;
                    atualizarInterface();
                    
                    // Carregar dados da etapa
                    carregarDadosEtapa(stepNumber);
                }
            });
        });
        
        // Carregar dados de uma etapa espec√≠fica
        function carregarDadosEtapa(etapa) {
            switch(etapa) {
                case 1:
                    if (dadosTR.etapa1) {
                        document.getElementById('titulo').value = dadosTR.etapa1.titulo || '';
                        document.getElementById('objetivo').value = dadosTR.etapa1.objetivo || '';
                        document.getElementById('justificativa').value = dadosTR.etapa1.justificativa || '';
                    }
                    break;
                    
                case 2:
                    if (dadosTR.etapa2) {
                        document.getElementById('situacao_atual').value = dadosTR.etapa2.situacao_atual || '';
                        document.getElementById('problemas').value = dadosTR.etapa2.problemas || '';
                        document.getElementById('impactos').value = dadosTR.etapa2.impactos || '';
                    }
                    break;
                    
                case 3:
                    if (dadosTR.etapa3) {
                        document.getElementById('especificacoes').value = dadosTR.etapa3.especificacoes || '';
                        document.getElementById('normas').value = dadosTR.etapa3.normas || '';
                        document.getElementById('qualificacao_tecnica').value = dadosTR.etapa3.qualificacao_tecnica || '';
                    }
                    break;
                    
                case 4:
                    if (dadosTR.etapa4 && dadosTR.etapa4.servicos) {
                        carregarTabelaServicos(dadosTR.etapa4.servicos);
                    }
                    break;
                    
                case 5:
                    if (dadosTR.etapa5) {
                        document.getElementById('prazo_execucao').value = dadosTR.etapa5.prazo_execucao || '';
                        document.getElementById('prazo_unidade').value = dadosTR.etapa5.prazo_unidade || 'dias';
                        document.getElementById('prazo_garantia').value = dadosTR.etapa5.prazo_garantia || '';
                        document.getElementById('garantia_unidade').value = dadosTR.etapa5.garantia_unidade || 'meses';
                        document.getElementById('condicoes_garantia').value = dadosTR.etapa5.condicoes_garantia || '';
                        document.getElementById('cronograma_basico').value = dadosTR.etapa5.cronograma_basico || '';
                    }
                    break;
                    
                case 6:
                    if (dadosTR.etapa6) {
                        carregarResponsabilidades('contratada', dadosTR.etapa6.contratada);
                        carregarResponsabilidades('contratante', dadosTR.etapa6.contratante);
                        document.getElementById('observacoes_gerais').value = dadosTR.etapa6.observacoes_gerais || '';
                    }
                    break;
            }
        }
        
        // Carregar tabela de servi√ßos
        function carregarTabelaServicos(servicos) {
            const tbody = document.querySelector('#tabelaServicos tbody');
            tbody.innerHTML = '';
            
            servicos.forEach(servico => {
                const novaLinha = tbody.insertRow();
                novaLinha.innerHTML = `
                    <td><input type="text" value="${servico.item}" readonly style="background: #f8f9fa; text-align: center;"></td>
                    <td><input type="text" value="${servico.descricao}" required></td>
                    <td>
                        <select required>
                            <option value="">Selecione</option>
                            <option value="m¬≤" ${servico.unidade === 'm¬≤' ? 'selected' : ''}>m¬≤</option>
                            <option value="m¬≥" ${servico.unidade === 'm¬≥' ? 'selected' : ''}>m¬≥</option>
                            <option value="m" ${servico.unidade === 'm' ? 'selected' : ''}>m</option>
                            <option value="un" ${servico.unidade === 'un' ? 'selected' : ''}>un</option>
                            <option value="kg" ${servico.unidade === 'kg' ? 'selected' : ''}>kg</option>
                            <option value="h" ${servico.unidade === 'h' ? 'selected' : ''}>h</option>
                            <option value="vb" ${servico.unidade === 'vb' ? 'selected' : ''}>vb</option>
                            <option value="cj" ${servico.unidade === 'cj' ? 'selected' : ''}>cj</option>
                            <option value="p√ß" ${servico.unidade === 'p√ß' ? 'selected' : ''}>p√ß</option>
                        </select>
                    </td>
                    <td><input type="number" value="${servico.quantidade}" step="0.01" required></td>
                    <td><button type="button" class="btn-remove-row" onclick="removerLinha(this)">Remover</button></td>
                `;
            });
        }
        
        // Carregar responsabilidades
        function carregarResponsabilidades(tipo, responsabilidades) {
            if (!responsabilidades || responsabilidades.length === 0) return;
            
            const container = document.getElementById(`responsabilidades${tipo.charAt(0).toUpperCase() + tipo.slice(1)}`);
            container.innerHTML = '';
            
            responsabilidades.forEach(resp => {
                const div = document.createElement('div');
                div.className = 'responsabilidade-item';
                div.innerHTML = `
                    <span>‚Ä¢</span>
                    <input type="text" value="${resp}">
                    <button type="button" class="btn-remove-row" onclick="this.parentElement.remove()">√ó</button>
                `;
                container.appendChild(div);
            });
        }
    </script>
</body>
</html>