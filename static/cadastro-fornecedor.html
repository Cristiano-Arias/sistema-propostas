// ===================================
// CADASTRO R√ÅPIDO DE FORNECEDOR V2.0
// Integrado ao m√≥dulo do Comprador
// ===================================

const CadastroRapidoFornecedor = {
    // Criar modal de cadastro r√°pido
    criarModal: function() {
        const modal = document.createElement('div');
        modal.id = 'modalCadastroRapido';
        modal.className = 'modal-cadastro-rapido';
        modal.innerHTML = `
            <div class="modal-cadastro-content">
                <div class="modal-cadastro-header">
                    <h3>üöÄ Cadastro R√°pido de Fornecedor</h3>
                    <button class="modal-close" onclick="CadastroRapidoFornecedor.fecharModal()">√ó</button>
                </div>
                
                <div class="modal-cadastro-body">
                    <p style="color: #666; margin-bottom: 20px;">
                        Cadastre rapidamente um fornecedor com apenas 3 campos. 
                        O fornecedor receber√° acesso autom√°tico ao sistema.
                    </p>
                    
                    <form id="formCadastroRapido">
                        <div class="form-group">
                            <label>CNPJ <span class="required">*</span></label>
                            <input type="text" id="cnpjRapido" required 
                                   placeholder="00.000.000/0000-00"
                                   onblur="CadastroRapidoFornecedor.validarCNPJ(this)">
                            <div class="cnpj-status" id="cnpjStatus"></div>
                        </div>
                        
                        <div class="form-group">
                            <label>Raz√£o Social <span class="required">*</span></label>
                            <input type="text" id="razaoSocialRapido" required 
                                   placeholder="Nome da empresa">
                        </div>
                        
                        <div class="form-group">
                            <label>E-mail <span class="required">*</span></label>
                            <input type="email" id="emailRapido" required 
                                   placeholder="contato@empresa.com">
                            <div class="help-text">
                                O fornecedor usar√° este e-mail para fazer login
                            </div>
                        </div>
                        
                        <div class="form-actions">
                            <button type="button" class="btn btn-secondary" 
                                    onclick="CadastroRapidoFornecedor.fecharModal()">
                                Cancelar
                            </button>
                            <button type="submit" class="btn btn-primary">
                                ‚úÖ Cadastrar e Convidar
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Adicionar estilos
        this.injetarEstilos();
        
        // Adicionar evento de submit
        document.getElementById('formCadastroRapido').addEventListener('submit', (e) => {
            e.preventDefault();
            this.cadastrarFornecedor();
        });
    },
    
    // Injetar estilos
    injetarEstilos: function() {
        const style = document.createElement('style');
        style.textContent = `
            .modal-cadastro-rapido {
                display: none;
                position: fixed;
                z-index: 1000;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                animation: fadeIn 0.3s;
            }
            
            .modal-cadastro-rapido.ativo {
                display: flex;
                align-items: center;
                justify-content: center;
            }
            
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            
            .modal-cadastro-content {
                background: white;
                border-radius: 15px;
                width: 90%;
                max-width: 500px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.2);
                animation: slideUp 0.3s;
            }
            
            @keyframes slideUp {
                from {
                    transform: translateY(50px);
                    opacity: 0;
                }
                to {
                    transform: translateY(0);
                    opacity: 1;
                }
            }
            
            .modal-cadastro-header {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 20px;
                border-radius: 15px 15px 0 0;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            
            .modal-cadastro-header h3 {
                margin: 0;
                font-size: 20px;
            }
            
            .modal-close {
                background: none;
                border: none;
                color: white;
                font-size: 28px;
                cursor: pointer;
                width: 40px;
                height: 40px;
                display: flex;
                align-items: center;
                justify-content: center;
                border-radius: 50%;
                transition: background 0.3s;
            }
            
            .modal-close:hover {
                background: rgba(255,255,255,0.2);
            }
            
            .modal-cadastro-body {
                padding: 30px;
            }
            
            .form-group {
                margin-bottom: 20px;
            }
            
            .form-group label {
                display: block;
                margin-bottom: 5px;
                font-weight: 600;
                color: #2c3e50;
            }
            
            .form-group input {
                width: 100%;
                padding: 10px;
                border: 2px solid #e0e0e0;
                border-radius: 8px;
                font-size: 16px;
                transition: border-color 0.3s;
            }
            
            .form-group input:focus {
                outline: none;
                border-color: #667eea;
                box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            }
            
            .required {
                color: #dc3545;
            }
            
            .help-text {
                font-size: 12px;
                color: #6c757d;
                margin-top: 5px;
            }
            
            .cnpj-status {
                font-size: 12px;
                margin-top: 5px;
                display: none;
            }
            
            .cnpj-status.validando {
                display: block;
                color: #ffc107;
            }
            
            .cnpj-status.valido {
                display: block;
                color: #28a745;
            }
            
            .cnpj-status.invalido {
                display: block;
                color: #dc3545;
            }
            
            .form-actions {
                display: flex;
                gap: 10px;
                justify-content: flex-end;
                margin-top: 30px;
            }
            
            .btn {
                padding: 10px 20px;
                border: none;
                border-radius: 8px;
                font-size: 14px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s;
            }
            
            .btn-primary {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
            }
            
            .btn-primary:hover {
                transform: translateY(-2px);
                box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
            }
            
            .btn-secondary {
                background: #6c757d;
                color: white;
            }
            
            .btn-secondary:hover {
                background: #5a6268;
            }
            
            /* Lista de fornecedores simplificada */
            .lista-fornecedores-rapida {
                background: white;
                padding: 20px;
                border-radius: 10px;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
                margin-top: 20px;
            }
            
            .fornecedor-item-rapido {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 15px;
                border-bottom: 1px solid #e0e0e0;
            }
            
            .fornecedor-item-rapido:last-child {
                border-bottom: none;
            }
            
            .fornecedor-info {
                flex: 1;
            }
            
            .fornecedor-info h4 {
                margin: 0 0 5px 0;
                color: #2c3e50;
                font-size: 16px;
            }
            
            .fornecedor-info p {
                margin: 0;
                color: #6c757d;
                font-size: 14px;
            }
            
            .btn-convidar {
                background: #28a745;
                color: white;
                padding: 8px 16px;
                border: none;
                border-radius: 6px;
                cursor: pointer;
                font-size: 14px;
                transition: all 0.3s;
            }
            
            .btn-convidar:hover {
                background: #218838;
                transform: translateY(-2px);
            }
            
            .btn-convidar.convidado {
                background: #6c757d;
                cursor: not-allowed;
            }
        `;
        document.head.appendChild(style);
    },
    
    // Abrir modal
    abrirModal: function() {
        let modal = document.getElementById('modalCadastroRapido');
        
        if (!modal) {
            this.criarModal();
            modal = document.getElementById('modalCadastroRapido');
        }
        
        modal.classList.add('ativo');
        
        // Limpar formul√°rio
        document.getElementById('formCadastroRapido').reset();
        document.getElementById('cnpjStatus').className = 'cnpj-status';
    },
    
    // Fechar modal
    fecharModal: function() {
        const modal = document.getElementById('modalCadastroRapido');
        if (modal) {
            modal.classList.remove('ativo');
        }
    },
    
    // Validar CNPJ
    validarCNPJ: function(input) {
        const cnpj = input.value.replace(/[^\d]/g, '');
        const status = document.getElementById('cnpjStatus');
        
        if (cnpj.length !== 14) {
            status.className = 'cnpj-status invalido';
            status.textContent = '‚ùå CNPJ inv√°lido';
            return false;
        }
        
        // Valida√ß√£o simples do CNPJ
        status.className = 'cnpj-status validando';
        status.textContent = '‚è≥ Validando CNPJ...';
        
        // Simular valida√ß√£o (em produ√ß√£o, consultar API)
        setTimeout(() => {
            // Verificar se j√° existe
            const fornecedores = JSON.parse(localStorage.getItem('fornecedores_sistema') || '[]');
            const existe = fornecedores.some(f => f.cnpj === input.value);
            
            if (existe) {
                status.className = 'cnpj-status invalido';
                status.textContent = '‚ùå CNPJ j√° cadastrado';
            } else {
                status.className = 'cnpj-status valido';
                status.textContent = '‚úÖ CNPJ v√°lido';
                
                // Auto-preencher raz√£o social se poss√≠vel
                // Em produ√ß√£o, buscar da Receita Federal
            }
        }, 1000);
        
        return true;
    },
    
    // Cadastrar fornecedor
    cadastrarFornecedor: async function() {
        const cnpj = document.getElementById('cnpjRapido').value;
        const razaoSocial = document.getElementById('razaoSocialRapido').value;
        const email = document.getElementById('emailRapido').value;
        
        // Valida√ß√µes b√°sicas
        if (!cnpj || !razaoSocial || !email) {
            alert('Por favor, preencha todos os campos');
            return;
        }
        
        // Criar fornecedor
        const fornecedor = {
            id: 'forn_' + Date.now(),
            cnpj: cnpj,
            razaoSocial: razaoSocial,
            email: email,
            tipo: 'fornecedor',
            cadastroRapido: true,
            cadastroCompleto: false,
            ativo: true,
            dataCadastro: new Date().toISOString(),
            cadastradoPor: JSON.parse(sessionStorage.getItem('sessao_ativa')).usuarioId,
            // Senha tempor√°ria (em produ√ß√£o, gerar e enviar por email)
            senha: btoa('senha123'), // Tempor√°ria
            primeiroAcesso: true
        };
        
        // Salvar fornecedor
        const fornecedores = JSON.parse(localStorage.getItem('fornecedores_sistema') || '[]');
        fornecedores.push(fornecedor);
        localStorage.setItem('fornecedores_sistema', JSON.stringify(fornecedores));
        
        // Adicionar √† lista de usu√°rios
        const usuarios = JSON.parse(localStorage.getItem('usuarios_sistema') || '[]');
        usuarios.push({
            id: fornecedor.id,
            nome: fornecedor.razaoSocial,
            email: fornecedor.email,
            senha: fornecedor.senha,
            tipo: 'fornecedor',
            cnpj: fornecedor.cnpj,
            ativo: true,
            dataCriacao: fornecedor.dataCadastro
        });
        localStorage.setItem('usuarios_sistema', JSON.stringify(usuarios));
        
        // Notificar fornecedor via sistema
        SistemaNotificacoes.criarNotificacao(
            'info',
            fornecedor.id,
            'Bem-vindo ao Sistema!',
            'Seu cadastro foi criado. Complete seu perfil para participar de processos.',
            {
                texto: 'Completar Cadastro',
                link: '/completar-cadastro.html'
            }
        );
        
        // Fechar modal
        this.fecharModal();
        
        // Mostrar sucesso
        alert(`‚úÖ Fornecedor cadastrado com sucesso!\n\nCNPJ: ${cnpj}\nE-mail: ${email}\nSenha tempor√°ria: senha123`);
        
        // Atualizar lista se existir
        if (typeof carregarListaFornecedores === 'function') {
            carregarListaFornecedores();
        }
        
        // Se estiver no contexto de convidar para processo
        if (window.processoAtual) {
            this.convidarParaProcesso(fornecedor.id, window.processoAtual);
        }
        
        return fornecedor;
    },
    
    // Convidar para processo
    convidarParaProcesso: function(fornecedorId, processo) {
        // Registrar convite
        const convites = JSON.parse(localStorage.getItem('convites_processo') || '{}');
        if (!convites[processo.numero]) {
            convites[processo.numero] = [];
        }
        
        convites[processo.numero].push({
            fornecedorId: fornecedorId,
            dataConvite: new Date().toISOString(),
            status: 'pendente'
        });
        
        localStorage.setItem('convites_processo', JSON.stringify(convites));
        
        // Notificar fornecedor
        SistemaNotificacoes.notificarNovoProcesso(processo, [fornecedorId]);
    },
    
    // Criar interface de lista simplificada
    criarListaFornecedores: function(containerId, processo = null) {
        const container = document.getElementById(containerId);
        if (!container) return;
        
        const fornecedores = JSON.parse(localStorage.getItem('fornecedores_sistema') || '[]');
        
        // Cabe√ßalho com bot√£o de cadastro
        container.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h3>Fornecedores Cadastrados</h3>
                <button class="btn btn-primary" onclick="CadastroRapidoFornecedor.abrirModal()">
                    ‚ûï Cadastro R√°pido
                </button>
            </div>
            
            <div style="margin-bottom: 20px;">
                <input type="text" id="buscaFornecedor" placeholder="Buscar por CNPJ ou Raz√£o Social..." 
                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px;"
                       onkeyup="CadastroRapidoFornecedor.filtrarFornecedores()">
            </div>
            
            <div class="lista-fornecedores-rapida" id="listaFornecedoresRapida">
                ${fornecedores.map(f => this.renderizarFornecedor(f, processo)).join('')}
            </div>
        `;
        
        // Guardar processo atual se fornecido
        if (processo) {
            window.processoAtual = processo;
        }
    },
    
    // Renderizar item de fornecedor
    renderizarFornecedor: function(fornecedor, processo = null) {
        const jaConvidado = this.verificarSeConvidado(fornecedor.id, processo?.numero);
        
        return `
            <div class="fornecedor-item-rapido" data-cnpj="${fornecedor.cnpj}" data-razao="${fornecedor.razaoSocial}">
                <div class="fornecedor-info">
                    <h4>${fornecedor.razaoSocial}</h4>
                    <p>CNPJ: ${fornecedor.cnpj} | E-mail: ${fornecedor.email}</p>
                    ${fornecedor.cadastroRapido ? '<small style="color: #ffc107;">‚ö†Ô∏è Cadastro simplificado</small>' : ''}
                </div>
                ${processo ? `
                    <button class="btn-convidar ${jaConvidado ? 'convidado' : ''}" 
                            onclick="CadastroRapidoFornecedor.convidarParaProcesso('${fornecedor.id}', ${JSON.stringify(processo).replace(/"/g, '&quot;')})"
                            ${jaConvidado ? 'disabled' : ''}>
                        ${jaConvidado ? '‚úì Convidado' : 'Convidar'}
                    </button>
                ` : ''}
            </div>
        `;
    },
    
    // Verificar se j√° foi convidado
    verificarSeConvidado: function(fornecedorId, numeroProcesso) {
        if (!numeroProcesso) return false;
        
        const convites = JSON.parse(localStorage.getItem('convites_processo') || '{}');
        const convitesProcesso = convites[numeroProcesso] || [];
        
        return convitesProcesso.some(c => c.fornecedorId === fornecedorId);
    },
    
    // Filtrar fornecedores
    filtrarFornecedores: function() {
        const busca = document.getElementById('buscaFornecedor').value.toLowerCase();
        const items = document.querySelectorAll('.fornecedor-item-rapido');
        
        items.forEach(item => {
            const cnpj = item.dataset.cnpj.toLowerCase();
            const razao = item.dataset.razao.toLowerCase();
            
            if (cnpj.includes(busca) || razao.includes(busca)) {
                item.style.display = 'flex';
            } else {
                item.style.display = 'none';
            }
        });
    }
};

// Exportar para uso global
window.CadastroRapidoFornecedor = CadastroRapidoFornecedor;