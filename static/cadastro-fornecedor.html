<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Fornecedores - Sistema de Gestão</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .section-title {
            color: #2c3e50;
            font-size: 24px;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            background: white;
            padding: 10px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tab {
            padding: 12px 24px;
            background: #f8f9fa;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .content-area {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .form-section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .form-section.required {
            background: #e3f2fd;
            border-color: #2196f3;
        }

        .form-section.optional {
            background: #f8f9fa;
            border-color: #dee2e6;
        }

        .section-title-form {
            font-size: 18px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .badge-required {
            background: #dc3545;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: normal;
        }

        .badge-optional {
            background: #6c757d;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: normal;
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #2c3e50;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .required {
            color: #dc3545;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
            margin-right: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .fornecedor-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 15px;
            border-left: 4px solid #667eea;
            transition: all 0.3s;
        }

        .fornecedor-card:hover {
            transform: translateX(5px);
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-ativo {
            background: #d4edda;
            color: #155724;
        }

        .status-inativo {
            background: #f8d7da;
            color: #721c24;
        }

        .status-pendente {
            background: #fff3cd;
            color: #856404;
        }

        .credentials-box {
            background: #d4edda;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #28a745;
            margin-top: 20px;
            display: none;
        }

        .search-box {
            position: relative;
            margin-bottom: 20px;
        }

        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 20px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #6c757d;
        }

        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            width: 90%;
            max-width: 600px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            transform: scale(1.2);
        }

        .modal-body {
            padding: 30px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6c757d;
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .info-box {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            color: #856404;
        }

        .contabil-grid {
            display: grid;
            gap: 20px;
            margin-top: 15px;
        }

        .ano-section {
            background: white;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e0e0e0;
        }

        .ano-title {
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 16px;
        }

        .quick-save-info {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            border-left: 4px solid #2196f3;
        }

        .quick-save-info h4 {
            color: #1976d2;
            margin-bottom: 10px;
        }

        .completeness-indicator {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .completeness-bar {
            width: 100%;
            height: 20px;
            background: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin-top: 10px;
        }

        .completeness-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
        }
    </style>
    <script src="auth.js"></script>
</head>
<body>
    <div class="header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
                <h1>👥 Cadastro de Fornecedores</h1>
                <p>Gerencie fornecedores e envie credenciais de acesso</p>
            </div>
            <div id="infoUsuario" style="background: rgba(255,255,255,0.2); padding: 10px 20px; border-radius: 8px;"></div>
        </div>
    </div>

    <div class="container">
        <div class="section-header">
            <h2 class="section-title">Gerenciamento de Fornecedores</h2>
            <button class="btn btn-primary" onclick="voltarDashboard()">
                ← Voltar ao Dashboard
            </button>
        </div>

        <!-- Estatísticas -->
        <div class="stats-cards">
            <div class="stat-card">
                <div class="stat-number" id="totalFornecedores">0</div>
                <div class="stat-label">Total de Fornecedores</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="fornecedoresAtivos">0</div>
                <div class="stat-label">Fornecedores Ativos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="cadastrosCompletos">0</div>
                <div class="stat-label">Cadastros Completos</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="cadastrosHoje">0</div>
                <div class="stat-label">Cadastrados Hoje</div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab active" onclick="mostrarAba('cadastrar')">
                ➕ Cadastrar Fornecedor
            </button>
            <button class="tab" onclick="mostrarAba('listar')">
                📋 Lista de Fornecedores
            </button>
            <button class="tab" onclick="mostrarAba('pendentes')">
                ⏳ Cadastros Incompletos
            </button>
        </div>

        <!-- Conteúdo -->
        <div class="content-area">
            <!-- Aba Cadastrar -->
            <div id="aba-cadastrar" class="aba-content">
                <div class="quick-save-info">
                    <h4>⚡ Cadastro Rápido de Fornecedor</h4>
                    <p>Apenas 3 campos obrigatórios: <strong>CNPJ, Razão Social e E-mail</strong>. Os demais dados podem ser preenchidos posteriormente pelo próprio fornecedor ou em outra ocasião.</p>
                </div>

                <div class="completeness-indicator">
                    <h4>📊 Completude do Cadastro</h4>
                    <div class="completeness-bar">
                        <div class="completeness-fill" id="completenessBar" style="width: 0%;"></div>
                    </div>
                    <p style="margin-top: 10px; font-size: 14px; color: #6c757d;">
                        <span id="completenessText">0% completo</span>
                    </p>
                </div>
                
                <form id="formCadastroFornecedor" onsubmit="cadastrarFornecedor(event)">
                    <!-- Dados Obrigatórios -->
                    <div class="form-section required">
                        <h3 class="section-title-form">
                            🔴 Dados Obrigatórios
                            <span class="badge-required">OBRIGATÓRIO</span>
                        </h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>CNPJ <span class="required">*</span></label>
                                <input type="text" id="cnpj" required placeholder="00.000.000/0000-00" 
                                       onblur="buscarCNPJ(this.value)" maxlength="18">
                            </div>
                            
                            <div class="form-group">
                                <label>Razão Social <span class="required">*</span></label>
                                <input type="text" id="razaoSocial" required>
                            </div>
                            
                            <div class="form-group">
                                <label>E-mail <span class="required">*</span></label>
                                <input type="email" id="email" required placeholder="contato@empresa.com">
                            </div>
                        </div>
                    </div>

                    <!-- Dados Básicos Opcionais -->
                    <div class="form-section optional">
                        <h3 class="section-title-form">
                            📋 Dados Básicos
                            <span class="badge-optional">OPCIONAL</span>
                        </h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>Nome Fantasia</label>
                                <input type="text" id="nomeFantasia">
                            </div>
                            
                            <div class="form-group">
                                <label>Telefone</label>
                                <input type="tel" id="telefone" placeholder="(00) 00000-0000">
                            </div>
                            
                            <div class="form-group">
                                <label>Responsável</label>
                                <input type="text" id="responsavel">
                            </div>
                            
                            <div class="form-group">
                                <label>CPF do Responsável</label>
                                <input type="text" id="cpfResponsavel" placeholder="000.000.000-00">
                            </div>
                        </div>
                    </div>

                    <!-- Endereço Opcional -->
                    <div class="form-section optional">
                        <h3 class="section-title-form">
                            📍 Endereço
                            <span class="badge-optional">OPCIONAL</span>
                        </h3>
                        <div class="form-grid">
                            <div class="form-group">
                                <label>CEP</label>
                                <input type="text" id="cep" placeholder="00000-000" onblur="buscarCEP(this.value)">
                            </div>
                            
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <label>Endereço</label>
                                <input type="text" id="endereco">
                            </div>
                            
                            <div class="form-group">
                                <label>Cidade</label>
                                <input type="text" id="cidade">
                            </div>
                            
                            <div class="form-group">
                                <label>Estado</label>
                                <select id="estado">
                                    <option value="">Selecione...</option>
                                    <option value="AC">Acre</option>
                                    <option value="AL">Alagoas</option>
                                    <option value="AP">Amapá</option>
                                    <option value="AM">Amazonas</option>
                                    <option value="BA">Bahia</option>
                                    <option value="CE">Ceará</option>
                                    <option value="DF">Distrito Federal</option>
                                    <option value="ES">Espírito Santo</option>
                                    <option value="GO">Goiás</option>
                                    <option value="MA">Maranhão</option>
                                    <option value="MT">Mato Grosso</option>
                                    <option value="MS">Mato Grosso do Sul</option>
                                    <option value="MG">Minas Gerais</option>
                                    <option value="PA">Pará</option>
                                    <option value="PB">Paraíba</option>
                                    <option value="PR">Paraná</option>
                                    <option value="PE">Pernambuco</option>
                                    <option value="PI">Piauí</option>
                                    <option value="RJ">Rio de Janeiro</option>
                                    <option value="RN">Rio Grande do Norte</option>
                                    <option value="RS">Rio Grande do Sul</option>
                                    <option value="RO">Rondônia</option>
                                    <option value="RR">Roraima</option>
                                    <option value="SC">Santa Catarina</option>
                                    <option value="SP">São Paulo</option>
                                    <option value="SE">Sergipe</option>
                                    <option value="TO">Tocantins</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Dados Contábeis -->
                    <div class="form-section optional">
                        <h3 class="section-title-form">
                            💰 Dados Contábeis - Últimos 3 Anos
                            <span class="badge-optional">OPCIONAL</span>
                        </h3>
                        <div class="info-box">
                            <p>💡 Estas informações ajudam na avaliação da capacidade financeira do fornecedor. Todos os valores devem ser informados em R$ (reais).</p>
                        </div>
                        
                        <div class="contabil-grid">
                            <!-- Ano Atual - 2 -->
                            <div class="ano-section">
                                <h4 class="ano-title">📅 <span id="anoLabel1"></span></h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Faturamento Líquido (R$)</label>
                                        <input type="text" id="faturamento_ano1" placeholder="R$ 0,00" 
                                               onkeyup="formatarMoeda(this)">
                                    </div>
                                    <div class="form-group">
                                        <label>Lucro Líquido (R$)</label>
                                        <input type="text" id="lucro_ano1" placeholder="R$ 0,00" 
                                               onkeyup="formatarMoeda(this)">
                                    </div>
                                </div>
                            </div>

                            <!-- Ano Atual - 1 -->
                            <div class="ano-section">
                                <h4 class="ano-title">📅 <span id="anoLabel2"></span></h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Faturamento Líquido (R$)</label>
                                        <input type="text" id="faturamento_ano2" placeholder="R$ 0,00" 
                                               onkeyup="formatarMoeda(this)">
                                    </div>
                                    <div class="form-group">
                                        <label>Lucro Líquido (R$)</label>
                                        <input type="text" id="lucro_ano2" placeholder="R$ 0,00" 
                                               onkeyup="formatarMoeda(this)">
                                    </div>
                                </div>
                            </div>

                            <!-- Ano Atual -->
                            <div class="ano-section">
                                <h4 class="ano-title">📅 <span id="anoLabel3"></span> (Ano Atual/Projeção)</h4>
                                <div class="form-grid">
                                    <div class="form-group">
                                        <label>Faturamento Líquido (R$)</label>
                                        <input type="text" id="faturamento_ano3" placeholder="R$ 0,00" 
                                               onkeyup="formatarMoeda(this)">
                                    </div>
                                    <div class="form-group">
                                        <label>Lucro Líquido (R$)</label>
                                        <input type="text" id="lucro_ano3" placeholder="R$ 0,00" 
                                               onkeyup="formatarMoeda(this)">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px; display: flex; gap: 10px;">
                        <button type="submit" class="btn btn-success">
                            ✅ Cadastrar e Gerar Credenciais
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="limparFormulario()">
                            🔄 Limpar Formulário
                        </button>
                    </div>
                </form>
                
                <!-- Box de credenciais geradas -->
                <div id="credentialsBox" class="credentials-box">
                    <h4 style="color: #155724; margin-bottom: 15px;">✅ Fornecedor Cadastrado com Sucesso!</h4>
                    <p style="margin-bottom: 10px;">Credenciais de acesso geradas:</p>
                    <div style="background: white; padding: 15px; border-radius: 5px; margin-bottom: 15px;">
                        <p><strong>Usuário:</strong> <span id="usuarioGerado"></span></p>
                        <p><strong>Senha:</strong> <span id="senhaGerada"></span></p>
                    </div>
                    <div style="display: flex; gap: 10px;">
                        <button class="btn btn-primary" onclick="enviarCredenciais()">
                            📧 Enviar por E-mail
                        </button>
                        <button class="btn btn-secondary" onclick="copiarCredenciais()">
                            📋 Copiar Credenciais
                        </button>
                    </div>
                </div>
            </div>

            <!-- Aba Listar -->
            <div id="aba-listar" class="aba-content" style="display: none;">
                <div class="search-box">
                    <input type="text" placeholder="Buscar por CNPJ, razão social ou e-mail..." 
                           onkeyup="buscarFornecedores(this.value)">
                    <span class="search-icon">🔍</span>
                </div>
                
                <div id="listaFornecedores">
                    <!-- Lista será carregada dinamicamente -->
                </div>
            </div>

            <!-- Aba Pendentes -->
            <div id="aba-pendentes" class="aba-content" style="display: none;">
                <p style="color: #6c757d; margin-bottom: 20px;">
                    Fornecedores com cadastro incompleto (apenas dados obrigatórios preenchidos)
                </p>
                
                <div id="listaPendentes">
                    <!-- Lista será carregada dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Edição -->
    <div id="modalEdicao" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>✏️ Editar Fornecedor</h2>
                <span class="close" onclick="fecharModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Formulário será carregado aqui -->
            </div>
        </div>
    </div>

    <script>
        let usuarioAtual = null;
        let fornecedorAtual = null;

        window.addEventListener('DOMContentLoaded', function() {
            usuarioAtual = Auth.verificarAutenticacao(['comprador', 'admin']);
            if (usuarioAtual) {
                Auth.exibirInfoUsuario();
                carregarEstatisticas();
                carregarListaFornecedores();
                preencherAnosContabeis();
                monitorarCompletude();
            }
        });

        function preencherAnosContabeis() {
            const anoAtual = new Date().getFullYear();
            document.getElementById('anoLabel1').textContent = anoAtual - 2;
            document.getElementById('anoLabel2').textContent = anoAtual - 1;
            document.getElementById('anoLabel3').textContent = anoAtual;
        }

        function monitorarCompletude() {
            // Monitorar mudanças em todos os campos
            const form = document.getElementById('formCadastroFornecedor');
            const inputs = form.querySelectorAll('input, select');
            
            inputs.forEach(input => {
                input.addEventListener('input', calcularCompletude);
                input.addEventListener('change', calcularCompletude);
            });
            
            // Calcular completude inicial
            calcularCompletude();
        }

        function calcularCompletude() {
            const form = document.getElementById('formCadastroFornecedor');
            const totalCampos = form.querySelectorAll('input, select').length;
            const camposPreenchidos = Array.from(form.querySelectorAll('input, select'))
                .filter(campo => campo.value.trim() !== '').length;
            
            const porcentagem = Math.round((camposPreenchidos / totalCampos) * 100);
            
            document.getElementById('completenessBar').style.width = porcentagem + '%';
            document.getElementById('completenessText').textContent = `${porcentagem}% completo (${camposPreenchidos} de ${totalCampos} campos)`;
        }

        function mostrarAba(aba) {
            // Esconder todas as abas
            document.querySelectorAll('.aba-content').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
            
            // Mostrar aba selecionada
            document.getElementById(`aba-${aba}`).style.display = 'block';
            event.target.classList.add('active');
            
            // Carregar conteúdo específico
            if (aba === 'listar') {
                carregarListaFornecedores();
            } else if (aba === 'pendentes') {
                carregarListaPendentes();
            }
        }

        function carregarEstatisticas() {
            const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
            const fornecedores = usuarios.filter(u => u.tipo === 'fornecedor');
            const hoje = new Date().toDateString();
            
            // Contar cadastros completos (com dados além dos obrigatórios)
            const cadastrosCompletos = fornecedores.filter(f => {
                const dadosCompletos = f.telefone || f.endereco || f.cidade || 
                                     f.dadosContabeis || f.responsavel;
                return dadosCompletos;
            }).length;
            
            document.getElementById('totalFornecedores').textContent = fornecedores.length;
            document.getElementById('fornecedoresAtivos').textContent = 
                fornecedores.filter(f => f.ativo !== false).length;
            document.getElementById('cadastrosCompletos').textContent = cadastrosCompletos;
            document.getElementById('cadastrosHoje').textContent = 
                fornecedores.filter(f => new Date(f.dataCriacao).toDateString() === hoje).length;
        }

        function cadastrarFornecedor(event) {
            event.preventDefault();
            
            // Validar CNPJ único
            const cnpj = document.getElementById('cnpj').value;
            const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
            
            if (usuarios.some(u => u.cnpj === cnpj)) {
                alert('❌ CNPJ já cadastrado no sistema!');
                return;
            }
            
            // Gerar credenciais
            const usuario = cnpj.replace(/[^\d]/g, '').substring(0, 8);
            const senha = gerarSenhaAleatoria();
            
            // Preparar dados contábeis
            const anoAtual = new Date().getFullYear();
            const dadosContabeis = {
                [anoAtual - 2]: {
                    faturamento: document.getElementById('faturamento_ano1').value.replace(/[^\d,]/g, '').replace(',', '.'),
                    lucro: document.getElementById('lucro_ano1').value.replace(/[^\d,]/g, '').replace(',', '.')
                },
                [anoAtual - 1]: {
                    faturamento: document.getElementById('faturamento_ano2').value.replace(/[^\d,]/g, '').replace(',', '.'),
                    lucro: document.getElementById('lucro_ano2').value.replace(/[^\d,]/g, '').replace(',', '.')
                },
                [anoAtual]: {
                    faturamento: document.getElementById('faturamento_ano3').value.replace(/[^\d,]/g, '').replace(',', '.'),
                    lucro: document.getElementById('lucro_ano3').value.replace(/[^\d,]/g, '').replace(',', '.'),
                    projecao: true
                }
            };
            
            // Verificar se tem dados contábeis preenchidos
            const temDadosContabeis = Object.values(dadosContabeis).some(ano => 
                ano.faturamento || ano.lucro
            );
            
            // Criar objeto fornecedor
            const novoFornecedor = {
                usuarioId: 'forn_' + Date.now(),
                nome: document.getElementById('razaoSocial').value,
                email: document.getElementById('email').value,
                senha: btoa(senha), // Em produção, usar hash
                tipo: 'fornecedor',
                ativo: true,
                primeiroAcesso: true,
                dataCriacao: new Date().toISOString(),
                cadastradoPor: usuarioAtual.usuarioId,
                
                // Dados obrigatórios
                cnpj: cnpj,
                razaoSocial: document.getElementById('razaoSocial').value,
                
                // Dados opcionais
                nomeFantasia: document.getElementById('nomeFantasia').value || null,
                telefone: document.getElementById('telefone').value || null,
                endereco: document.getElementById('endereco').value || null,
                cidade: document.getElementById('cidade').value || null,
                estado: document.getElementById('estado').value || null,
                cep: document.getElementById('cep').value || null,
                responsavel: document.getElementById('responsavel').value || null,
                cpfResponsavel: document.getElementById('cpfResponsavel').value || null,
                
                // Dados contábeis (se preenchidos)
                dadosContabeis: temDadosContabeis ? dadosContabeis : null,
                
                // Controle de completude
                cadastroCompleto: calcularCadastroCompleto(),
                
                // Dados de acesso
                usuario: usuario
            };
            
            // Salvar fornecedor
            usuarios.push(novoFornecedor);
            localStorage.setItem('usuarios', JSON.stringify(usuarios));
            
            // Salvar dados adicionais da empresa
            const fornecedorData = {
                razaoSocial: novoFornecedor.razaoSocial,
                nomeFantasia: novoFornecedor.nomeFantasia,
                cnpj: novoFornecedor.cnpj,
                telefone: novoFornecedor.telefone,
                endereco: novoFornecedor.endereco,
                cidade: novoFornecedor.cidade,
                estado: novoFornecedor.estado,
                cep: novoFornecedor.cep,
                responsavel: novoFornecedor.responsavel,
                cpfResponsavel: novoFornecedor.cpfResponsavel,
                dadosContabeis: novoFornecedor.dadosContabeis
            };
            localStorage.setItem(`fornecedorData_${novoFornecedor.usuarioId}`, JSON.stringify(fornecedorData));
            
            // Mostrar credenciais
            document.getElementById('usuarioGerado').textContent = usuario;
            document.getElementById('senhaGerada').textContent = senha;
            document.getElementById('credentialsBox').style.display = 'block';
            
            // Guardar fornecedor atual para envio de e-mail
            fornecedorAtual = novoFornecedor;
            fornecedorAtual.senhaPlain = senha;
            
            // Criar notificação para o fornecedor
            Auth.Notificacoes.criar({
                tipo: 'cadastro_criado',
                titulo: '🎉 Bem-vindo ao Sistema!',
                mensagem: novoFornecedor.cadastroCompleto ? 
                    'Seu cadastro foi criado com sucesso. Acesse o sistema para participar de processos.' :
                    'Seu cadastro básico foi criado. Complete seu perfil para melhorar suas chances em processos.',
                destinatario: novoFornecedor.usuarioId,
                remetente: 'Sistema',
                metadata: {
                    primeiroAcesso: true,
                    cadastroCompleto: novoFornecedor.cadastroCompleto
                }
            });
            
            // Atualizar estatísticas
            carregarEstatisticas();
            
            // Limpar formulário
            document.getElementById('formCadastroFornecedor').reset();
            calcularCompletude();
            
            // Scroll para mostrar credenciais
            document.getElementById('credentialsBox').scrollIntoView({ behavior: 'smooth' });
        }

        function calcularCadastroCompleto() {
            // Considera completo se tiver pelo menos telefone e endereço além dos obrigatórios
            return !!(document.getElementById('telefone').value && 
                     document.getElementById('endereco').value);
        }

        function gerarSenhaAleatoria() {
            const caracteres = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789@#$%';
            let senha = '';
            for (let i = 0; i < 10; i++) {
                senha += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
            }
            return senha;
        }

        function enviarCredenciais() {
            if (!fornecedorAtual) return;
            
            // Simular envio de e-mail
            alert(`📧 E-mail enviado para ${fornecedorAtual.email} com as credenciais de acesso!\n\nUsuário: ${fornecedorAtual.usuario}\nSenha: ${fornecedorAtual.senhaPlain}`);
            
            // Registrar envio
            Auth.registrarLog(usuarioAtual.usuarioId, 'credenciais_enviadas', {
                fornecedor: fornecedorAtual.usuarioId,
                email: fornecedorAtual.email
            });
        }

        function copiarCredenciais() {
            const texto = `Credenciais de Acesso\n\nUsuário: ${document.getElementById('usuarioGerado').textContent}\nSenha: ${document.getElementById('senhaGerada').textContent}`;
            
            navigator.clipboard.writeText(texto).then(() => {
                alert('✅ Credenciais copiadas para a área de transferência!');
            });
        }

        function buscarCNPJ(cnpj) {
            // Formatar CNPJ
            cnpj = cnpj.replace(/[^\d]/g, '');
            
            if (cnpj.length === 14) {
                // Em produção, buscar dados na API da Receita Federal
                // Aqui apenas formatamos
                const cnpjFormatado = cnpj.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
                document.getElementById('cnpj').value = cnpjFormatado;
            }
        }

        function buscarCEP(cep) {
            cep = cep.replace(/[^\d]/g, '');
            
            if (cep.length === 8) {
                // Buscar CEP na API ViaCEP
                fetch(`https://viacep.com.br/ws/${cep}/json/`)
                    .then(response => response.json())
                    .then(data => {
                        if (!data.erro) {
                            document.getElementById('endereco').value = `${data.logradouro}, ${data.bairro}`;
                            document.getElementById('cidade').value = data.localidade;
                            document.getElementById('estado').value = data.uf;
                            calcularCompletude();
                        }
                    })
                    .catch(error => console.error('Erro ao buscar CEP:', error));
            }
        }

        function carregarListaFornecedores() {
            const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
            const fornecedores = usuarios.filter(u => u.tipo === 'fornecedor');
            const container = document.getElementById('listaFornecedores');
            
            if (fornecedores.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📋</div>
                        <h3>Nenhum fornecedor cadastrado</h3>
                        <p>Comece cadastrando o primeiro fornecedor</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = fornecedores.map(f => {
                const statusClass = f.ativo === false ? 'status-inativo' : 
                                  f.primeiroAcesso ? 'status-pendente' : 'status-ativo';
                const statusTexto = f.ativo === false ? 'Inativo' : 
                                  f.primeiroAcesso ? 'Primeiro Acesso' : 'Ativo';
                
                // Indicador de completude
                const completudeTexto = f.cadastroCompleto ? 
                    '<span style="color: #28a745;">✅ Cadastro Completo</span>' : 
                    '<span style="color: #ffc107;">⚠️ Cadastro Básico</span>';
                
                return `
                    <div class="fornecedor-card">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4 style="color: #2c3e50; margin-bottom: 10px;">${f.razaoSocial || f.nome}</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; color: #6c757d; font-size: 14px;">
                                    <div><strong>CNPJ:</strong> ${f.cnpj || 'Não informado'}</div>
                                    <div><strong>E-mail:</strong> ${f.email}</div>
                                    <div><strong>Telefone:</strong> ${f.telefone || 'Não informado'}</div>
                                    <div><strong>Usuário:</strong> ${f.usuario || f.email}</div>
                                </div>
                                <div style="margin-top: 10px;">
                                    ${completudeTexto}
                                    ${f.dadosContabeis ? ' | <span style="color: #17a2b8;">💰 Dados Contábeis</span>' : ''}
                                </div>
                            </div>
                            <span class="status-badge ${statusClass}">${statusTexto}</span>
                        </div>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="editarFornecedor('${f.usuarioId}')">
                                ✏️ Completar Cadastro
                            </button>
                            <button class="btn btn-success" onclick="reenviarCredenciais('${f.usuarioId}')">
                                📧 Reenviar Credenciais
                            </button>
                            <button class="btn btn-secondary" onclick="toggleStatus('${f.usuarioId}')">
                                ${f.ativo === false ? '✅ Ativar' : '🚫 Desativar'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function carregarListaPendentes() {
            const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
            const pendentes = usuarios.filter(u => u.tipo === 'fornecedor' && !u.cadastroCompleto);
            const container = document.getElementById('listaPendentes');
            
            if (pendentes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">✅</div>
                        <h3>Nenhum cadastro incompleto</h3>
                        <p>Todos os fornecedores têm cadastro completo</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = pendentes.map(f => {
                const diasCadastro = Math.floor((new Date() - new Date(f.dataCriacao)) / (1000 * 60 * 60 * 24));
                
                // Listar campos faltantes
                const camposFaltantes = [];
                if (!f.telefone) camposFaltantes.push('Telefone');
                if (!f.endereco) camposFaltantes.push('Endereço');
                if (!f.responsavel) camposFaltantes.push('Responsável');
                if (!f.dadosContabeis) camposFaltantes.push('Dados Contábeis');
                
                return `
                    <div class="fornecedor-card">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4 style="color: #2c3e50; margin-bottom: 10px;">${f.razaoSocial || f.nome}</h4>
                                <p style="color: #6c757d; font-size: 14px;">
                                    <strong>E-mail:</strong> ${f.email} | 
                                    <strong>CNPJ:</strong> ${f.cnpj} |
                                    <strong>Cadastrado há:</strong> ${diasCadastro} dias
                                </p>
                                <p style="color: #dc3545; font-size: 14px; margin-top: 10px;">
                                    <strong>Campos faltantes:</strong> ${camposFaltantes.join(', ')}
                                </p>
                            </div>
                            <span class="status-badge status-pendente">Cadastro Incompleto</span>
                        </div>
                        <div style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="editarFornecedor('${f.usuarioId}')">
                                ✏️ Completar Cadastro
                            </button>
                            <button class="btn btn-secondary" onclick="reenviarCredenciais('${f.usuarioId}')">
                                📧 Reenviar Credenciais
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function buscarFornecedores(termo) {
            if (termo.length < 3 && termo.length > 0) return;
            
            const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
            const fornecedores = usuarios.filter(u => u.tipo === 'fornecedor');
            
            const filtrados = fornecedores.filter(f => {
                const busca = termo.toLowerCase();
                return (f.cnpj && f.cnpj.includes(busca)) ||
                       (f.razaoSocial && f.razaoSocial.toLowerCase().includes(busca)) ||
                       (f.nome && f.nome.toLowerCase().includes(busca)) ||
                       (f.email && f.email.toLowerCase().includes(busca));
            });
            
            const container = document.getElementById('listaFornecedores');
            
            if (filtrados.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #6c757d;">Nenhum fornecedor encontrado</p>';
                return;
            }
            
            // Reutilizar a função de carregar lista com os resultados filtrados
            container.innerHTML = filtrados.map(f => {
                const statusClass = f.ativo === false ? 'status-inativo' : 
                                  f.primeiroAcesso ? 'status-pendente' : 'status-ativo';
                const statusTexto = f.ativo === false ? 'Inativo' : 
                                  f.primeiroAcesso ? 'Primeiro Acesso' : 'Ativo';
                
                const completudeTexto = f.cadastroCompleto ? 
                    '<span style="color: #28a745;">✅ Cadastro Completo</span>' : 
                    '<span style="color: #ffc107;">⚠️ Cadastro Básico</span>';
                
                return `
                    <div class="fornecedor-card">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <h4 style="color: #2c3e50; margin-bottom: 10px;">${f.razaoSocial || f.nome}</h4>
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px; color: #6c757d; font-size: 14px;">
                                    <div><strong>CNPJ:</strong> ${f.cnpj || 'Não informado'}</div>
                                    <div><strong>E-mail:</strong> ${f.email}</div>
                                    <div><strong>Telefone:</strong> ${f.telefone || 'Não informado'}</div>
                                    <div><strong>Usuário:</strong> ${f.usuario || f.email}</div>
                                </div>
                                <div style="margin-top: 10px;">
                                    ${completudeTexto}
                                    ${f.dadosContabeis ? ' | <span style="color: #17a2b8;">💰 Dados Contábeis</span>' : ''}
                                </div>
                            </div>
                            <span class="status-badge ${statusClass}">${statusTexto}</span>
                        </div>
                        <div style="margin-top: 15px; display: flex; gap: 10px;">
                            <button class="btn btn-primary" onclick="editarFornecedor('${f.usuarioId}')">
                                ✏️ Completar Cadastro
                            </button>
                            <button class="btn btn-success" onclick="reenviarCredenciais('${f.usuarioId}')">
                                📧 Reenviar Credenciais
                            </button>
                            <button class="btn btn-secondary" onclick="toggleStatus('${f.usuarioId}')">
                                ${f.ativo === false ? '✅ Ativar' : '🚫 Desativar'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function editarFornecedor(usuarioId) {
            alert('Função de edição/completar cadastro será implementada em breve!');
        }

        function reenviarCredenciais(usuarioId) {
            const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
            const fornecedor = usuarios.find(u => u.usuarioId === usuarioId);
            
            if (!fornecedor) return;
            
            // Gerar nova senha
            const novaSenha = gerarSenhaAleatoria();
            fornecedor.senha = btoa(novaSenha);
            fornecedor.senhaAlterada = new Date().toISOString();
            
            // Salvar
            localStorage.setItem('usuarios', JSON.stringify(usuarios));
            
            alert(`📧 Novas credenciais enviadas para ${fornecedor.email}!\n\nUsuário: ${fornecedor.usuario || fornecedor.email}\nNova senha: ${novaSenha}`);
            
            // Criar notificação
            Auth.Notificacoes.criar({
                tipo: 'credenciais_alteradas',
                titulo: '🔐 Credenciais Alteradas',
                mensagem: 'Suas credenciais de acesso foram alteradas. Verifique seu e-mail.',
                destinatario: usuarioId,
                remetente: usuarioAtual.nome
            });
        }

        function toggleStatus(usuarioId) {
            const usuarios = JSON.parse(localStorage.getItem('usuarios') || '[]');
            const fornecedor = usuarios.find(u => u.usuarioId === usuarioId);
            
            if (!fornecedor) return;
            
            fornecedor.ativo = !fornecedor.ativo;
            fornecedor.statusAlterado = new Date().toISOString();
            fornecedor.statusAlteradoPor = usuarioAtual.usuarioId;
            
            localStorage.setItem('usuarios', JSON.stringify(usuarios));
            
            alert(`✅ Fornecedor ${fornecedor.ativo ? 'ativado' : 'desativado'} com sucesso!`);
            
            carregarListaFornecedores();
            carregarEstatisticas();
        }

        function limparFormulario() {
            document.getElementById('formCadastroFornecedor').reset();
            document.getElementById('credentialsBox').style.display = 'none';
            calcularCompletude();
        }

        function voltarDashboard() {
            window.location.href = 'dashboard-comprador.html';
        }

        function fecharModal() {
            document.getElementById('modalEdicao').style.display = 'none';
        }

        function formatarMoeda(input) {
            let valor = input.value.replace(/\D/g, '');
            valor = (valor / 100).toFixed(2);
            valor = valor.replace('.', ',');
            valor = valor.replace(/(\d)(?=(\d{3})+(?!\d))/g, '$1.');
            input.value = 'R$ ' + valor;
        }

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // Máscaras de input
        document.getElementById('cnpj').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^\d]/g, '');
            if (value.length <= 14) {
                value = value.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
                e.target.value = value;
            }
        });

        document.getElementById('telefone').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^\d]/g, '');
            if (value.length <= 11) {
                value = value.replace(/^(\d{2})(\d{5})(\d{4})$/, '($1) $2-$3');
                e.target.value = value;
            }
        });

        document.getElementById('cep').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^\d]/g, '');
            if (value.length <= 8) {
                value = value.replace(/^(\d{5})(\d{3})$/, '$1-$2');
                e.target.value = value;
            }
        });

        document.getElementById('cpfResponsavel').addEventListener('input', function(e) {
            let value = e.target.value.replace(/[^\d]/g, '');
            if (value.length <= 11) {
                value = value.replace(/^(\d{3})(\d{3})(\d{3})(\d{2})$/, '$1.$2.$3-$4');
                e.target.value = value;
            }
        });
    </script>
</body>
</html>
