<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal de Propostas â€” Acesso</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <style>
    :root {
      --bg1: #6a88ff;
      --bg2: #7c4dff;
      --card: #ffffff;
      --text: #1f2330;
      --muted: #6b7280;
      --primary: #5a67d8;
      --primary-2: #7f56d9;
      --danger: #ef4444;
      --success: #10b981;
      --radius: 14px;
      --shadow: 0 20px 50px rgba(31, 35, 48, 0.12);
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      color: var(--text);
      background: linear-gradient(135deg, var(--bg1), var(--bg2)) fixed;
    }
    .wrap {
      min-height: 100%;
      display: grid;
      place-items: center;
      padding: 32px 16px;
    }
    .card {
      width: 100%;
      max-width: 520px;
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 28px 28px 22px;
    }
    .brand {
      display: flex; align-items: center; gap: 10px; margin-bottom: 6px;
      font-weight: 700; font-size: 20px;
    }
    .badge {
      display:inline-flex; align-items:center; justify-content:center;
      width:36px; height:36px; border-radius: 10px; background: #eef2ff; color:#5145cd;
      font-weight:700;
    }
    h1 {
      font-size: 22px; margin: 8px 0 4px; line-height: 1.25;
    }
    p.subtitle {
      margin: 0 0 18px; color: var(--muted); font-size: 14px;
    }
    label {
      display:block; margin: 14px 0 6px; font-weight: 600; font-size: 14px;
    }
    input[type="email"], input[type="password"] {
      width: 100%; padding: 12px 14px; border: 1px solid #e5e7eb; border-radius: 10px;
      font-size: 16px; outline: none; transition: border .16s ease;
    }
    input:focus { border-color: #a78bfa; box-shadow: 0 0 0 3px rgba(167,139,250,.15); }
    .row {
      display: flex; align-items: center; gap: 10px;
    }
    .btn {
      width: 100%; margin-top: 16px; padding: 13px 16px; font-weight: 700;
      background: linear-gradient(135deg, #6d7cff, #7f56d9);
      border: none; color: #fff; border-radius: 12px; cursor: pointer;
      display: inline-flex; align-items: center; justify-content: center; gap: 10px;
    }
    .btn.loading { opacity: .7; cursor: progress; }
    .btn .spinner {
      display: none; width: 16px; height: 16px; border-radius: 50%;
      border: 2px solid rgba(255,255,255,.5); border-top-color: #fff; animation: spin .8s linear infinite;
    }
    .btn.loading .spinner { display: inline-block; }
    @keyframes spin { to { transform: rotate(360deg); } }

    .alert {
      display: none; margin-top: 14px; padding: 10px 12px; border-radius: 10px; font-size: 14px;
    }
    .alert.error   { background: #fee2e2; color: #b91c1c; }
    .alert.success { background: #dcfce7; color: #065f46; }
    .alert.info    { background: #e0e7ff; color: #3730a3; }

    .status {
      margin-top: 18px; font-size: 13px; color: var(--muted); display:flex; align-items:center; gap:8px;
    }
    .dot { width:8px; height:8px; border-radius:50%; background: var(--success); display:inline-block; }
    .foot {
      margin-top: 12px; font-size: 12px; color: var(--muted); text-align:center;
    }
    .toggle {
      cursor:pointer; user-select:none; font-size: 12px; color: #4b5563;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <main class="card" role="main" aria-labelledby="titulo">
      <div class="brand"><span class="badge">ðŸ”’</span>Portal de Propostas</div>
      <h1 id="titulo">Acesso ao Sistema</h1>
      <p class="subtitle">Entre com suas credenciais para continuar.</p>

      <!-- Mensagens -->
      <div id="errorMessage"   class="alert error"   role="alert"></div>
      <div id="successMessage" class="alert success" role="status"></div>
      <div id="infoMessage"    class="alert info"    role="status"></div>

      <!-- FormulÃ¡rio -->
      <form id="formLogin" novalidate>
        <label for="email">Eâ€‘mail</label>
        <input id="email" name="email" type="email" autocomplete="email" placeholder="seu@email.com" required />

        <label for="senha">Senha</label>
        <div class="row">
          <input id="senha" name="senha" type="password" autocomplete="current-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required />
          <span id="togglePwd" class="toggle" title="Mostrar/ocultar senha">mostrar</span>
        </div>

        <button id="btnLogin" type="submit" class="btn">
          <span class="spinner" aria-hidden="true"></span>
          Entrar no Sistema
        </button>
      </form>

      <div class="status">
        <span class="dot" aria-hidden="true"></span> Sistema operacional
      </div>
      <div class="foot">Ambiente: ProduÃ§Ã£o â€¢ AtualizaÃ§Ãµes em tempo real</div>
    </main>
  </div>

  <!-- Config do Firebase (do SEU projeto). Pode ficar pÃºblico; seguranÃ§a vem das Rules. -->
  <script>
    window.firebaseConfig = {
      apiKey: "AIzaSyCgF366Ft7RkZHYaZb77HboNO3BPbmCjT8",
      authDomain: "portal-de-proposta.firebaseapp.com",
      projectId: "portal-de-proposta",
      storageBucket: "portal-de-proposta.firebasestorage.app",
      messagingSenderId: "321036073908",
      appId: "1:321036073908:web:3149b9ea2cb77a704890e1",
      measurementId: "G-CFFVQGM3EC"
    };
  </script>

  <!-- Login e verificaÃ§Ã£o de perfil (Firebase CDN Modules) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // ===== UtilitÃ¡rios de UI =====
    const btnLogin = document.getElementById('btnLogin');
    const errorEl  = document.getElementById('errorMessage');
    const okEl     = document.getElementById('successMessage');
    const infoEl   = document.getElementById('infoMessage');
    const emailI   = document.getElementById('email');
    const passI    = document.getElementById('senha');
    const toggle   = document.getElementById('togglePwd');

    function setLoading(loading) {
      if (!btnLogin) return;
      btnLogin.disabled = loading;
      btnLogin.classList.toggle('loading', loading);
    }
    function show(el, msg, ms=4000) {
      if (!el) return;
      el.textContent = msg;
      el.style.display = 'block';
      if (ms) setTimeout(() => el.style.display = 'none', ms);
    }
    function hideAll() { [errorEl, okEl, infoEl].forEach(e => e && (e.style.display='none')); }

    toggle?.addEventListener('click', () => {
      passI.type = passI.type === 'password' ? 'text' : 'password';
      toggle.textContent = passI.type === 'password' ? 'mostrar' : 'ocultar';
    });

    // ===== Firebase Auth =====
    const app = initializeApp(window.firebaseConfig);
    const auth = getAuth(app);

    async function verifyAndRedirect(user) {
      // ObtÃ©m ID Token do Firebase e verifica no backend
      const idToken = await user.getIdToken();
      const resp = await fetch('/auth/verify', {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify({ token: idToken })
      });
      const data = await resp.json();

      if (!resp.ok) {
        throw new Error(data?.erro || 'Falha ao verificar token no servidor');
      }

      const perfil = (data?.perfil || '').toLowerCase();
      const map = {
        admin:        '/static/admin-usuarios.html',
        requisitante: '/static/dashboard-requisitante-funcional.html',
        comprador:    '/static/dashboard-comprador-funcional.html',
        fornecedor:   '/static/dashboard-fornecedor-funcional.html'
      };

      if (map[perfil]) {
        show(okEl, 'Login realizado. Redirecionandoâ€¦', 1200);
        setTimeout(() => window.location.href = map[perfil], 800);
      } else {
        show(infoEl, 'UsuÃ¡rio sem perfil definido. Contate o administrador.');
      }
    }

    // SubmissÃ£o do formulÃ¡rio
    document.getElementById('formLogin')?.addEventListener('submit', async (e) => {
      e.preventDefault();
      hideAll();
      setLoading(true);
      try {
        const email = emailI.value.trim();
        const senha = passI.value;
        if (!email || !senha) throw new Error('Informe e-mail e senha.');

        const { user } = await signInWithEmailAndPassword(auth, email, senha);
        await verifyAndRedirect(user);
      } catch (err) {
        console.error(err);
        const msg = (err?.message || '').toLowerCase().includes('password') ? 'E-mail ou senha invÃ¡lidos.' :
                    err?.message || 'Falha no login';
        show(errorEl, msg);
      } finally {
        setLoading(false);
      }
    });

    // Se jÃ¡ estiver logado, verifica e redireciona
    onAuthStateChanged(auth, (user) => { if (user) verifyAndRedirect(user).catch(console.error); });
  </script>
</body>
</html>
