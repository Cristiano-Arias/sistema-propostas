<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cadastro de Usuários</title>
  <style>
    :root{--bg1:#0f2027;--bg2:#203a43;--bg3:#2c5364;--card:rgba(255,255,255,.06);--b:rgba(255,255,255,.12);--txt:#F4F6F8;--muted:#c8d0d8;}
    *{box-sizing:border-box}html,body{height:100%}body{margin:0;font-family:Inter,Segoe UI,Arial,sans-serif;color:var(--txt);
      background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3)) fixed;display:flex;align-items:center;justify-content:center;padding:24px}
    .wrap{width:100%;max-width:960px}
    .card{background:var(--card);border:1px solid var(--b);backdrop-filter:blur(8px);border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.25);overflow:hidden}
    .hd{padding:18px 22px;border-bottom:1px solid var(--b);display:flex;gap:12px;align-items:center}
    .hd h1{font-size:18px;margin:0}
    .badge{font-size:12px;border:1px solid var(--b);padding:4px 8px;border-radius:999px;color:var(--muted)}
    .bd{padding:22px}
    .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:16px}
    .full{grid-column:1/-1}
    label{display:block;font-size:13px;color:var(--muted);margin:0 0 6px}
    input,select{width:100%;padding:12px 12px;border-radius:12px;border:1px solid var(--b);background:rgba(0,0,0,.15);color:var(--txt)}
    .actions{display:flex;gap:12px;justify-content:flex-end;margin-top:18px}
    button{padding:12px 18px;border-radius:12px;border:1px solid var(--b);background:#179E7A;color:white;font-weight:600;cursor:pointer}
    .msg{margin-top:10px;font-size:13px}
    .ok{color:#6ae0a7}.err{color:#ffb3b3}
    @media(max-width:720px){.grid{grid-template-columns:1fr}}
    small{color:var(--muted)}
  </style>
  <script>
    (function () {
      const t = localStorage.getItem('access_token') || localStorage.getItem('token');
      const p = localStorage.getItem('perfil');
      if (!t || !['comprador','admin'].includes(p)) {
        localStorage.setItem('login_error','Acesso restrito: faça login como Comprador/Admin.');
        window.location.href = '/login-unificado.html';
      }
    })();
    function onlyDigits(s){return (s||'').replace(/\D+/g,'');}
    function validarCnpjLocal(c){
      c = onlyDigits(c);
      if(!/^\d{14}$/.test(c) || /^(\d)\1{13}$/.test(c)) return false;
      const calc = (base, pesos) => {
        let s=0; for(let i=0;i<pesos.length;i++) s += (+base[i])*pesos[i];
        const r = s % 11; return (r<2)?0:11-r;
      };
      const p1=[5,4,3,2,9,8,7,6,5,4,3,2], p2=[6,...p1];
      const dv1 = calc(c.slice(0,12), p1);
      const dv2 = calc(c.slice(0,12)+dv1, p2);
      return c.endsWith(String(dv1)+String(dv2));
    }
    async function cadastrarUsuario(evt){
      evt.preventDefault();
      const token = localStorage.getItem('access_token') || localStorage.getItem('token');
      const perfil = document.getElementById('perfil').value;
      const body = {
        nome:  document.getElementById('nome').value.trim(),
        email: document.getElementById('email').value.trim(),
        senha: document.getElementById('senha').value,
        perfil: perfil
      };
      if(perfil === 'fornecedor'){
        const cnpj = document.getElementById('cnpj').value;
        if(!validarCnpjLocal(cnpj)){ setMsg('CNPJ inválido.', true); return; }
        body.cnpj = onlyDigits(cnpj);
      }
      try{
        const res = await fetch('/api/usuarios', {
          method:'POST',
          headers:{'Content-Type':'application/json', 'Authorization':'Bearer '+token},
          body: JSON.stringify(body)
        });
        const data = await res.json().catch(()=>({}));
        if(res.status === 201){ setMsg('Usuário criado com sucesso.', false); document.getElementById('form').reset(); toggleCnpj(); }
        else if(res.status === 409){ setMsg(data.erro || 'Conflito: e-mail ou CNPJ já cadastrado.', true); }
        else if(res.status === 401 || res.status === 403){ setMsg('Acesso negado. Refaça login como Comprador/Admin.', true); }
        else { setMsg(data.erro || 'Falha ao criar usuário.', true); }
      }catch(e){ setMsg('Erro de rede. Tente novamente.', true); }
    }
    function setMsg(t,err){ const m=document.getElementById('msg'); m.textContent=t; m.className='msg '+(err?'err':'ok'); }
    function toggleCnpj(){ const sel=document.getElementById('perfil').value;
      document.getElementById('grupo-cnpj').style.display=(sel==='fornecedor')?'grid':'none'; }
    document.addEventListener('DOMContentLoaded',()=>toggleCnpj());
  </script>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="hd"><span class="badge">Admin</span><h1>Cadastro de Usuários</h1></div>
      <div class="bd">
        <form id="form" onsubmit="cadastrarUsuario(event)">
          <div class="grid">
            <div class="full">
              <label>Perfil</label>
              <select id="perfil" onchange="toggleCnpj()">
                <option value="comprador">Comprador</option>
                <option value="requisitante">Requisitante</option>
                <option value="fornecedor">Fornecedor</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <div>
              <label>Nome</label>
              <input id="nome" required placeholder="Nome completo">
            </div>
            <div>
              <label>E-mail / Usuário</label>
              <input id="email" required placeholder="email@empresa.com ou fornecedor_00000000000100">
            </div>
            <div class="full">
              <label>Senha provisória</label>
              <input id="senha" type="password" required minlength="6" placeholder="Mínimo 6 caracteres">
            </div>
          </div>
          <div class="grid full" id="grupo-cnpj" style="display:none; margin-top:8px">
            <div class="full">
              <label>CNPJ (somente para fornecedor)</label>
              <input id="cnpj" placeholder="00.000.000/0001-00" maxlength="18">
              <small>Obrigatório para perfil Fornecedor. Unicidade garantida no servidor.</small>
            </div>
          </div>
          <div class="actions">
            <button type="button" onclick="history.back()">Voltar</button>
            <button type="submit">Cadastrar</button>
          </div>
          <div id="msg" class="msg"></div>
        </form>
      </div>
    </div>
  </div>
</body>
</html>
