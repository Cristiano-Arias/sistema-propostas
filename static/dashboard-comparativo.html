<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparativo de Propostas - Baseado no Portal Real</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
        font-family: 'Segoe UI', Arial, sans-serif;
        color: var(--text-primary);
        line-height: 1.6;
        margin: 0;
        padding: 0;
    }
    
    .comparativo-wrapper {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
    }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .page-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Process Selector */
        .process-selector {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }

        .process-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s ease;
        }

        .process-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Analysis Tabs */
        .analysis-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 8px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            gap: 8px;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-button.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .tab-button:not(.active):hover {
            background: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
        }

        /* Azure IA Insights */
        .ai-insights {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        .ai-insights::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .ai-icon {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .ai-content {
            position: relative;
            z-index: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .ai-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .ai-card-title {
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }

        /* Comparison Container */
        .comparison-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 25px;
        }

        .comparison-header {
            padding: 20px 25px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }

        .comparison-title {
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
        }

        .export-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--light-bg);
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: white;
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            background: white;
        }

        .comparison-table th {
            background: linear-gradient(135deg, var(--primary-color), #2980b9);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
        }

        .comparison-table th:first-child {
            width: 200px;
            min-width: 200px;
            background: linear-gradient(135deg, #2c3e50, #34495e);
        }

        .comparison-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            vertical-align: top;
        }

        .comparison-table tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }

        .item-label {
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            text-align: center;
        }

        .proposal-cell {
            min-width: 250px;
            position: relative;
        }

        .company-header {
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
            color: white;
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
            padding: 18px 12px;
        }

        /* Value Formatting */
        .value-monetary {
            font-weight: 700;
            color: var(--success-color);
            font-size: 1.1em;
        }

        .value-quantity {
            font-weight: 600;
            color: var(--primary-color);
        }

        .value-percentage {
            font-weight: 600;
            color: var(--warning-color);
        }

        .value-text {
            color: var(--text-primary);
        }

        .value-total {
            font-weight: 700;
            color: var(--danger-color);
            font-size: 1.2em;
            background: rgba(231, 76, 60, 0.1);
            padding: 5px 8px;
            border-radius: 5px;
        }

        /* Section Headers */
        .section-header {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            padding: 15px 20px;
            font-weight: 700;
            font-size: 1.1rem;
            text-align: center;
            margin: 0;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .container {
                padding: 15px;
            }
            
            .comparison-table th:first-child {
                width: 180px;
                min-width: 180px;
            }
            
            .proposal-cell {
                min-width: 220px;
            }
        }

        @media (max-width: 768px) {
            .analysis-tabs {
                flex-direction: column;
                gap: 8px;
            }

            .comparison-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .export-buttons {
                justify-content: center;
            }

            .comparison-table th:first-child {
                width: 150px;
                min-width: 150px;
            }

            .proposal-cell {
                min-width: 200px;
            }

            .ai-content {
                grid-template-columns: 1fr;
            }
        }

        /* Loading States */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Voltar Button */
        .btn-voltar {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 10px;
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .btn-voltar:hover {
            transform: translateX(-5px);
            background: white;
        }

        /* Print Styles */
        @media print {
            .export-buttons,
            .analysis-tabs,
            .ai-insights,
            .btn-voltar {
                display: none !important;
            }
        
            /* Estilos adicionais para impress√£o do relat√≥rio */
            .modal-overlay {
                position: static !important;
                background: white !important;
            }
            
            .modal-content {
                box-shadow: none !important;
                max-width: 100% !important;
            }
            
            table {
                page-break-inside: avoid;
            }

    /* Resumo do parecer do requisitante */
    .parecer-resumo {
        background: #fff;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 15px;
        box-shadow: var(--shadow);
    }
    .parecer-resumo table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }
    .parecer-resumo th {
        background: var(--primary-color);
        color: white;
        padding: 10px;
        text-align: left;
    }
    .parecer-resumo td {
        padding: 8px 10px;
        border-bottom: 1px solid var(--border-color);
    }
        }
        
            .comparison-container {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }
        
            body {
                background: white !important;
            }
        }
    </style>
</head>
<body>
    <div class="comparativo-wrapper">
        <!-- Bot√£o Voltar -->
        <a href="dashboard-comprador-funcional.html" class="btn-voltar">
        <i class="fas fa-arrow-left"></i> Voltar ao Dashboard
    </a>

    <div class="container">
        <div class="header">
            <h1 class="page-title">üìä Comparativo de Propostas</h1>
            <p class="page-subtitle">An√°lise detalhada baseada nas tabelas reais do portal de propostas</p>
        </div>

        <!-- Process Selector -->
        <div class="process-selector">
            <select class="process-select" id="processSelect">
                <option value="">Selecione um processo para an√°lise...</option>
            </select>
            <!-- Bot√£o para enviar o comparativo t√©cnico ao requisitante -->
            <button class="btn btn-success" id="btn-enviar-comparativo-tecnico" style="margin-top: 10px;">
                <i class="fas fa-share-square"></i>
                Enviar Comparativo T√©cnico
            </button>
        </div>

    <!-- Resumo do Parecer do Requisitante (renderizado quando existir) -->
    <div id="parecerResumo" class="parecer-resumo" style="display:none; margin-top: 20px;"></div>

        <!-- Analysis Type Tabs -->
        <div class="analysis-tabs">
            <button class="tab-button active" data-tab="tecnica">
                <i class="fas fa-cogs"></i>
                An√°lise T√©cnica
            </button>
            <button class="tab-button" data-tab="comercial">
                <i class="fas fa-dollar-sign"></i>
                An√°lise Comercial
            </button>
        </div>

        <!-- Azure IA Insights -->
        <div class="ai-insights">
            <div class="ai-header">
                <div class="ai-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <div>
                    <h3>Insights Azure IA</h3>
                    <p>An√°lise autom√°tica das propostas baseada nos dados reais do portal</p>
                </div>
            </div>

            <div class="ai-content">
                <div class="ai-card">
                    <div class="ai-card-title">
                        <i class="fas fa-lightbulb"></i>
                        Destaque Principal
                    </div>
                    <div id="aiHighlight">
                        Carregue um processo para ver os insights da Azure IA...
                    </div>
                </div>

                <div class="ai-card">
                    <div class="ai-card-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Pontos de Aten√ß√£o
                    </div>
                    <div id="aiAttention">
                        Aguardando an√°lise das propostas...
                    </div>
                </div>

                <div class="ai-card">
                    <div class="ai-card-title">
                        <i class="fas fa-chart-line"></i>
                        An√°lise de Mercado
                    </div>
                    <div id="aiMarket">
                        Dados de mercado ser√£o exibidos ap√≥s sele√ß√£o do processo...
                    </div>
                </div>
            </div>
        </div>

        <!-- Technical Analysis Tab -->
        <div id="tecnica" class="tab-content active">
            <!-- Dados Cadastrais -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-building"></i>
                        1. Dados Cadastrais
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Dados Cadastrais</th>
                                <th class="company-header">Aguardando sele√ß√£o...</th>
                            </tr>
                        </thead>
                        <tbody id="dadosCadastraisTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Proposta T√©cnica -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-clipboard-list"></i>
                        2. Proposta T√©cnica
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Aspectos T√©cnicos</th>
                                <th class="company-header">Aguardando sele√ß√£o...</th>
                            </tr>
                        </thead>
                        <tbody id="propostaTecnicaTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tabela de Servi√ßos T√©cnica -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-tasks"></i>
                        2.1 Tabela de Servi√ßos (Quantidades)
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Servi√ßo</th>
                                <th class="company-header">Aguardando sele√ß√£o...</th>
                            </tr>
                        </thead>
                        <tbody id="servicosTecnicaTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- M√£o de Obra -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-users"></i>
                        2.2 M√£o de Obra Direta e Indireta
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Fun√ß√£o</th>
                                <th class="company-header">Aguardando sele√ß√£o...</th>
                            </tr>
                        </thead>
                        <tbody id="maoObraTecnicaTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Materiais -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-boxes"></i>
                        2.3 Lista de Materiais (Quantidades)
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Material</th>
                                <th class="company-header">Aguardando sele√ß√£o...</th>
                            </tr>
                        </thead>
                        <tbody id="materiaisTecnicaTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Equipamentos -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-tools"></i>
                        2.4 Lista de Equipamentos (Quantidades)
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Equipamento</th>
                                <th class="company-header">Aguardando sele√ß√£o...</th>
                            </tr>
                        </thead>
                        <tbody id="equipamentosTecnicaTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Commercial Analysis Tab -->
        <div id="comercial" class="tab-content">
            <!-- Tabela de Servi√ßos Comercial -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-calculator"></i>
                        3.1 Tabela de Servi√ßos (Valores)
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Servi√ßo</th>
                                <th class="company-header">Aguardando sele√ß√£o...</th>
                            </tr>
                        </thead>
                        <tbody id="servicosComercialTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- M√£o de Obra Comercial -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-money-bill-wave"></i>
                        3.2 M√£o de Obra (Custos)
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Fun√ß√£o</th>
                                <th class="company-header">Aguardando sele√ß√£o...</th>
                            </tr>
                        </thead>
                        <tbody id="maoObraComercialTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Materiais Comercial -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-shopping-cart"></i>
                        3.3 Materiais (Custos)
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Material</th>
                                <th class="company-header">Aguardando sele√ß√£o...</th>
                            </tr>
                        </thead>
                        <tbody id="materiaisComercialTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Equipamentos Comercial -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-wrench"></i>
                        3.4 Equipamentos (Custos)
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Equipamento</th>
                                <th class="company-header">Aguardando sele√ß√£o...</th>
                            </tr>
                        </thead>
                        <tbody id="equipamentosComercialTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- BDI Detalhado -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-percentage"></i>
                        3.5 BDI Detalhado
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Item do BDI</th>
                                <th class="company-header">Aguardando sele√ß√£o...</th>
                            </tr>
                        </thead>
                        <tbody id="bdiTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Resumo Financeiro -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-chart-pie"></i>
                        3.6 Resumo Financeiro
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Componente</th>
                                <th class="company-header">Aguardando sele√ß√£o...</th>
                            </tr>
                        </thead>
                        <tbody id="resumoFinanceiroTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
/**
 * Sistema de Comparativo de Propostas - Vers√£o Integrada
 * Mant√©m o visual original mas com dados reais do localStorage
 */

class ComparativoPropostasIntegrado {
    constructor() {
        this.currentProcess = null;
        this.currentTab = 'tecnica';
        this.proposals = [];
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.loadAvailableProcesses();
    }

    setupEventListeners() {
        // Tab switching
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                this.switchTab(e.currentTarget.getAttribute('data-tab'));
            });
        });

        // Process selection
        const processSelect = document.getElementById('processSelect');
        if (processSelect) {
            processSelect.addEventListener('change', (e) => {
                this.loadProcess(e.target.value);
            });
        }
    }

    // Carregar processos dispon√≠veis do localStorage
    loadAvailableProcesses() {
        const processos = JSON.parse(localStorage.getItem('processos_licitatorios') || '[]');
        const processSelect = document.getElementById('processSelect');
        
        if (!processSelect) return;
        
        // Limpar op√ß√µes existentes
        processSelect.innerHTML = '<option value="">Selecione um processo para an√°lise...</option>';
        
        // Contador de processos com propostas
        let processosComPropostas = 0;
        
        // Adicionar processos que t√™m propostas
        processos.forEach(processo => {
            // Buscar propostas para este processo
            const propostas = this.buscarPropostasDoProcesso(processo.id);
            
            if (propostas.length > 0) {
                processosComPropostas++;
                const option = document.createElement('option');
                option.value = processo.id;
                option.textContent = `${processo.numeroProcesso} - ${processo.trVinculado?.titulo || 'Sem t√≠tulo'}`;
                processSelect.appendChild(option);
            }
        });
        
        // Se n√£o houver nenhum processo com propostas, mostrar mensagem
        if (processosComPropostas === 0) {
            processSelect.innerHTML = '<option value="">Nenhum processo com propostas dispon√≠vel para compara√ß√£o</option>';
            
            // Opcional: Mostrar mensagem informativa na tela
            const aiHighlight = document.getElementById('aiHighlight');
            if (aiHighlight) {
                aiHighlight.textContent = 'N√£o h√° processos com propostas para an√°lise. Aguarde o envio de propostas pelos fornecedores.';
            }
        }
        
        // Se vier com processo selecionado na URL
        const urlParams = new URLSearchParams(window.location.search);
        const processoId = urlParams.get('processo');
        if (processoId && processosComPropostas > 0) {
            processSelect.value = processoId;
            this.loadProcess(processoId);
        }
    }

    // Buscar propostas de um processo espec√≠fico
    buscarPropostasDoProcesso(processoId) {
        const propostas = [];
        const propostasMap = new Map(); // Usar Map para evitar duplicatas
        
        // Buscar em propostas_fornecedores (prioridade 1)
        const propostasFornecedores = JSON.parse(localStorage.getItem('propostas_fornecedores') || '[]');
        propostasFornecedores.forEach(p => {
            if (p.processoId === processoId && p.status === 'ENVIADA') {
                // Usar CNPJ como chave √∫nica para evitar duplicatas
                const chave = p.fornecedorCNPJ || p.cnpj;
                if (chave && !propostasMap.has(chave)) {
                    propostasMap.set(chave, this.formatarPropostaFornecedor(p));
                }
            }
        });
    
        // Buscar em propostas_comparativo (prioridade 2)
        const propostasComparativo = JSON.parse(localStorage.getItem('propostas_comparativo') || '[]');
        propostasComparativo.forEach(p => {
            if (p.numeroProcesso === processoId) {
                const chave = p.fornecedorCNPJ || p.cnpj;
                // S√≥ adicionar se ainda n√£o existe
                if (chave && !propostasMap.has(chave)) {
                    propostasMap.set(chave, this.formatarPropostaFornecedor(p));
                }
            }
        });
        
        // Buscar em propostas_completas (prioridade 3)
        const propostasCompletas = JSON.parse(localStorage.getItem('propostas_completas') || '[]');
        propostasCompletas.forEach(p => {
            if (p.processoId === processoId) {
                const chave = p.dadosCadastrais?.cnpj || p.cnpj;
                // S√≥ adicionar se ainda n√£o existe
                if (chave && !propostasMap.has(chave)) {
                    propostasMap.set(chave, this.formatarPropostaCompleta(p));
                }
            }
        });
        
        // Converter Map para array
        return Array.from(propostasMap.values());
    }
    // Formatar proposta do fornecedor para o formato esperado
    formatarPropostaFornecedor(proposta) {
        // Verificar se tem dados completos salvos
        if (proposta.dadosCompletos) {
            const dados = proposta.dadosCompletos;
            return {
                id: proposta.id,
                processoId: proposta.processoId,
                dadosCadastrais: dados.dadosCadastrais || {
                    razaoSocial: proposta.fornecedorRazaoSocial,
                    cnpj: proposta.fornecedorCNPJ,
                    endereco: proposta.endereco || 'N√£o informado',
                    cidade: proposta.cidade || 'N√£o informado',
                    telefone: proposta.telefone || 'N√£o informado',
                    email: proposta.fornecedorEmail || proposta.email || 'N√£o informado',
                    respTecnico: proposta.responsavel || dados.dadosCadastrais?.respTecnico || 'N√£o informado',
                    crea: proposta.crea || dados.dadosCadastrais?.crea || 'N√£o informado'
                },
                propostaTecnica: dados.propostaTecnica || {
                    objetoConcorrencia: proposta.objeto || 'Conforme TR',
                    escopoInclusos: proposta.escopo || dados.propostaTecnica?.escopoInclusos || 'Conforme especifica√ß√µes',
                    escopoExclusos: dados.propostaTecnica?.escopoExclusos || 'N√£o especificado',
                    metodologia: proposta.descricao_tecnica || dados.propostaTecnica?.metodologia || 'Conforme padr√µes t√©cnicos',
                    sequenciaExecucao: dados.propostaTecnica?.sequenciaExecucao || 'Conforme cronograma',
                    prazoExecucao: proposta.prazoExecucao || '180 dias',
                    prazoMobilizacao: dados.propostaTecnica?.prazoMobilizacao || '15 dias',
                    garantias: proposta.garantia || dados.propostaTecnica?.garantias || '12 meses',
                    estruturaCanteiro: dados.propostaTecnica?.estruturaCanteiro || 'Conforme necess√°rio',
                    obrigacoesContratada: dados.propostaTecnica?.obrigacoesContratada || 'Conforme contrato',
                    obrigacoesContratante: dados.propostaTecnica?.obrigacoesContratante || 'Conforme contrato'
                },
                // IMPORTANTE: Mapear arrays diretamente sem convers√£o
                servicosTecnica: dados.propostaTecnica?.servicosTecnica || [],
                maoObraTecnica: dados.propostaTecnica?.equipe || [],
                materiaisTecnica: dados.propostaTecnica?.materiais || [],
                equipamentosTecnica: dados.propostaTecnica?.equipamentos || [],
                servicosComercial: dados.propostaComercial?.servicos || [],
                maoObraComercial: dados.propostaComercial?.maoObra || [],
                materiaisComercial: dados.propostaComercial?.materiaisComercial || [],
                equipamentosComercial: dados.propostaComercial?.equipamentosComercial || [],
                bdi: dados.propostaComercial?.bdi || [],
                resumoFinanceiro: this.formatarResumoFinanceiro(dados.propostaComercial, proposta.valor)
            };
        } else {
            // Fallback para propostas sem dados completos
            return this.formatarPropostaSimples(proposta);
        }
    }
    // Novo m√©todo para formatar BDI
    formatarBDI(bdis, valorTotal) {
        if (!bdis || !Array.isArray(bdis)) return [];
        
        return bdis.map(item => ({
            item: item[0] || item.item || 'Item BDI',
            percentual: parseFloat(item[1] || item.percentual || 0),
            valor: parseFloat(item[2] || item.valor || 0)
        }));
    }
    
    // Novo m√©todo para formatar resumo financeiro
    formatarResumoFinanceiro(comercial, valorTotal) {
        if (!comercial || !comercial.totais) {
            return {
                totalServicos: 0,
                totalMaoObra: 0,
                totalMateriais: 0,
                totalEquipamentos: 0,
                custoDireto: 0,
                bdiPercentual: 0,
                bdiValor: 0,
                valorTotal: parseFloat(valorTotal || 0)
            };
        }
        
        const totais = comercial.totais;
        return {
            totalServicos: this.converterParaNumero(totais.servicos),
            totalMaoObra: this.converterParaNumero(totais.maoObra),
            totalMateriais: this.converterParaNumero(totais.materiais),
            totalEquipamentos: this.converterParaNumero(totais.equipamentos),
            custoDireto: this.converterParaNumero(totais.custoDirecto),
            bdiPercentual: parseFloat(totais.bdiPercentual || 0),
            bdiValor: this.converterParaNumero(totais.bdiValor),
            valorTotal: this.converterParaNumero(comercial.valorTotal || valorTotal)
        };
    }
    
    // M√©todo auxiliar para converter valores monet√°rios
    converterParaNumero(valor) {
        if (!valor) return 0;
        if (typeof valor === 'number') return valor;
        
        // Remove R$, pontos e converte v√≠rgula em ponto
        const numero = valor.toString()
            .replace(/R\$/g, '')
            .replace(/\./g, '')
            .replace(',', '.')
            .trim();
        
        return parseFloat(numero) || 0;
    }
    
    // M√©todo para propostas simples (sem dados completos)
    formatarPropostaSimples(proposta) {
        return {
            id: proposta.id,
            processoId: proposta.processoId,
            dadosCadastrais: {
                razaoSocial: proposta.fornecedorRazaoSocial,
                cnpj: proposta.fornecedorCNPJ,
                endereco: proposta.endereco || 'N√£o informado',
                cidade: proposta.cidade || 'N√£o informado',
                telefone: proposta.telefone || 'N√£o informado',
                email: proposta.fornecedorEmail || proposta.email || 'N√£o informado',
                respTecnico: proposta.responsavel || 'N√£o informado',
                crea: proposta.crea || 'N√£o informado'
            },
            propostaTecnica: {
                objetoConcorrencia: proposta.objeto || 'Conforme TR',
                escopoInclusos: proposta.escopo || 'Conforme especifica√ß√µes',
                escopoExclusos: 'N√£o especificado',
                metodologia: proposta.descricao_tecnica || 'Conforme padr√µes t√©cnicos',
                sequenciaExecucao: proposta.cronograma || 'Conforme cronograma',
                prazoExecucao: proposta.prazoExecucao || '180 dias',
                prazoMobilizacao: '15 dias',
                garantias: proposta.garantia || '12 meses',
                estruturaCanteiro: 'Conforme necess√°rio',
                obrigacoesContratada: 'Conforme contrato',
                obrigacoesContratante: 'Conforme contrato'
            },
            servicosTecnica: [],
            maoObraTecnica: [],
            materiaisTecnica: [],
            equipamentosTecnica: [],
            servicosComercial: [],
            maoObraComercial: [],
            materiaisComercial: [],
            equipamentosComercial: [],
            bdi: [],
            resumoFinanceiro: {
                totalServicos: 0,
                totalMaoObra: 0,
                totalMateriais: 0,
                totalEquipamentos: 0,
                custoDireto: 0,
                bdiPercentual: 0,
                bdiValor: 0,
                valorTotal: parseFloat(proposta.valor || 0)
            }
        };
    }
    
    // Formatar proposta completa
    formatarPropostaCompleta(proposta) {
        return proposta; // J√° est√° no formato correto
    }

    /**
     * Aplicar pareceres do requisitante √†s propostas carregadas para um processo.
     * Essa fun√ß√£o l√™ a chave 'propostas_para_requisitante' do localStorage, localiza
     * um comparativo t√©cnico j√° analisado pelo requisitante (parecer_requisitante === 'analise_realizada')
     * e, para cada fornecedor, copia a recomenda√ß√£o e o parecer do requisitante para
     * dentro do objeto propostaTecnica da proposta correspondente. O v√≠nculo √© feito
     * pelo CNPJ do fornecedor.
     *
     * @param {string|number} processId - ID do processo atualmente selecionado
     */
    aplicarParecerRequisitante(processId) {
        try {
            const propostasReqRaw = localStorage.getItem('propostas_para_requisitante');
            if (!propostasReqRaw) return;
            const propostasReq = JSON.parse(propostasReqRaw);
            // Procurar o comparativo t√©cnico deste processo que j√° tenha sido analisado
            const comp = propostasReq.find(p => {
                return p.processo_id == processId && p.comparativo_tecnico && p.parecer_requisitante === 'analise_realizada';
            });
            if (!comp || !comp.comparativo_tecnico) return;
            const lista = comp.comparativo_tecnico.proposals || [];
            // Mapear recomenda√ß√µes para as propostas carregadas
            lista.forEach(pr => {
                const cnpj = pr.dadosCadastrais?.cnpj || pr.cnpj;
                if (!cnpj) return;
                this.proposals.forEach(prop => {
                    const pCnpj = prop.dadosCadastrais?.cnpj || prop.cnpj;
                    if (pCnpj && pCnpj === cnpj) {
                        // Copiar recomenda√ß√£o e parecer para a proposta
                        prop.propostaTecnica = prop.propostaTecnica || {};
                        // Se houver hist√≥rico de pareceres na proposta, usar a √∫ltima entrada
                        if (Array.isArray(pr.pareceres) && pr.pareceres.length > 0) {
                            const last = pr.pareceres[pr.pareceres.length - 1];
                            prop.propostaTecnica.recomendacaoRequisitante = last.recomendacao || '';
                            prop.propostaTecnica.parecerRequisitante = last.parecer || '';
                        } else {
                            prop.propostaTecnica.recomendacaoRequisitante = pr.recomendacao_requisitante || pr.propostaTecnica?.recomendacaoRequisitante || '';
                            prop.propostaTecnica.parecerRequisitante = pr.parecer_requisitante || pr.propostaTecnica?.parecerRequisitante || '';
                        }
                    }
                });
            });
        } catch (error) {
            console.error('Erro ao aplicar pareceres do requisitante:', error);
        }
    }

    /**
     * Renderizar um resumo dos pareceres do requisitante para o processo atual.
     * Este m√©todo procura em `propostas_para_requisitante` um comparativo t√©cnico
     * que j√° tenha sido analisado pelo requisitante (parecer_requisitante ===
     * 'analise_realizada') e, se encontrado, monta uma tabela com a
     * recomenda√ß√£o e o parecer do requisitante para cada fornecedor.
     * O resumo √© exibido no elemento com id `parecerResumo`. Se nenhum
     * parecer for encontrado, o cont√™iner √© ocultado.
     *
     * @param {string|number} processId - ID do processo atualmente selecionado
     */
    renderParecerResumo(processId) {
        const resumoContainer = document.getElementById('parecerResumo');
        if (!resumoContainer) return;
        // Limpar conte√∫do existente
        resumoContainer.innerHTML = '';
        resumoContainer.style.display = 'none';

        try {
            const propostasReqRaw = localStorage.getItem('propostas_para_requisitante');
            if (!propostasReqRaw) return;
            const propostasReq = JSON.parse(propostasReqRaw);
            // Localizar o comparativo deste processo que j√° tenha sido analisado
            const comp = propostasReq.find(p => {
                return p.processo_id == processId && p.comparativo_tecnico && p.parecer_requisitante === 'analise_realizada';
            });
            if (!comp || !comp.comparativo_tecnico) {
                return;
            }
            const list = comp.comparativo_tecnico.proposals || [];
            if (!list.length) return;
            // Construir mapa de cores e labels para as recomenda√ß√µes
            const labelMap = {
                'aprovada_tecnicamente': 'Aprovada Tecnicamente',
                'ajuste': 'Solicitar Ajuste',
                'reprovada_tecnicamente': 'Reprovada Tecnicamente'
            };
            const colorMap = {
                'aprovada_tecnicamente': '#0066cc', // azul
                'ajuste': '#e6a600',                 // amarelo
                'reprovada_tecnicamente': '#cc0000'  // vermelho
            };
            // Cabe√ßalho
            let html = '<h3 style="margin-bottom: 15px;">Parecer do Requisitante</h3>';
            html += '<table style="width:100%; border-collapse: collapse;">';
            html += '<thead><tr>';
            html += '<th style="text-align:left; padding:8px; border-bottom:1px solid #e2e8f0;">Fornecedor</th>';
            html += '<th style="text-align:left; padding:8px; border-bottom:1px solid #e2e8f0;">Recomenda√ß√£o</th>';
            html += '<th style="text-align:left; padding:8px; border-bottom:1px solid #e2e8f0;">Parecer</th>';
            html += '</tr></thead><tbody>';
            // Linhas
            list.forEach(pr => {
                // Nome e CNPJ do fornecedor
                const razao = pr.dadosCadastrais?.razaoSocial || pr.razaoSocial || pr.fornecedorRazaoSocial || 'Fornecedor';
                const recomend = pr.recomendacao_requisitante || pr.propostaTecnica?.recomendacaoRequisitante || '';
                const parecer = pr.parecer_requisitante || pr.propostaTecnica?.parecerRequisitante || '';
                if (!recomend && !parecer) return; // Ignorar se n√£o houver info
                const label = labelMap[recomend] || recomend || 'N√£o informado';
                const color = colorMap[recomend] || '#333';
                html += '<tr>';
                html += `<td style="padding:8px; border-bottom:1px solid #e2e8f0;"><strong>${razao}</strong></td>`;
                html += `<td style="padding:8px; border-bottom:1px solid #e2e8f0; color:${color}; font-weight:600;">${label}</td>`;
                html += `<td style="padding:8px; border-bottom:1px solid #e2e8f0;">${parecer || 'N√£o informado'}</td>`;
                html += '</tr>';
            });
            html += '</tbody></table>';
            resumoContainer.innerHTML = html;
            resumoContainer.style.display = 'block';
        } catch (e) {
            console.error('Erro ao renderizar parecer do requisitante:', e);
        }
    }

    // Gerar dados t√©cnicos baseados na proposta
    gerarServicosTecnica(proposta) {
        // Se j√° tem dados detalhados, usar
        if (proposta.servicos) return proposta.servicos;
        
        // Gerar dados b√°sicos
        return [
            { descricao: 'Servi√ßo principal', unidade: 'un', quantidade: 1 },
            { descricao: 'Servi√ßos complementares', unidade: 'vb', quantidade: 1 }
        ];
    }

    gerarMaoObraTecnica(proposta) {
        if (proposta.maoObra) return proposta.maoObra;
        
        return [
            { funcao: 'Coordenador', quantidade: 1, tempo: 6 },
            { funcao: 'T√©cnico', quantidade: 2, tempo: 6 },
            { funcao: 'Auxiliar', quantidade: 3, tempo: 6 }
        ];
    }

    gerarMateriaisTecnica(proposta) {
        if (proposta.materiais) return proposta.materiais;
        
        return [
            { material: 'Material principal', especificacao: 'Conforme especifica√ß√£o', unidade: 'un', quantidade: 100 }
        ];
    }

    gerarEquipamentosTecnica(proposta) {
        if (proposta.equipamentos) return proposta.equipamentos;
        
        return [
            { equipamento: 'Equipamento principal', especificacao: 'Conforme necess√°rio', unidade: 'un', quantidade: 1, tempo: 6 }
        ];
    }

    // Gerar dados comerciais
    gerarServicosComercial(proposta) {
        const valor = parseFloat(proposta.valor || 0);
        return [
            { 
                descricao: 'Servi√ßo principal', 
                unidade: 'un', 
                quantidade: 1, 
                precoUnitario: valor * 0.7,
                total: valor * 0.7
            },
            { 
                descricao: 'Servi√ßos complementares', 
                unidade: 'vb', 
                quantidade: 1, 
                precoUnitario: valor * 0.3,
                total: valor * 0.3
            }
        ];
    }

    gerarMaoObraComercial(proposta) {
        const valor = parseFloat(proposta.valor || 0);
        return [
            { funcao: 'Coordenador', quantidade: 1, tempo: 6, salario: 5000, encargos: 80, total: 54000 },
            { funcao: 'T√©cnico', quantidade: 2, tempo: 6, salario: 3000, encargos: 80, total: 64800 },
            { funcao: 'Auxiliar', quantidade: 3, tempo: 6, salario: 1500, encargos: 80, total: 48600 }
        ];
    }

    gerarMateriaisComercial(proposta) {
        const valor = parseFloat(proposta.valor || 0);
        return [
            { 
                material: 'Material principal', 
                especificacao: 'Conforme especifica√ß√£o', 
                unidade: 'un', 
                quantidade: 100,
                precoUnitario: valor * 0.002,
                total: valor * 0.2
            }
        ];
    }

    gerarEquipamentosComercial(proposta) {
        const valor = parseFloat(proposta.valor || 0);
        return [
            { 
                equipamento: 'Equipamento principal', 
                especificacao: 'Conforme necess√°rio', 
                quantidade: 1, 
                tempo: 6,
                precoMensal: valor * 0.02,
                total: valor * 0.12
            }
        ];
    }

    gerarBDI(proposta) {
        const valor = parseFloat(proposta.valor || 0);
        const bdiPercentual = proposta.bdi || 25;
        const valorBDI = valor * (bdiPercentual / 100);
        
        return [
            { item: 'Administra√ß√£o Central', percentual: 8.0, valor: valorBDI * 0.32 },
            { item: 'Seguros e Garantias', percentual: 1.5, valor: valorBDI * 0.06 },
            { item: 'Riscos', percentual: 2.0, valor: valorBDI * 0.08 },
            { item: 'Despesas Financeiras', percentual: 1.0, valor: valorBDI * 0.04 },
            { item: 'Lucro', percentual: 8.0, valor: valorBDI * 0.32 },
            { item: 'Tributos (ISS, PIS, COFINS)', percentual: 4.5, valor: valorBDI * 0.18 }
        ];
    }

    gerarResumoFinanceiro(proposta) {
        const valor = parseFloat(proposta.valor || 0);
        const custoDireto = valor * 0.75;
        const bdi = valor * 0.25;
        
        return {
            totalServicos: custoDireto * 0.4,
            totalMaoObra: custoDireto * 0.3,
            totalMateriais: custoDireto * 0.2,
            totalEquipamentos: custoDireto * 0.1,
            custoDireto: custoDireto,
            bdiPercentual: 25.0,
            bdiValor: bdi,
            valorTotal: valor
        };
    }

    switchTab(tabName) {
        // Update button states
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

        // Update content visibility
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(tabName).classList.add('active');

        this.currentTab = tabName;
        this.updateAIInsights(tabName);
    }

    loadProcess(processId) {
        if (!processId) return;

        this.currentProcess = processId;
        this.showLoading();

        // Buscar propostas do processo
        this.proposals = this.buscarPropostasDoProcesso(processId);
        // Ap√≥s carregar propostas, aplicar eventuais pareceres do requisitante presentes em propostas_para_requisitante
        try {
            this.aplicarParecerRequisitante(processId);
        } catch (e) {
            console.warn('Falha ao aplicar parecer do requisitante:', e);
        }
        
        if (this.proposals.length === 0) {
            alert('Nenhuma proposta encontrada para este processo!');
            this.hideLoading();
            return;
        }

        // Atualizar interface
        this.updateCompanyHeaders();
        this.updateAllTables();
        this.updateAIInsights(this.currentTab);

        // Ap√≥s atualizar as tabelas, renderizar o resumo do parecer do requisitante, se houver
        try {
            this.renderParecerResumo(processId);
        } catch (e) {
            console.warn('Falha ao renderizar resumo do parecer do requisitante:', e);
        }
        
        this.hideLoading();
    }

    updateCompanyHeaders() {
        const headers = document.querySelectorAll('.company-header');
        
        // Atualizar todos os headers de cada tabela
        document.querySelectorAll('.comparison-table').forEach(table => {
            const thead = table.querySelector('thead tr');
            if (thead) {
                // Remover headers antigos (exceto o primeiro)
                while (thead.children.length > 1) {
                    thead.removeChild(thead.lastChild);
                }
                
                // Adicionar novos headers
                this.proposals.forEach(proposal => {
                    const th = document.createElement('th');
                    th.className = 'company-header';
                    th.textContent = proposal.dadosCadastrais.razaoSocial;
                    thead.appendChild(th);
                });
            }
        });
    }

    updateAllTables() {
        // An√°lise T√©cnica
        this.updateDadosCadastraisTable();
        this.updatePropostaTecnicaTable();
        this.updateServicosTecnicaTable();
        this.updateMaoObraTecnicaTable();
        this.updateMateriaisTecnicaTable();
        this.updateEquipamentosTecnicaTable();

        // An√°lise Comercial
        this.updateServicosComercialTable();
        this.updateMaoObraComercialTable();
        this.updateMateriaisComercialTable();
        this.updateEquipamentosComercialTable();
        this.updateBDITable();
        this.updateResumoFinanceiroTable();
    }

    // Tabelas de An√°lise T√©cnica
    updateDadosCadastraisTable() {
        const tableBody = document.getElementById('dadosCadastraisTable');
        if (!tableBody) return;

        const items = [
            { label: 'Raz√£o Social', key: 'razaoSocial' },
            { label: 'CNPJ', key: 'cnpj' },
            { label: 'Endere√ßo', key: 'endereco' },
            { label: 'Cidade/UF', key: 'cidade' },
            { label: 'Telefone', key: 'telefone' },
            { label: 'E-mail', key: 'email' },
            { label: 'Respons√°vel T√©cnico', key: 'respTecnico' },
            { label: 'CREA/CAU', key: 'crea' }
        ];

        this.buildTable(tableBody, items, 'dadosCadastrais');
    }

    updatePropostaTecnicaTable() {
        const tableBody = document.getElementById('propostaTecnicaTable');
        if (!tableBody) return;

        const items = [
            { label: 'Objeto da Concorr√™ncia', key: 'objetoConcorrencia', type: 'text' },
            { label: 'Servi√ßos a Executar', key: 'escopoInclusos', type: 'text' },
            { label: 'Servi√ßos Ocultos', key: 'escopoExclusos', type: 'text' },
            { label: 'Metodologia de Execu√ß√£o', key: 'metodologia', type: 'text' },
            { label: 'Plano de Execu√ß√£o', key: 'sequenciaExecucao', type: 'text' },
            { label: 'Prazo de Execu√ß√£o', key: 'prazoExecucao', type: 'text' },
            { label: 'Prazo de Mobiliza√ß√£o', key: 'prazoMobilizacao', type: 'text' },
            { label: 'Garantias Oferecidas', key: 'garantias', type: 'text' },
            { label: 'Estrutura do Canteiro', key: 'estruturaCanteiro', type: 'text' },
            { label: 'Obriga√ß√µes da Contratada', key: 'obrigacoesContratada', type: 'text' },
            { label: 'Obriga√ß√µes da Contratante', key: 'obrigacoesContratante', type: 'text' },
            // Campos adicionados para exibir o parecer do requisitante. Esses valores s√£o
            // preenchidos pelo m√≥dulo requisitante no objeto propostaTecnica usando
            // as chaves parecerRequisitante e recomendacaoRequisitante.
            { label: 'Recomenda√ß√£o do Requisitante', key: 'recomendacaoRequisitante', type: 'status' },
            { label: 'Parecer do Requisitante', key: 'parecerRequisitante', type: 'text' }
        ];

        this.buildTable(tableBody, items, 'propostaTecnica');
    }

    updateServicosTecnicaTable() {
        const tableContainer = document.querySelector('#servicosTecnicaTable').closest('.table-container');
        
        // Criar container para tabelas lado a lado
        tableContainer.innerHTML = `
            <div class="side-by-side-container" style="display: flex; gap: 20px; overflow-x: auto; padding: 20px;">
            </div>
        `;
        
        const container = tableContainer.querySelector('.side-by-side-container');
        
        // Para cada proposta, criar uma tabela completa
        this.proposals.forEach(proposal => {
            const column = document.createElement('div');
            column.className = 'proposal-column';
            column.style.cssText = 'flex: 0 0 400px; background: white; border-radius: 10px; border: 2px solid #e2e8f0; overflow: hidden;';
            
            // Header da empresa
            const header = document.createElement('div');
            header.style.cssText = 'background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 15px; text-align: center; font-weight: 700;';
            header.textContent = proposal.dadosCadastrais.razaoSocial;
            column.appendChild(header);
            
            // Criar tabela
            const table = document.createElement('table');
            table.style.cssText = 'width: 100%; border-collapse: collapse; font-size: 0.9rem;';
            
            // Header da tabela
            table.innerHTML = `
                <thead>
                    <tr style="background: #f1f5f9;">
                        <th style="padding: 10px; text-align: left;">Item</th>
                        <th style="padding: 10px; text-align: left;">Descri√ß√£o</th>
                        <th style="padding: 10px; text-align: left;">Unid.</th>
                        <th style="padding: 10px; text-align: left;">Qtd</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            const tbody = table.querySelector('tbody');
            
            // Preencher dados
            if (proposal.servicosTecnica && Array.isArray(proposal.servicosTecnica)) {
                proposal.servicosTecnica.forEach((servico, index) => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1;">${index + 1}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1;">${servico[1] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1;">${servico[2] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; font-weight: 600; color: #3498db;">${servico[3] || '-'}</td>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #999;">Nenhum servi√ßo informado</td></tr>';
            }
            
            column.appendChild(table);
            container.appendChild(column);
        });
    }
    updateMaoObraTecnicaTable() {
        const tableContainer = document.querySelector('#maoObraTecnicaTable').closest('.table-container');
        
        tableContainer.innerHTML = `
            <div class="side-by-side-container" style="display: flex; gap: 20px; overflow-x: auto; padding: 20px;">
            </div>
        `;
        
        const container = tableContainer.querySelector('.side-by-side-container');
        
        this.proposals.forEach(proposal => {
            const column = document.createElement('div');
            column.className = 'proposal-column';
            column.style.cssText = 'flex: 0 0 400px; background: white; border-radius: 10px; border: 2px solid #e2e8f0; overflow: hidden;';
            
            // Header
            const header = document.createElement('div');
            header.style.cssText = 'background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 15px; text-align: center; font-weight: 700;';
            header.textContent = proposal.dadosCadastrais.razaoSocial;
            column.appendChild(header);
            
            // Tabela
            const table = document.createElement('table');
            table.style.cssText = 'width: 100%; border-collapse: collapse; font-size: 0.9rem;';
            
            table.innerHTML = `
                <thead>
                    <tr style="background: #f1f5f9;">
                        <th style="padding: 10px; text-align: left;">Fun√ß√£o</th>
                        <th style="padding: 10px; text-align: center;">Qtd</th>
                        <th style="padding: 10px; text-align: center;">Meses</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            const tbody = table.querySelector('tbody');
            
            if (proposal.maoObraTecnica && Array.isArray(proposal.maoObraTecnica)) {
                proposal.maoObraTecnica.forEach(item => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1;">${item[0] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: center; font-weight: 600; color: #3498db;">${item[1] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: center;">${item[2] || '-'}</td>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #999;">Nenhuma informa√ß√£o de m√£o de obra</td></tr>';
            }
            
            column.appendChild(table);
            container.appendChild(column);
        });
    }

    updateMateriaisTecnicaTable() {
        const tableContainer = document.querySelector('#materiaisTecnicaTable').closest('.table-container');
    
        tableContainer.innerHTML = `
            <div class="side-by-side-container" style="display: flex; gap: 20px; overflow-x: auto; padding: 20px;">
            </div>
        `;
        
        const container = tableContainer.querySelector('.side-by-side-container');
        
        this.proposals.forEach(proposal => {
            const column = document.createElement('div');
            column.className = 'proposal-column';
            column.style.cssText = 'flex: 0 0 450px; background: white; border-radius: 10px; border: 2px solid #e2e8f0; overflow: hidden;';
            
            // Header
            const header = document.createElement('div');
            header.style.cssText = 'background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 15px; text-align: center; font-weight: 700;';
            header.textContent = proposal.dadosCadastrais.razaoSocial;
            column.appendChild(header);
            
            // Tabela
            const table = document.createElement('table');
            table.style.cssText = 'width: 100%; border-collapse: collapse; font-size: 0.9rem;';
            
            table.innerHTML = `
                <thead>
                    <tr style="background: #f1f5f9;">
                        <th style="padding: 10px; text-align: left;">Material</th>
                        <th style="padding: 10px; text-align: left;">Especifica√ß√£o</th>
                        <th style="padding: 10px; text-align: center;">Unid.</th>
                        <th style="padding: 10px; text-align: center;">Qtd</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            const tbody = table.querySelector('tbody');
            
            if (proposal.materiaisTecnica && Array.isArray(proposal.materiaisTecnica)) {
                proposal.materiaisTecnica.forEach(item => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1;">${item[0] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1;">${item[1] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: center;">${item[2] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: center; font-weight: 600; color: #3498db;">${item[3] || '-'}</td>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 20px; color: #999;">Nenhum material informado</td></tr>';
            }
            
            column.appendChild(table);
            container.appendChild(column);
        });
    }

    updateEquipamentosTecnicaTable() {
        const tableContainer = document.querySelector('#equipamentosTecnicaTable').closest('.table-container');
    
        tableContainer.innerHTML = `
            <div class="side-by-side-container" style="display: flex; gap: 20px; overflow-x: auto; padding: 20px;">
            </div>
        `;
        
        const container = tableContainer.querySelector('.side-by-side-container');
        
        this.proposals.forEach(proposal => {
            const column = document.createElement('div');
            column.className = 'proposal-column';
            column.style.cssText = 'flex: 0 0 500px; background: white; border-radius: 10px; border: 2px solid #e2e8f0; overflow: hidden;';
            
            // Header
            const header = document.createElement('div');
            header.style.cssText = 'background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 15px; text-align: center; font-weight: 700;';
            header.textContent = proposal.dadosCadastrais.razaoSocial;
            column.appendChild(header);
            
            // Tabela
            const table = document.createElement('table');
            table.style.cssText = 'width: 100%; border-collapse: collapse; font-size: 0.9rem;';
            
            table.innerHTML = `
                <thead>
                    <tr style="background: #f1f5f9;">
                        <th style="padding: 10px; text-align: left;">Equipamento</th>
                        <th style="padding: 10px; text-align: left;">Especifica√ß√£o</th>
                        <th style="padding: 10px;">Unid.</th>
                        <th style="padding: 10px;">Qtd</th>
                        <th style="padding: 10px;">Tempo</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            const tbody = table.querySelector('tbody');
            
            if (proposal.equipamentosTecnica && Array.isArray(proposal.equipamentosTecnica)) {
                proposal.equipamentosTecnica.forEach(item => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1;">${item[0] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1;">${item[1] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: center;">${item[2] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: center; font-weight: 600; color: #3498db;">${item[3] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: center;">${item[4] || '-'} meses</td>
                    `;
                });
            } else {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px; color: #999;">Nenhum equipamento informado</td></tr>';
            }
            
            column.appendChild(table);
            container.appendChild(column);
        });
    }
    // Tabelas de An√°lise Comercial
    updateServicosComercialTable() {
        const tableContainer = document.querySelector('#servicosComercialTable').closest('.table-container');
        
        tableContainer.innerHTML = `
            <div class="side-by-side-container" style="display: flex; gap: 20px; overflow-x: auto; padding: 20px;">
            </div>
        `;
        
        const container = tableContainer.querySelector('.side-by-side-container');
        
        this.proposals.forEach(proposal => {
            const column = document.createElement('div');
            column.className = 'proposal-column';
            column.style.cssText = 'flex: 0 0 500px; background: white; border-radius: 10px; border: 2px solid #e2e8f0; overflow: hidden;';
            
            // Header
            const header = document.createElement('div');
            header.style.cssText = 'background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 15px; text-align: center; font-weight: 700;';
            header.textContent = proposal.dadosCadastrais.razaoSocial;
            column.appendChild(header);
            
            // Tabela
            const table = document.createElement('table');
            table.style.cssText = 'width: 100%; border-collapse: collapse; font-size: 0.9rem;';
            
            table.innerHTML = `
                <thead>
                    <tr style="background: #f1f5f9;">
                        <th style="padding: 10px; text-align: left;">Item</th>
                        <th style="padding: 10px; text-align: left;">Descri√ß√£o</th>
                        <th style="padding: 10px;">Un.</th>
                        <th style="padding: 10px;">Qtd</th>
                        <th style="padding: 10px;">P.Unit</th>
                        <th style="padding: 10px;">Total</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            const tbody = table.querySelector('tbody');
            
            if (proposal.servicosComercial && Array.isArray(proposal.servicosComercial)) {
                let totalServicos = 0;
                
                proposal.servicosComercial.forEach((servico, index) => {
                    const row = tbody.insertRow();
                    const total = this.converterParaNumero(servico[5]) || 0;
                    totalServicos += total;
                    
                    row.innerHTML = `
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1;">${index + 1}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1;">${servico[1] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: center;">${servico[2] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: center;">${servico[3] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: right; color: #27ae60; font-weight: 600;">R$ ${servico[4] || '0,00'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: right; color: #27ae60; font-weight: 700;">R$ ${servico[5] || '0,00'}</td>
                    `;
                });
                
                // Linha de total
                const totalRow = tbody.insertRow();
                totalRow.style.cssText = 'background: #f8fafc; font-weight: 700;';
                totalRow.innerHTML = `
                    <td colspan="5" style="padding: 15px; text-align: right;">TOTAL SERVI√áOS:</td>
                    <td style="padding: 15px; text-align: right; color: #e74c3c; font-size: 1.1em;">R$ ${this.formatCurrency(totalServicos)}</td>
                `;
            } else {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #999;">Nenhum servi√ßo comercial informado</td></tr>';
            }
            
            column.appendChild(table);
            container.appendChild(column);
        });
    }

    updateMaoObraComercialTable() {
        const tableContainer = document.querySelector('#maoObraComercialTable').closest('.table-container');
    
        tableContainer.innerHTML = `
            <div class="side-by-side-container" style="display: flex; gap: 20px; overflow-x: auto; padding: 20px;">
            </div>
        `;
        
        const container = tableContainer.querySelector('.side-by-side-container');
        
        this.proposals.forEach(proposal => {
            const column = document.createElement('div');
            column.className = 'proposal-column';
            column.style.cssText = 'flex: 0 0 600px; background: white; border-radius: 10px; border: 2px solid #e2e8f0; overflow: hidden;';
            
            // Header
            const header = document.createElement('div');
            header.style.cssText = 'background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 15px; text-align: center; font-weight: 700;';
            header.textContent = proposal.dadosCadastrais.razaoSocial;
            column.appendChild(header);
            
            // Tabela
            const table = document.createElement('table');
            table.style.cssText = 'width: 100%; border-collapse: collapse; font-size: 0.9rem;';
            
            table.innerHTML = `
                <thead>
                    <tr style="background: #f1f5f9;">
                        <th style="padding: 10px; text-align: left;">Fun√ß√£o</th>
                        <th style="padding: 10px;">Qtd</th>
                        <th style="padding: 10px;">Meses</th>
                        <th style="padding: 10px;">Sal√°rio</th>
                        <th style="padding: 10px;">Enc.(%)</th>
                        <th style="padding: 10px;">Total Mensal</th>
                        <th style="padding: 10px;">Total Geral</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            const tbody = table.querySelector('tbody');
            
            if (proposal.maoObraComercial && Array.isArray(proposal.maoObraComercial)) {
                let totalMaoObra = 0;
                
                proposal.maoObraComercial.forEach(item => {
                    const row = tbody.insertRow();
                    const totalGeral = this.converterParaNumero(item[6]) || 0;
                    totalMaoObra += totalGeral;
                    
                    row.innerHTML = `
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1;">${item[0] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: center;">${item[1] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: center;">${item[2] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: right; color: #27ae60;">R$ ${item[3] || '0,00'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: center; color: #f39c12;">${item[4] || '0'}%</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: right; color: #27ae60;">R$ ${item[5] || '0,00'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: right; color: #27ae60; font-weight: 700;">R$ ${item[6] || '0,00'}</td>
                    `;
                });
                
                // Linha de total
                const totalRow = tbody.insertRow();
                totalRow.style.cssText = 'background: #f8fafc; font-weight: 700;';
                totalRow.innerHTML = `
                    <td colspan="6" style="padding: 15px; text-align: right;">TOTAL M√ÉO DE OBRA:</td>
                    <td style="padding: 15px; text-align: right; color: #e74c3c; font-size: 1.1em;">R$ ${this.formatCurrency(totalMaoObra)}</td>
                `;
            } else {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 20px; color: #999;">Nenhuma informa√ß√£o de m√£o de obra</td></tr>';
            }
            
            column.appendChild(table);
            container.appendChild(column);
        });
    }

    updateMateriaisComercialTable() {
        const tableContainer = document.querySelector('#materiaisComercialTable').closest('.table-container');
    
        tableContainer.innerHTML = `
            <div class="side-by-side-container" style="display: flex; gap: 20px; overflow-x: auto; padding: 20px;">
            </div>
        `;
        
        const container = tableContainer.querySelector('.side-by-side-container');
        
        this.proposals.forEach(proposal => {
            const column = document.createElement('div');
            column.className = 'proposal-column';
            column.style.cssText = 'flex: 0 0 550px; background: white; border-radius: 10px; border: 2px solid #e2e8f0; overflow: hidden;';
            
            // Header
            const header = document.createElement('div');
            header.style.cssText = 'background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 15px; text-align: center; font-weight: 700;';
            header.textContent = proposal.dadosCadastrais.razaoSocial;
            column.appendChild(header);
            
            // Tabela
            const table = document.createElement('table');
            table.style.cssText = 'width: 100%; border-collapse: collapse; font-size: 0.9rem;';
            
            table.innerHTML = `
                <thead>
                    <tr style="background: #f1f5f9;">
                        <th style="padding: 10px; text-align: left;">Material</th>
                        <th style="padding: 10px; text-align: left;">Especifica√ß√£o</th>
                        <th style="padding: 10px;">Unid.</th>
                        <th style="padding: 10px;">Qtd</th>
                        <th style="padding: 10px;">P.Unit</th>
                        <th style="padding: 10px;">Total</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            const tbody = table.querySelector('tbody');
            
            if (proposal.materiaisComercial && Array.isArray(proposal.materiaisComercial)) {
                let totalMateriais = 0;
                
                proposal.materiaisComercial.forEach(item => {
                    const row = tbody.insertRow();
                    const total = this.converterParaNumero(item[5]) || 0;
                    totalMateriais += total;
                    
                    row.innerHTML = `
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1;">${item[0] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1;">${item[1] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: center;">${item[2] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: center;">${item[3] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: right; color: #27ae60;">R$ ${item[4] || '0,00'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: right; color: #27ae60; font-weight: 700;">R$ ${item[5] || '0,00'}</td>
                    `;
                });
                
                // Linha de total
                const totalRow = tbody.insertRow();
                totalRow.style.cssText = 'background: #f8fafc; font-weight: 700;';
                totalRow.innerHTML = `
                    <td colspan="5" style="padding: 15px; text-align: right;">TOTAL MATERIAIS:</td>
                    <td style="padding: 15px; text-align: right; color: #e74c3c; font-size: 1.1em;">R$ ${this.formatCurrency(totalMateriais)}</td>
                `;
            } else {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #999;">Nenhum material informado</td></tr>';
            }
            
            column.appendChild(table);
            container.appendChild(column);
        });
    }

    updateEquipamentosComercialTable() {
        const tableContainer = document.querySelector('#equipamentosComercialTable').closest('.table-container');
    
        tableContainer.innerHTML = `
            <div class="side-by-side-container" style="display: flex; gap: 20px; overflow-x: auto; padding: 20px;">
            </div>
        `;
        
        const container = tableContainer.querySelector('.side-by-side-container');
        
        this.proposals.forEach(proposal => {
            const column = document.createElement('div');
            column.className = 'proposal-column';
            column.style.cssText = 'flex: 0 0 550px; background: white; border-radius: 10px; border: 2px solid #e2e8f0; overflow: hidden;';
            
            // Header
            const header = document.createElement('div');
            header.style.cssText = 'background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 15px; text-align: center; font-weight: 700;';
            header.textContent = proposal.dadosCadastrais.razaoSocial;
            column.appendChild(header);
            
            // Tabela
            const table = document.createElement('table');
            table.style.cssText = 'width: 100%; border-collapse: collapse; font-size: 0.9rem;';
            
            table.innerHTML = `
                <thead>
                    <tr style="background: #f1f5f9;">
                        <th style="padding: 10px; text-align: left;">Equipamento</th>
                        <th style="padding: 10px; text-align: left;">Especifica√ß√£o</th>
                        <th style="padding: 10px;">Qtd</th>
                        <th style="padding: 10px;">Meses</th>
                        <th style="padding: 10px;">P./M√™s</th>
                        <th style="padding: 10px;">Total</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            const tbody = table.querySelector('tbody');
            
            if (proposal.equipamentosComercial && Array.isArray(proposal.equipamentosComercial)) {
                let totalEquipamentos = 0;
                
                proposal.equipamentosComercial.forEach(item => {
                    const row = tbody.insertRow();
                    const total = this.converterParaNumero(item[5]) || 0;
                    totalEquipamentos += total;
                    
                    row.innerHTML = `
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1;">${item[0] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1;">${item[1] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: center;">${item[2] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: center;">${item[3] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: right; color: #27ae60;">R$ ${item[4] || '0,00'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: right; color: #27ae60; font-weight: 700;">R$ ${item[5] || '0,00'}</td>
                    `;
                });
                
                // Linha de total
                const totalRow = tbody.insertRow();
                totalRow.style.cssText = 'background: #f8fafc; font-weight: 700;';
                totalRow.innerHTML = `
                    <td colspan="5" style="padding: 15px; text-align: right;">TOTAL EQUIPAMENTOS:</td>
                    <td style="padding: 15px; text-align: right; color: #e74c3c; font-size: 1.1em;">R$ ${this.formatCurrency(totalEquipamentos)}</td>
                `;
            } else {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #999;">Nenhum equipamento informado</td></tr>';
            }
            
            column.appendChild(table);
            container.appendChild(column);
        });
    }

    updateBDITable() {
        const tableContainer = document.querySelector('#bdiTable').closest('.table-container');
        
        tableContainer.innerHTML = `
            <div class="side-by-side-container" style="display: flex; gap: 20px; overflow-x: auto; padding: 20px;">
            </div>
        `;
        
        const container = tableContainer.querySelector('.side-by-side-container');
        
        this.proposals.forEach(proposal => {
            const column = document.createElement('div');
            column.className = 'proposal-column';
            column.style.cssText = 'flex: 0 0 400px; background: white; border-radius: 10px; border: 2px solid #e2e8f0; overflow: hidden;';
            
            // Header
            const header = document.createElement('div');
            header.style.cssText = 'background: linear-gradient(135deg, #27ae60, #2ecc71); color: white; padding: 15px; text-align: center; font-weight: 700;';
            header.textContent = proposal.dadosCadastrais.razaoSocial;
            column.appendChild(header);
            
            // Tabela
            const table = document.createElement('table');
            table.style.cssText = 'width: 100%; border-collapse: collapse; font-size: 0.9rem;';
            
            table.innerHTML = `
                <thead>
                    <tr style="background: #f1f5f9;">
                        <th style="padding: 10px; text-align: left;">Item do BDI</th>
                        <th style="padding: 10px; text-align: center;">%</th>
                        <th style="padding: 10px; text-align: right;">Valor</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;
            
            const tbody = table.querySelector('tbody');
            
            if (proposal.bdi && Array.isArray(proposal.bdi)) {
                let totalPercentual = 0;
                let totalValor = 0;
                
                proposal.bdi.forEach(item => {
                    const row = tbody.insertRow();
                    const percentual = parseFloat(item[1]) || 0;
                    const valor = this.converterParaNumero(item[2]) || 0;
                    
                    totalPercentual += percentual;
                    totalValor += valor;
                    
                    row.innerHTML = `
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1;">${item[0] || '-'}</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: center; color: #f39c12; font-weight: 600;">${percentual.toFixed(1)}%</td>
                        <td style="padding: 10px; border-bottom: 1px solid #ecf0f1; text-align: right; color: #27ae60; font-weight: 600;">R$ ${this.formatCurrency(valor)}</td>
                    `;
                });
                
                // Linha de total
                const totalRow = tbody.insertRow();
                totalRow.style.cssText = 'background: #f8fafc; font-weight: 700;';
                totalRow.innerHTML = `
                    <td style="padding: 15px;">BDI TOTAL</td>
                    <td style="padding: 15px; text-align: center; color: #e74c3c;">${totalPercentual.toFixed(1)}%</td>
                    <td style="padding: 15px; text-align: right; color: #e74c3c; font-size: 1.1em;">R$ ${this.formatCurrency(totalValor)}</td>
                `;
            } else {
                tbody.innerHTML = '<tr><td colspan="3" style="text-align: center; padding: 20px; color: #999;">BDI n√£o informado</td></tr>';
            }
            
            column.appendChild(table);
            container.appendChild(column);
        });
    }

    updateResumoFinanceiroTable() {
        const tableBody = document.getElementById('resumoFinanceiroTable');
        if (!tableBody) return;

        const resumoItems = [
            { label: 'Total Servi√ßos', key: 'totalServicos' },
            { label: 'Total M√£o de Obra', key: 'totalMaoObra' },
            { label: 'Total Materiais', key: 'totalMateriais' },
            { label: 'Total Equipamentos', key: 'totalEquipamentos' },
            { label: 'Custo Direto', key: 'custoDireto' },
            { label: 'BDI Total (%)', key: 'bdiPercentual' },
            { label: 'BDI Total (R$)', key: 'bdiValor' },
            { label: 'VALOR TOTAL DA PROPOSTA', key: 'valorTotal' }
        ];

        tableBody.innerHTML = '';
        
        resumoItems.forEach(item => {
            const row = document.createElement('tr');
            
            // Label column
            const labelCell = document.createElement('td');
            labelCell.className = 'item-label';
            labelCell.textContent = item.label;
            if (item.key === 'valorTotal') {
                labelCell.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
                labelCell.style.fontSize = '1.1rem';
            }
            row.appendChild(labelCell);

            // Proposal columns
            this.proposals.forEach(proposal => {
                const cell = document.createElement('td');
                cell.className = 'proposal-cell';
                
                const value = proposal.resumoFinanceiro?.[item.key];
                if (value !== undefined) {
                    if (item.key === 'bdiPercentual') {
                        cell.innerHTML = `<span class="value-percentage">${value}%</span>`;
                    } else if (item.key === 'valorTotal') {
                        cell.innerHTML = `<span class="value-total">${this.formatCurrency(value)}</span>`;
                        cell.style.background = 'rgba(231, 76, 60, 0.1)';
                        cell.style.fontWeight = 'bold';
                    } else {
                        cell.innerHTML = `<span class="value-monetary">${this.formatCurrency(value)}</span>`;
                    }
                } else {
                    cell.innerHTML = '<span class="value-text">N√£o informado</span>';
                }
                
                row.appendChild(cell);
            });

            tableBody.appendChild(row);
        });
    }

    // Utility Functions
    buildTable(tableBody, items, dataSection) {
        tableBody.innerHTML = '';

        items.forEach(item => {
            const row = document.createElement('tr');
            
            // Label column
            const labelCell = document.createElement('td');
            labelCell.className = 'item-label';
            labelCell.textContent = item.label;
            row.appendChild(labelCell);

            // Proposal columns
            this.proposals.forEach(proposal => {
                const cell = document.createElement('td');
                cell.className = 'proposal-cell';
                
                const value = proposal[dataSection]?.[item.key];
                const formattedValue = this.formatValue(value, item.type);
                
                cell.innerHTML = formattedValue;
                row.appendChild(cell);
            });

            tableBody.appendChild(row);
        });
    }

    formatValue(value, type) {
        if (value === undefined || value === null || value === '') {
            return '<span class="value-text">N√£o informado</span>';
        }

        switch (type) {
            case 'monetary':
                return `<span class="value-monetary">${this.formatCurrency(value)}</span>`;
            case 'percentage':
                return `<span class="value-percentage">${value}%</span>`;
            case 'quantity':
                return `<span class="value-quantity">${value}</span>`;
            case 'status': {
                // Exibir recomenda√ß√£o do requisitante com cores diferentes conforme status
                const labelMap = {
                    'aprovada_tecnicamente': 'Aprovada Tecnicamente',
                    'ajuste': 'Solicitar Ajuste',
                    'reprovada_tecnicamente': 'Reprovada Tecnicamente'
                };
                const colorMap = {
                    'aprovada_tecnicamente': '#0066cc', // azul
                    'ajuste': '#e6a600',                 // amarelo
                    'reprovada_tecnicamente': '#cc0000'  // vermelho
                };
                const label = labelMap[value] || value;
                const color = colorMap[value] || '#333';
                return `<span class="value-status" style="color:${color}; font-weight:600;">${label}</span>`;
            }
            case 'text':
            default:
                return `<span class="value-text">${value}</span>`;
        }
    }

    formatCurrency(value) {
        if (typeof value === 'number') {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }
        return value || 'R$ 0,00';
    }

    async updateAIInsights(tabType) {
        // Elementos do DOM
        const highlightElement = document.getElementById('aiHighlight');
        const attentionElement = document.getElementById('aiAttention');
        const marketElement = document.getElementById('aiMarket');
        
        // Verificar se temos propostas para analisar
        if (!this.proposals || this.proposals.length === 0) {
            highlightElement.textContent = 'Selecione um processo para ver os insights...';
            attentionElement.textContent = 'Aguardando an√°lise das propostas...';
            marketElement.textContent = 'Dados de mercado ser√£o exibidos ap√≥s sele√ß√£o do processo...';
            return;
        }
        
        // Mostrar loading
        highlightElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Analisando...';
        attentionElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';
        marketElement.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Calculando...';
        
        try {
            // Verificar se Azure IA est√° dispon√≠vel
            if (typeof window.AzureIAPropostas !== 'undefined') {
                console.log('Azure IA dispon√≠vel - usando an√°lise avan√ßada');
                
                // Usar inst√¢ncia global ou criar nova
                const azureIA = window.azureIAGlobal || new window.AzureIAPropostas();
                
                // Garantir que est√° configurado
                if (azureIA.fallbackMode) {
                    azureIA.configurarAzure(
                        'https://portalcompras.openai.azure.com/',
                        '6Z0VYdgofYJMu32yWoaJfQtuocrVPKFi0sZhnBge7hluMgJXDVvuJQQJ99BHACYeBjFXJ3w3AAABACOGvaka'
                    );
                }
                
                // Executar an√°lise
                const insights = await azureIA.analisarPropostas(this.proposals, tabType);
                
                // Atualizar interface com resultados
                highlightElement.textContent = insights.highlight || 'An√°lise conclu√≠da';
                attentionElement.textContent = insights.attention || 'Sem alertas identificados';
                marketElement.textContent = insights.market || 'Dados do mercado processados';
                
                // Adicionar indicador de modo
                const modoIndicador = azureIA.fallbackMode ? ' (Modo Simulado)' : ' (Azure IA)';
                highlightElement.innerHTML += `<small style="opacity: 0.7;">${modoIndicador}</small>`;
                
            } else {
                console.log('Azure IA n√£o dispon√≠vel - usando an√°lise b√°sica');
                
                // Fallback para an√°lise b√°sica
                const insights = this.getAIInsights(tabType);
                
                highlightElement.textContent = insights.highlight;
                attentionElement.textContent = insights.attention;
                marketElement.textContent = insights.market;
                
                // Adicionar indicador de modo b√°sico
                highlightElement.innerHTML += '<small style="opacity: 0.7;"> (An√°lise B√°sica)</small>';
            }
            
        } catch (error) {
            console.error('Erro ao obter insights:', error);
            
            // Em caso de erro, usar an√°lise b√°sica
            const insights = this.getAIInsights(tabType);
            
            highlightElement.textContent = insights.highlight;
            attentionElement.textContent = insights.attention;
            marketElement.textContent = insights.market;
            
            // Indicar que houve erro
            marketElement.innerHTML += '<br><small style="color: #e74c3c;">‚ö†Ô∏è Erro na an√°lise avan√ßada</small>';
        }
    }

    getAIInsights(tabType) {
        if (this.proposals.length === 0) {
            return {
                highlight: 'Selecione um processo para ver os insights...',
                attention: 'Aguardando dados...',
                market: 'Aguardando dados...'
            };
        }
    
        // Usar a nova classe de an√°lise se dispon√≠vel
        if (window.AzureIAPropostas) {
            const ia = new window.AzureIAPropostas();
            if (tabType === 'tecnica') {
                return ia.analisarDadosReaisTecnicos(this.proposals);
            } else {
                return ia.analisarDadosReaisComerciais(this.proposals);
            }
        }

    // Fallback mant√©m o c√≥digo original
    const valores = this.proposals.map(p => p.resumoFinanceiro?.valorTotal || 0);
    const menorValor = Math.min(...valores);
    const melhorProposta = this.proposals.find(p => p.resumoFinanceiro?.valorTotal === menorValor);

        if (tabType === 'tecnica') {
            return {
                highlight: `${melhorProposta?.dadosCadastrais.razaoSocial} apresenta a proposta mais competitiva com prazo de ${melhorProposta?.propostaTecnica.prazoExecucao}.`,
                attention: `Verificar documenta√ß√£o t√©cnica e certifica√ß√µes de todos os fornecedores. Analisar viabilidade dos prazos propostos.`,
                market: `${this.proposals.length} propostas recebidas. Varia√ß√£o de valores entre ${this.formatCurrency(Math.min(...valores))} e ${this.formatCurrency(Math.max(...valores))}.`
            };
        } else {
            const variacaoPercentual = ((Math.max(...valores) - Math.min(...valores)) / Math.min(...valores) * 100).toFixed(2);
            
            return {
                highlight: `${melhorProposta?.dadosCadastrais.razaoSocial} oferece o menor valor: ${this.formatCurrency(menorValor)}.`,
                attention: `Varia√ß√£o de ${variacaoPercentual}% entre a maior e menor proposta. Verificar composi√ß√£o do BDI de cada fornecedor.`,
                market: `M√©dia de mercado: ${this.formatCurrency(valores.reduce((a, b) => a + b, 0) / valores.length)}. Desvio padr√£o indica ${variacaoPercentual > 30 ? 'alta' : 'baixa'} dispers√£o de pre√ßos.`
            };
        }
    }

    showLoading() {
        const containers = document.querySelectorAll('.comparison-container');
        containers.forEach(container => {
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div class="loading-spinner"></div>
                <div style="color: #64748b; font-weight: 600;">Carregando dados das propostas...</div>
            `;
            
            container.style.position = 'relative';
            container.appendChild(overlay);
        });
    }

    hideLoading() {
        document.querySelectorAll('.loading-overlay').forEach(overlay => {
            overlay.remove();
        });
    }

    // M√©todos de exporta√ß√£o
    generateExportData() {
        const data = [];
        const tables = document.querySelectorAll(`#${this.currentTab} .comparison-table`);
        
        tables.forEach((table, tableIndex) => {
            if (tableIndex > 0) data.push([]); // Add separator between tables
            
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('th, td');
                const rowData = Array.from(cells).map(cell => 
                    cell.textContent.trim().replace(/\n/g, ' ').replace(/\s+/g, ' ')
                );
                data.push(rowData);
            });
        });
        
        return data;
    }

    convertToCSV(data) {
        return data.map(row => 
            row.map(cell => `"${cell}"`).join(',')
        ).join('\n');
    }

    downloadCSV(csv, filename) {
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }
}

// Fun√ß√µes globais para os bot√µes
window.exportData = function() {
    const comparativo = window.comparativoReal;
    if (!comparativo || !comparativo.currentProcess) {
        alert('Selecione um processo antes de exportar.');
        return;
    }
    
    const currentTabName = comparativo.currentTab === 'tecnica' ? 'Tecnica' : 'Comercial';
    
    // Generate export data based on current tab
    const data = comparativo.generateExportData();
    const csv = comparativo.convertToCSV(data);
    comparativo.downloadCSV(csv, `Comparativo_${currentTabName}_${comparativo.currentProcess}.csv`);
}

window.openFilters = function() {
    // Simple filter implementation
    const filters = [
        'Valor at√© R$ 3M',
        'Prazo at√© 180 dias',
        'Com certifica√ß√£o ISO',
        'BDI at√© 30%',
        'Experi√™ncia > 10 anos'
    ];
    
    const selectedFilters = [];

    filters.forEach(filter => {
        if (confirm(`Aplicar filtro: ${filter}?`)) {
            selectedFilters.push(filter);
        }
    });

    if (selectedFilters.length > 0) {
        alert(`Filtros aplicados: ${selectedFilters.join(', ')}`);
        // Here you would implement the actual filtering logic
    }
}

// Fun√ß√£o para inicializar Azure IA
function inicializarAzureIAComparativo() {
    if (window.AzureIAPropostas) {
        // Criar inst√¢ncia global para reutiliza√ß√£o
        window.azureIAGlobal = new window.AzureIAPropostas();
        
        // Configurar com as credenciais
        const configurado = window.azureIAGlobal.configurarAzure(
            'https://portalcompras.openai.azure.com/',
            '6Z0VYdgofYJMu32yWoaJfQtuocrVPKFi0sZhnBge7hluMgJXDVvuJQQJ99BHACYeBjFXJ3w3AAABACOGvaka'
        );
        
        if (configurado) {
            console.log('‚úÖ Azure IA configurado no Comparativo!');
            window.azureIAGlobal.testarConexao().then(resultado => {
                console.log('üîå Conex√£o Azure:', resultado);
            });
        }
    }
}

// Fun√ß√£o para enviar o comparativo t√©cnico ao requisitante
function enviarComparativoTecnicoParaRequisitante() {
    try {
        const comparativo = window.comparativoReal;
        if (!comparativo || !comparativo.currentProcess) {
            alert('Selecione um processo com comparativo antes de enviar.');
            return;
        }
        const processoId = comparativo.currentProcess;
        const propostas = comparativo.proposals || [];
        if (!Array.isArray(propostas) || propostas.length === 0) {
            alert('Nenhuma proposta dispon√≠vel para enviar o comparativo.');
            return;
        }
        // Determinar t√≠tulo do processo
        let processoTitulo = '';
        try {
            const processosLocal = JSON.parse(localStorage.getItem('sistema_processos') || localStorage.getItem('processos_licitatorios') || '[]');
            const processo = processosLocal.find(p => p.id == processoId || p.processoId == processoId);
            if (processo) {
                const numProc = processo.numeroProcesso || processo.numero || processoId;
                const tituloTR = (processo.trVinculado && (processo.trVinculado.titulo || processo.trVinculado.objeto)) || processo.objeto || '';
                processoTitulo = numProc + (tituloTR ? ' - ' + tituloTR : '');
            } else {
                processoTitulo = 'Processo ' + processoId;
            }
        } catch (e) {
            processoTitulo = 'Processo ' + processoId;
        }
        // Determinar comprador respons√°vel
        let compradorResponsavel = '';
        try {
            const comprador = JSON.parse(localStorage.getItem('usuario_comprador') || localStorage.getItem('comprador_logado') || '{}');
            compradorResponsavel = comprador.nome || comprador.email || '';
        } catch (e) {
            compradorResponsavel = '';
        }
        // Selecionar fornecedor de menor valor
        let idxMenorValor = 0;
        for (let i = 1; i < propostas.length; i++) {
            const valAtual = parseFloat(propostas[i]?.resumoFinanceiro?.valorTotal) || 0;
            const valMin = parseFloat(propostas[idxMenorValor]?.resumoFinanceiro?.valorTotal) || 0;
            if (valAtual < valMin) idxMenorValor = i;
        }
        const melhorValor = propostas[idxMenorValor];
        // Selecionar fornecedor de menor prazo
        let idxMenorPrazo = 0;
        for (let i = 1; i < propostas.length; i++) {
            const prazoAtualStr = propostas[i]?.propostaTecnica?.prazoExecucao || '';
            const prazoMinStr = propostas[idxMenorPrazo]?.propostaTecnica?.prazoExecucao || '';
            const prazoAtual = parseInt(String(prazoAtualStr).replace(/\D/g, ''), 10) || Number.MAX_SAFE_INTEGER;
            const prazoMin = parseInt(String(prazoMinStr).replace(/\D/g, ''), 10) || Number.MAX_SAFE_INTEGER;
            if (prazoAtual < prazoMin) idxMenorPrazo = i;
        }
        const melhorPrazo = propostas[idxMenorPrazo];
        const prazoStr = melhorPrazo?.propostaTecnica?.prazoExecucao || '';
        // Construir objeto de resumo
        const comparativoResumo = {
            melhorValorFornecedor: melhorValor?.dadosCadastrais?.razaoSocial || '',
            melhorPrazoFornecedor: melhorPrazo?.dadosCadastrais?.razaoSocial || '',
            menorValor: parseFloat(melhorValor?.resumoFinanceiro?.valorTotal) || 0,
            menorPrazo: prazoStr
        };
        // Se existir um comparativo t√©cnico anterior deste processo no localStorage,
        // copiar os pareceres j√° emitidos para os novos fornecedores antes de
        // construir o objeto. Isso evita perder o hist√≥rico quando o comprador
        // gera uma nova vers√£o do comparativo.
        let propostasRequisitantePrev = [];
        try {
            propostasRequisitantePrev = JSON.parse(localStorage.getItem('propostas_para_requisitante') || '[]');
        } catch (e) {
            propostasRequisitantePrev = [];
        }
        const comparativoAnterior = propostasRequisitantePrev.find(p => p.processo_id == processoId && p.comparativo_tecnico);
        if (comparativoAnterior && comparativoAnterior.comparativo_tecnico) {
            const prevList = comparativoAnterior.comparativo_tecnico.proposals || [];
            // Copiar pareceres para cada fornecedor
            proposals.forEach(nov => {
                const cnpjNov = nov.dadosCadastrais?.cnpj || nov.cnpj;
                const prev = prevList.find(pr => {
                    const cnpjPrev = pr.dadosCadastrais?.cnpj || pr.cnpj;
                    return cnpjPrev && cnpjPrev === cnpjNov;
                });
                if (prev) {
                    // copiar hist√≥rico de pareceres e campos individuais
                    if (Array.isArray(prev.pareceres)) {
                        nov.pareceres = JSON.parse(JSON.stringify(prev.pareceres));
                    }
                    if (prev.parecer_requisitante) nov.parecer_requisitante = prev.parecer_requisitante;
                    if (prev.recomendacao_requisitante) nov.recomendacao_requisitante = prev.recomendacao_requisitante;
                    if (prev.data_parecer_requisitante) nov.data_parecer_requisitante = prev.data_parecer_requisitante;
                    if (prev.status_requisitante) nov.status_requisitante = prev.status_requisitante;
                }
            });
        }
        // Construir objeto de comparativo
        const comparativoTecnico = {
            proposals: propostas,
            resumo: comparativoResumo
        };
        // Criar proposta para o requisitante
        const propostaEnvio = {
            id: Date.now(),
            processo_id: processoId,
            processo_titulo: processoTitulo,
            fornecedor_cnpj: melhorValor?.dadosCadastrais?.cnpj || '',
            prazo: prazoStr.replace(/\D/g, '') || '',
            data_envio_requisitante: new Date().toLocaleDateString('pt-BR'),
            comprador_responsavel: compradorResponsavel,
            descricao_tecnica: 'Comparativo T√©cnico de Propostas',
            parecer_comprador: `Fornecedor de menor valor: ${comparativoResumo.melhorValorFornecedor}. Menor prazo: ${comparativoResumo.melhorPrazoFornecedor}.`,
            status: 'PENDENTE_PARECER',
            comparativo_tecnico: comparativoTecnico
        };
        // Atualizar lista de propostas para requisitante
        let propostasRequisitante = [];
        try {
            propostasRequisitante = JSON.parse(localStorage.getItem('propostas_para_requisitante') || '[]');
        } catch (e) {
            propostasRequisitante = [];
        }
        // Remover comparativos t√©cnicos anteriores deste processo
        propostasRequisitante = propostasRequisitante.filter(p => !(p.processo_id == processoId && p.comparativo_tecnico));
        propostasRequisitante.push(propostaEnvio);
        localStorage.setItem('propostas_para_requisitante', JSON.stringify(propostasRequisitante));
        // Gerar notifica√ß√£o ao requisitante
        let notificacoes = [];
        try {
            notificacoes = JSON.parse(localStorage.getItem('notificacoes_requisitante') || '[]');
        } catch (e) {
            notificacoes = [];
        }
        notificacoes.push({
            id: Date.now(),
            titulo: 'Comparativo T√©cnico de Propostas',
            mensagem: `O comparativo t√©cnico do processo ${processoTitulo} foi enviado para seu parecer.`,
            data: new Date().toLocaleDateString('pt-BR'),
            lida: false
        });
        localStorage.setItem('notificacoes_requisitante', JSON.stringify(notificacoes));
        alert('Comparativo t√©cnico enviado ao requisitante para parecer!');
    } catch (erro) {
        console.warn('Erro ao enviar comparativo t√©cnico:', erro);
        alert('N√£o foi poss√≠vel enviar o comparativo t√©cnico. Verifique os dados e tente novamente.');
    }
}

// Adicionar listener para o bot√£o de envio (deve existir no DOM)
document.addEventListener('DOMContentLoaded', function() {
    const btnEnviar = document.getElementById('btn-enviar-comparativo-tecnico');
    if (btnEnviar) {
        btnEnviar.addEventListener('click', enviarComparativoTecnicoParaRequisitante);
    }
});

// Inicializar quando DOM estiver pronto
document.addEventListener('DOMContentLoaded', function() {
    // Inicializar Azure IA primeiro
    inicializarAzureIAComparativo();
    
    // Depois inicializar o comparativo
    window.comparativoReal = new ComparativoPropostasIntegrado();
});
    </script>
   <!-- Integra√ß√£o com Azure AI -->
   <script src="azure-config.js"></script>
   <script src="integracao-relatorio-comparativo.js"></script>
    </div> <!-- Fechamento da comparativo-wrapper -->

    <script type="module" src="/static/firebase.js"></script>
<script type="module" src="/static/js/auth.js"></script>

<script type="module" src="/static/js/firebase.js"></script>
<script type="module" src="/static/js/realtime-sync.js"></script>
</body>
</html>
