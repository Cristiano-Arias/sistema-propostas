<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparativo de Propostas - Baseado no Portal Real</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #3498db;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --light-bg: #f8fafc;
            --card-bg: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            text-align: center;
        }

        .page-title {
            font-size: 2.2rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* Process Selector */
        .process-selector {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }

        .process-select {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid var(--border-color);
            border-radius: 10px;
            font-size: 1rem;
            background: white;
            transition: all 0.3s ease;
        }

        .process-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        /* Analysis Tabs */
        .analysis-tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 8px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            gap: 8px;
        }

        .tab-button {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: transparent;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .tab-button.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
        }

        .tab-button:not(.active):hover {
            background: rgba(52, 152, 219, 0.1);
            color: var(--primary-color);
        }

        /* Azure IA Insights */
        .ai-insights {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            position: relative;
            overflow: hidden;
        }

        .ai-insights::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .ai-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            position: relative;
            z-index: 1;
        }

        .ai-icon {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
        }

        .ai-content {
            position: relative;
            z-index: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .ai-card {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .ai-card-title {
            font-weight: 700;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
        }

        /* Comparison Container */
        .comparison-container {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: var(--shadow);
            overflow: hidden;
            margin-bottom: 25px;
        }

        .comparison-header {
            padding: 20px 25px;
            border-bottom: 2px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
        }

        .comparison-title {
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-primary);
        }

        .export-buttons {
            display: flex;
            gap: 10px;
        }

        .btn {
            padding: 10px 16px;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
            transform: translateY(-2px);
        }

        .btn-secondary {
            background: var(--light-bg);
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: white;
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            max-height: 600px;
            overflow-y: auto;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            background: white;
        }

        .comparison-table th {
            background: linear-gradient(135deg, var(--primary-color), #2980b9);
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 700;
            position: sticky;
            top: 0;
            z-index: 10;
            border-right: 1px solid rgba(255, 255, 255, 0.2);
        }

        .comparison-table th:first-child {
            width: 200px;
            min-width: 200px;
            background: linear-gradient(135deg, #2c3e50, #34495e);
        }

        .comparison-table td {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            border-right: 1px solid var(--border-color);
            vertical-align: top;
        }

        .comparison-table tbody tr:hover {
            background-color: rgba(52, 152, 219, 0.05);
        }

        .item-label {
            font-weight: 700;
            color: white;
            background: linear-gradient(135deg, #2c3e50, #34495e);
            text-align: center;
        }

        .proposal-cell {
            min-width: 250px;
            position: relative;
        }

        .company-header {
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
            color: white;
            text-align: center;
            font-weight: 700;
            font-size: 1.1rem;
            padding: 18px 12px;
        }

        /* Value Formatting */
        .value-monetary {
            font-weight: 700;
            color: var(--success-color);
            font-size: 1.1em;
        }

        .value-quantity {
            font-weight: 600;
            color: var(--primary-color);
        }

        .value-percentage {
            font-weight: 600;
            color: var(--warning-color);
        }

        .value-text {
            color: var(--text-primary);
        }

        .value-total {
            font-weight: 700;
            color: var(--danger-color);
            font-size: 1.2em;
            background: rgba(231, 76, 60, 0.1);
            padding: 5px 8px;
            border-radius: 5px;
        }

        /* Section Headers */
        .section-header {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            padding: 15px 20px;
            font-weight: 700;
            font-size: 1.1rem;
            text-align: center;
            margin: 0;
        }

        /* Tab Content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .container {
                padding: 15px;
            }
            
            .comparison-table th:first-child {
                width: 180px;
                min-width: 180px;
            }
            
            .proposal-cell {
                min-width: 220px;
            }
        }

        @media (max-width: 768px) {
            .analysis-tabs {
                flex-direction: column;
                gap: 8px;
            }

            .comparison-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }

            .export-buttons {
                justify-content: center;
            }

            .comparison-table th:first-child {
                width: 150px;
                min-width: 150px;
            }

            .proposal-cell {
                min-width: 200px;
            }

            .ai-content {
                grid-template-columns: 1fr;
            }
        }

        /* Loading States */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Voltar Button */
        .btn-voltar {
            position: fixed;
            top: 20px;
            left: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            border-radius: 10px;
            color: var(--text-primary);
            text-decoration: none;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: var(--shadow);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .btn-voltar:hover {
            transform: translateX(-5px);
            background: white;
        }

        /* Print Styles */
        @media print {
            .export-buttons,
            .analysis-tabs,
            .ai-insights,
            .btn-voltar {
                display: none !important;
            }

            .comparison-container {
                box-shadow: none !important;
                border: 1px solid #ddd !important;
            }

            body {
                background: white !important;
            }
        }
    </style>
</head>
<body>
    <!-- Botão Voltar -->
    <a href="dashboard-comprador-funcional.html" class="btn-voltar">
        <i class="fas fa-arrow-left"></i> Voltar ao Dashboard
    </a>

    <div class="container">
        <div class="header">
            <h1 class="page-title">📊 Comparativo de Propostas</h1>
            <p class="page-subtitle">Análise detalhada baseada nas tabelas reais do portal de propostas</p>
        </div>

        <!-- Process Selector -->
        <div class="process-selector">
            <select class="process-select" id="processSelect">
                <option value="">Selecione um processo para análise...</option>
            </select>
        </div>

        <!-- Analysis Type Tabs -->
        <div class="analysis-tabs">
            <button class="tab-button active" data-tab="tecnica">
                <i class="fas fa-cogs"></i>
                Análise Técnica
            </button>
            <button class="tab-button" data-tab="comercial">
                <i class="fas fa-dollar-sign"></i>
                Análise Comercial
            </button>
        </div>

        <!-- Azure IA Insights -->
        <div class="ai-insights">
            <div class="ai-header">
                <div class="ai-icon">
                    <i class="fas fa-robot"></i>
                </div>
                <div>
                    <h3>Insights Azure IA</h3>
                    <p>Análise automática das propostas baseada nos dados reais do portal</p>
                </div>
            </div>

            <div class="ai-content">
                <div class="ai-card">
                    <div class="ai-card-title">
                        <i class="fas fa-lightbulb"></i>
                        Destaque Principal
                    </div>
                    <div id="aiHighlight">
                        Carregue um processo para ver os insights da Azure IA...
                    </div>
                </div>

                <div class="ai-card">
                    <div class="ai-card-title">
                        <i class="fas fa-exclamation-triangle"></i>
                        Pontos de Atenção
                    </div>
                    <div id="aiAttention">
                        Aguardando análise das propostas...
                    </div>
                </div>

                <div class="ai-card">
                    <div class="ai-card-title">
                        <i class="fas fa-chart-line"></i>
                        Análise de Mercado
                    </div>
                    <div id="aiMarket">
                        Dados de mercado serão exibidos após seleção do processo...
                    </div>
                </div>
            </div>
        </div>

        <!-- Technical Analysis Tab -->
        <div id="tecnica" class="tab-content active">
            <!-- Dados Cadastrais -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-building"></i>
                        1. Dados Cadastrais
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Dados Cadastrais</th>
                                <th class="company-header">Aguardando seleção...</th>
                            </tr>
                        </thead>
                        <tbody id="dadosCadastraisTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Proposta Técnica -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-clipboard-list"></i>
                        2. Proposta Técnica
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Aspectos Técnicos</th>
                                <th class="company-header">Aguardando seleção...</th>
                            </tr>
                        </thead>
                        <tbody id="propostaTecnicaTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Tabela de Serviços Técnica -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-tasks"></i>
                        2.1 Tabela de Serviços (Quantidades)
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Serviço</th>
                                <th class="company-header">Aguardando seleção...</th>
                            </tr>
                        </thead>
                        <tbody id="servicosTecnicaTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Mão de Obra -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-users"></i>
                        2.2 Mão de Obra Direta e Indireta
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Função</th>
                                <th class="company-header">Aguardando seleção...</th>
                            </tr>
                        </thead>
                        <tbody id="maoObraTecnicaTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Materiais -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-boxes"></i>
                        2.3 Lista de Materiais (Quantidades)
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Material</th>
                                <th class="company-header">Aguardando seleção...</th>
                            </tr>
                        </thead>
                        <tbody id="materiaisTecnicaTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Equipamentos -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-tools"></i>
                        2.4 Lista de Equipamentos (Quantidades)
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Equipamento</th>
                                <th class="company-header">Aguardando seleção...</th>
                            </tr>
                        </thead>
                        <tbody id="equipamentosTecnicaTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Commercial Analysis Tab -->
        <div id="comercial" class="tab-content">
            <!-- Tabela de Serviços Comercial -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-calculator"></i>
                        3.1 Tabela de Serviços (Valores)
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Serviço</th>
                                <th class="company-header">Aguardando seleção...</th>
                            </tr>
                        </thead>
                        <tbody id="servicosComercialTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Mão de Obra Comercial -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-money-bill-wave"></i>
                        3.2 Mão de Obra (Custos)
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Função</th>
                                <th class="company-header">Aguardando seleção...</th>
                            </tr>
                        </thead>
                        <tbody id="maoObraComercialTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Materiais Comercial -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-shopping-cart"></i>
                        3.3 Materiais (Custos)
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Material</th>
                                <th class="company-header">Aguardando seleção...</th>
                            </tr>
                        </thead>
                        <tbody id="materiaisComercialTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Equipamentos Comercial -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-wrench"></i>
                        3.4 Equipamentos (Custos)
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Equipamento</th>
                                <th class="company-header">Aguardando seleção...</th>
                            </tr>
                        </thead>
                        <tbody id="equipamentosComercialTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- BDI Detalhado -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-percentage"></i>
                        3.5 BDI Detalhado
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Item do BDI</th>
                                <th class="company-header">Aguardando seleção...</th>
                            </tr>
                        </thead>
                        <tbody id="bdiTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Resumo Financeiro -->
            <div class="comparison-container">
                <div class="comparison-header">
                    <div class="comparison-title">
                        <i class="fas fa-chart-pie"></i>
                        3.6 Resumo Financeiro
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-secondary" onclick="openFilters()">
                            <i class="fas fa-filter"></i>
                            Filtrar
                        </button>
                        <button class="btn btn-primary" onclick="exportData()">
                            <i class="fas fa-file-export"></i>
                            Exportar
                        </button>
                    </div>
                </div>

                <div class="table-container">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th class="item-label">Componente</th>
                                <th class="company-header">Aguardando seleção...</th>
                            </tr>
                        </thead>
                        <tbody id="resumoFinanceiroTable">
                            <tr>
                                <td colspan="2" style="text-align: center; padding: 40px; color: #999;">
                                    Selecione um processo para visualizar os dados
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
/**
 * Sistema de Comparativo de Propostas - Versão Integrada
 * Mantém o visual original mas com dados reais do localStorage
 */

class ComparativoPropostasIntegrado {
    constructor() {
        this.currentProcess = null;
        this.currentTab = 'tecnica';
        this.proposals = [];
        this.init();
    }

    init() {
        this.setupEventListeners();
        this.loadAvailableProcesses();
    }

    setupEventListeners() {
        // Tab switching
        const tabButtons = document.querySelectorAll('.tab-button');
        tabButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                this.switchTab(e.currentTarget.getAttribute('data-tab'));
            });
        });

        // Process selection
        const processSelect = document.getElementById('processSelect');
        if (processSelect) {
            processSelect.addEventListener('change', (e) => {
                this.loadProcess(e.target.value);
            });
        }
    }

    // Carregar processos disponíveis do localStorage
    loadAvailableProcesses() {
        const processos = JSON.parse(localStorage.getItem('processos_licitatorios') || '[]');
        const processSelect = document.getElementById('processSelect');
        
        if (!processSelect) return;
        
        // Limpar opções existentes
        processSelect.innerHTML = '<option value="">Selecione um processo para análise...</option>';
        
        // Adicionar processos que têm propostas
        processos.forEach(processo => {
            // Buscar propostas para este processo
            const propostas = this.buscarPropostasDoProcesso(processo.id);
            
            if (propostas.length > 0) {
                const option = document.createElement('option');
                option.value = processo.id;
                option.textContent = `${processo.numeroProcesso} - ${processo.trVinculado?.titulo || 'Sem título'}`;
                processSelect.appendChild(option);
            }
        });
        
        // Se vier com processo selecionado na URL
        const urlParams = new URLSearchParams(window.location.search);
        const processoId = urlParams.get('processo');
        if (processoId) {
            processSelect.value = processoId;
            this.loadProcess(processoId);
        }
    }

    // Buscar propostas de um processo específico
    buscarPropostasDoProcesso(processoId) {
        const propostas = [];
        
        // Buscar em propostas_fornecedores
        const propostasFornecedores = JSON.parse(localStorage.getItem('propostas_fornecedores') || '[]');
        propostasFornecedores.forEach(p => {
            if (p.processoId === processoId) {
                propostas.push(this.formatarPropostaFornecedor(p));
            }
        });
        
        // Buscar em propostas_completas
        const propostasCompletas = JSON.parse(localStorage.getItem('propostas_completas') || '[]');
        propostasCompletas.forEach(p => {
            if (p.processoId === processoId && !propostas.find(prop => prop.id === p.id)) {
                propostas.push(this.formatarPropostaCompleta(p));
            }
        });
        
        return propostas;
    }

    // Formatar proposta do fornecedor para o formato esperado
    formatarPropostaFornecedor(proposta) {
        return {
            id: proposta.id,
            processoId: proposta.processoId,
            dadosCadastrais: {
                razaoSocial: proposta.fornecedorRazaoSocial,
                cnpj: proposta.fornecedorCNPJ,
                endereco: proposta.endereco || 'Não informado',
                cidade: proposta.cidade || 'Não informado',
                telefone: proposta.telefone || 'Não informado',
                email: proposta.email || 'Não informado',
                respTecnico: proposta.responsavel || 'Não informado',
                crea: proposta.crea || 'Não informado'
            },
            propostaTecnica: {
                objetoConcorrencia: proposta.objeto || 'Conforme TR',
                escopoInclusos: proposta.escopo || 'Conforme especificações',
                escopoExclusos: 'Não especificado',
                metodologia: proposta.descricao_tecnica || 'Conforme padrões técnicos',
                sequenciaExecucao: proposta.cronograma || 'Conforme cronograma',
                prazoExecucao: proposta.prazoExecucao || '180 dias',
                prazoMobilizacao: '15 dias',
                garantias: proposta.garantia || '12 meses',
                estruturaCanteiro: 'Conforme necessário',
                obrigacoesContratada: 'Conforme contrato',
                obrigacoesContratante: 'Conforme contrato'
            },
            servicosTecnica: this.gerarServicosTecnica(proposta),
            maoObraTecnica: this.gerarMaoObraTecnica(proposta),
            materiaisTecnica: this.gerarMateriaisTecnica(proposta),
            equipamentosTecnica: this.gerarEquipamentosTecnica(proposta),
            servicosComercial: this.gerarServicosComercial(proposta),
            maoObraComercial: this.gerarMaoObraComercial(proposta),
            materiaisComercial: this.gerarMateriaisComercial(proposta),
            equipamentosComercial: this.gerarEquipamentosComercial(proposta),
            bdi: this.gerarBDI(proposta),
            resumoFinanceiro: this.gerarResumoFinanceiro(proposta)
        };
    }

    // Formatar proposta completa
    formatarPropostaCompleta(proposta) {
        return proposta; // Já está no formato correto
    }

    // Gerar dados técnicos baseados na proposta
    gerarServicosTecnica(proposta) {
        // Se já tem dados detalhados, usar
        if (proposta.servicos) return proposta.servicos;
        
        // Gerar dados básicos
        return [
            { descricao: 'Serviço principal', unidade: 'un', quantidade: 1 },
            { descricao: 'Serviços complementares', unidade: 'vb', quantidade: 1 }
        ];
    }

    gerarMaoObraTecnica(proposta) {
        if (proposta.maoObra) return proposta.maoObra;
        
        return [
            { funcao: 'Coordenador', quantidade: 1, tempo: 6 },
            { funcao: 'Técnico', quantidade: 2, tempo: 6 },
            { funcao: 'Auxiliar', quantidade: 3, tempo: 6 }
        ];
    }

    gerarMateriaisTecnica(proposta) {
        if (proposta.materiais) return proposta.materiais;
        
        return [
            { material: 'Material principal', especificacao: 'Conforme especificação', unidade: 'un', quantidade: 100 }
        ];
    }

    gerarEquipamentosTecnica(proposta) {
        if (proposta.equipamentos) return proposta.equipamentos;
        
        return [
            { equipamento: 'Equipamento principal', especificacao: 'Conforme necessário', unidade: 'un', quantidade: 1, tempo: 6 }
        ];
    }

    // Gerar dados comerciais
    gerarServicosComercial(proposta) {
        const valor = parseFloat(proposta.valor || 0);
        return [
            { 
                descricao: 'Serviço principal', 
                unidade: 'un', 
                quantidade: 1, 
                precoUnitario: valor * 0.7,
                total: valor * 0.7
            },
            { 
                descricao: 'Serviços complementares', 
                unidade: 'vb', 
                quantidade: 1, 
                precoUnitario: valor * 0.3,
                total: valor * 0.3
            }
        ];
    }

    gerarMaoObraComercial(proposta) {
        const valor = parseFloat(proposta.valor || 0);
        return [
            { funcao: 'Coordenador', quantidade: 1, tempo: 6, salario: 5000, encargos: 80, total: 54000 },
            { funcao: 'Técnico', quantidade: 2, tempo: 6, salario: 3000, encargos: 80, total: 64800 },
            { funcao: 'Auxiliar', quantidade: 3, tempo: 6, salario: 1500, encargos: 80, total: 48600 }
        ];
    }

    gerarMateriaisComercial(proposta) {
        const valor = parseFloat(proposta.valor || 0);
        return [
            { 
                material: 'Material principal', 
                especificacao: 'Conforme especificação', 
                unidade: 'un', 
                quantidade: 100,
                precoUnitario: valor * 0.002,
                total: valor * 0.2
            }
        ];
    }

    gerarEquipamentosComercial(proposta) {
        const valor = parseFloat(proposta.valor || 0);
        return [
            { 
                equipamento: 'Equipamento principal', 
                especificacao: 'Conforme necessário', 
                quantidade: 1, 
                tempo: 6,
                precoMensal: valor * 0.02,
                total: valor * 0.12
            }
        ];
    }

    gerarBDI(proposta) {
        const valor = parseFloat(proposta.valor || 0);
        const bdiPercentual = proposta.bdi || 25;
        const valorBDI = valor * (bdiPercentual / 100);
        
        return [
            { item: 'Administração Central', percentual: 8.0, valor: valorBDI * 0.32 },
            { item: 'Seguros e Garantias', percentual: 1.5, valor: valorBDI * 0.06 },
            { item: 'Riscos', percentual: 2.0, valor: valorBDI * 0.08 },
            { item: 'Despesas Financeiras', percentual: 1.0, valor: valorBDI * 0.04 },
            { item: 'Lucro', percentual: 8.0, valor: valorBDI * 0.32 },
            { item: 'Tributos (ISS, PIS, COFINS)', percentual: 4.5, valor: valorBDI * 0.18 }
        ];
    }

    gerarResumoFinanceiro(proposta) {
        const valor = parseFloat(proposta.valor || 0);
        const custoDireto = valor * 0.75;
        const bdi = valor * 0.25;
        
        return {
            totalServicos: custoDireto * 0.4,
            totalMaoObra: custoDireto * 0.3,
            totalMateriais: custoDireto * 0.2,
            totalEquipamentos: custoDireto * 0.1,
            custoDireto: custoDireto,
            bdiPercentual: 25.0,
            bdiValor: bdi,
            valorTotal: valor
        };
    }

    switchTab(tabName) {
        // Update button states
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.classList.remove('active');
        });
        document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

        // Update content visibility
        document.querySelectorAll('.tab-content').forEach(content => {
            content.classList.remove('active');
        });
        document.getElementById(tabName).classList.add('active');

        this.currentTab = tabName;
        this.updateAIInsights(tabName);
    }

    loadProcess(processId) {
        if (!processId) return;

        this.currentProcess = processId;
        this.showLoading();

        // Buscar propostas do processo
        this.proposals = this.buscarPropostasDoProcesso(processId);
        
        if (this.proposals.length === 0) {
            alert('Nenhuma proposta encontrada para este processo!');
            this.hideLoading();
            return;
        }

        // Atualizar interface
        this.updateCompanyHeaders();
        this.updateAllTables();
        this.updateAIInsights(this.currentTab);
        
        this.hideLoading();
    }

    updateCompanyHeaders() {
        const headers = document.querySelectorAll('.company-header');
        
        // Atualizar todos os headers de cada tabela
        document.querySelectorAll('.comparison-table').forEach(table => {
            const thead = table.querySelector('thead tr');
            if (thead) {
                // Remover headers antigos (exceto o primeiro)
                while (thead.children.length > 1) {
                    thead.removeChild(thead.lastChild);
                }
                
                // Adicionar novos headers
                this.proposals.forEach(proposal => {
                    const th = document.createElement('th');
                    th.className = 'company-header';
                    th.textContent = proposal.dadosCadastrais.razaoSocial;
                    thead.appendChild(th);
                });
            }
        });
    }

    updateAllTables() {
        // Análise Técnica
        this.updateDadosCadastraisTable();
        this.updatePropostaTecnicaTable();
        this.updateServicosTecnicaTable();
        this.updateMaoObraTecnicaTable();
        this.updateMateriaisTecnicaTable();
        this.updateEquipamentosTecnicaTable();

        // Análise Comercial
        this.updateServicosComercialTable();
        this.updateMaoObraComercialTable();
        this.updateMateriaisComercialTable();
        this.updateEquipamentosComercialTable();
        this.updateBDITable();
        this.updateResumoFinanceiroTable();
    }

    // Tabelas de Análise Técnica
    updateDadosCadastraisTable() {
        const tableBody = document.getElementById('dadosCadastraisTable');
        if (!tableBody) return;

        const items = [
            { label: 'Razão Social', key: 'razaoSocial' },
            { label: 'CNPJ', key: 'cnpj' },
            { label: 'Endereço', key: 'endereco' },
            { label: 'Cidade/UF', key: 'cidade' },
            { label: 'Telefone', key: 'telefone' },
            { label: 'E-mail', key: 'email' },
            { label: 'Responsável Técnico', key: 'respTecnico' },
            { label: 'CREA/CAU', key: 'crea' }
        ];

        this.buildTable(tableBody, items, 'dadosCadastrais');
    }

    updatePropostaTecnicaTable() {
        const tableBody = document.getElementById('propostaTecnicaTable');
        if (!tableBody) return;

        const items = [
            { label: 'Objeto da Concorrência', key: 'objetoConcorrencia', type: 'text' },
            { label: 'Serviços a Executar', key: 'escopoInclusos', type: 'text' },
            { label: 'Serviços Ocultos', key: 'escopoExclusos', type: 'text' },
            { label: 'Metodologia de Execução', key: 'metodologia', type: 'text' },
            { label: 'Plano de Execução', key: 'sequenciaExecucao', type: 'text' },
            { label: 'Prazo de Execução', key: 'prazoExecucao', type: 'text' },
            { label: 'Prazo de Mobilização', key: 'prazoMobilizacao', type: 'text' },
            { label: 'Garantias Oferecidas', key: 'garantias', type: 'text' },
            { label: 'Estrutura do Canteiro', key: 'estruturaCanteiro', type: 'text' },
            { label: 'Obrigações da Contratada', key: 'obrigacoesContratada', type: 'text' },
            { label: 'Obrigações da Contratante', key: 'obrigacoesContratante', type: 'text' }
        ];

        this.buildTable(tableBody, items, 'propostaTecnica');
    }

    updateServicosTecnicaTable() {
        const tableBody = document.getElementById('servicosTecnicaTable');
        if (!tableBody) return;

        // Coletar todos os serviços únicos
        const servicosUnicos = new Set();
        this.proposals.forEach(proposal => {
            if (proposal.servicosTecnica) {
                proposal.servicosTecnica.forEach(servico => {
                    servicosUnicos.add(servico.descricao);
                });
            }
        });

        tableBody.innerHTML = '';
        
        Array.from(servicosUnicos).forEach(servicoDesc => {
            const row = document.createElement('tr');
            
            // Label column
            const labelCell = document.createElement('td');
            labelCell.className = 'item-label';
            labelCell.textContent = servicoDesc;
            row.appendChild(labelCell);

            // Proposal columns
            this.proposals.forEach(proposal => {
                const cell = document.createElement('td');
                cell.className = 'proposal-cell';
                
                const servico = proposal.servicosTecnica?.find(s => s.descricao === servicoDesc);
                if (servico) {
                    cell.innerHTML = `
                        <div><strong>Unidade:</strong> <span class="value-text">${servico.unidade}</span></div>
                        <div><strong>Quantidade:</strong> <span class="value-quantity">${servico.quantidade}</span></div>
                    `;
                } else {
                    cell.innerHTML = '<span class="value-text">Não informado</span>';
                }
                
                row.appendChild(cell);
            });

            tableBody.appendChild(row);
        });
    }

    updateMaoObraTecnicaTable() {
        const tableBody = document.getElementById('maoObraTecnicaTable');
        if (!tableBody) return;

        // Coletar todas as funções únicas
        const funcoesUnicas = new Set();
        this.proposals.forEach(proposal => {
            if (proposal.maoObraTecnica) {
                proposal.maoObraTecnica.forEach(func => {
                    funcoesUnicas.add(func.funcao);
                });
            }
        });

        tableBody.innerHTML = '';
        
        Array.from(funcoesUnicas).forEach(funcao => {
            const row = document.createElement('tr');
            
            // Label column
            const labelCell = document.createElement('td');
            labelCell.className = 'item-label';
            labelCell.textContent = funcao;
            row.appendChild(labelCell);

            // Proposal columns
            this.proposals.forEach(proposal => {
                const cell = document.createElement('td');
                cell.className = 'proposal-cell';
                
                const func = proposal.maoObraTecnica?.find(f => f.funcao === funcao);
                if (func) {
                    cell.innerHTML = `
                        <div><strong>Quantidade:</strong> <span class="value-quantity">${func.quantidade}</span></div>
                        <div><strong>Tempo:</strong> <span class="value-text">${func.tempo} meses</span></div>
                    `;
                } else {
                    cell.innerHTML = '<span class="value-text">Não informado</span>';
                }
                
                row.appendChild(cell);
            });

            tableBody.appendChild(row);
        });
    }

    updateMateriaisTecnicaTable() {
        const tableBody = document.getElementById('materiaisTecnicaTable');
        if (!tableBody) return;

        // Coletar todos os materiais únicos
        const materiaisUnicos = new Set();
        this.proposals.forEach(proposal => {
            if (proposal.materiaisTecnica) {
                proposal.materiaisTecnica.forEach(mat => {
                    materiaisUnicos.add(mat.material);
                });
            }
        });

        tableBody.innerHTML = '';
        
        Array.from(materiaisUnicos).forEach(material => {
            const row = document.createElement('tr');
            
            // Label column
            const labelCell = document.createElement('td');
            labelCell.className = 'item-label';
            labelCell.textContent = material;
            row.appendChild(labelCell);

            // Proposal columns
            this.proposals.forEach(proposal => {
                const cell = document.createElement('td');
                cell.className = 'proposal-cell';
                
                const mat = proposal.materiaisTecnica?.find(m => m.material === material);
                if (mat) {
                    cell.innerHTML = `
                        <div><strong>Especificação:</strong> <span class="value-text">${mat.especificacao}</span></div>
                        <div><strong>Unidade:</strong> <span class="value-text">${mat.unidade}</span></div>
                        <div><strong>Quantidade:</strong> <span class="value-quantity">${mat.quantidade}</span></div>
                    `;
                } else {
                    cell.innerHTML = '<span class="value-text">Não informado</span>';
                }
                
                row.appendChild(cell);
            });

            tableBody.appendChild(row);
        });
    }

    updateEquipamentosTecnicaTable() {
        const tableBody = document.getElementById('equipamentosTecnicaTable');
        if (!tableBody) return;

        // Coletar todos os equipamentos únicos
        const equipamentosUnicos = new Set();
        this.proposals.forEach(proposal => {
            if (proposal.equipamentosTecnica) {
                proposal.equipamentosTecnica.forEach(eq => {
                    equipamentosUnicos.add(eq.equipamento);
                });
            }
        });

        tableBody.innerHTML = '';
        
        Array.from(equipamentosUnicos).forEach(equipamento => {
            const row = document.createElement('tr');
            
            // Label column
            const labelCell = document.createElement('td');
            labelCell.className = 'item-label';
            labelCell.textContent = equipamento;
            row.appendChild(labelCell);

            // Proposal columns
            this.proposals.forEach(proposal => {
                const cell = document.createElement('td');
                cell.className = 'proposal-cell';
                
                const eq = proposal.equipamentosTecnica?.find(e => e.equipamento === equipamento);
                if (eq) {
                    cell.innerHTML = `
                        <div><strong>Especificação:</strong> <span class="value-text">${eq.especificacao}</span></div>
                        <div><strong>Unidade:</strong> <span class="value-text">${eq.unidade}</span></div>
                        <div><strong>Quantidade:</strong> <span class="value-quantity">${eq.quantidade}</span></div>
                        <div><strong>Tempo:</strong> <span class="value-text">${eq.tempo} meses</span></div>
                    `;
                } else {
                    cell.innerHTML = '<span class="value-text">Não informado</span>';
                }
                
                row.appendChild(cell);
            });

            tableBody.appendChild(row);
        });
    }

    // Tabelas de Análise Comercial
    updateServicosComercialTable() {
        const tableBody = document.getElementById('servicosComercialTable');
        if (!tableBody) return;

        // Coletar todos os serviços únicos
        const servicosUnicos = new Set();
        this.proposals.forEach(proposal => {
            if (proposal.servicosComercial) {
                proposal.servicosComercial.forEach(servico => {
                    servicosUnicos.add(servico.descricao);
                });
            }
        });

        tableBody.innerHTML = '';
        
        Array.from(servicosUnicos).forEach(servicoDesc => {
            const row = document.createElement('tr');
            
            // Label column
            const labelCell = document.createElement('td');
            labelCell.className = 'item-label';
            labelCell.textContent = servicoDesc;
            row.appendChild(labelCell);

            // Proposal columns
            this.proposals.forEach(proposal => {
                const cell = document.createElement('td');
                cell.className = 'proposal-cell';
                
                const servico = proposal.servicosComercial?.find(s => s.descricao === servicoDesc);
                if (servico) {
                    cell.innerHTML = `
                        <div><strong>Unidade:</strong> <span class="value-text">${servico.unidade}</span></div>
                        <div><strong>Quantidade:</strong> <span class="value-quantity">${servico.quantidade}</span></div>
                        <div><strong>Preço Unit:</strong> <span class="value-monetary">${this.formatCurrency(servico.precoUnitario)}</span></div>
                        <div><strong>Total:</strong> <span class="value-total">${this.formatCurrency(servico.total)}</span></div>
                    `;
                } else {
                    cell.innerHTML = '<span class="value-text">Não informado</span>';
                }
                
                row.appendChild(cell);
            });

            tableBody.appendChild(row);
        });
    }

    updateMaoObraComercialTable() {
        const tableBody = document.getElementById('maoObraComercialTable');
        if (!tableBody) return;

        // Coletar todas as funções únicas
        const funcoesUnicas = new Set();
        this.proposals.forEach(proposal => {
            if (proposal.maoObraComercial) {
                proposal.maoObraComercial.forEach(func => {
                    funcoesUnicas.add(func.funcao);
                });
            }
        });

        tableBody.innerHTML = '';
        
        Array.from(funcoesUnicas).forEach(funcao => {
            const row = document.createElement('tr');
            
            // Label column
            const labelCell = document.createElement('td');
            labelCell.className = 'item-label';
            labelCell.textContent = funcao;
            row.appendChild(labelCell);

            <!-- CONTINUAÇÃO DO ARQUIVO - PARTE 2 -->
<!-- Cole este conteúdo logo após "row.appendChild(labelCell);" -->

            // Proposal columns
            this.proposals.forEach(proposal => {
                const cell = document.createElement('td');
                cell.className = 'proposal-cell';
                
                const func = proposal.maoObraComercial?.find(f => f.funcao === funcao);
                if (func) {
                    cell.innerHTML = `
                        <div><strong>Quantidade:</strong> <span class="value-quantity">${func.quantidade}</span></div>
                        <div><strong>Tempo:</strong> <span class="value-text">${func.tempo} meses</span></div>
                        <div><strong>Salário:</strong> <span class="value-monetary">${this.formatCurrency(func.salario)}</span></div>
                        <div><strong>Enc. Sociais:</strong> <span class="value-percentage">${func.encargos}%</span></div>
                        <div><strong>Total:</strong> <span class="value-total">${this.formatCurrency(func.total)}</span></div>
                    `;
                } else {
                    cell.innerHTML = '<span class="value-text">Não informado</span>';
                }
                
                row.appendChild(cell);
            });

            tableBody.appendChild(row);
        });
    }

    updateMateriaisComercialTable() {
        const tableBody = document.getElementById('materiaisComercialTable');
        if (!tableBody) return;

        // Coletar todos os materiais únicos
        const materiaisUnicos = new Set();
        this.proposals.forEach(proposal => {
            if (proposal.materiaisComercial) {
                proposal.materiaisComercial.forEach(mat => {
                    materiaisUnicos.add(mat.material);
                });
            }
        });

        tableBody.innerHTML = '';
        
        Array.from(materiaisUnicos).forEach(material => {
            const row = document.createElement('tr');
            
            // Label column
            const labelCell = document.createElement('td');
            labelCell.className = 'item-label';
            labelCell.textContent = material;
            row.appendChild(labelCell);

            // Proposal columns
            this.proposals.forEach(proposal => {
                const cell = document.createElement('td');
                cell.className = 'proposal-cell';
                
                const mat = proposal.materiaisComercial?.find(m => m.material === material);
                if (mat) {
                    cell.innerHTML = `
                        <div><strong>Especificação:</strong> <span class="value-text">${mat.especificacao}</span></div>
                        <div><strong>Unidade:</strong> <span class="value-text">${mat.unidade}</span></div>
                        <div><strong>Quantidade:</strong> <span class="value-quantity">${mat.quantidade}</span></div>
                        <div><strong>Preço Unit:</strong> <span class="value-monetary">${this.formatCurrency(mat.precoUnitario)}</span></div>
                        <div><strong>Total:</strong> <span class="value-total">${this.formatCurrency(mat.total)}</span></div>
                    `;
                } else {
                    cell.innerHTML = '<span class="value-text">Não informado</span>';
                }
                
                row.appendChild(cell);
            });

            tableBody.appendChild(row);
        });
    }

    updateEquipamentosComercialTable() {
        const tableBody = document.getElementById('equipamentosComercialTable');
        if (!tableBody) return;

        // Coletar todos os equipamentos únicos
        const equipamentosUnicos = new Set();
        this.proposals.forEach(proposal => {
            if (proposal.equipamentosComercial) {
                proposal.equipamentosComercial.forEach(eq => {
                    equipamentosUnicos.add(eq.equipamento);
                });
            }
        });

        tableBody.innerHTML = '';
        
        Array.from(equipamentosUnicos).forEach(equipamento => {
            const row = document.createElement('tr');
            
            // Label column
            const labelCell = document.createElement('td');
            labelCell.className = 'item-label';
            labelCell.textContent = equipamento;
            row.appendChild(labelCell);

            // Proposal columns
            this.proposals.forEach(proposal => {
                const cell = document.createElement('td');
                cell.className = 'proposal-cell';
                
                const eq = proposal.equipamentosComercial?.find(e => e.equipamento === equipamento);
                if (eq) {
                    cell.innerHTML = `
                        <div><strong>Especificação:</strong> <span class="value-text">${eq.especificacao}</span></div>
                        <div><strong>Quantidade:</strong> <span class="value-quantity">${eq.quantidade}</span></div>
                        <div><strong>Tempo:</strong> <span class="value-text">${eq.tempo} meses</span></div>
                        <div><strong>Preço/mês:</strong> <span class="value-monetary">${this.formatCurrency(eq.precoMensal)}</span></div>
                        <div><strong>Total:</strong> <span class="value-total">${this.formatCurrency(eq.total)}</span></div>
                    `;
                } else {
                    cell.innerHTML = '<span class="value-text">Não informado</span>';
                }
                
                row.appendChild(cell);
            });

            tableBody.appendChild(row);
        });
    }

    updateBDITable() {
        const tableBody = document.getElementById('bdiTable');
        if (!tableBody) return;

        const bdiItems = [
            'Administração Central',
            'Seguros e Garantias',
            'Riscos',
            'Despesas Financeiras',
            'Lucro',
            'Tributos (ISS, PIS, COFINS)'
        ];

        tableBody.innerHTML = '';
        
        bdiItems.forEach(item => {
            const row = document.createElement('tr');
            
            // Label column
            const labelCell = document.createElement('td');
            labelCell.className = 'item-label';
            labelCell.textContent = item;
            row.appendChild(labelCell);

            // Proposal columns
            this.proposals.forEach(proposal => {
                const cell = document.createElement('td');
                cell.className = 'proposal-cell';
                
                const bdiItem = proposal.bdi?.find(b => b.item === item);
                if (bdiItem) {
                    cell.innerHTML = `
                        <div><strong>Percentual:</strong> <span class="value-percentage">${bdiItem.percentual}%</span></div>
                        <div><strong>Valor:</strong> <span class="value-monetary">${this.formatCurrency(bdiItem.valor)}</span></div>
                    `;
                } else {
                    cell.innerHTML = '<span class="value-text">Não informado</span>';
                }
                
                row.appendChild(cell);
            });

            tableBody.appendChild(row);
        });
    }

    updateResumoFinanceiroTable() {
        const tableBody = document.getElementById('resumoFinanceiroTable');
        if (!tableBody) return;

        const resumoItems = [
            { label: 'Total Serviços', key: 'totalServicos' },
            { label: 'Total Mão de Obra', key: 'totalMaoObra' },
            { label: 'Total Materiais', key: 'totalMateriais' },
            { label: 'Total Equipamentos', key: 'totalEquipamentos' },
            { label: 'Custo Direto', key: 'custoDireto' },
            { label: 'BDI Total (%)', key: 'bdiPercentual' },
            { label: 'BDI Total (R$)', key: 'bdiValor' },
            { label: 'VALOR TOTAL DA PROPOSTA', key: 'valorTotal' }
        ];

        tableBody.innerHTML = '';
        
        resumoItems.forEach(item => {
            const row = document.createElement('tr');
            
            // Label column
            const labelCell = document.createElement('td');
            labelCell.className = 'item-label';
            labelCell.textContent = item.label;
            if (item.key === 'valorTotal') {
                labelCell.style.background = 'linear-gradient(135deg, #e74c3c, #c0392b)';
                labelCell.style.fontSize = '1.1rem';
            }
            row.appendChild(labelCell);

            // Proposal columns
            this.proposals.forEach(proposal => {
                const cell = document.createElement('td');
                cell.className = 'proposal-cell';
                
                const value = proposal.resumoFinanceiro?.[item.key];
                if (value !== undefined) {
                    if (item.key === 'bdiPercentual') {
                        cell.innerHTML = `<span class="value-percentage">${value}%</span>`;
                    } else if (item.key === 'valorTotal') {
                        cell.innerHTML = `<span class="value-total">${this.formatCurrency(value)}</span>`;
                        cell.style.background = 'rgba(231, 76, 60, 0.1)';
                        cell.style.fontWeight = 'bold';
                    } else {
                        cell.innerHTML = `<span class="value-monetary">${this.formatCurrency(value)}</span>`;
                    }
                } else {
                    cell.innerHTML = '<span class="value-text">Não informado</span>';
                }
                
                row.appendChild(cell);
            });

            tableBody.appendChild(row);
        });
    }

    // Utility Functions
    buildTable(tableBody, items, dataSection) {
        tableBody.innerHTML = '';

        items.forEach(item => {
            const row = document.createElement('tr');
            
            // Label column
            const labelCell = document.createElement('td');
            labelCell.className = 'item-label';
            labelCell.textContent = item.label;
            row.appendChild(labelCell);

            // Proposal columns
            this.proposals.forEach(proposal => {
                const cell = document.createElement('td');
                cell.className = 'proposal-cell';
                
                const value = proposal[dataSection]?.[item.key];
                const formattedValue = this.formatValue(value, item.type);
                
                cell.innerHTML = formattedValue;
                row.appendChild(cell);
            });

            tableBody.appendChild(row);
        });
    }

    formatValue(value, type) {
        if (value === undefined || value === null || value === '') {
            return '<span class="value-text">Não informado</span>';
        }

        switch (type) {
            case 'monetary':
                return `<span class="value-monetary">${this.formatCurrency(value)}</span>`;
            case 'percentage':
                return `<span class="value-percentage">${value}%</span>`;
            case 'quantity':
                return `<span class="value-quantity">${value}</span>`;
            case 'text':
            default:
                return `<span class="value-text">${value}</span>`;
        }
    }

    formatCurrency(value) {
        if (typeof value === 'number') {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }
        return value || 'R$ 0,00';
    }

    updateAIInsights(tabType) {
        const insights = this.getAIInsights(tabType);
        
        document.getElementById('aiHighlight').textContent = insights.highlight;
        document.getElementById('aiAttention').textContent = insights.attention;
        document.getElementById('aiMarket').textContent = insights.market;
    }

    getAIInsights(tabType) {
        if (this.proposals.length === 0) {
            return {
                highlight: 'Selecione um processo para ver os insights...',
                attention: 'Aguardando dados...',
                market: 'Aguardando dados...'
            };
        }

        // Encontrar menor valor
        const valores = this.proposals.map(p => p.resumoFinanceiro?.valorTotal || 0);
        const menorValor = Math.min(...valores);
        const melhorProposta = this.proposals.find(p => p.resumoFinanceiro?.valorTotal === menorValor);

        if (tabType === 'tecnica') {
            return {
                highlight: `${melhorProposta?.dadosCadastrais.razaoSocial} apresenta a proposta mais competitiva com prazo de ${melhorProposta?.propostaTecnica.prazoExecucao}.`,
                attention: `Verificar documentação técnica e certificações de todos os fornecedores. Analisar viabilidade dos prazos propostos.`,
                market: `${this.proposals.length} propostas recebidas. Variação de valores entre ${this.formatCurrency(Math.min(...valores))} e ${this.formatCurrency(Math.max(...valores))}.`
            };
        } else {
            const variacaoPercentual = ((Math.max(...valores) - Math.min(...valores)) / Math.min(...valores) * 100).toFixed(2);
            
            return {
                highlight: `${melhorProposta?.dadosCadastrais.razaoSocial} oferece o menor valor: ${this.formatCurrency(menorValor)}.`,
                attention: `Variação de ${variacaoPercentual}% entre a maior e menor proposta. Verificar composição do BDI de cada fornecedor.`,
                market: `Média de mercado: ${this.formatCurrency(valores.reduce((a, b) => a + b, 0) / valores.length)}. Desvio padrão indica ${variacaoPercentual > 30 ? 'alta' : 'baixa'} dispersão de preços.`
            };
        }
    }

    showLoading() {
        const containers = document.querySelectorAll('.comparison-container');
        containers.forEach(container => {
            const overlay = document.createElement('div');
            overlay.className = 'loading-overlay';
            overlay.innerHTML = `
                <div class="loading-spinner"></div>
                <div style="color: #64748b; font-weight: 600;">Carregando dados das propostas...</div>
            `;
            
            container.style.position = 'relative';
            container.appendChild(overlay);
        });
    }

    hideLoading() {
        document.querySelectorAll('.loading-overlay').forEach(overlay => {
            overlay.remove();
        });
    }

    // Métodos de exportação
    generateExportData() {
        const data = [];
        const tables = document.querySelectorAll(`#${this.currentTab} .comparison-table`);
        
        tables.forEach((table, tableIndex) => {
            if (tableIndex > 0) data.push([]); // Add separator between tables
            
            const rows = table.querySelectorAll('tr');
            rows.forEach(row => {
                const cells = row.querySelectorAll('th, td');
                const rowData = Array.from(cells).map(cell => 
                    cell.textContent.trim().replace(/\n/g, ' ').replace(/\s+/g, ' ')
                );
                data.push(rowData);
            });
        });
        
        return data;
    }

    convertToCSV(data) {
        return data.map(row => 
            row.map(cell => `"${cell}"`).join(',')
        ).join('\n');
    }

    downloadCSV(csv, filename) {
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        
        if (link.download !== undefined) {
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    }
}

// Funções globais para os botões
window.exportData = function() {
    const comparativo = window.comparativoReal;
    if (!comparativo || !comparativo.currentProcess) {
        alert('Selecione um processo antes de exportar.');
        return;
    }
    
    const currentTabName = comparativo.currentTab === 'tecnica' ? 'Tecnica' : 'Comercial';
    
    // Generate export data based on current tab
    const data = comparativo.generateExportData();
    const csv = comparativo.convertToCSV(data);
    comparativo.downloadCSV(csv, `Comparativo_${currentTabName}_${comparativo.currentProcess}.csv`);
}

window.openFilters = function() {
    // Simple filter implementation
    const filters = [
        'Valor até R$ 3M',
        'Prazo até 180 dias',
        'Com certificação ISO',
        'BDI até 30%',
        'Experiência > 10 anos'
    ];
    
    const selectedFilters = [];

    filters.forEach(filter => {
        if (confirm(`Aplicar filtro: ${filter}?`)) {
            selectedFilters.push(filter);
        }
    });

    if (selectedFilters.length > 0) {
        alert(`Filtros aplicados: ${selectedFilters.join(', ')}`);
        // Here you would implement the actual filtering logic
    }
}

// Inicializar quando DOM estiver pronto
document.addEventListener('DOMContentLoaded', function() {
    window.comparativoReal = new ComparativoPropostasIntegrado();
});
    </script>
</body>
</html>                              
